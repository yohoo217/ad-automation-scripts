<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建立廣告</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; text-align: center; }
        label { font-weight: bold; }
        input[type="text"], input[type="url"], textarea, .custom-file-upload {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }
        textarea {
            height: 300px;
            font-family: monospace;
        }
        button, input[type="submit"], .button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        button:hover, input[type="submit"]:hover, .button:hover { background-color: #4cae4c; }
        .flash-messages { list-style-type: none; padding: 0; margin-bottom: 20px; }
        .flash-messages li { padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .flash-success { background-color: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; }
        .flash-error { background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
        .required { color: red; }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .nav-button {
            background-color: #337ab7;
        }
        .nav-button:hover { background-color: #286090; }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 12px;
        }
        table, th, td {
            border: 1px solid #ddd;
            padding: 4px;
            vertical-align: middle;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
            text-align: center;
        }
        .file-upload-container {
            position: relative;
            margin-bottom: 10px;
        }
        .custom-file-upload {
            display: block;
            padding: 4px 8px;
            cursor: pointer;
            background-color: #f8f8f8;
            text-align: center;
            border: 1px dashed #ccc;
            font-size: 12px;
        }
        .custom-file-upload:hover {
            background-color: #f0f0f0;
        }
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .upload-preview {
            max-width: 50px;
            max-height: 50px;
            margin-top: 5px;
            display: block;
        }
        .field-group {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .field-group h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .form-row {
            margin-bottom: 15px;
        }
        .help-text {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        .image-cell {
            position: relative;
        }
        .image-input-container {
            display: flex;
            flex-direction: column;
        }
        .preview-container {
            display: flex;
            align-items: center;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-buttons">
            <a href="{{ url_for('batch') }}" class="button nav-button">批量廣告創建</a>
        </div>
        
        <h1>建立廣告</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="flash-{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <!-- 快速輸入區塊 -->
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 25px;">
            <h2 style="text-align: center;">快速資訊輸入</h2>
            <p>將格式化文案貼到下方文字區，然後點擊「解析資訊」按鈕自動填入表單</p>
            <textarea id="bulk-info-input" placeholder="請貼上格式化的廣告資訊，例如：
廣告資訊
-廣告主：和德昌股份有限公司
-代理商：香港商陽獅銳奇股份有限公司台灣分公司星傳媒體事業處
-活動名稱：電豹_麥當勞_Meaty Angus 5月宣傳活動
-活動走期：2025/5/21 ~ 2025/6/3
-投放版位：電豹原生影音廣告
-總預算：NT$150,000(未稅) 
-計價方式：CPV $0.4

廣告素材
l   素材：https://lion.box.com/s/g3zngprm41ckr9hmlid5nvcg9s1m1sy8

l   導連：https://www.mcdonalds.com/tw/zh-tw/whats-hot/0521meatyangus.html?utm_source=ptt&utm_medium=paid-video&utm_campaign=cp~np-meaty-angus_sd~2025-05-21&utm_content=at~pnta_cv~tvc20s-5s-acg　

l   文案：

-  標題：傳說中的辣個美味！電動追番必吃「辣味四盎司牛肉堡」

-   CTA：吃飽再戰"></textarea>
            <button type="button" id="parse-info" class="nav-button" style="margin-top: 10px;">解析資訊</button>
        </div>

        <form action="{{ url_for('create_ad_route') }}" method="post" id="ad-form">
            <input type="hidden" id="active_tab_input" name="active_tab" value="{{ active_tab }}">
            <div class="tabs">
                <div class="tab {% if active_tab == 'native-ad' %}active{% endif %}" data-tab="native-ad">原生廣告</div>
                <div class="tab {% if active_tab == 'gif-ad' %}active{% endif %}" data-tab="gif-ad">GIF 廣告</div>
                <div class="tab {% if active_tab == 'slide-ad' %}active{% endif %}" data-tab="slide-ad">水平 Slide 廣告</div>
                <div class="tab {% if active_tab == 'vertical-slide-ad' %}active{% endif %}" data-tab="vertical-slide-ad">垂直 Slide 廣告</div>
                <div class="tab {% if active_tab == 'vertical-cube-slide-ad' %}active{% endif %}" data-tab="vertical-cube-slide-ad">垂直 Cube Slide 廣告</div>
            </div>
            
            <div id="native-ad" class="tab-content {% if active_tab == 'native-ad' %}active{% endif %}">
                <div class="field-group">
                    <h3>廣告資訊</h3>
                    <table>
                        <tr>
                            <th width="30%">欄位名稱</th>
                            <th>內容</th>
                        </tr>
                        <tr>
                            <td><label for="adset_id">Adset ID <span class="required">*</span></label></td>
                            <td><input type="text" id="adset_id" name="adset_id" value="{{ adset_id or '' }}" required>
                                <div class="help-text">廣告組ID，必填，例如：00947c1b-f7cd-47c6-a23a-0639e9702cc7</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="display_name">廣告單元顯示名稱</label></td>
                            <td><input type="text" id="display_name" name="display_name" value="{{ display_name or '' }}">
                                <div class="help-text">僅顯示於後台，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="advertiser">廣告商 <span class="required">*</span></label></td>
                            <td><input type="text" id="advertiser" name="advertiser" value="{{ advertiser or '' }}" required>
                                <div class="help-text">廣告主名稱，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="main_title">主標題 <span class="required">*</span></label></td>
                            <td><input type="text" id="main_title" name="main_title" value="{{ main_title or '' }}" required>
                                <div class="help-text">廣告主標題，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="subtitle">副標題</label></td>
                            <td><input type="text" id="subtitle" name="subtitle" value="{{ subtitle or '' }}">
                                <div class="help-text">廣告副標題，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="landing_page">到達頁面網址 <span class="required">*</span></label></td>
                            <td><input type="url" id="landing_page" name="landing_page" placeholder="https://example.com" value="{{ landing_page or '' }}" required>
                                <div class="help-text">用戶點擊廣告後跳轉的網址，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="call_to_action">行動呼籲按鈕文字</label></td>
                            <td><input type="text" id="call_to_action" name="call_to_action" value="{{ call_to_action or '瞭解詳情' }}">
                                <div class="help-text">CTA按鈕文字，預設為「瞭解詳情」</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="tracking_url">追蹤 URL</label></td>
                            <td><input type="url" id="tracking_url" name="tracking_url" placeholder="https://tracker.example.com?id=123" value="{{ tracking_url or '' }}">
                                <div class="help-text">用於追蹤點擊的URL，可選</div>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="field-group">
                    <h3>廣告圖片 <span class="required">*</span></h3>
                    <p>所有圖片均為必填。請提供本地完整檔案路徑，或使用上傳功能。</p>
                    
                    <div class="form-row">
                        <label for="image_path_m">圖片 1200x628 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="image_path_m" name="image_path_m" placeholder="/path/to/your/image_1200x628.jpg" value="{{ image_path_m or '' }}" required>
                            <div class="help-text">大型橫幅圖片，尺寸1200x628像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="image_path_m" accept="image/*">
                                </label>
                                <img id="preview_m" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="image_path_p">圖片 336x280/300x250 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="image_path_p" name="image_path_p" placeholder="/path/to/your/image_336x280.jpg" value="{{ image_path_p or '' }}" required>
                            <div class="help-text">中型橫幅圖片，尺寸336x280像素或300x250像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="image_path_p" accept="image/*">
                                </label>
                                <img id="preview_p" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="image_path_o">圖片 640x100 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="image_path_o" name="image_path_o" placeholder="/path/to/your/image_640x100.jpg" value="{{ image_path_o or '' }}" required>
                            <div class="help-text">窄橫幅圖片，尺寸640x100像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="image_path_o" accept="image/*">
                                </label>
                                <img id="preview_o" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="image_path_s">圖片 300x300 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="image_path_s" name="image_path_s" placeholder="/path/to/your/image_300x300.jpg" value="{{ image_path_s or '' }}" required>
                            <div class="help-text">方形圖片，尺寸300x300像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="image_path_s" accept="image/*">
                                </label>
                                <img id="preview_s" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gif-ad" class="tab-content {% if active_tab == 'gif-ad' %}active{% endif %}">
                <div class="field-group">
                    <h3>廣告資訊</h3>
                    <table>
                        <tr>
                            <th width="30%">欄位名稱</th>
                            <th>內容</th>
                        </tr>
                        <tr>
                            <td><label for="gif_adset_id">Adset ID <span class="required">*</span></label></td>
                            <td><input type="text" id="gif_adset_id" name="gif_adset_id" value="{{ gif_adset_id or '' }}" required>
                                <div class="help-text">廣告組ID，必填，例如：00947c1b-f7cd-47c6-a23a-0639e9702cc7</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="gif_display_name">廣告單元顯示名稱</label></td>
                            <td><input type="text" id="gif_display_name" name="gif_display_name" value="{{ gif_display_name or '' }}">
                                <div class="help-text">僅顯示於後台，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="gif_advertiser">廣告商 <span class="required">*</span></label></td>
                            <td><input type="text" id="gif_advertiser" name="gif_advertiser" value="{{ gif_advertiser or '' }}" required>
                                <div class="help-text">廣告主名稱，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="gif_main_title">主標題 <span class="required">*</span></label></td>
                            <td><input type="text" id="gif_main_title" name="gif_main_title" value="{{ gif_main_title or '' }}" required>
                                <div class="help-text">廣告主標題，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="gif_subtitle">副標題</label></td>
                            <td><input type="text" id="gif_subtitle" name="gif_subtitle" value="{{ gif_subtitle or '' }}">
                                <div class="help-text">廣告副標題，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="gif_landing_page">到達頁面網址 <span class="required">*</span></label></td>
                            <td><input type="url" id="gif_landing_page" name="gif_landing_page" placeholder="https://example.com" value="{{ gif_landing_page or '' }}" required>
                                <div class="help-text">用戶點擊廣告後跳轉的網址，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="gif_call_to_action">行動呼籲按鈕文字</label></td>
                            <td><input type="text" id="gif_call_to_action" name="gif_call_to_action" value="{{ gif_call_to_action or '立即購買' }}">
                                <div class="help-text">CTA按鈕文字，預設為「立即購買」</div>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="field-group">
                    <h3>廣告素材 <span class="required">*</span></h3>
                    <p>所有圖片均為必填。請提供本地完整檔案路徑，或使用上傳功能。</p>
                    
                    <div class="form-row">
                        <label for="gif_image_path_m">圖片 1200x628 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="gif_image_path_m" name="gif_image_path_m" placeholder="/path/to/your/image_1200x628.jpg" value="{{ gif_image_path_m or '' }}" required>
                            <div class="help-text">大型橫幅圖片，尺寸1200x628像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="gif_image_path_m" accept="image/*">
                                </label>
                                <img id="preview_gif_m" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="gif_image_path_s">圖片 300x300 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="gif_image_path_s" name="gif_image_path_s" placeholder="/path/to/your/image_300x300.jpg" value="{{ gif_image_path_s or '' }}" required>
                            <div class="help-text">方形圖片，尺寸300x300像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="gif_image_path_s" accept="image/*">
                                </label>
                                <img id="preview_gif_s" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="gif_background_image">遊戲套件預設背景 <span class="required">*</span></label>
                        <input type="text" id="gif_background_image" name="gif_background_image" placeholder="請輸入背景圖片網址" value="{{ gif_background_image or '' }}" required>
                        <div class="help-text">遊戲套件預設背景圖片網址</div>
                    </div>
                </div>

                <div class="field-group">
                    <h3>遊戲套件設定</h3>
                    <div class="form-row">
                        <label for="gif_background_url">背景圖片網址 <span class="required">*</span></label>
                        <input type="url" id="gif_background_url" name="gif_background_url" placeholder="https://example.com/background.webp" value="{{ gif_background_url or '' }}" required>
                        <div class="help-text">背景圖片的網址，必填</div>
                    </div>
                    <div class="form-row">
                        <label for="gif_target_url">目標網址 <span class="required">*</span></label>
                        <input type="url" id="gif_target_url" name="gif_target_url" placeholder="https://example.com" value="{{ gif_target_url or '' }}" required>
                        <div class="help-text">點擊後跳轉的目標網址，必填</div>
                    </div>
                    <input type="hidden" id="gif_payload_game_widget" name="gif_payload_game_widget">
                </div>
            </div>

            <div id="slide-ad" class="tab-content {% if active_tab == 'slide-ad' %}active{% endif %}">
                <div class="field-group">
                    <h3>廣告資訊</h3>
                    <table>
                        <tr>
                            <th width="30%">欄位名稱</th>
                            <th>內容</th>
                        </tr>
                        <tr>
                            <td><label for="slide_adset_id">Adset ID <span class="required">*</span></label></td>
                            <td><input type="text" id="slide_adset_id" name="slide_adset_id" value="{{ slide_adset_id or '' }}" required>
                                <div class="help-text">廣告組ID，必填，例如：00947c1b-f7cd-47c6-a23a-0639e9702cc7</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="slide_display_name">廣告單元顯示名稱</label></td>
                            <td><input type="text" id="slide_display_name" name="slide_display_name" value="{{ slide_display_name or '' }}">
                                <div class="help-text">僅顯示於後台，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="slide_advertiser">廣告商 <span class="required">*</span></label></td>
                            <td><input type="text" id="slide_advertiser" name="slide_advertiser" value="{{ slide_advertiser or '' }}" required>
                                <div class="help-text">廣告主名稱，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="slide_main_title">主標題 <span class="required">*</span></label></td>
                            <td><input type="text" id="slide_main_title" name="slide_main_title" value="{{ slide_main_title or '' }}" required>
                                <div class="help-text">廣告主標題，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="slide_subtitle">副標題</label></td>
                            <td><input type="text" id="slide_subtitle" name="slide_subtitle" value="{{ slide_subtitle or '' }}">
                                <div class="help-text">廣告副標題，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="slide_landing_page">到達頁面網址 <span class="required">*</span></label></td>
                            <td><input type="url" id="slide_landing_page" name="slide_landing_page" placeholder="https://example.com" value="{{ slide_landing_page or '' }}" required>
                                <div class="help-text">用戶點擊廣告後跳轉的網址，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="slide_call_to_action">行動呼籲按鈕文字</label></td>
                            <td><input type="text" id="slide_call_to_action" name="slide_call_to_action" value="{{ slide_call_to_action or '立即了解' }}">
                                <div class="help-text">CTA按鈕文字，預設為「立即了解」</div>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="field-group">
                    <h3>廣告素材 <span class="required">*</span></h3>
                    <p>所有圖片均為必填。請提供本地完整檔案路徑，或使用上傳功能。</p>
                    
                    <div class="form-row">
                        <label for="slide_image_path_m">圖片 1200x628 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="slide_image_path_m" name="slide_image_path_m" placeholder="/path/to/your/image_1200x628.jpg" value="{{ slide_image_path_m or '' }}" required>
                            <div class="help-text">大型橫幅圖片，尺寸1200x628像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="slide_image_path_m" accept="image/*">
                                </label>
                                <img id="preview_slide_m" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="slide_image_path_s">圖片 300x300 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="slide_image_path_s" name="slide_image_path_s" placeholder="/path/to/your/image_300x300.jpg" value="{{ slide_image_path_s or '' }}" required>
                            <div class="help-text">方形圖片，尺寸300x300像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="slide_image_path_s" accept="image/*">
                                </label>
                                <img id="preview_slide_s" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="slide_background_image">遊戲套件預設背景 <span class="required">*</span></label>
                        <input type="text" id="slide_background_image" name="slide_background_image" placeholder="請輸入背景圖片網址" value="{{ slide_background_image or '' }}" required>
                        <div class="help-text">遊戲套件預設背景圖片網址</div>
                    </div>
                </div>

                <div class="field-group">
                    <h3>滑動廣告設定 <span class="required">*</span></h3>
                    <div id="slide-items-container">
                        <!-- 默認顯示一個滑動項目 -->
                        <div class="slide-item" data-index="0">
                            <h4>滑動項目 #1</h4>
                            <div class="form-row">
                                <label for="slide_image_url_0">圖片網址 <span class="required">*</span></label>
                                <input type="url" id="slide_image_url_0" name="slide_image_url_0" class="slide-image-url" 
                                       placeholder="https://example.com/image1.jpg" value="" required>
                                <div class="help-text">滑動廣告圖片的URL，必填</div>
                            </div>
                            <div class="form-row">
                                <label for="slide_target_url_0">目標網址 <span class="required">*</span></label>
                                <input type="url" id="slide_target_url_0" name="slide_target_url_0" class="slide-target-url"
                                       placeholder="https://example.com/page1" value="" required>
                                <div class="help-text">點擊圖片後跳轉的目標網址，必填</div>
                            </div>
                        </div>
                    </div>
                    <div class="slide-controls">
                        <button type="button" id="add-slide-item" class="button nav-button">新增滑動項目</button>
                        <button type="button" id="remove-slide-item" class="button" style="background-color: #d9534f;">移除最後一個項目</button>
                    </div>
                    <input type="hidden" id="slide_payload_game_widget" name="slide_payload_game_widget">
                </div>
            </div>

            <div id="vertical-slide-ad" class="tab-content {% if active_tab == 'vertical-slide-ad' %}active{% endif %}">
                <div class="field-group">
                    <h3>廣告資訊</h3>
                    <table>
                        <tr>
                            <th width="30%">欄位名稱</th>
                            <th>內容</th>
                        </tr>
                        <tr>
                            <td><label for="vertical_slide_adset_id">Adset ID <span class="required">*</span></label></td>
                            <td><input type="text" id="vertical_slide_adset_id" name="vertical_slide_adset_id" value="{{ vertical_slide_adset_id or '' }}" required>
                                <div class="help-text">廣告組ID，必填，例如：00947c1b-f7cd-47c6-a23a-0639e9702cc7</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_slide_display_name">廣告單元顯示名稱</label></td>
                            <td><input type="text" id="vertical_slide_display_name" name="vertical_slide_display_name" value="{{ vertical_slide_display_name or '' }}">
                                <div class="help-text">僅顯示於後台，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_slide_advertiser">廣告商 <span class="required">*</span></label></td>
                            <td><input type="text" id="vertical_slide_advertiser" name="vertical_slide_advertiser" value="{{ vertical_slide_advertiser or '' }}" required>
                                <div class="help-text">廣告主名稱，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_slide_main_title">主標題 <span class="required">*</span></label></td>
                            <td><input type="text" id="vertical_slide_main_title" name="vertical_slide_main_title" value="{{ vertical_slide_main_title or '' }}" required>
                                <div class="help-text">廣告主標題，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_slide_subtitle">副標題</label></td>
                            <td><input type="text" id="vertical_slide_subtitle" name="vertical_slide_subtitle" value="{{ vertical_slide_subtitle or '' }}">
                                <div class="help-text">廣告副標題，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_slide_landing_page">到達頁面網址 <span class="required">*</span></label></td>
                            <td><input type="url" id="vertical_slide_landing_page" name="vertical_slide_landing_page" placeholder="https://example.com" value="{{ vertical_slide_landing_page or '' }}" required>
                                <div class="help-text">用戶點擊廣告後跳轉的網址，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_slide_call_to_action">行動呼籲按鈕文字</label></td>
                            <td><input type="text" id="vertical_slide_call_to_action" name="vertical_slide_call_to_action" value="{{ vertical_slide_call_to_action or '立即了解' }}">
                                <div class="help-text">CTA按鈕文字，預設為「立即了解」</div>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="field-group">
                    <h3>廣告素材 <span class="required">*</span></h3>
                    <p>所有圖片均為必填。請提供本地完整檔案路徑，或使用上傳功能。</p>
                    
                    <div class="form-row">
                        <label for="vertical_slide_image_path_m">圖片 1200x628 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="vertical_slide_image_path_m" name="vertical_slide_image_path_m" placeholder="/path/to/your/image_1200x628.jpg" value="{{ vertical_slide_image_path_m or '' }}" required>
                            <div class="help-text">大型橫幅圖片，尺寸1200x628像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="vertical_slide_image_path_m" accept="image/*">
                                </label>
                                <img id="preview_vertical_slide_m" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="vertical_slide_image_path_s">圖片 300x300 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="vertical_slide_image_path_s" name="vertical_slide_image_path_s" placeholder="/path/to/your/image_300x300.jpg" value="{{ vertical_slide_image_path_s or '' }}" required>
                            <div class="help-text">方形圖片，尺寸300x300像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="vertical_slide_image_path_s" accept="image/*">
                                </label>
                                <img id="preview_vertical_slide_s" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="vertical_slide_background_image">遊戲套件預設背景 <span class="required">*</span></label>
                        <input type="text" id="vertical_slide_background_image" name="vertical_slide_background_image" placeholder="請輸入背景圖片網址" value="{{ vertical_slide_background_image or '' }}" required>
                        <div class="help-text">遊戲套件預設背景圖片網址</div>
                    </div>
                </div>

                <div class="field-group">
                    <h3>滑動廣告設定 <span class="required">*</span></h3>
                    <div id="vertical-slide-items-container">
                        <!-- 默認顯示一個滑動項目 -->
                        <div class="vertical-slide-item" data-index="0">
                            <h4>滑動項目 #1</h4>
                            <div class="form-row">
                                <label for="vertical_slide_image_url_0">圖片網址 <span class="required">*</span></label>
                                <input type="url" id="vertical_slide_image_url_0" name="vertical_slide_image_url_0" class="vertical-slide-image-url" 
                                       placeholder="https://example.com/image1.jpg" value="" required>
                                <div class="help-text">滑動廣告圖片的URL，必填</div>
                            </div>
                            <div class="form-row">
                                <label for="vertical_slide_target_url_0">目標網址 <span class="required">*</span></label>
                                <input type="url" id="vertical_slide_target_url_0" name="vertical_slide_target_url_0" class="vertical-slide-target-url"
                                       placeholder="https://example.com/page1" value="" required>
                                <div class="help-text">點擊圖片後跳轉的目標網址，必填</div>
                            </div>
                        </div>
                    </div>
                    <div class="slide-controls">
                        <button type="button" id="add-vertical-slide-item" class="button nav-button">新增滑動項目</button>
                        <button type="button" id="remove-vertical-slide-item" class="button" style="background-color: #d9534f;">移除最後一個項目</button>
                    </div>
                    <input type="hidden" id="vertical_slide_payload_game_widget" name="vertical_slide_payload_game_widget">
                </div>
                </div>

            <div id="vertical-cube-slide-ad" class="tab-content {% if active_tab == 'vertical-cube-slide-ad' %}active{% endif %}">
                <div class="field-group">
                    <h3>廣告資訊</h3>
                    <table>
                        <tr>
                            <th width="30%">欄位名稱</th>
                            <th>內容</th>
                        </tr>
                        <tr>
                            <td><label for="vertical_cube_slide_adset_id">Adset ID <span class="required">*</span></label></td>
                            <td><input type="text" id="vertical_cube_slide_adset_id" name="vertical_cube_slide_adset_id" value="{{ vertical_cube_slide_adset_id or '' }}" required>
                                <div class="help-text">廣告組ID，必填，例如：00947c1b-f7cd-47c6-a23a-0639e9702cc7</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_cube_slide_display_name">廣告單元顯示名稱</label></td>
                            <td><input type="text" id="vertical_cube_slide_display_name" name="vertical_cube_slide_display_name" value="{{ vertical_cube_slide_display_name or '' }}">
                                <div class="help-text">僅顯示於後台，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_cube_slide_advertiser">廣告商 <span class="required">*</span></label></td>
                            <td><input type="text" id="vertical_cube_slide_advertiser" name="vertical_cube_slide_advertiser" value="{{ vertical_cube_slide_advertiser or '' }}" required>
                                <div class="help-text">廣告主名稱，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_cube_slide_main_title">主標題 <span class="required">*</span></label></td>
                            <td><input type="text" id="vertical_cube_slide_main_title" name="vertical_cube_slide_main_title" value="{{ vertical_cube_slide_main_title or '' }}" required>
                                <div class="help-text">廣告主標題，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_cube_slide_subtitle">副標題</label></td>
                            <td><input type="text" id="vertical_cube_slide_subtitle" name="vertical_cube_slide_subtitle" value="{{ vertical_cube_slide_subtitle or '' }}">
                                <div class="help-text">廣告副標題，可選</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_cube_slide_landing_page">到達頁面網址 <span class="required">*</span></label></td>
                            <td><input type="url" id="vertical_cube_slide_landing_page" name="vertical_cube_slide_landing_page" placeholder="https://example.com" value="{{ vertical_cube_slide_landing_page or '' }}" required>
                                <div class="help-text">用戶點擊廣告後跳轉的網址，必填</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="vertical_cube_slide_call_to_action">行動呼籲按鈕文字</label></td>
                            <td><input type="text" id="vertical_cube_slide_call_to_action" name="vertical_cube_slide_call_to_action" value="{{ vertical_cube_slide_call_to_action or '立即了解' }}">
                                <div class="help-text">CTA按鈕文字，預設為「立即了解」</div>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="field-group">
                    <h3>廣告素材 <span class="required">*</span></h3>
                    <p>所有圖片均為必填。請提供本地完整檔案路徑，或使用上傳功能。</p>
                    
                    <div class="form-row">
                        <label for="vertical_cube_slide_image_path_m">圖片 1200x628 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="vertical_cube_slide_image_path_m" name="vertical_cube_slide_image_path_m" placeholder="/path/to/your/image_1200x628.jpg" value="{{ vertical_cube_slide_image_path_m or '' }}" required>
                            <div class="help-text">大型橫幅圖片，尺寸1200x628像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="vertical_cube_slide_image_path_m" accept="image/*">
                                </label>
                                <img id="preview_vertical_cube_slide_m" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="vertical_cube_slide_image_path_s">圖片 300x300 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="vertical_cube_slide_image_path_s" name="vertical_cube_slide_image_path_s" placeholder="/path/to/your/image_300x300.jpg" value="{{ vertical_cube_slide_image_path_s or '' }}" required>
                            <div class="help-text">方形圖片，尺寸300x300像素</div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    上傳圖片
                                    <input type="file" class="file-input" data-target="vertical_cube_slide_image_path_s" accept="image/*">
                                </label>
                                <img id="preview_vertical_cube_slide_s" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="vertical_cube_slide_background_image">遊戲套件預設背景 <span class="required">*</span></label>
                        <input type="text" id="vertical_cube_slide_background_image" name="vertical_cube_slide_background_image" placeholder="請輸入背景圖片網址" value="{{ vertical_cube_slide_background_image or '' }}" required>
                        <div class="help-text">遊戲套件預設背景圖片網址</div>
                    </div>
                </div>

                <div class="field-group">
                    <h3>滑動廣告設定 <span class="required">*</span></h3>
                    <div id="vertical-cube-slide-items-container">
                        <!-- 滑動項目將由 JavaScript 動態生成 -->
                    </div>
                    <div class="slide-controls">
                        <button type="button" id="add-vertical-cube-slide-item" class="button nav-button">新增滑動項目</button>
                        <button type="button" id="remove-vertical-cube-slide-item" class="button" style="background-color: #d9534f;">移除最後一個項目</button>
                    </div>
                    <input type="hidden" id="vertical_cube_slide_payload_game_widget" name="vertical_cube_slide_payload_game_widget" value="{{ vertical_cube_slide_payload_game_widget or '' }}">
                </div>

                <!-- 使用 data 屬性儲存已保存的垂直 cube 滑動項目數據 -->
                {% if vertical_cube_slide_items %}
                <div id="vertical-cube-slide-items-data" style="display: none;" 
                     data-items='{{ vertical_cube_slide_items|tojson|safe }}'></div>
                {% endif %}
            </div>
            
            <input type="submit" value="建立廣告">
        </form>
    </div>

    <script>
        // Tab 切換功能
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有 tab 的 active 類
                    tabs.forEach(t => t.classList.remove('active'));
                    // 移除所有內容的 active 類
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 添加當前 tab 的 active 類
                    this.classList.add('active');
                    
                    // 獲取對應的內容並添加 active 類
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // 更新隱藏的 input 值
                    document.getElementById('active_tab_input').value = tabId;
                    
                    // 切換必填欄位
                    toggleRequiredFields(tabId);
                });
            });
        });

        // 全局變數
        let verticalSlideItemCount = 0;
        
        // 水平滑動廣告相關函數
        const slideAd = {
            itemCount: 0,
            
            initialize: function() {
                const container = document.getElementById('slide-items-container');
                if (!container) return;
                
                const existingImageUrls = document.querySelectorAll('.slide-image-url');
                
                if (existingImageUrls.length === 0) {
                    this.addItem();
                } else {
                    this.itemCount = existingImageUrls.length;
                }
                
                this.updatePayload();
            },
            
            addItem: function() {
                this.itemCount++;
                const container = document.getElementById('slide-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'slide-item';
                newItem.setAttribute('data-index', this.itemCount - 1);
                
                const index = this.itemCount - 1;
                newItem.innerHTML = '<h4>滑動項目 #' + this.itemCount + '</h4>' +
                    '<div class="form-row">' +
                    '<label for="slide_image_url_' + index + '">圖片網址 <span class="required">*</span></label>' +
                    '<input type="url" id="slide_image_url_' + index + '" name="slide_image_url_' + index + '" class="slide-image-url" ' +
                    'placeholder="https://example.com/image' + this.itemCount + '.jpg" value="" required>' +
                    '<div class="help-text">滑動廣告圖片的URL，必填</div>' +
                    '</div>' +
                    '<div class="form-row">' +
                    '<label for="slide_target_url_' + index + '">目標網址 <span class="required">*</span></label>' +
                    '<input type="url" id="slide_target_url_' + index + '" name="slide_target_url_' + index + '" class="slide-target-url"' +
                    'placeholder="https://example.com/page' + this.itemCount + '" value="" required>' +
                    '<div class="help-text">點擊圖片後跳轉的目標網址，必填</div>' +
                    '</div>';
                
                container.appendChild(newItem);
                this.updatePayload();
            },
            
            removeItem: function() {
                if (this.itemCount > 1) {
                    const container = document.getElementById('slide-items-container');
                    container.removeChild(container.lastChild);
                    this.itemCount--;
                    this.updatePayload();
                }
            },
            
            updatePayload: function() {
                const imageUrlsInputs = document.querySelectorAll('.slide-image-url');
                const targetUrlsInputs = document.querySelectorAll('.slide-target-url');
                
                const slides = [];
                const invokes = [];
                
                for (let i = 0; i < imageUrlsInputs.length; i++) {
                    const imageUrl = imageUrlsInputs[i].value;
                    const targetUrl = targetUrlsInputs[i].value;

                    if (imageUrl && imageUrl.trim() !== '') {
                        slides.push(imageUrl);
                        // Only add to invokes if the corresponding targetUrl is also valid
                        if (targetUrl && targetUrl.trim() !== '') {
                            invokes.push({
                                action: "OPEN_EXTERNAL_BROWSER",
                                payload: {
                                    url: targetUrl
                                }
                            });
                        } else {
                            // If a slide exists but its target URL doesn't, its corresponding invoke will be missing.
                            // If invokes array *must* be the same length as slides, this needs adjustment.
                        }
                    }
                }
                
                const payload = {
                    type: "SLIDE",
                    data: {
                        slides: slides // Array of image URLs
                    },
                    invokes: invokes // Array of invoke objects, corresponding to slides with target URLs
                };
                
                const payloadInput = document.getElementById('slide_payload_game_widget');
                if (payloadInput) {
                    payloadInput.value = JSON.stringify(payload, null, 2);
                }
            }
        };
        
        // 垂直滑動廣告相關函數
        const verticalSlideAd = {
            itemCount: 0,
            
            initialize: function() {
                const container = document.getElementById('vertical-slide-items-container');
                if (!container) return;
                
                container.innerHTML = ''; // 清空容器，以便重新填充
                this.itemCount = 0;

                const dataElement = document.getElementById('vertical-slide-items-data');
                let restoredItems = [];
                if (dataElement && dataElement.dataset.items) {
                    try {
                        restoredItems = JSON.parse(dataElement.dataset.items);
                    } catch (e) {
                        console.error('無法解析 vertical_slide_items JSON:', e);
                        restoredItems = [];
                    }
                }

                if (restoredItems && restoredItems.length > 0) {
                    restoredItems.forEach(item => {
                        this.addItem(item.image_url, item.target_url);
                    });
                } else {
                    this.addItem(); 
                }
                // No need to call updatePayload here, as addItem calls it.
            },
            
            addItem: function(imageUrl = '', targetUrl = '') {
                this.itemCount++;
                const container = document.getElementById('vertical-slide-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'vertical-slide-item';
                const itemIndex = this.itemCount - 1;
                newItem.setAttribute('data-index', itemIndex);
                
                newItem.innerHTML = `
                    <h4>滑動項目 #${this.itemCount}</h4>
                    <div class="form-row">
                        <label for="vertical_slide_image_url_${itemIndex}">圖片網址 <span class="required">*</span></label>
                        <input type="url" id="vertical_slide_image_url_${itemIndex}" 
                               name="vertical_slide_image_url_${itemIndex}" 
                               class="vertical-slide-image-url" 
                               placeholder="https://example.com/image${this.itemCount}.jpg" 
                               value="${imageUrl}" required>
                        <div class="help-text">滑動廣告圖片的URL，必填</div>
                    </div>
                    <div class="form-row">
                        <label for="vertical_slide_target_url_${itemIndex}">目標網址 <span class="required">*</span></label>
                        <input type="url" id="vertical_slide_target_url_${itemIndex}" 
                               name="vertical_slide_target_url_${itemIndex}" 
                               class="vertical-slide-target-url"
                               placeholder="https://example.com/page${this.itemCount}" 
                               value="${targetUrl}" required>
                        <div class="help-text">點擊圖片後跳轉的目標網址，必填</div>
                    </div>
                `;
                
                container.appendChild(newItem);

                // 為新添加的輸入欄位綁定 change 事件以更新 payload
                newItem.querySelectorAll('.vertical-slide-image-url, .vertical-slide-target-url').forEach(input => {
                    input.addEventListener('change', () => this.updatePayload()); // 使用箭頭函數確保 this 指向 verticalSlideAd
                });
                this.updatePayload(); // 每次添加/初始化項目後立即更新 payload
            },
            
            removeItem: function() {
                    const container = document.getElementById('vertical-slide-items-container');
                if (this.itemCount > 0) { 
                    const lastItem = container.lastChild;
                    if (lastItem) {
                        container.removeChild(lastItem);
                    this.itemCount--;
                    }
                }
                if (this.itemCount === 0 && container.children.length === 0) { // 確保在容器真正為空時才添加新項目
                    this.addItem();
                } else {
                    this.updatePayload(); // 如果沒有添加新項目，則僅更新 payload
                }
            },
            
            updatePayload: function() {
                const imageUrlsInputs = document.querySelectorAll('.vertical-slide-image-url');
                const targetUrlsInputs = document.querySelectorAll('.vertical-slide-target-url');
                
                const slides = [];
                const invokes = [];
                
                for (let i = 0; i < imageUrlsInputs.length; i++) {
                    const imageUrl = imageUrlsInputs[i].value;
                    const targetUrl = targetUrlsInputs[i].value;

                    if (imageUrl && imageUrl.trim() !== '') {
                        slides.push(imageUrl);
                        // Only add to invokes if the corresponding targetUrl is also valid
                        if (targetUrl && targetUrl.trim() !== '') {
                            invokes.push({
                                action: "OPEN_EXTERNAL_BROWSER",
                                payload: {
                                    url: targetUrl
                                }
                            });
                        } else {
                            // If a slide exists but its target URL doesn't, we might need an empty invoke or a default one.
                            // Based on the template, invokes array should match slides array in terms of interaction points.
                            // For now, if a slide has no target URL, its corresponding invoke will be missing.
                            // If the invokes array *must* be the same length as slides, this needs adjustment.
                        }
                    }
                }
                
                const payload = {
                    type: "SLIDE", // Changed from previous VERTICAL_SLIDE
                    data: {
                        options: {
                            direction: "vertical",
                            loop: "true", // String "true"
                            loopedSlides: slides.length > 0 ? slides.length : 1, // Dynamic, min 1
                            autoplay: {
                                delay: 2000
                            }
                        },
                        slides: slides // Array of image URLs
                    },
                    invokes: invokes // Array of invoke objects, corresponding to slides with target URLs
                };
                
                const payloadInput = document.getElementById('vertical_slide_payload_game_widget');
                if (payloadInput) {
                    payloadInput.value = JSON.stringify(payload, null, 2);
                }
                    }
                };
                
        // 垂直 Cube 滑動廣告相關函數
        const verticalCubeSlideAd = {
            itemCount: 0,
            
            initialize: function() {
                const container = document.getElementById('vertical-cube-slide-items-container');
                if (!container) return;
                
                container.innerHTML = ''; // 清空容器，以便重新填充
                this.itemCount = 0;
                
                const dataElement = document.getElementById('vertical-cube-slide-items-data');
                let restoredItems = [];
                if (dataElement && dataElement.dataset.items) {
                    try {
                        restoredItems = JSON.parse(dataElement.dataset.items);
                    } catch (e) {
                        console.error('無法解析 vertical_cube_slide_items JSON:', e);
                        restoredItems = [];
                    }
                }
                
                if (restoredItems && restoredItems.length > 0) {
                    restoredItems.forEach(item => {
                        this.addItem(item.image_url, item.target_url);
                    });
                } else {
                    // 如果沒有已保存的項目，或者解析失敗，則添加一個空項目
                    this.addItem(); 
                }
                this.updatePayload(); // 確保在初始化後更新payload
            },
            
            addItem: function(imageUrl = '', targetUrl = '') {
                this.itemCount++;
                const container = document.getElementById('vertical-cube-slide-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'vertical-cube-slide-item';
                const itemIndex = this.itemCount - 1; // 項目索引從0開始
                newItem.setAttribute('data-index', itemIndex);
                
                newItem.innerHTML = `
                    <h4>滑動項目 #${this.itemCount}</h4>
                    <div class="form-row">
                        <label for="vertical_cube_slide_image_url_${itemIndex}">圖片網址 <span class="required">*</span></label>
                        <input type="url" id="vertical_cube_slide_image_url_${itemIndex}" 
                               name="vertical_cube_slide_image_url_${itemIndex}" 
                               class="vertical-cube-slide-image-url" 
                               placeholder="https://example.com/image${this.itemCount}.jpg" 
                               value="${imageUrl}" required>
                        <div class="help-text">滑動廣告圖片的URL，必填</div>
                    </div>
                    <div class="form-row">
                        <label for="vertical_cube_slide_target_url_${itemIndex}">目標網址 <span class="required">*</span></label>
                        <input type="url" id="vertical_cube_slide_target_url_${itemIndex}" 
                               name="vertical_cube_slide_target_url_${itemIndex}" 
                               class="vertical-cube-slide-target-url"
                               placeholder="https://example.com/page${this.itemCount}" 
                               value="${targetUrl}" required>
                        <div class="help-text">點擊圖片後跳轉的目標網址，必填</div>
                    </div>
                `;
                
                container.appendChild(newItem);
                // 為新添加的輸入欄位綁定 change 事件以更新 payload
                newItem.querySelectorAll('.vertical-cube-slide-image-url, .vertical-cube-slide-target-url').forEach(input => {
                    input.addEventListener('change', () => this.updatePayload());
                });
                this.updatePayload(); // 每次添加後都更新 payload
            },
            
            removeItem: function() {
                const container = document.getElementById('vertical-cube-slide-items-container');
                if (this.itemCount > 0) { // 允許移除最後一個項目，但至少保留0個的狀態
                    const lastItem = container.lastChild;
                    if (lastItem) {
                        container.removeChild(lastItem);
                        this.itemCount--;
                    }
                }
                 if (this.itemCount === 0) { // 如果移除了所有項目，添加一個新的空項目
                    this.addItem();
                }
                this.updatePayload(); // 每次移除後都更新 payload
            },
            
            updatePayload: function() {
                const imageUrls = Array.from(document.querySelectorAll('.vertical-cube-slide-image-url')).map(input => input.value);
                const targetUrls = Array.from(document.querySelectorAll('.vertical-cube-slide-target-url')).map(input => input.value);
                
                const slides = imageUrls.filter(url => url.trim() !== ''); // 只包括非空圖片 URL
                const invokes = [];
                
                for (let i = 0; i < slides.length; i++) {
                    // 只有當圖片 URL 和對應的目標 URL 都存在時，才添加到 invokes
                    if (targetUrls[i] && targetUrls[i].trim() !== '') {
                        invokes.push({
                            action: "OPEN_EXTERNAL_BROWSER",
                            payload: {
                                url: targetUrls[i]
                            }
                        });
                    }
                }
                
                const payload = {
                    type: "SLIDE",
                    data: {
                        options: {
                            effect: "cube",
                            direction: "vertical",
                            loop: "true", // 注意：模板中是字符串 "true"
                            loopedSlides: slides.length > 0 ? slides.length : 1, // 根據 slides 陣列的長度動態設置，至少為1
                            autoplay: {
                                delay: 2000
                            }
                        },
                        slides: slides // 使用過濾後的圖片 URL 陣列
                    },
                    invokes: invokes
                };
                
                const payloadInput = document.getElementById('vertical_cube_slide_payload_game_widget');
                if (payloadInput) {
                    payloadInput.value = JSON.stringify(payload, null, 2);
                }
            }
        };

        // 切換必填欄位的函數
        function toggleRequiredFields(activeTabId) {
            console.log('切換必填欄位，當前標籤:', activeTabId);
            
            // 定義所有可能需要 'required' 屬性的基本欄位ID (靜態欄位)
            const allPossibleBaseRequiredFieldIds = [
                'adset_id', 'advertiser', 'main_title', 'landing_page', 'image_path_m', 'image_path_o', 'image_path_p', 'image_path_s',
                'gif_adset_id', 'gif_advertiser', 'gif_main_title', 'gif_landing_page', 'gif_image_path_m', 'gif_image_path_s', 'gif_background_image', 'gif_background_url', 'gif_target_url',
                'slide_adset_id', 'slide_advertiser', 'slide_main_title', 'slide_landing_page', 'slide_image_path_m', 'slide_image_path_s', 'slide_background_image',
                'vertical_slide_adset_id', 'vertical_slide_advertiser', 'vertical_slide_main_title', 'vertical_slide_landing_page', 'vertical_slide_image_path_m', 'vertical_slide_image_path_s', 'vertical_slide_background_image',
                'vertical_cube_slide_adset_id', 'vertical_cube_slide_advertiser', 'vertical_cube_slide_main_title', 'vertical_cube_slide_landing_page', 'vertical_cube_slide_image_path_m', 'vertical_cube_slide_image_path_s', 'vertical_cube_slide_background_image'
            ];

            // 1. 從所有這些基本欄位中移除 'required' 屬性
            allPossibleBaseRequiredFieldIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.removeAttribute('required');
                }
            });
            
            // 2. 從所有類型的動態滑動項目輸入中移除 'required' 屬性
            // 這是一個通用清除步驟，確保所有非活動標籤的動態字段都被清除
            document.querySelectorAll('.slide-image-url, .slide-target-url, .vertical-slide-image-url, .vertical-slide-target-url, .vertical-cube-slide-image-url, .vertical-cube-slide-target-url').forEach(input => {
                input.removeAttribute('required');
            });

            // 3. 根據活動頁籤定義需要設為 'required' 的欄位
            const fieldsToMakeRequired = []; // 用於靜態欄位ID

            if (activeTabId === 'native-ad') {
                fieldsToMakeRequired.push('adset_id', 'advertiser', 'main_title', 'landing_page', 'image_path_m', 'image_path_o', 'image_path_p', 'image_path_s');
            } else if (activeTabId === 'gif-ad') {
                fieldsToMakeRequired.push('gif_adset_id', 'gif_advertiser', 'gif_main_title', 'gif_landing_page', 'gif_image_path_m', 'gif_image_path_s', 'gif_background_image', 'gif_background_url', 'gif_target_url');
            } else if (activeTabId === 'slide-ad') {
                fieldsToMakeRequired.push('slide_adset_id', 'slide_advertiser', 'slide_main_title', 'slide_landing_page', 'slide_image_path_m', 'slide_image_path_s', 'slide_background_image');
                // 為當前活動的 slide-ad 的動態項目添加 required
                document.querySelectorAll('#slide-items-container .slide-item input.slide-image-url, #slide-items-container .slide-item input.slide-target-url').forEach(input => {
                    if (input.type !== 'hidden') input.setAttribute('required', '');
                });
            } else if (activeTabId === 'vertical-slide-ad') {
                fieldsToMakeRequired.push('vertical_slide_adset_id', 'vertical_slide_advertiser', 'vertical_slide_main_title', 'vertical_slide_landing_page', 'vertical_slide_image_path_m', 'vertical_slide_image_path_s', 'vertical_slide_background_image');
                // 為當前活動的 vertical-slide-ad 的動態項目添加 required
                document.querySelectorAll('#vertical-slide-items-container .vertical-slide-item input.vertical-slide-image-url, #vertical-slide-items-container .vertical-slide-item input.vertical-slide-target-url').forEach(input => {
                    if (input.type !== 'hidden') input.setAttribute('required', '');
                });
            } else if (activeTabId === 'vertical-cube-slide-ad') {
                fieldsToMakeRequired.push('vertical_cube_slide_adset_id', 'vertical_cube_slide_advertiser', 'vertical_cube_slide_main_title', 'vertical_cube_slide_landing_page', 'vertical_cube_slide_image_path_m', 'vertical_cube_slide_image_path_s', 'vertical_cube_slide_background_image');
                // 為當前活動的 vertical-cube-slide-ad 的動態項目添加 required
                document.querySelectorAll('#vertical-cube-slide-items-container .vertical-cube-slide-item input.vertical-cube-slide-image-url, #vertical-cube-slide-items-container .vertical-cube-slide-item input.vertical-cube-slide-target-url').forEach(input => {
                    if (input.type !== 'hidden') input.setAttribute('required', '');
                });
            }

            // 4. 為活動頁籤的靜態欄位應用 'required' 屬性
            fieldsToMakeRequired.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.setAttribute('required', '');
                }
            });
        }

        // 初始化水平滑動項目函數
        function initializeSlideItems() {
            // 初始化水平滑動項目
            slideAd.initialize();
            
            // 初始化垂直滑動項目
            verticalSlideAd.initialize();
            
            // 初始化垂直 Cube 滑動項目
            verticalCubeSlideAd.initialize();
            
            // 綁定水平滑動項目按鈕事件
            document.getElementById('add-slide-item').addEventListener('click', function() {
                slideAd.addItem();
            });
            
            document.getElementById('remove-slide-item').addEventListener('click', function() {
                slideAd.removeItem();
            });
            
            // 綁定垂直滑動項目按鈕事件
            document.getElementById('add-vertical-slide-item').addEventListener('click', function() {
                verticalSlideAd.addItem();
            });
            
            document.getElementById('remove-vertical-slide-item').addEventListener('click', function() {
                verticalSlideAd.removeItem();
            });
            
            // 綁定垂直 Cube 滑動項目按鈕事件
            document.getElementById('add-vertical-cube-slide-item').addEventListener('click', function() {
                verticalCubeSlideAd.addItem();
            });
            
            document.getElementById('remove-vertical-cube-slide-item').addEventListener('click', function() {
                verticalCubeSlideAd.removeItem();
            });
            
            // 為輸入框添加事件監聽，更新payload
            document.querySelectorAll('.slide-image-url, .slide-target-url').forEach(input => {
                input.addEventListener('change', function() {
                    slideAd.updatePayload();
                });
            });
            
            document.querySelectorAll('.vertical-slide-image-url, .vertical-slide-target-url').forEach(input => {
                input.addEventListener('change', function() {
                    verticalSlideAd.updatePayload();
                });
            });
            
            document.querySelectorAll('.vertical-cube-slide-image-url, .vertical-cube-slide-target-url').forEach(input => {
                input.addEventListener('change', function() {
                    verticalCubeSlideAd.updatePayload();
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 初始化當前標籤的必填欄位
            const initialActiveTab = '{{ active_tab }}';
            toggleRequiredFields(initialActiveTab);
            
            // 初始化水平滑動項目
            initializeSlideItems();
            
            // 處理圖片上傳功能
            document.querySelectorAll('.file-input').forEach(function(input) {
                input.addEventListener('change', function(e) {
                    const targetField = this.dataset.target;
                    const targetInput = document.getElementById(targetField);
                    const previewId = 'preview_' + targetField.split('_').pop();
                    let previewImg;
                    
                    // 特別處理不同標籤頁的預覽圖
                    if (targetField.startsWith('gif_')) {
                        previewImg = document.getElementById('preview_gif_' + targetField.split('_').pop());
                    } else if (targetField.startsWith('slide_')) {
                        previewImg = document.getElementById('preview_slide_' + targetField.split('_').pop());
                    } else if (targetField.startsWith('vertical_slide_')) {
                        previewImg = document.getElementById('preview_vertical_slide_' + targetField.split('_').pop());
                    } else if (targetField.startsWith('vertical_cube_slide_')) {
                        previewImg = document.getElementById('preview_vertical_cube_slide_' + targetField.split('_').pop());
                    } else {
                        previewImg = document.getElementById(previewId);
                    }
                    
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        // 顯示上傳中的提示
                        if (targetInput) targetInput.value = '上傳中...';
                        
                        // 發送上傳請求
                        fetch('/upload', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 更新輸入框的值為文件路徑
                                if (targetInput) targetInput.value = data.file_path;
                                
                                // 顯示圖片預覽
                                if (previewImg) {
                                    previewImg.src = URL.createObjectURL(file);
                                    previewImg.style.display = 'block';
                                }
                            } else {
                                alert('上傳失敗: ' + data.error);
                                if (targetInput) targetInput.value = '';
                            }
                        })
                        .catch(error => {
                            console.error('上傳錯誤:', error);
                            alert('上傳過程中發生錯誤');
                            if (targetInput) targetInput.value = '';
                        });
                    }
                });
            });
        });
    </script>
</body>
</html> 