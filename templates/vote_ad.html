{% extends "base.html" %}

{% block title %}æŠ•ç¥¨å»£å‘Šå»ºç«‹{% endblock %}

{% block page_title %}ğŸ—³ï¸ å»ºç«‹æŠ•ç¥¨å»£å‘Š{% endblock %}

{% block additional_styles %}
<style>
    .vote-options-container {
        margin-top: 20px;
        margin-bottom: 20px;
    }
    .vote-option {
        border: 1px solid #dee2e6;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 12px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .vote-option h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #495057;
        font-weight: 600;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 8px;
    }
    .vote-controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .checkbox-group {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 5px;
    }
    .color-section {
        background-color: #fff;
        border: 1px solid #e0e6ed;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .color-section h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #495057;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block content %}
<button type="button" id="clear-form-button" class="clear-form-btn">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å…§å®¹</button>

<form action="{{ url_for('main.create_vote_ad') }}" method="post" id="ad-form">
    <div class="field-group">
        <h3>ğŸ“‹ åŸºæœ¬å»£å‘Šè³‡è¨Š</h3>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="adset_id">Adset ID <span class="required">*</span></label>
                <input type="text" id="adset_id" name="adset_id" value="{{ adset_id or '' }}" required
                       placeholder="ä¾‹å¦‚ï¼š00947c1b-f7cd-47c6-a23a-0639e9702cc7">
                <div class="help-text">å»£å‘Šçµ„IDï¼Œå¿…å¡«</div>
            </div>
            
            <div class="form-row">
                <label for="display_name">å»£å‘Šå–®å…ƒé¡¯ç¤ºåç¨±</label>
                <input type="text" id="display_name" name="display_name" value="{{ display_name or '' }}"
                       placeholder="åƒ…ä¾›å¾Œå°é¡¯ç¤ºä½¿ç”¨">
                <div class="help-text">åƒ…é¡¯ç¤ºæ–¼å¾Œå°ï¼Œå¯é¸</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="advertiser">å»£å‘Šå•† <span class="required">*</span></label>
                <input type="text" id="advertiser" name="advertiser" value="{{ advertiser or '' }}" required
                       placeholder="å»£å‘Šä¸»åç¨±">
                <div class="help-text">å»£å‘Šä¸»åç¨±ï¼Œå¿…å¡«</div>
            </div>
            
            <div class="form-row">
                <label for="main_title">ä¸»æ¨™é¡Œ <span class="required">*</span></label>
                <input type="text" id="main_title" name="main_title" value="{{ main_title or '' }}" required
                       placeholder="å»£å‘Šä¸»æ¨™é¡Œ">
                <div class="help-text">å»£å‘Šä¸»æ¨™é¡Œï¼Œå¿…å¡«</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="vote_title">æŠ•ç¥¨æ¨™é¡Œ <span class="required">*</span></label>
                <input type="text" id="vote_title" name="vote_title" value="{{ vote_title or '' }}" required
                       placeholder="æŠ•ç¥¨å€å¡Šçš„æ¨™é¡Œ">
                <div class="help-text">æŠ•ç¥¨å€å¡Šçš„æ¨™é¡Œï¼Œå¿…å¡«</div>
            </div>
            
            <div class="form-row">
                <label for="subtitle">æ–‡å­—æ•˜è¿°</label>
                <input type="text" id="subtitle" name="subtitle" value="{{ subtitle or '' }}"
                       placeholder="å»£å‘Šå‰¯æ¨™é¡Œï¼ˆå¯é¸ï¼‰">
                <div class="help-text">å»£å‘Šå‰¯æ¨™é¡Œï¼Œå¯é¸</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="call_to_action">è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—</label>
                <input type="text" id="call_to_action" name="call_to_action" value="{{ call_to_action or 'ç«‹å³äº†è§£' }}"
                       placeholder="ç«‹å³äº†è§£">
                <div class="help-text">CTAæŒ‰éˆ•æ–‡å­—ï¼Œé è¨­ç‚ºã€Œç«‹å³äº†è§£ã€</div>
            </div>
            
            <div class="form-row">
                <label for="vote_id">Vote ID <span class="required">*</span></label>
                <input type="text" id="vote_id" name="vote_id" value="{{ vote_id or 'myVoteId' }}" required
                       placeholder="myVoteId">
                <div class="help-text">æŠ•ç¥¨è­˜åˆ¥ç¢¼ï¼Œå¿…å¡«</div>
            </div>
        </div>
        
        <div class="form-row">
            <label for="landing_page">åˆ°é”é é¢ç¶²å€ <span class="required">*</span></label>
            <input type="url" id="landing_page" name="landing_page" placeholder="https://example.com" 
                   value="{{ landing_page or '' }}" required>
            <div class="help-text">ç”¨æˆ¶é»æ“Šå»£å‘Šå¾Œè·³è½‰çš„ç¶²å€ï¼Œå¿…å¡«</div>
        </div>
    </div>

    <div class="field-group">
        <h3>ğŸ–¼ï¸ å»£å‘Šç´ æ</h3>
        <p style="margin-bottom: 20px; color: #666; font-style: italic;">
            æ‰€æœ‰åœ–ç‰‡å‡ç‚ºå¿…å¡«ã€‚è«‹æä¾›æœ¬åœ°å®Œæ•´æª”æ¡ˆè·¯å¾‘ï¼Œæˆ–ä½¿ç”¨ä¸Šå‚³åŠŸèƒ½ã€‚
        </p>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="image_path_m">å¤§å°ºå¯¸åœ–ç‰‡ 1200x628 <span class="required">*</span></label>
                <div class="file-upload-container">
                    <input type="text" id="image_path_m" name="image_path_m" 
                           placeholder="/path/to/your/image_1200x628.jpg" 
                           value="{{ image_path_m or '' }}" required>
                    <div class="help-text">å¤§å‹æ©«å¹…åœ–ç‰‡ï¼Œå°ºå¯¸1200x628åƒç´ </div>
                    <div class="preview-container">
                        <label class="custom-file-upload">
                            ğŸ“ ä¸Šå‚³åœ–ç‰‡
                            <input type="file" class="file-input" data-target="image_path_m" accept="image/*">
                        </label>
                        <img id="preview_m" class="upload-preview" style="display: none;" alt="é è¦½åœ–">
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <label for="image_path_s">å°å°ºå¯¸åœ–ç‰‡ 300x300 <span class="required">*</span></label>
                <div class="file-upload-container">
                    <input type="text" id="image_path_s" name="image_path_s" 
                           placeholder="/path/to/your/image_300x300.jpg" 
                           value="{{ image_path_s or '' }}" required>
                    <div class="help-text">æ–¹å½¢åœ–ç‰‡ï¼Œå°ºå¯¸300x300åƒç´ </div>
                    <div class="preview-container">
                        <label class="custom-file-upload">
                            ğŸ“ ä¸Šå‚³åœ–ç‰‡
                            <input type="file" class="file-input" data-target="image_path_s" accept="image/*">
                        </label>
                        <img id="preview_s" class="upload-preview" style="display: none;" alt="é è¦½åœ–">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-row">
            <label for="vote_image">æŠ•ç¥¨åœ–ç‰‡ç¶²å€ <span class="required">*</span></label>
            <input type="url" id="vote_image" name="vote_image" placeholder="è«‹è¼¸å…¥æŠ•ç¥¨åœ–ç‰‡ç¶²å€" 
                   value="{{ vote_image or '' }}" required>
            <div class="help-text">æŠ•ç¥¨å€å¡Šé¡¯ç¤ºçš„åœ–ç‰‡URL</div>
        </div>
    </div>

    <div class="field-group">
        <h3>âš™ï¸ æŠ•ç¥¨å»£å‘Šè¨­å®š</h3>
        
        <div class="form-grid-3">
            <div class="form-row">
                <label for="vote_width">æŠ•ç¥¨å€å¡Šå¯¬åº¦</label>
                <input type="text" id="vote_width" name="vote_width" value="{{ vote_width or '80%' }}"
                       placeholder="80%">
                <div class="help-text">æŠ•ç¥¨å€å¡Šçš„å¯¬åº¦ï¼Œä¾‹å¦‚: 80%</div>
            </div>
            
            <div class="form-row">
                <label for="vote_position">æŠ•ç¥¨ä½ç½®</label>
                <select id="vote_position" name="vote_position">
                    <option value="top" {% if vote_position == 'top' %}selected{% endif %}>é ‚éƒ¨</option>
                    <option value="middle" {% if vote_position == 'middle' %}selected{% endif %}>ä¸­é–“</option>
                    <option value="bottom" {% if vote_position == 'bottom' or vote_position is not defined %}selected{% endif %}>åº•éƒ¨</option>
                </select>
                <div class="help-text">æŠ•ç¥¨å€å¡Šåœ¨ç•«é¢ä¸­çš„ä½ç½®</div>
            </div>
            
            <div class="form-row">
                <label for="timeout">é¡¯ç¤ºè¶…æ™‚ (æ¯«ç§’)</label>
                <input type="number" id="timeout" name="timeout" value="{{ timeout or 2000 }}" 
                       placeholder="2000">
                <div class="help-text">æŠ•ç¥¨å€å¡Šé¡¯ç¤ºçš„è¶…æ™‚æ™‚é–“ï¼Œå–®ä½æ¯«ç§’</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="min_position">æœ€å°ä½ç½® (%)</label>
                <input type="number" id="min_position" name="min_position" value="{{ min_position or 50 }}" 
                       min="0" max="100" placeholder="50">
                <div class="help-text">æŠ•ç¥¨å€å¡Šé¡¯ç¤ºçš„æœ€å°ä½ç½®ç™¾åˆ†æ¯”</div>
            </div>
            
            <div class="form-row">
                <label for="max_position">æœ€å¤§ä½ç½® (%)</label>
                <input type="number" id="max_position" name="max_position" value="{{ max_position or 70 }}" 
                       min="0" max="100" placeholder="70">
                <div class="help-text">æŠ•ç¥¨å€å¡Šé¡¯ç¤ºçš„æœ€å¤§ä½ç½®ç™¾åˆ†æ¯”</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="divider_color">åˆ†éš”ç·šé¡è‰²</label>
                <div class="color-input-group">
                    <input type="color" id="divider_color" name="divider_color" value="{{ divider_color or '#ff0000' }}">
                    <input type="text" value="{{ divider_color or '#ff0000' }}" readonly>
                </div>
                <div class="help-text">æŠ•ç¥¨é¸é …çš„åˆ†éš”ç·šé¡è‰²</div>
            </div>
            
            <div class="form-row">
                <label for="bg_color">èƒŒæ™¯é¡è‰²</label>
                <div class="color-input-group">
                    <input type="color" id="bg_color" name="bg_color" value="{{ bg_color or '#ffffff' }}">
                    <input type="text" value="{{ bg_color or '#ffffff' }}" readonly>
                </div>
                <div class="help-text">æŠ•ç¥¨å€å¡Šçš„èƒŒæ™¯é¡è‰²</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="color-section">
                <h4>ğŸ† ä½¿ç”¨è€…é¸æ“‡çš„é¸é …æ¨£å¼</h4>
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="winner_bg_color">èƒŒæ™¯é¡è‰²</label>
                        <div class="color-input-group">
                            <input type="color" id="winner_bg_color" name="winner_bg_color" value="{{ winner_bg_color or '#26D07C' }}">
                            <input type="text" value="{{ winner_bg_color or '#26D07C' }}" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="winner_text_color">æ–‡å­—é¡è‰²</label>
                        <div class="color-input-group">
                            <input type="color" id="winner_text_color" name="winner_text_color" value="{{ winner_text_color or '#ffffff' }}">
                            <input type="text" value="{{ winner_text_color or '#ffffff' }}" readonly>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="color-section">
                <h4>ğŸ’” ä½¿ç”¨è€…æ²’æœ‰é¸æ“‡çš„é¸é …æ¨£å¼</h4>
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="loser_bg_color">èƒŒæ™¯é¡è‰²</label>
                        <div class="color-input-group">
                            <input type="color" id="loser_bg_color" name="loser_bg_color" value="{{ loser_bg_color or '#000000' }}">
                            <input type="text" value="{{ loser_bg_color or '#000000' }}" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="loser_text_color">æ–‡å­—é¡è‰²</label>
                        <div class="color-input-group">
                            <input type="color" id="loser_text_color" name="loser_text_color" value="{{ loser_text_color or '#ffffff' }}">
                            <input type="text" value="{{ loser_text_color or '#ffffff' }}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="field-group">
        <h3>ğŸ—³ï¸ æŠ•ç¥¨é¸é …è¨­å®š</h3>
        <div class="dynamic-items-container">
            <div id="vote-options-container" class="vote-options-container">
                <!-- æŠ•ç¥¨é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <div class="vote-controls">
                <button type="button" id="add-vote-option" class="add-item-btn">â• æ–°å¢æŠ•ç¥¨é¸é …</button>
                <button type="button" id="remove-vote-option" class="clear-form-btn">â– ç§»é™¤æœ€å¾Œä¸€å€‹é¸é …</button>
            </div>
        </div>
        
        <input type="hidden" id="payload_vote_widget" name="payload_vote_widget">
    </div>
    
    <input type="submit" value="ğŸ—³ï¸ å»ºç«‹æŠ•ç¥¨å»£å‘Š">
</form>
{% endblock %}

{% block additional_scripts %}
<script>
    // æŠ•ç¥¨å»£å‘Šç‰¹æœ‰çš„ JavaScript
    let voteOptionCount = 0;
    
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–æŠ•ç¥¨é¸é …
        initializeVoteOptions();
        
        // è¨­ç½®é¡è‰²é¸æ“‡å™¨åŒæ­¥
        setupColorSyncers();
        
        // ç‚ºæ‰€æœ‰è¡¨å–®å…ƒç´ æ·»åŠ  change äº‹ä»¶ç›£è½å™¨ï¼Œä»¥ä¾¿æ›´æ–° payload
        document.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('change', () => updatePayload());
        });
        
        // æ·»åŠ æ¸…é™¤è¡¨å–®æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
        document.getElementById('clear-form-button').addEventListener('click', function() {
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡«å¯«çš„å…§å®¹å—ï¼Ÿ')) {
                clearFormInputs();
            }
        });
        
        // æ·»åŠ /ç§»é™¤æŠ•ç¥¨é¸é …æŒ‰éˆ•
        document.getElementById('add-vote-option').addEventListener('click', function() {
            addVoteOption();
        });
        
        document.getElementById('remove-vote-option').addEventListener('click', function() {
            removeVoteOption();
        });
        
        // è¡¨å–®æäº¤å‰ç¢ºä¿æ›´æ–° payload
        document.getElementById('ad-form').addEventListener('submit', function(e) {
            updatePayload();
        });
        
        // åˆå§‹æ›´æ–°ä¸€æ¬¡ payload
        updatePayload();
    });
    
    // è¨­ç½®é¡è‰²é¸æ“‡å™¨èˆ‡æ–‡å­—æ¡†åŒæ­¥
    function setupColorSyncers() {
        const colorInputs = [
            'divider_color', 'bg_color', 'winner_bg_color', 
            'winner_text_color', 'loser_bg_color', 'loser_text_color'
        ];
        
        colorInputs.forEach(inputId => {
            const colorInput = document.getElementById(inputId);
            const textInput = colorInput.parentElement.querySelector('input[type="text"]');
            
            colorInput.addEventListener('input', function() {
                textInput.value = this.value;
                updatePayload();
            });
        });
    }
    
    // æ¸…é™¤è¡¨å–®æ‰€æœ‰è¼¸å…¥æ¬„ä½çš„å‡½æ•¸
    function clearFormInputs() {
        // æ¸…é™¤æ–‡æœ¬è¼¸å…¥ã€URLã€æ•¸å­—è¼¸å…¥
        document.querySelectorAll('input[type="text"], input[type="url"], input[type="number"]').forEach(input => {
            input.value = '';
        });
        
        // é‡ç½®é¸æ“‡æ¬„ä½åˆ°é»˜èªå€¼
        document.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
        });
        
        // é‡ç½®é¡è‰²é¸æ“‡å™¨åˆ°é»˜èªå€¼
        const colorDefaults = {
            'divider_color': '#ff0000',
            'bg_color': '#ffffff',
            'winner_bg_color': '#26D07C',
            'winner_text_color': '#ffffff',
            'loser_bg_color': '#000000',
            'loser_text_color': '#ffffff'
        };
        
        Object.keys(colorDefaults).forEach(id => {
            document.getElementById(id).value = colorDefaults[id];
            const textInput = document.getElementById(id).parentElement.querySelector('input[type="text"]');
            if (textInput) textInput.value = colorDefaults[id];
        });
        
        // æ¸…é™¤æŠ•ç¥¨é¸é …
        const container = document.getElementById('vote-options-container');
        container.innerHTML = '';
        voteOptionCount = 0;
        
        // é‡æ–°åˆå§‹åŒ–å…©å€‹é»˜èªé¸é …
        initializeVoteOptions();
        
        // æ¸…é™¤é è¦½åœ–ç‰‡
        document.querySelectorAll('.upload-preview').forEach(img => {
            img.style.display = 'none';
            img.src = '';
        });
        
        // é‡æ–°è¨­ç½®é è¨­å€¼
        document.getElementById('call_to_action').value = 'ç«‹å³äº†è§£';
        document.getElementById('vote_id').value = 'myVoteId';
        document.getElementById('vote_width').value = '80%';
        document.getElementById('timeout').value = '2000';
        document.getElementById('min_position').value = '50';
        document.getElementById('max_position').value = '70';
        
        // æ›´æ–° payload
        updatePayload();
    }
    
    function initializeVoteOptions() {
        // å¾ session æ•¸æ“šæ¢å¾©é¸é …ï¼Œæˆ–è€…æ·»åŠ é»˜èªé¸é …
        const existingOptions = JSON.parse('{{ vote_options | tojson | safe }}' || '[]');
        
        if (existingOptions && existingOptions.length > 0) {
            existingOptions.forEach(option => {
                addVoteOption(option.title, option.text_color, option.bg_color, option.target_url);
            });
        } else {
            // æ·»åŠ é»˜èªçš„å…©å€‹é¸é …
            addVoteOption("æ–‡ç« æ›´è‡ªç”±", "#207AED", "#E7F3FF", "");
            addVoteOption("æ¨å»£æ•™è‚²æœå‹™", "#207AED", "#E7F3FF", "");
        }
    }
    
    function addVoteOption(title = "", textColor = "#207AED", bgColor = "#E7F3FF", targetUrl = "") {
        const container = document.getElementById('vote-options-container');
        const index = voteOptionCount;
        
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item vote-option';
        newItem.setAttribute('data-index', index);
        
        newItem.innerHTML = `
            <button type="button" class="remove-item-btn" onclick="removeSpecificVoteOption(${index})" title="ç§»é™¤æ­¤é¸é …">Ã—</button>
            <h4>é¸é … #${index + 1}</h4>
            <div class="form-grid-2">
                <div class="form-row">
                    <label for="option_title_${index}">é¸é …æ¨™é¡Œ <span class="required">*</span></label>
                    <input type="text" id="option_title_${index}" name="option_title_${index}" class="vote-option-title" 
                           placeholder="æŠ•ç¥¨é¸é …${index + 1}" value="${title}" required>
                </div>
                
                <div class="form-row">
                    <label for="option_target_url_${index}">é»æ“Šç¶²å€</label>
                    <input type="url" id="option_target_url_${index}" name="option_target_url_${index}" class="vote-option-target-url"
                           placeholder="https://example.com/page${index + 1}" value="${targetUrl}">
                    <div class="help-text">é»æ“Šæ­¤é¸é …å¾Œè·³è½‰çš„ç›®æ¨™ç¶²å€ï¼Œå¯é¸</div>
                </div>
            </div>
            
            <div class="form-grid-2">
                <div class="form-row">
                    <label for="option_text_color_${index}">æ–‡å­—é¡è‰²</label>
                    <div class="color-input-group">
                        <input type="color" id="option_text_color_${index}" name="option_text_color_${index}" 
                               class="vote-option-text-color" value="${textColor}">
                        <input type="text" value="${textColor}" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <label for="option_bg_color_${index}">èƒŒæ™¯é¡è‰²</label>
                    <div class="color-input-group">
                        <input type="color" id="option_bg_color_${index}" name="option_bg_color_${index}" 
                               class="vote-option-bg-color" value="${bgColor}">
                        <input type="text" value="${bgColor}" readonly>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(newItem);
        voteOptionCount++;

        // ç‚ºæ–°æ·»åŠ çš„è¼¸å…¥æ¬„ä½ç¶å®šäº‹ä»¶
        newItem.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', () => updatePayload());
        });
        
        // è¨­ç½®é¡è‰²åŒæ­¥
        const colorInputs = newItem.querySelectorAll('input[type="color"]');
        colorInputs.forEach(colorInput => {
            const textInput = colorInput.parentElement.querySelector('input[type="text"]');
            colorInput.addEventListener('input', function() {
                textInput.value = this.value;
                updatePayload();
            });
        });
        
        updatePayload();
    }
    
    function removeVoteOption() {
        const container = document.getElementById('vote-options-container');
        if (container.children.length > 2) {
            container.removeChild(container.lastChild);
            voteOptionCount--;
            updatePayload();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™å…©å€‹æŠ•ç¥¨é¸é …ï¼');
        }
    }
    
    function removeSpecificVoteOption(index) {
        const container = document.getElementById('vote-options-container');
        if (container.children.length > 2) {
            const item = container.querySelector(`[data-index="${index}"]`);
            if (item) {
                container.removeChild(item);
                // é‡æ–°ç·¨è™Ÿå…¶é¤˜é …ç›®
                renumberVoteOptions();
                updatePayload();
            }
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™å…©å€‹æŠ•ç¥¨é¸é …ï¼');
        }
    }
    
    function renumberVoteOptions() {
        const container = document.getElementById('vote-options-container');
        const items = container.querySelectorAll('.vote-option');
        
        items.forEach((item, newIndex) => {
            item.setAttribute('data-index', newIndex);
            item.querySelector('h4').textContent = `é¸é … #${newIndex + 1}`;
            
            // æ›´æ–°æ‰€æœ‰ç›¸é—œçš„ ID å’Œ name
            const inputs = item.querySelectorAll('input');
            inputs.forEach(input => {
                const oldName = input.getAttribute('name');
                const oldId = input.getAttribute('id');
                
                if (oldName) {
                    const baseName = oldName.replace(/_\d+$/, '');
                    input.setAttribute('name', `${baseName}_${newIndex}`);
                }
                
                if (oldId) {
                    const baseId = oldId.replace(/_\d+$/, '');
                    input.setAttribute('id', `${baseId}_${newIndex}`);
                }
                
                // æ›´æ–°å°æ‡‰çš„ label
                const label = item.querySelector(`label[for="${oldId}"]`);
                if (label) {
                    label.setAttribute('for', input.id);
                }
            });
            
            // æ›´æ–°ç§»é™¤æŒ‰éˆ•çš„ onclick
            const removeBtn = item.querySelector('.remove-item-btn');
            if (removeBtn) {
                removeBtn.setAttribute('onclick', `removeSpecificVoteOption(${newIndex})`);
            }
        });
        
        voteOptionCount = items.length;
    }
    
    function updatePayload() {
        const titleInputs = document.querySelectorAll('.vote-option-title');
        const textColorInputs = document.querySelectorAll('.vote-option-text-color');
        const bgColorInputs = document.querySelectorAll('.vote-option-bg-color');
        const targetUrlInputs = document.querySelectorAll('.vote-option-target-url');
        
        const options = [];
        
        for (let i = 0; i < titleInputs.length; i++) {
            const title = titleInputs[i].value;
            const textColor = textColorInputs[i].value;
            const bgColor = bgColorInputs[i].value;
            const targetUrl = targetUrlInputs[i].value;
            
            const option = {
                title: title,
                textColor: textColor,
                bgColor: bgColor,
                invokes: []
            };
            
            // å¦‚æœæœ‰ç›®æ¨™URLï¼Œæ·»åŠ åˆ°invokes
            if (targetUrl && targetUrl.trim() !== '') {
                option.invokes.push({
                    action: "OPEN_EXTERNAL_BROWSER",
                    payload: {
                        url: targetUrl
                    }
                });
            }
            
            options.push(option);
        }
        
        const voteImage = document.getElementById('vote_image').value;
        const dividerColor = document.getElementById('divider_color').value;
        const voteWidth = document.getElementById('vote_width').value;
        const bgColor = document.getElementById('bg_color').value;
        const votePosition = document.getElementById('vote_position').value;
        const minPosition = parseInt(document.getElementById('min_position').value) || 50;
        const maxPosition = parseInt(document.getElementById('max_position').value) || 70;
        const timeout = parseInt(document.getElementById('timeout').value) || 2000;
        const winnerBgColor = document.getElementById('winner_bg_color').value;
        const winnerTextColor = document.getElementById('winner_text_color').value;
        const loserBgColor = document.getElementById('loser_bg_color').value;
        const loserTextColor = document.getElementById('loser_text_color').value;
        const voteId = document.getElementById('vote_id').value;
        
        const payload = {
            type: "VOTE",
            data: {
                id: voteId,
                img: voteImage,
                dividerColor: dividerColor,
                width: voteWidth,
                bgColor: bgColor,
                position: votePosition,
                minPosition: minPosition,
                maxPosition: maxPosition,
                timeout: timeout,
                winner: {
                    bgColor: winnerBgColor,
                    textColor: winnerTextColor
                },
                loser: {
                    bgColor: loserBgColor,
                    textColor: loserTextColor
                },
                displayAnimation: ["fade", "slide"],
                options: options
            }
        };
        
        document.getElementById('payload_vote_widget').value = JSON.stringify(payload);
    }

    // å¿«é€Ÿè³‡è¨Šè§£æå‡½æ•¸
    function parseInfoText(text) {
        try {
            // è§£æå»£å‘Šä¸»
            const advertiserMatch = text.match(/[-Â·]\s*å»£å‘Šä¸»[:ï¼š]\s*(.+)/);
            if (advertiserMatch) {
                document.getElementById('advertiser').value = advertiserMatch[1].trim();
            }

            // è§£ææ´»å‹•åç¨±ä½œç‚ºä¸»æ¨™é¡Œ
            const titleMatch = text.match(/[-Â·]\s*æ´»å‹•åç¨±[:ï¼š]\s*(.+)/);
            if (titleMatch) {
                document.getElementById('main_title').value = titleMatch[1].trim();
            }

            // è§£ææ¨™é¡Œä½œç‚ºæŠ•ç¥¨æ¨™é¡Œ
            const voteMatch = text.match(/[-Â·]\s*æ¨™é¡Œ[:ï¼š]\s*(.+)/);
            if (voteMatch) {
                document.getElementById('vote_title').value = voteMatch[1].trim();
            }

            // è§£æ CTA
            const ctaMatch = text.match(/[-Â·]\s*CTA[:ï¼š]\s*(.+)/);
            if (ctaMatch) {
                document.getElementById('call_to_action').value = ctaMatch[1].trim();
            }

            // è§£æå°é€£
            const landingMatch = text.match(/(?:å°é€£|åˆ°é”é é¢)[:ï¼š]\s*(https?:\/\/[^\s]+)/);
            if (landingMatch) {
                document.getElementById('landing_page').value = landingMatch[1].trim();
            }

            updatePayload();
            alert('âœ… è³‡è¨Šè§£æå®Œæˆï¼è«‹æª¢æŸ¥å¡«å…¥çš„å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚');
        } catch (error) {
            console.error('è§£æéŒ¯èª¤:', error);
            alert('âŒ è§£æéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼ã€‚');
        }
    }
</script>
{% endblock %} 