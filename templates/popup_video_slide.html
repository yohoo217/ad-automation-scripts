{% extends "base.html" %}

{% block title %}åŸç”Ÿå½ˆè·³å½±éŸ³ slide å»£å‘Šå»ºç«‹{% endblock %}

{% block page_title %}å»ºç«‹åŸç”Ÿå½ˆè·³å½±éŸ³ slide å»£å‘Š{% endblock %}

{% block additional_styles %}
<style>
    .video-controls {
        margin-top: 20px;
        margin-bottom: 20px;
    }
    .video-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .clear-form-btn {
        background-color: #f44336;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 15px;
    }
    .clear-form-btn:hover {
        background-color: #d32f2f;
    }
    .main-content-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 20px;
    }
    .form-column {
        flex: 1;
        min-width: 0;
    }
    .preview-column {
        width: 300px;
        flex-shrink: 0;
        position: sticky;
        top: 20px;
    }
    .ad-preview-container {
        width: 300px;
        height: 250px;
        border: 2px solid #333;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        background-color: #000;
        overflow: hidden;
    }
    .ad-preview-header {
        padding: 2px 8px;
        font-size: 12px;
        color: #cd9601;
        text-align: left;
    }
    .ad-preview-main {
        flex-grow: 1;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        height: 157px;
        background-color: #000;
    }
    .ad-preview-title {
        padding: 4px 8px;
        font-weight: bold;
        font-size: 14px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: white;
    }
    .ad-preview-subtitle {
        padding: 4px 8px;
        font-size: 12px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: gray;
    }
    .ad-preview-footer {
        display: flex;
        font-size: 12px;
    }
    .ad-preview-advertiser {
        flex-grow: 1;
        padding: 4px 8px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: gray;
    }
    .ad-preview-cta {
        padding: 4px 12px;
        font-weight: bold;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background-color: #0d6efd;
        color: white;
        border-radius: 5px;
        margin: 4px;
    }
    #preview-cut1-view {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        background-color: #000;
    }
    .preview-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .preview-poster {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
    }
    .video-play-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .video-play-btn:hover {
        background: rgba(0, 0, 0, 0.9);
    }
    .video-duration-display {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        z-index: 10;
    }
    .cut1-background-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .popup-content-preview {
        width: 300px;
        height: 500px;
        border: 2px solid #666;
        background-color: #000;
        margin: 0 auto;
        overflow: hidden;
        position: relative;
        /* å½±ç‰‡å€åŸŸ 300x157 + åœ–ç‰‡å€åŸŸ 300x343 = ç¸½é«˜åº¦ 500px */
    }
    .popup-video-preview {
        background-color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        border-radius: 5px;
        overflow: hidden;
    }
    .popup-image-preview {
        background-color: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        border-radius: 5px;
        overflow: hidden;
        position: relative;
    }
    .popup-slide-wrapper {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    .popup-preview-slide {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }
    .popup-preview-slide.active {
        opacity: 1;
    }
    .popup-preview-slide img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background-color: #f0f0f0;
    }
    .popup-dots-container {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 5px;
        z-index: 10;
    }
    .popup-preview-dot {
        width: 8px;
        height: 8px;
        background-color: #888;
        border-radius: 50%;
        transition: background-color 0.3s;
    }
    .popup-preview-dot.active {
        background-color: #fff;
    }
    .dynamic-item {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 15px;
        margin-top: 10px;
        background-color: #f9f9f9;
    }
    .dynamic-item .dynamic-item {
        background-color: #f0f0f0;
        border-color: #bbb;
    }
    .add-item-btn {
        background-color: #28a745;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    .add-item-btn:hover {
        background-color: #218838;
    }
    .remove-item-btn {
        background-color: #dc3545;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        float: right;
    }
    .remove-item-btn:hover {
        background-color: #c82333;
    }
    .dynamic-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .dynamic-item-header label {
        margin: 0;
    }
    .preview-section {
        background: transparent;
        border: none;
        padding: 0;
        margin: 0;
    }
    .preview-section h3 {
        background: transparent;
        border: none;
        padding: 0;
    }
    .slide-item {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fff;
        position: relative;
    }
    .remove-slide-btn {
        background-color: #dc3545;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }
    .remove-slide-btn:hover {
        background-color: #c82333;
    }
    #slide-items-container {
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content-wrapper">
    <div class="form-column">
        <form action="{{ url_for('main.clear_popup_video_slide_form') }}" method="post" style="display: inline;">
            <button type="submit" class="clear-form-btn" onclick="return confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡«å¯«çš„å…§å®¹å—ï¼Ÿ')">æ¸…é™¤æ‰€æœ‰å…§å®¹</button>
        </form>

        <form action="{{ url_for('main.create_popup_video_slide_ad') }}" method="post" id="ad-form">
            <div class="field-group">
                <h3>ğŸ“‹ åŸºæœ¬å»£å‘Šè³‡è¨Š</h3>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="adset_id">Adset ID <span class="required">*</span></label>
                        <input type="text" id="adset_id" name="adset_id" value="{{ adset_id or '' }}" required
                               placeholder="ä¾‹å¦‚ï¼š00947c1b-f7cd-47c6-a23a-0639e9702cc7">
                        <div class="help-text">å»£å‘Šçµ„IDï¼Œå¿…å¡«</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="display_name">å»£å‘Šå–®å…ƒé¡¯ç¤ºåç¨±</label>
                        <input type="text" id="display_name" name="display_name" value="{{ display_name or '' }}"
                               placeholder="åƒ…ä¾›å¾Œå°é¡¯ç¤ºä½¿ç”¨">
                        <div class="help-text">åƒ…é¡¯ç¤ºæ–¼å¾Œå°ï¼Œå¯é¸</div>
                    </div>
                </div>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="advertiser">å»£å‘Šå•† <span class="required">*</span></label>
                        <input type="text" id="advertiser" name="advertiser" value="{{ advertiser or '' }}" required
                               placeholder="å»£å‘Šä¸»åç¨±">
                        <div class="help-text">å»£å‘Šä¸»åç¨±ï¼Œå¿…å¡«</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="main_title">ä¸»æ¨™é¡Œ <span class="required">*</span></label>
                        <input type="text" id="main_title" name="main_title" value="{{ main_title or '' }}" required
                               placeholder="å»£å‘Šä¸»æ¨™é¡Œ">
                        <div class="help-text">å»£å‘Šä¸»æ¨™é¡Œï¼Œå¿…å¡«</div>
                    </div>
                </div>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="subtitle">æ–‡å­—æ•˜è¿°</label>
                        <input type="text" id="subtitle" name="subtitle" value="{{ subtitle or '' }}"
                               placeholder="å»£å‘Šå‰¯æ¨™é¡Œï¼ˆå¯é¸ï¼‰">
                        <div class="help-text">å»£å‘Šå‰¯æ¨™é¡Œï¼Œå¯é¸</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="call_to_action">è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—</label>
                        <input type="text" id="call_to_action" name="call_to_action" value="{{ call_to_action or 'ç«‹å³äº†è§£' }}"
                               placeholder="ç«‹å³äº†è§£">
                        <div class="help-text">CTAæŒ‰éˆ•æ–‡å­—ï¼Œé è¨­ç‚ºã€Œç«‹å³äº†è§£ã€</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <label for="landing_page">åˆ°é”é é¢ç¶²å€ <span class="required">*</span></label>
                    <input type="url" id="landing_page" name="landing_page" placeholder="https://example.com" 
                           value="{{ landing_page or '' }}" required>
                    <div class="help-text">ç”¨æˆ¶é»æ“Šå»£å‘Šå¾Œè·³è½‰çš„ç¶²å€ï¼Œå¿…å¡«</div>
                </div>
            </div>

            <div class="field-group">
                <h3>ğŸ“¹ å»£å‘Šç´ æ</h3>
                <p style="margin-bottom: 20px; color: #666; font-style: italic;">
                    æ‰€æœ‰åœ–ç‰‡å‡ç‚ºå¿…å¡«ã€‚è«‹æä¾›æœ¬åœ°å®Œæ•´æª”æ¡ˆè·¯å¾‘ï¼Œæˆ–ä½¿ç”¨ä¸Šå‚³åŠŸèƒ½ã€‚
                </p>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="image_path_m">å¤§å°ºå¯¸åœ–ç‰‡ 1200x628 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="image_path_m" name="image_path_m" 
                                   placeholder="/path/to/your/image_1200x628.jpg" 
                                   value="{{ image_path_m or '' }}" required>
                            <div class="help-text">å¤§å‹æ©«å¹…åœ–ç‰‡ï¼Œå°ºå¯¸1200x628åƒç´ </div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    ğŸ“ ä¸Šå‚³åœ–ç‰‡
                                    <input type="file" class="file-input" data-target="image_path_m" accept="image/*">
                                </label>
                                <img id="preview_m" class="upload-preview" style="display: none;" alt="é è¦½åœ–">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="image_path_s">å°å°ºå¯¸åœ–ç‰‡ 300x300 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="image_path_s" name="image_path_s" 
                                   placeholder="/path/to/your/image_300x300.jpg" 
                                   value="{{ image_path_s or '' }}" required>
                            <div class="help-text">æ–¹å½¢åœ–ç‰‡ï¼Œå°ºå¯¸300x300åƒç´ </div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    ğŸ“ ä¸Šå‚³åœ–ç‰‡
                                    <input type="file" class="file-input" data-target="image_path_s" accept="image/*">
                                </label>
                                <img id="preview_s" class="upload-preview" style="display: none;" alt="é è¦½åœ–">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <label for="background_image">äº’å‹•å»£å‘Šå¢Šæª”èƒŒæ™¯ <span class="required">*</span></label>
                    <input type="text" id="background_image" name="background_image" 
                           placeholder="è«‹è¼¸å…¥èƒŒæ™¯åœ–ç‰‡ç¶²å€" value="{{ background_image or '' }}" required>
                    <div class="help-text">äº’å‹•å»£å‘Šå¢Šæª”èƒŒæ™¯åœ–ç‰‡ç¶²å€</div>
                </div>
            </div>

            <div class="field-group">
                <h3>âš™ï¸ é€²éšäº’å‹•è¨­å®š & cut1 åœ–ç‰‡è¨­å®š</h3>
                <p style="margin-bottom: 20px; color: #666; font-style: italic;">
                    æ­¤å€å¡Šç‚ºé€²éšè¨­å®šï¼Œä¸»è¦ç”¨æ–¼åŸç”Ÿå½ˆè·³å½±éŸ³ slide å»£å‘Šçš„äº’å‹•å±¤ã€‚è‹¥ä¸ç¢ºå®šï¼Œå¯ä¿ç•™é è¨­å€¼ã€‚
                </p>

                <input type="hidden" name="generate_popup_url" value="true">

                <div class="form-row">
                    <label for="img_background">cut1 èƒŒæ™¯åœ–ç‰‡ç¶²å€</label>
                    <input type="url" id="img_background" name="img_background" 
                           placeholder="https://static.ottercdn.com/trek/media/..." 
                           value="{{ popup_payload.img_background or '' }}">
                    <div class="help-text">è¨­å®šå»£å‘Šçš„ cut1 èƒŒæ™¯åœ–ç‰‡ç¶²å€</div>
                </div>

                <div class="form-row">
                    <label>å½ˆçª—å…§å®¹ (payload_popupJson)</label>
                    <div class="help-text" style="margin-bottom: 10px;">
                        æ ¹æ“šå›ºå®šæ ¼å¼ç”¢ç”Ÿå½ˆçª—å…§å®¹ã€‚åŒ…å«å½±ç‰‡å’Œæ»‘å‹•åœ–ç‰‡çµ„ä»¶ã€‚
                    </div>
                    <div id="popup-list-container" class="dynamic-container">
                        <!-- Video Item -->
                        <div class="dynamic-item">
                            <h5>å½ˆçª—å…§å®¹ (1/2): å½±ç‰‡</h5>
                            <div class="form-row">
                                <label for="popup_video_url">å½±ç‰‡ç´ æç¶²å€</label>
                                <input type="url" id="popup_video_url" class="payload-popup-input" placeholder="https://www.youtube.com/watch?v=..."
                                       value="{{ popup_payload.video_url or 'https://www.youtube.com/watch?v=gSD-pmXK4iY' }}">
                                <div class="help-text">æ”¯æ´ YouTube æˆ–ç›´æ¥å½±ç‰‡ç¶²å€</div>
                            </div>
                        </div>
                        <!-- Slide Item -->
                        <div class="dynamic-item">
                            <h5>å½ˆçª—å…§å®¹ (2/2): æ»‘å‹•åœ–ç‰‡çµ„ä»¶</h5>
                            <div class="form-row">
                                <label for="slide_autoplay_delay">è‡ªå‹•æ’­æ”¾å»¶é² (æ¯«ç§’)</label>
                                <input type="number" id="slide_autoplay_delay" class="payload-popup-input" placeholder="2000" min="100" step="100"
                                       value="{{ popup_payload.slide_autoplay_delay or '2000' }}">
                                <div class="help-text">æ»‘å‹•åœ–ç‰‡è‡ªå‹•æ’­æ”¾çš„å»¶é²æ™‚é–“ï¼Œå–®ä½ç‚ºæ¯«ç§’</div>
                            </div>
                            <div class="form-row">
                                <label>æ»‘å‹•åœ–ç‰‡åˆ—è¡¨</label>
                                <div id="slide-items-container">
                                    <!-- å‹•æ…‹ç”Ÿæˆçš„æ»‘å‹•åœ–ç‰‡è¼¸å…¥æ¬„ä½ -->
                                </div>
                                <button type="button" class="add-item-btn" onclick="addSlideItem()">â• æ–°å¢æ»‘å‹•åœ–ç‰‡</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="payload_popup_json" name="payload_popup_json" value="{{ payload_popup_json or '' }}">
                </div>
                
                <input type="hidden" id="payload_game_widget" name="payload_game_widget" value="{{ payload_game_widget or '' }}">
            </div>
            
            <!-- éš±è—çš„ç›¸å®¹æ€§æ¬„ä½ï¼Œç¢ºä¿ JavaScript æ­£å¸¸é‹ä½œ -->
            <input type="hidden" id="video_url" name="video_url" value="">
            <input type="hidden" id="poster_image" name="poster_image" value="">
            
            <input type="submit" value="ğŸ¯ å»ºç«‹åŸç”Ÿå½ˆè·³å½±éŸ³æ»‘å‹•å»£å‘Š">
        </form>
    </div>

    <div class="preview-column">
        <div class="preview-section">
            <h3 style="color: #333; margin-bottom: 15px; font-size: 16px; font-weight: 600;">ğŸ–¼ï¸ å»£å‘Šå³æ™‚é è¦½</h3>
            <div class="ad-preview-container">
                <div class="ad-preview-header">å»£å‘Š</div>
                <div class="ad-preview-main">
                    <div id="preview-cut1-view">
                        <img id="preview-cut1-bg" class="cut1-background-img" src="" alt="cut1 èƒŒæ™¯åœ–ç‰‡" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 14px;">
                            å°šæœªè¨­å®š cut1 èƒŒæ™¯åœ–ç‰‡
                        </div>
                    </div>
                </div>
                <div id="preview-main-title" class="ad-preview-title">ä¸»æ¨™é¡Œ</div>
                <div id="preview-subtitle" class="ad-preview-subtitle">æ–‡å­—æ•˜è¿°</div>
                <div class="ad-preview-footer">
                    <div id="preview-advertiser" class="ad-preview-advertiser">å»£å‘Šå•†</div>
                    <div id="preview-call-to-action" class="ad-preview-cta">è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—</div>
                </div>
            </div>
            
            <h3 style="color: #333; margin: 20px 0 15px 0; font-size: 16px; font-weight: 600;">ğŸ¬ å½ˆçª—å…§å®¹é è¦½</h3>
                <div class="popup-content-preview">
                    <div style="position: absolute; top: 5px; left: 5px; background: rgba(255,255,255,0.9); padding: 3px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; z-index: 10;">
                        å½ˆçª—å…§å®¹é è¦½ (å½±ç‰‡ + æ»‘å‹•åœ–ç‰‡çµ„ä»¶)
                    </div>
                    
                    <!-- å½±ç‰‡å€åŸŸï¼šå°æ‡‰ 1200x628ï¼Œå¯¦éš›é¡¯ç¤º 300x157 -->
                    <div class="popup-video-preview" id="popup-video-preview" style="width: 300px; height: 157px; position: relative;">
                        <video id="popup-preview-video" style="display: none; width: 100%; height: 100%; object-fit: cover;" muted playsinline controls>
                            <source id="popup-preview-video-source" src="" type="video/mp4">
                            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±éŸ³æ’­æ”¾
                        </video>
                        <button id="popup-play-btn" class="video-play-btn" style="display: none;">â–¶</button>
                        <div id="popup-video-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ccc; font-size: 12px; text-align: center;">
                            ğŸ“¹<br>å½±ç‰‡ç´ æ<br>1200Ã—628
                        </div>
                    </div>
                    
                    <!-- åœ–ç‰‡å€åŸŸï¼šå°æ‡‰ 690x788ï¼Œå¯¦éš›é¡¯ç¤º 300x343 -->
                    <div class="popup-image-preview" id="popup-image-preview" style="width: 300px; height: 343px;">
                        <div class="popup-slide-wrapper" id="popup-slide-wrapper">
                            <!-- Slides will be injected here -->
                        </div>
                        <div class="popup-dots-container" id="popup-dots-container">
                            <!-- Dots will be injected here -->
                        </div>
                        <div id="popup-image-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 12px; text-align: center;">
                            ğŸ–¼ï¸<br>æ»‘å‹•åœ–ç‰‡çµ„ä»¶<br>å°šæœªæ–°å¢åœ–ç‰‡
                        </div>
                    </div>
                </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    // Debounce å‡½æ•¸ï¼Œé˜²æ­¢äº‹ä»¶éæ–¼é »ç¹è§¸ç™¼
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // è‡ªå‹•å„²å­˜è¡¨å–®ç‹€æ…‹åˆ°å¾Œç«¯ session
    const autoSaveForm = debounce(() => {
        const form = document.getElementById('ad-form');
        const formData = new FormData(form);
        
        // ä½¿ç”¨ fetch API å°‡è¡¨å–®æ•¸æ“šç™¼é€åˆ°å¾Œç«¯
        fetch("{{ url_for('main.save_form_data') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Form state auto-saved to session.');
            } else {
                console.error('Failed to auto-save form state:', data.message);
            }
        })
        .catch(error => {
            console.error('Error in auto-save request:', error);
        });
    }, 500); // åœ¨ç”¨æˆ¶åœæ­¢è¼¸å…¥ 500 æ¯«ç§’å¾Œè§¸ç™¼

    // åŸç”Ÿå½ˆè·³å½±éŸ³æ»‘å‹•å»£å‘Šç‰¹æœ‰çš„ JavaScript
    let previewVideo;
    let isVideoPlaying = false;
    let popupSlidePreviewInterval;
    let currentPopupSlideIndex = 0;
    
    document.addEventListener('DOMContentLoaded', function() {
        // ç‚ºè¡¨å–®æ·»åŠ è¼¸å…¥äº‹ä»¶ç›£è½å™¨ä»¥è§¸ç™¼è‡ªå‹•å„²å­˜
        const adForm = document.getElementById('ad-form');
        if (adForm) {
            adForm.addEventListener('input', autoSaveForm);
        }

        // åˆå§‹åŒ–å½±éŸ³é è¦½
        previewVideo = document.getElementById('preview-video');
        
        // è¼‰å…¥å„²å­˜çš„æ»‘å‹•åœ–ç‰‡æ•¸æ“š
        loadSavedSlideData();
        
        // æ›´æ–° payload
        updatePayload();

        // æ·»åŠ äº‹ä»¶ç›£è½å™¨ä»¥æ›´æ–°é è¦½
        const inputsToTrack = ['advertiser', 'main_title', 'subtitle', 'call_to_action', 
                              'img_background', 'popup_video_url', 'slide_autoplay_delay'];
        inputsToTrack.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateVideoSlideAdPreview);
                element.addEventListener('change', updateVideoSlideAdPreview);
            }
        });

        // ç‚ºå½ˆçª—é è¦½å½±ç‰‡æ·»åŠ æ’­æ”¾æ§åˆ¶
        const popupPlayBtn = document.getElementById('popup-play-btn');
        if (popupPlayBtn) {
            popupPlayBtn.addEventListener('click', togglePopupVideoPlayback);
        }

        // åˆå§‹åŒ–äº’å‹•è¨­å®š
        initializeInteractiveSettings();

        // é¦–æ¬¡åŠ è¼‰æ™‚æ›´æ–°é è¦½
        updateVideoSlideAdPreview();
    });
    
    function updatePayload() {
        const imgBackground = document.getElementById('img_background').value;
        
        const payload = {
            type: "SIMPLE",
            data: {
                img_background: imgBackground
            },
            _sys: {
                popupActionKeys: ["a"]
            }
        };
        
        document.getElementById('payload_game_widget').value = JSON.stringify(payload);
    }

    function updateVideoSlideAdPreview() {
        // æ›´æ–° payload
        updatePayload();
        
        // æ›´æ–°æ–‡å­—éƒ¨åˆ†
        document.getElementById('preview-main-title').textContent = document.getElementById('main_title').value || 'ä¸»æ¨™é¡Œ';
        document.getElementById('preview-subtitle').textContent = document.getElementById('subtitle').value || 'æ–‡å­—æ•˜è¿°';
        document.getElementById('preview-advertiser').textContent = document.getElementById('advertiser').value || 'å»£å‘Šå•†';
        document.getElementById('preview-call-to-action').textContent = document.getElementById('call_to_action').value || 'è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—';

        // æ›´æ–° cut1 èƒŒæ™¯åœ–ç‰‡é è¦½
        updateCut1Preview();
        
        // æ›´æ–°å½ˆçª—å…§å®¹é è¦½
        updatePopupContentPreview();
    }

    function updateCut1Preview() {
        const imgBackground = document.getElementById('img_background').value;
        const cut1BgImg = document.getElementById('preview-cut1-bg');
        const placeholder = cut1BgImg.nextElementSibling;
        
        if (imgBackground) {
            cut1BgImg.src = imgBackground;
            cut1BgImg.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            cut1BgImg.style.display = 'none';
            placeholder.style.display = 'flex';
        }
    }

    function updatePopupContentPreview() {
        // æ›´æ–°å½±ç‰‡é è¦½
        const videoUrl = document.getElementById('popup_video_url').value;
        const popupVideo = document.getElementById('popup-preview-video');
        const popupVideoSource = document.getElementById('popup-preview-video-source');
        const videoPlaceholder = document.getElementById('popup-video-placeholder');
        const playBtn = document.getElementById('popup-play-btn');
        
        if (videoUrl) {
            // å°‡ YouTube URL è½‰æ›ç‚ºå¯åµŒå…¥çš„æ ¼å¼
            let embedUrl = videoUrl;
            if (videoUrl.includes('youtube.com/watch?v=')) {
                const videoId = videoUrl.split('v=')[1].split('&')[0];
                embedUrl = `https://www.youtube.com/embed/${videoId}`;
            } else if (videoUrl.includes('youtu.be/')) {
                const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                embedUrl = `https://www.youtube.com/embed/${videoId}`;
            }
            
            // å¦‚æœæ˜¯ YouTube å½±ç‰‡ï¼Œä½¿ç”¨ iframeï¼›å¦å‰‡ä½¿ç”¨ video æ¨™ç±¤
            if (embedUrl.includes('youtube.com/embed/')) {
                popupVideo.style.display = 'none';
                if (playBtn) playBtn.style.display = 'none';
                
                // å‰µå»ºæˆ–æ›´æ–° iframe
                let iframe = document.getElementById('popup-preview-iframe');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.id = 'popup-preview-iframe';
                    iframe.style.cssText = 'width: 100%; height: 100%; border: none;';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                    iframe.allowFullscreen = true;
                    videoPlaceholder.parentNode.appendChild(iframe);
                }
                iframe.src = embedUrl;
                iframe.style.display = 'block';
                videoPlaceholder.style.display = 'none';
            } else {
                // ç§»é™¤ iframeï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const iframe = document.getElementById('popup-preview-iframe');
                if (iframe) iframe.style.display = 'none';
                
                popupVideoSource.src = embedUrl;
                popupVideo.load();
                popupVideo.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                if (playBtn) {
                    playBtn.style.display = 'flex';
                    playBtn.textContent = 'â–¶';
                }
            }
        } else {
            // éš±è—æ‰€æœ‰å½±ç‰‡å…ƒç´ 
            const iframe = document.getElementById('popup-preview-iframe');
            if (iframe) iframe.style.display = 'none';
            popupVideo.style.display = 'none';
            videoPlaceholder.style.display = 'flex';
            if (playBtn) {
                playBtn.style.display = 'none';
            }
        }
        
        // æ›´æ–°æ»‘å‹•åœ–ç‰‡é è¦½
        updatePopupSlidePreview();
    }

    function togglePopupVideoPlayback() {
        const popupVideo = document.getElementById('popup-preview-video');
        const playBtn = document.getElementById('popup-play-btn');
        
        if (popupVideo && playBtn) {
            if (popupVideo.paused) {
                popupVideo.play();
                playBtn.textContent = 'â¸';
            } else {
                popupVideo.pause();
                playBtn.textContent = 'â–¶';
            }
        }
    }

    function updatePopupSlidePreview() {
        const slideWrapper = document.getElementById('popup-slide-wrapper');
        const dotsContainer = document.getElementById('popup-dots-container');
        const imagePlaceholder = document.getElementById('popup-image-placeholder');
        
        // æ¸…é™¤ç¾æœ‰å…§å®¹
        slideWrapper.innerHTML = '';
        dotsContainer.innerHTML = '';
        
        // åœæ­¢ç¾æœ‰çš„è‡ªå‹•æ’­æ”¾
        clearInterval(popupSlidePreviewInterval);
        
        // æ”¶é›†æ‰€æœ‰æ»‘å‹•åœ–ç‰‡
        const slideItems = document.querySelectorAll('.slide-item');
        let validSlides = [];
        
        slideItems.forEach((item, index) => {
            const imageUrlInput = item.querySelector('.slide-image-url');
            if (imageUrlInput && imageUrlInput.value) {
                validSlides.push(imageUrlInput.value);
                
                // å‰µå»ºæ»‘å‹•é …ç›®
                const slideDiv = document.createElement('div');
                slideDiv.className = 'popup-preview-slide';
                slideDiv.innerHTML = `<img src="${imageUrlInput.value}" alt="Slide ${index + 1}">`;
                slideWrapper.appendChild(slideDiv);
                
                // å‰µå»ºæŒ‡ç¤ºå™¨
                const dotSpan = document.createElement('span');
                dotSpan.className = 'popup-preview-dot';
                dotsContainer.appendChild(dotSpan);
            }
        });
        
        if (validSlides.length > 0) {
            // éš±è—ä½”ä½ç¬¦
            imagePlaceholder.style.display = 'none';
            
            const slides = slideWrapper.querySelectorAll('.popup-preview-slide');
            const dots = dotsContainer.querySelectorAll('.popup-preview-dot');
            currentPopupSlideIndex = 0;
            
            function showSlide() {
                slides.forEach((s, i) => s.classList.toggle('active', i === currentPopupSlideIndex));
                dots.forEach((d, i) => d.classList.toggle('active', i === currentPopupSlideIndex));
            }
            
            // é¡¯ç¤ºç¬¬ä¸€å¼µåœ–ç‰‡
            showSlide();
            
            // å¦‚æœæœ‰å¤šå¼µåœ–ç‰‡ï¼Œå•Ÿå‹•è‡ªå‹•æ’­æ”¾
            if (slides.length > 1) {
                const autoplayDelay = parseInt(document.getElementById('slide_autoplay_delay').value) || 2000;
                popupSlidePreviewInterval = setInterval(() => {
                    currentPopupSlideIndex = (currentPopupSlideIndex + 1) % slides.length;
                    showSlide();
                }, autoplayDelay);
            }
        } else {
            // é¡¯ç¤ºä½”ä½ç¬¦
            imagePlaceholder.style.display = 'flex';
            imagePlaceholder.innerHTML = 'ğŸ–¼ï¸<br>æ»‘å‹•åœ–ç‰‡çµ„ä»¶<br>å°šæœªæ–°å¢åœ–ç‰‡';
        }
    }

    // =================================================================
    // Slide Management Functions
    // =================================================================
    
    let slideItemCounter = 1; // å¾ 1 é–‹å§‹ï¼Œå› ç‚ºå·²ç¶“æœ‰ç¬¬ä¸€å€‹é …ç›®
    
    function loadSavedSlideData() {
        // å¾å¾Œç«¯è¼‰å…¥çš„ payload_popup_json ä¸­æ¢å¾©æ»‘å‹•åœ–ç‰‡æ•¸æ“š
        const payloadJson = document.getElementById('payload_popup_json').value;
        if (payloadJson) {
            try {
                const payload = JSON.parse(payloadJson);
                if (payload.popupList) {
                    // æ‰¾åˆ° SLIDE é¡å‹çš„é …ç›®
                    const slideItem = payload.popupList.find(item => item.type === 'SLIDE');
                    if (slideItem && slideItem.data && slideItem.data.slides) {
                        const slides = slideItem.data.slides;
                        const invokes = slideItem.invokes || [];
                        
                        // æ¸…é™¤ç¾æœ‰çš„æ»‘å‹•åœ–ç‰‡é …ç›®
                        const container = document.getElementById('slide-items-container');
                        container.innerHTML = '';
                        
                        // é‡æ–°å‰µå»ºæ»‘å‹•åœ–ç‰‡é …ç›®
                        slides.forEach((imageUrl, index) => {
                            const landingUrl = invokes[index] ? invokes[index][0]?.payload?.url || '' : '';
                            
                            const slideItemHtml = `
                                <div class="slide-item" data-index="${index}">
                                    <div class="dynamic-item-header">
                                        <label>æ»‘å‹•åœ–ç‰‡ #${index + 1}</label>
                                        <button type="button" class="remove-slide-btn" onclick="removeSlideItem(${index})">Ã—</button>
                                    </div>
                                    <div class="form-row">
                                        <label>åœ–ç‰‡ç¶²å€</label>
                                        <input type="url" class="slide-image-url" placeholder="https://static.ottercdn.com/trek/media/..." value="${imageUrl}">
                                    </div>
                                    <div class="form-row">
                                        <label>é»æ“Šå°é€£ç¶²å€</label>
                                        <input type="url" class="slide-landing-url" placeholder="https://example.com" value="${landingUrl}">
                                    </div>
                                </div>
                            `;
                            
                            container.insertAdjacentHTML('beforeend', slideItemHtml);
                        });
                        
                        slideItemCounter = slides.length;
                        
                        // ç‚ºè¼‰å…¥çš„è¼¸å…¥æ¬„ä½æ·»åŠ äº‹ä»¶ç›£è½å™¨
                        container.querySelectorAll('input').forEach(input => {
                            input.addEventListener('input', () => {
                                updatePayloadPopupJson();
                                updatePopupSlidePreview();
                            });
                        });
                        
                        // è¨­å®šè‡ªå‹•æ’­æ”¾å»¶é²
                        if (slideItem.data.options && slideItem.data.options.autoplay) {
                            const delayInput = document.getElementById('slide_autoplay_delay');
                            if (delayInput) {
                                delayInput.value = slideItem.data.options.autoplay.delay || 500;
                            }
                        }
                    }
                }
            } catch (e) {
                console.log('è¼‰å…¥æ»‘å‹•åœ–ç‰‡æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
            }
        }
        
        // å¦‚æœæ²’æœ‰ç¾æœ‰æ•¸æ“šï¼Œç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹æ»‘å‹•åœ–ç‰‡é …ç›®
        const container = document.getElementById('slide-items-container');
        if (container.children.length === 0) {
            const slideItemHtml = `
                <div class="slide-item" data-index="0">
                    <div class="dynamic-item-header">
                        <label>æ»‘å‹•åœ–ç‰‡ #1</label>
                        <button type="button" class="remove-slide-btn" onclick="removeSlideItem(0)">Ã—</button>
                    </div>
                    <div class="form-row">
                        <label>åœ–ç‰‡ç¶²å€</label>
                        <input type="url" class="slide-image-url" placeholder="https://static.ottercdn.com/trek/media/...">
                    </div>
                    <div class="form-row">
                        <label>é»æ“Šå°é€£ç¶²å€</label>
                        <input type="url" class="slide-landing-url" placeholder="https://example.com">
                    </div>
                </div>
            `;
            container.innerHTML = slideItemHtml;
            
            // ç‚ºåˆå§‹é …ç›®æ·»åŠ äº‹ä»¶ç›£è½å™¨
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => {
                    updatePayloadPopupJson();
                    updatePopupSlidePreview();
                });
            });
        }
    }

    function addSlideItem() {
        const container = document.getElementById('slide-items-container');
        const newIndex = slideItemCounter;
        
        const slideItemHtml = `
            <div class="slide-item" data-index="${newIndex}">
                <div class="dynamic-item-header">
                    <label>æ»‘å‹•åœ–ç‰‡ #${newIndex + 1}</label>
                    <button type="button" class="remove-slide-btn" onclick="removeSlideItem(${newIndex})">Ã—</button>
                </div>
                <div class="form-row">
                    <label>åœ–ç‰‡ç¶²å€</label>
                    <input type="url" class="slide-image-url" placeholder="https://static.ottercdn.com/trek/media/...">
                </div>
                <div class="form-row">
                    <label>é»æ“Šå°é€£ç¶²å€</label>
                    <input type="url" class="slide-landing-url" placeholder="https://example.com">
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', slideItemHtml);
        slideItemCounter++;
        
        // ç‚ºæ–°æ·»åŠ çš„è¼¸å…¥æ¬„ä½æ·»åŠ äº‹ä»¶ç›£è½å™¨
        const newSlideItem = container.lastElementChild;
        newSlideItem.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => {
                updatePayloadPopupJson();
                updatePopupSlidePreview();
            });
        });
        
        updatePayloadPopupJson();
        updatePopupContentPreview();
    }

    function removeSlideItem(index) {
        const slideItems = document.querySelectorAll('.slide-item');
        if (slideItems.length <= 1) {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ»‘å‹•åœ–ç‰‡é …ç›®');
            return;
        }
        
        const slideItem = document.querySelector(`.slide-item[data-index="${index}"]`);
        if (slideItem) {
            slideItem.remove();
            updateSlideLabels();
            updatePayloadPopupJson();
            updatePopupSlidePreview();
        }
    }

    function updateSlideLabels() {
        const slideItems = document.querySelectorAll('.slide-item');
        slideItems.forEach((item, index) => {
            // æ›´æ–° data-index
            item.setAttribute('data-index', index);
            
            // æ›´æ–°æ¨™ç±¤æ–‡å­—
            const label = item.querySelector('.dynamic-item-header label');
            if (label) {
                label.textContent = `æ»‘å‹•åœ–ç‰‡ #${index + 1}`;
            }
            
            // æ›´æ–°åˆªé™¤æŒ‰éˆ•çš„ onclick äº‹ä»¶
            const removeBtn = item.querySelector('.remove-slide-btn');
            if (removeBtn) {
                removeBtn.setAttribute('onclick', `removeSlideItem(${index})`);
            }
        });
        
        // æ›´æ–°å…¨å±€è¨ˆæ•¸å™¨
        slideItemCounter = slideItems.length;
    }

    // =================================================================
    // Interactive Settings (urlInteractivePopups & payload_popupJson)
    // =================================================================

    function initializeInteractiveSettings() {
        // ç‚ºå·²å­˜åœ¨çš„æ»‘å‹•åœ–ç‰‡è¼¸å…¥æ¬„ä½æ·»åŠ äº‹ä»¶ç›£è½å™¨
        document.querySelectorAll('.slide-image-url, .slide-landing-url').forEach(input => {
            input.addEventListener('input', () => {
                updatePayloadPopupJson();
                updatePopupContentPreview();
            });
        });
        
        // Use event delegation for dynamically added elements
        const form = document.getElementById('ad-form');
        form.addEventListener('input', handleDynamicInputs);
    }

    function handleDynamicInputs(e) {
        // Using a timeout to avoid excessive updates on every keystroke
        clearTimeout(window.inputUpdateTimeout);
        window.inputUpdateTimeout = setTimeout(() => {
            // Always update the popup payload json as its inputs are static
            updatePayloadPopupJson();
            updatePopupContentPreview();
        }, 300);
    }

    // --- urlInteractivePopups functions (addInteractivePopup, updateUrlInteractivePopups) are removed ---

    // --- payload_popupJson (Simplified Static Version) ---

    function updatePayloadPopupJson() {
        const videoUrl = document.getElementById('popup_video_url').value;
        const autoplayDelay = parseInt(document.getElementById('slide_autoplay_delay').value) || 500;
        
        // æ”¶é›†æ‰€æœ‰æ»‘å‹•åœ–ç‰‡æ•¸æ“š
        const slideItems = document.querySelectorAll('.slide-item');
        const slides = [];
        const invokes = [];
        
        slideItems.forEach(item => {
            const imageUrl = item.querySelector('.slide-image-url').value;
            const landingUrl = item.querySelector('.slide-landing-url').value;
            
            if (imageUrl) {
                slides.push(imageUrl);
                
                // ç‚ºæ¯å€‹æ»‘å‹•åœ–ç‰‡å‰µå»ºå°æ‡‰çš„ invoke å‹•ä½œ
                const slideInvoke = [
                    {
                        action: "OPEN_EXTERNAL_BROWSER",
                        payload: {
                            url: landingUrl || "https://example.com"
                        }
                    },
                    {
                        action: "CLOSE_POPUP",
                        payload: {}
                    },
                    {
                        action: "AOTTERTREK",
                        payload: {
                            method: "tkadn",
                            params: ["CLICK_EVENT_img_link"]
                        }
                    }
                ];
                invokes.push(slideInvoke);
            }
        });

        // æ§‹å»ºæœ€çµ‚çš„ payload
        const popupList = [];
        
        // 1. Video item (å¦‚æœæœ‰å½±ç‰‡ç¶²å€)
        if (videoUrl) {
            popupList.push({
                type: "video",
                url: videoUrl
            });
        }
        
        // 2. Slide item (å¦‚æœæœ‰æ»‘å‹•åœ–ç‰‡)
        if (slides.length > 0) {
            popupList.push({
                type: "SLIDE",
                data: {
                    options: {
                        autoplay: {
                            delay: autoplayDelay
                        }
                    },
                    slides: slides
                },
                invokes: invokes
            });
        }

        // Final payload object
        const finalPayload = {
            popupList: popupList
        };

        document.getElementById('payload_popup_json').value = JSON.stringify(finalPayload, null, 2);
    }

    // å¿«é€Ÿè³‡è¨Šè§£æå‡½æ•¸
    function parseInfoText(text) {
        try {
            // è§£æå»£å‘Šä¸»
            const advertiserMatch = text.match(/[-Â·]\s*å»£å‘Šä¸»[:ï¼š]\s*(.+)/);
            if (advertiserMatch) {
                document.getElementById('advertiser').value = advertiserMatch[1].trim();
            }

            // è§£ææ´»å‹•åç¨±ä½œç‚ºä¸»æ¨™é¡Œ
            const titleMatch = text.match(/[-Â·]\s*æ´»å‹•åç¨±[:ï¼š]\s*(.+)/);
            if (titleMatch) {
                document.getElementById('main_title').value = titleMatch[1].trim();
            }

            // è§£ææ¨™é¡Œ
            const headlineMatch = text.match(/[-Â·]\s*æ¨™é¡Œ[:ï¼š]\s*(.+)/);
            if (headlineMatch) {
                document.getElementById('subtitle').value = headlineMatch[1].trim();
            }

            // è§£æ CTA
            const ctaMatch = text.match(/[-Â·]\s*CTA[:ï¼š]\s*(.+)/);
            if (ctaMatch) {
                document.getElementById('call_to_action').value = ctaMatch[1].trim();
            }

            // è§£æå°é€£
            const landingMatch = text.match(/(?:å°é€£|åˆ°é”é é¢)[:ï¼š]\s*(https?:\/\/[^\s]+)/);
            if (landingMatch) {
                document.getElementById('landing_page').value = landingMatch[1].trim();
            }

            updatePayload();
            updateVideoSlideAdPreview();
            alert('âœ… è³‡è¨Šè§£æå®Œæˆï¼è«‹æª¢æŸ¥å¡«å…¥çš„å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚');
        } catch (error) {
            console.error('è§£æéŒ¯èª¤:', error);
            alert('âŒ è§£æéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼ã€‚');
        }
    }
</script>
{% endblock %}