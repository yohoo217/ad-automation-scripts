{% extends "base.html" %}

{% block title %}廣告報表{% endblock %}
{% block page_title %}廣告報表{% endblock %}

{% block additional_styles %}
<!-- 改用 ExcelJS 庫 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>

<style>
    .report-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .input-section {
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #f8faff 0%, #f1f5ff 100%);
        border-radius: 12px;
        border: 1px solid #e0e6ed;
    }
    
    .report-content {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .report-content iframe {
        width: 100%;
        height: 100%;
        border: none;
        min-height: 500px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error {
        color: #dc3545;
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
    }
    
    .daily-report-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid #007bff;
    }
    
    .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .report-table th,
    .report-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }
    
    .report-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .report-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .cookie-status {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .cookie-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .cookie-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .export-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 10px;
    }
    
    .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }
    
    .export-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div id="cookie-status" class="cookie-status cookie-success">
        ✓ Cookie 已自動設置成功
    </div>
    
    <div class="input-section">
        <h3>📊 廣告報表查詢</h3>
        <div class="form-row">
            <label for="setId">廣告集 ID <span class="required">*</span></label>
            <input type="text" id="setId" name="setId" placeholder="請輸入廣告集 ID，例如：82000801-b829-4812-aefb-eae6a9b27040" required>
            <div class="help-text">輸入您要查詢的廣告集 ID，系統會自動取得走期時間和活動資訊</div>
        </div>

        <div class="form-row">
            <label for="isSlideAd">
                <input type="checkbox" id="isSlideAd" name="isSlideAd" style="margin-right: 8px;">
                🎬 這是 Slide 廣告（會顯示 cut 分析數據）
            </label>
            <div class="help-text">勾選此項目將會查詢 AdUnit 並顯示各 cut 的詳細數據</div>
        </div>
        
        <!-- 隱藏的輸入框，用於儲存從 AdSet 取得的數據 -->
        <input type="hidden" id="sinceDate" name="sinceDate">
        <input type="hidden" id="toDate" name="toDate">
        <input type="hidden" id="campaignEndDate" name="campaignEndDate">
        <input type="hidden" id="currentDate" name="currentDate">
        
        <button type="button" id="fetchReport" class="button">📈 取得報表</button>
        <button type="button" id="exportExcel" class="export-button" disabled>📊 產出 XLSX 報表</button>
    </div>
    
    <div id="reportContent" class="report-content" style="display: none;">
        <h3>📈 每日報表</h3>
        <div id="dailyReportContainer">
            <!-- 報表內容將在這裡顯示 -->
        </div>
    </div>
    
    <div id="loadingMessage" class="loading" style="display: none;">
        <p>📊 正在載入報表資料...</p>
        <div style="margin-top: 10px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #667eea; animation: spin 1s linear infinite;"></div>
        </div>
    </div>
    
    <div id="errorMessage" class="error" style="display: none;">
        <!-- 錯誤訊息將在這裡顯示 -->
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block additional_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 自動設置 Cookie
    const defaultCookie = "AOTTERBD_SESSION=757418f543a95a889184e798ec5ab66d4fad04e5-lats=1724229220332&sso=PIg4zu/Vdnn/A15vMEimFlVAGliNhoWlVd5FTvtEMRAFpk/VvBGvAetanw8DLATSLexy9pee/t52uNojvoFS2Q==;aotter=eyJ1c2VyIjp7ImlkIjoiNjNkYjRkNDBjOTFiNTUyMmViMjk4YjBkIiwiZW1haWwiOiJpYW4uY2hlbkBhb3R0ZXIubmV0IiwiY3JlYXRlZEF0IjoxNjc1MzE2NTQ0LCJlbWFpbFZlcmlmaWVkIjp0cnVlLCJsZWdhY3lJZCI6bnVsbCwibGVnYWN5U2VxSWQiOjE2NzUzMTY1NDQ3ODI5NzQwMDB9LCJhY2Nlc3NUb2tlbiI6IjJkYjQyZTNkOTM5MDUzMjdmODgyZmYwMDRiZmI4YmEzZjBhNTlmMDQwYzhiN2Y4NGY5MmZmZTIzYTU0ZTQ2MDQiLCJ1ZWEiOm51bGx9; _Secure-1PSID=vlPPgXupFroiSjP1/A02minugZVZDgIG4K; _Secure-1PSIDCC=g.a000mwhavReSVd1vN09AVTswXkPAhyuW7Tgj8-JFhj-FZya9I_l1B6W2gqTIWAtQUTQMkTxoAwACgYKAW0SARISFQHGX2MiC--NJ2PzCzDpJ0m3odxHhxoVAUF8yKr8r49abq8oe4UxCA0t_QCW0076; _Secure-3PSID=AKEyXzUuXI1zywmFmkEBEBHfg6GRkRM9cJ9BiJZxmaR46x5im_krhaPtmL4Jhw8gQsz5uFFkfbc; _Secure-3PSIDCC=sidts-CjEBUFGohzUF6oK3ZMACCk2peoDBDp6djBwJhGc4Lxgu2zOlzbVFeVpXF4q1TYZ5ba6cEAA";
    
    try {
        // 解析並設置各個 cookie
        const cookies = defaultCookie.split(';');
        cookies.forEach(cookie => {
            if (cookie.trim()) {
                document.cookie = cookie.trim() + "; path=/; SameSite=Lax";
            }
        });
        
        document.getElementById('cookie-status').className = 'cookie-status cookie-success';
        document.getElementById('cookie-status').innerHTML = '✓ Cookie 已自動設置成功';
    } catch (error) {
        console.error('設置 Cookie 時發生錯誤:', error);
        document.getElementById('cookie-status').className = 'cookie-status cookie-error';
        document.getElementById('cookie-status').innerHTML = '✗ Cookie 設置失敗: ' + error.message;
    }
    
    // 取得報表按鈕
    document.getElementById('fetchReport').addEventListener('click', function() {
        const setId = document.getElementById('setId').value.trim();
        
        if (!setId) {
            alert('請輸入廣告集 ID');
            return;
        }
        
        // 使用預設時間戳，實際會從 AdSet 自動取得正確的時間戳
        const defaultSinceDate = Date.now() - (30 * 24 * 60 * 60 * 1000); // 30天前
        const defaultToDate = Date.now(); // 當前時間
        
        console.log('開始查詢報表，AdSet ID:', setId);
        fetchReportData(setId, defaultSinceDate, defaultToDate);
    });
    
    // 產出 Excel 報表按鈕
    document.getElementById('exportExcel').addEventListener('click', function() {
        exportToExcel();
    });
    
    // 儲存報表資料供導出使用
    let currentReportData = null;
    let currentAdsetInfo = null; // 儲存廣告集資訊
    let currentCutData = {}; // 儲存 cut 數據
    let isSlideAd = false; // 是否為 slide 廣告
    
    // 取得報表資料
    async function fetchReportData(setId, sinceDate, toDate) {
        const loadingElement = document.getElementById('loadingMessage');
        const reportElement = document.getElementById('reportContent');
        const errorElement = document.getElementById('errorMessage');
        
        // 檢查是否為 slide 廣告
        isSlideAd = document.getElementById('isSlideAd').checked;
        
        // 顯示載入中
        loadingElement.style.display = 'block';
        reportElement.style.display = 'none';
        errorElement.style.display = 'none';
        
        try {
            // 第一步：先查詢廣告集資訊，取得正確的時間戳
            console.log('正在查詢廣告集資訊:', `/api/adset-info?adsetId=${encodeURIComponent(setId)}`);
            
            const adsetResponse = await fetch(`/api/adset-info?adsetId=${encodeURIComponent(setId)}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            let actualSinceDate = sinceDate;
            let actualToDate = toDate;
            
            // 處理廣告集資訊回應
            if (adsetResponse.ok) {
                const adsetInfo = await adsetResponse.json();
                console.log('收到廣告集資訊:', adsetInfo);
                currentAdsetInfo = adsetInfo;
                
                if (adsetInfo.success && adsetInfo.info) {
                    // 自動設置走期結束日期
                    if (adsetInfo.info.campaignEndDate) {
                        document.getElementById('campaignEndDate').value = adsetInfo.info.campaignEndDate;
                        console.log('自動設置走期結束日期:', adsetInfo.info.campaignEndDate);
                    }
                    
                    // 自動設置開始和結束時間戳
                    if (adsetInfo.info.fromTimestamp) {
                        actualSinceDate = adsetInfo.info.fromTimestamp;
                        document.getElementById('sinceDate').value = actualSinceDate;
                        console.log('自動設置開始時間戳:', actualSinceDate);
                    }
                    if (adsetInfo.info.toTimestamp) {
                        actualToDate = adsetInfo.info.toTimestamp;
                        document.getElementById('toDate').value = actualToDate;
                        console.log('自動設置結束時間戳:', actualToDate);
                    }
                    
                    // 設置當前日期
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('currentDate').value = today;
                }
            } else {
                console.warn('查詢廣告集資訊失敗，將使用傳入的預設時間戳');
                currentAdsetInfo = {
                    success: false,
                    pricing: { bMode: 'CPC', price: 7.0, currency: 'TWD' },
                    info: { 
                        name: '未知活動', 
                        adType: '原生互動廣告', 
                        budget: 0, 
                        campaignEndDate: null,
                        fromTimestamp: null,
                        toTimestamp: null
                    }
                };
            }
            
            // 第二步：使用正確的時間戳查詢報表
            console.log('正在查詢報表，使用時間戳:', `從 ${actualSinceDate} 到 ${actualToDate}`);
            
            const queries = [
                // 查詢報表資料
                fetch(`/api/report-proxy?setId=${encodeURIComponent(setId)}&sinceDate=${encodeURIComponent(actualSinceDate)}&toDate=${encodeURIComponent(actualToDate)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                })
            ];
            
            // 如果是 slide 廣告，加入 AdUnit 查詢
            if (isSlideAd) {
                queries.push(
                    fetch(`/api/adunits?adsetId=${encodeURIComponent(setId)}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                );
                console.log('正在查詢 AdUnit:', `/api/adunits?adsetId=${encodeURIComponent(setId)}`);
            }
            
            // 並行查詢
            const responses = await Promise.all(queries);
            const [reportResponse, adunitResponse] = responses;
            
            // 處理報表回應
            if (!reportResponse.ok) {
                throw new Error(`報表請求失敗: HTTP ${reportResponse.status}: ${reportResponse.statusText}`);
            }
            
            const jsonResponse = await reportResponse.json();
            console.log('收到代理回應:', jsonResponse);
            
            // 處理 AdUnit 和 cut 數據
            let cutData = {};
            if (isSlideAd && adunitResponse && adunitResponse.ok) {
                const adunitResult = await adunitResponse.json();
                console.log('收到 AdUnit 資訊:', adunitResult);
                
                if (adunitResult.success && adunitResult.adunits.length > 0) {
                    // 為每個 AdUnit 查詢 cut 數據
                    const cutQueries = adunitResult.adunits.map(adunit => 
                        fetch(`/api/cut-data?uuid=${encodeURIComponent(adunit.uuid)}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        })
                    );
                    
                    const cutResponses = await Promise.all(cutQueries);
                    
                    // 處理每個 cut 數據回應
                    for (let i = 0; i < cutResponses.length; i++) {
                        const response = cutResponses[i];
                        const adunit = adunitResult.adunits[i];
                        
                        if (response.ok) {
                            const cutResult = await response.json();
                            if (cutResult.success) {
                                cutData[adunit.uuid] = {
                                    adunit: adunit,
                                    data: cutResult.data
                                };
                                console.log(`收到 AdUnit ${adunit.uuid} 的 cut 數據:`, cutResult.data);
                            }
                        }
                    }
                }
            }
            
            currentCutData = cutData;
            
            if (jsonResponse.success) {
                const htmlContent = jsonResponse.content;
                console.log('收到 HTML 內容，長度:', htmlContent.length);
                
                // 解析並顯示每日報表
                displayDailyReport(htmlContent);
            } else {
                throw new Error(jsonResponse.error || '代理請求失敗');
            }
            
        } catch (error) {
            console.error('取得報表時發生錯誤:', error);
            
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            errorElement.innerHTML = `
                <h4>❌ 取得報表失敗</h4>
                <p><strong>錯誤詳情:</strong> ${error.message}</p>
                <p><strong>可能原因:</strong></p>
                <ul>
                    <li>網路連線問題</li>
                    <li>廣告集 ID 不正確</li>
                    <li>Cookie 可能已過期</li>
                    <li>伺服器代理服務異常</li>
                    ${isSlideAd ? '<li>AdUnit 或 cut 數據查詢失敗</li>' : ''}
                </ul>
                <p><strong>建議解決方法:</strong></p>
                <ul>
                    <li>確認廣告集 ID 是否正確</li>
                    <li>檢查網路連線</li>
                    <li>嘗試重新整理頁面</li>
                    <li>如果問題持續，請聯絡技術支援</li>
                </ul>
            `;
        }
    }
    
    // 顯示每日報表
    function displayDailyReport(htmlContent) {
        const loadingElement = document.getElementById('loadingMessage');
        const reportElement = document.getElementById('reportContent');
        const dailyReportContainer = document.getElementById('dailyReportContainer');
        
        // 獲取走期和當前日期設定
        const campaignEndDate = document.getElementById('campaignEndDate').value;
        const currentDate = document.getElementById('currentDate').value;
        
        loadingElement.style.display = 'none';
        
        try {
            // 創建臨時 DOM 來解析 HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // 取得原始報表表格
            let dailyReportTable = findDailyReportTable(doc);
            
            if (dailyReportTable) {
                // 如果是 slide 廣告，需要重新構建表格以包含 cut 數據
                if (isSlideAd && Object.keys(currentCutData).length > 0) {
                    dailyReportTable = buildSlideReportTable(dailyReportTable, currentCutData);
                }
                
                // 處理表格內容，根據走期設定調整顯示
                if (campaignEndDate && currentDate) {
                    dailyReportTable = processTableBySchedule(dailyReportTable, campaignEndDate, currentDate);
                }
                
                // 顯示表格
                let dailyReportContent = `
                    <div class="daily-report-section">
                        <h4>📊 每日報表數據${isSlideAd ? '（含 Cut 分析數據）' : ''}</h4>
                        ${dailyReportTable.outerHTML}
                    </div>
                `;
                
                dailyReportContainer.innerHTML = dailyReportContent;
                
                // 美化表格
                const table = dailyReportContainer.querySelector('table');
                if (table) {
                    table.className = 'report-table';
                }
                
                reportElement.style.display = 'block';
                
                // 顯示成功訊息和各種資訊
                addReportMessages(dailyReportContainer, campaignEndDate, currentDate);
                
                // 啟用導出按鈕並儲存報表資料
                enableExportButton();
                currentReportData = {
                    setId: document.getElementById('setId').value.trim(),
                    sinceDate: document.getElementById('sinceDate').value,
                    toDate: document.getElementById('toDate').value,
                    campaignEndDate: campaignEndDate,
                    currentDate: currentDate,
                    table: dailyReportTable,
                    isSlideAd: isSlideAd,
                    cutData: currentCutData
                };
            } else {
                throw new Error('在返回的 HTML 中找不到每日報表表格');
            }
            
        } catch (error) {
            console.error('解析 HTML 內容時發生錯誤:', error);
            
            // 如果解析失敗，顯示錯誤訊息
            dailyReportContainer.innerHTML = `
                <div class="daily-report-section">
                    <h4>⚠️ 無法找到每日報表</h4>
                    <p style="color: #6c757d;">
                        <strong>錯誤:</strong> ${error.message}
                    </p>
                    <p style="color: #6c757d; font-size: 14px;">
                        可能原因：報表格式已變更或數據不完整。請檢查廣告集 ID 是否正確。
                    </p>
                </div>
            `;
            reportElement.style.display = 'block';
        }
    }
    
    // 尋找每日報表表格
    function findDailyReportTable(doc) {
        // 專門查找每日報表的表格
        let dailyReportTable = null;
        
        // 查找包含"每日報表"文字的元素
        const allElements = doc.querySelectorAll('*');
        let dailyReportSection = null;
        
        for (let element of allElements) {
            if (element.textContent && element.textContent.includes('每日報表')) {
                dailyReportSection = element;
                break;
            }
        }
        
        if (dailyReportSection) {
            // 找到每日報表標題，尋找其後的表格
            let nextElement = dailyReportSection.nextElementSibling;
            
            // 循環查找表格，可能需要跨越一些 div 容器
            while (nextElement) {
                if (nextElement.tagName === 'TABLE') {
                    dailyReportTable = nextElement;
                    break;
                } else if (nextElement.tagName === 'DIV') {
                    // 在 div 容器內查找表格
                    const tableInDiv = nextElement.querySelector('table');
                    if (tableInDiv) {
                        dailyReportTable = tableInDiv;
                        break;
                    }
                }
                nextElement = nextElement.nextElementSibling;
            }
        }
        
        if (!dailyReportTable) {
            // 如果沒找到每日報表表格，嘗試通過表格內容來識別
            const tables = doc.querySelectorAll('table');
            
            for (let table of tables) {
                const tableText = table.textContent || '';
                // 檢查表格是否包含日期格式的內容（YYYY-MM-DD）
                if (tableText.includes('播放數') || tableText.includes('觀看數') || 
                    tableText.includes('點擊數') || tableText.includes('觀看率') ||
                    tableText.includes('曝光數') || tableText.includes('點擊率') ||
                    /\d{4}-\d{2}-\d{2}/.test(tableText)) {
                    dailyReportTable = table;
                    break;
                }
            }
        }
        
        return dailyReportTable;
    }
    
    // 根據走期設定處理表格內容
    function processTableBySchedule(table, campaignEndDate, currentDate) {
        const clonedTable = table.cloneNode(true);
        const rows = clonedTable.querySelectorAll('tr');
        
        if (rows.length < 2) return clonedTable; // 如果沒有數據行，直接返回
        
        // 轉換日期格式用於比較
        const campaignEnd = new Date(campaignEndDate);
        const current = new Date(currentDate);
        
        // 解析現有數據
        const tableData = [];
        const headers = [];
        let totalRow = null;
        
        // 獲取表頭
        const headerCells = rows[0].querySelectorAll('th, td');
        for (let cell of headerCells) {
            headers.push(cell.textContent.trim());
        }
        
        // === 新增：若表頭缺「星期」，插入後續自動補值 ===
        let needInsertWeekCol = true;
        headers.forEach(h => {
            if (h.includes('星期') || h.includes('週')) needInsertWeekCol = false;
        });
        if (needInsertWeekCol) {
            headers.splice(1, 0, '星期'); // 日期後插一欄
        }
        
        // 解析數據行，跳過TOTAL行
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length > 0) {
                const firstCellText = cells[0].textContent.trim();
                
                if (firstCellText === 'TOTAL') {
                    // 保存TOTAL行供後續使用
                    totalRow = row.cloneNode(true);
                    continue;
                }
                
                // 嘗試解析日期格式
                let rowDate = null;
                const dateText = firstCellText;
                
                // 格式解析邏輯
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                    rowDate = new Date(dateText);
                } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                    const [month, day] = dateText.split('/');
                    rowDate = new Date(current.getFullYear(), parseInt(month) - 1, parseInt(day));
                } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                    const [month, day] = dateText.split('-');
                    rowDate = new Date(current.getFullYear(), parseInt(month) - 1, parseInt(day));
                }
                
                if (rowDate) {
                    const rowData = [];
                    for (let j = 0; j < cells.length; j++) {
                        rowData.push(cells[j].textContent.trim());
                    }
                    // after rowData push 完
                    if (needInsertWeekCol) {
                        const weekStr = getWeekdayInChinese(rowDate);
                        rowData.splice(1, 0, weekStr); // 把星期填到第 2 格
                    }
                    tableData.push({
                        date: rowDate,
                        dateText: dateText,
                        data: rowData,
                        hasData: true
                    });
                }
            }
        }
        
        // 生成完整的日期範圍（從最早的數據日期到走期結束日期）
        let startDate = null;
        let endDate = campaignEnd;
        
        if (tableData.length > 0) {
            // 找到最早的數據日期
            startDate = new Date(Math.min(...tableData.map(item => item.date.getTime())));
            
            // 如果有數據的最後日期晚於走期結束日期，則擴展到該日期
            const lastDataDate = new Date(Math.max(...tableData.map(item => item.date.getTime())));
            if (lastDataDate > endDate) {
                endDate = lastDataDate;
            }
        } else {
            // 如果沒有現有數據，從當前日期開始到走期結束
            startDate = current;
        }
        
        // 生成完整的日期序列
        const completeData = [];
        const currentDateIter = new Date(startDate);
        
        while (currentDateIter <= endDate) {
            const dateStr = formatDateToMatch(currentDateIter, tableData.length > 0 ? tableData[0].dateText : null);
            const weekday = getWeekdayInChinese(currentDateIter);
            
            // 檢查是否有現有數據
            const existingData = tableData.find(item => 
                item.date.getTime() === currentDateIter.getTime()
            );
            
            if (existingData) {
                // 使用現有數據
                completeData.push(existingData);
            } else {
                // 創建空白行
                const emptyRowData = [dateStr, weekday];
                
                // 根據表頭數量填充空白欄位
                for (let i = 2; i < headers.length; i++) {
                    emptyRowData.push('');
                }
                
                completeData.push({
                    date: new Date(currentDateIter),
                    dateText: dateStr,
                    data: emptyRowData,
                    hasData: false
                });
            }
            
            // 移到下一天
            currentDateIter.setDate(currentDateIter.getDate() + 1);
        }
        
        // 重新構建表格
        const newTable = document.createElement('table');
        newTable.className = clonedTable.className;
        
        // 添加表頭
        const headerRow = document.createElement('tr');
        for (let header of headers) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);
        
        // 添加數據行
        for (let item of completeData) {
            const row = document.createElement('tr');
            
            for (let i = 0; i < item.data.length; i++) {
                const cell = document.createElement('td');
                
                if (!item.hasData && i >= 2) {
                    // 對於空白數據，顯示特殊標記
                    if (item.date > current) {
                        cell.innerHTML = '<span style="color: #ccc;">—</span>';
                        cell.style.backgroundColor = '#f8f9fa';
                    } else if (item.date > campaignEnd) {
                        cell.innerHTML = '<span style="color: #ccc;">—</span>';
                        cell.style.backgroundColor = '#fff3cd';
                    } else {
                        cell.innerHTML = '<span style="color: #ccc;">—</span>';
                        cell.style.backgroundColor = '#f8f9fa';
                    }
                } else {
                    cell.textContent = item.data[i] || '';
                }
                
                row.appendChild(cell);
            }
            
            // 添加未到期的視覺標示
            if (!item.hasData) {
                if (item.date > current) {
                    row.style.backgroundColor = '#f8f9fa';
                    row.style.opacity = '0.6';
                    row.firstChild.innerHTML += ' <span style="color: #ffc107;"></span>';
                } else if (item.date > campaignEnd) {
                    row.style.backgroundColor = '#fff3cd';
                    row.style.opacity = '0.8';
                    row.firstChild.innerHTML += ' <span style="color: #dc3545;">📅</span>';
                }
            }
            
            newTable.appendChild(row);
        }
        
        // 添加TOTAL行
        if (totalRow) {
            newTable.appendChild(totalRow);
        }
        
        return newTable;
    }
    
    // 輔助函數：格式化日期以匹配現有格式
    function formatDateToMatch(date, sampleDateText) {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        
        if (!sampleDateText) {
            return `${month}/${day}`;
        }
        
        // 根據樣本格式決定輸出格式
        if (sampleDateText.includes('-')) {
            if (sampleDateText.length > 5) {
                // YYYY-MM-DD 格式
                return `${date.getFullYear()}-${month}-${day}`;
            } else {
                // MM-DD 格式
                return `${month}-${day}`;
            }
        } else {
            // MM/DD 格式
            return `${month}/${day}`;
        }
    }
    
    // 輔助函數：獲取中文星期
    function getWeekdayInChinese(date) {
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        return weekdays[date.getDay()];
    }
    
    // 初始化預設日期
    setDefaultDates();
    
    // 啟用導出按鈕
    function enableExportButton() {
        const exportBtn = document.getElementById('exportExcel');
        exportBtn.disabled = false;
    }
    
    // 產出 Excel 報表
    async function exportToExcel() {
        if (!currentReportData) {
            alert('請先取得報表資料');
            return;
        }

        try {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('廣告報表');
            
            // 設定欄寬
            worksheet.columns = [
                { width: 4, },   // A 外框
                { width: 12 },  // B 日期
                { width: 15 },   // C 星期
                { width: 15 },  // D 曝光
                { width: 20 },  // E 點擊
                { width: 28 },  // F CTR
                { width: 15 },  // G cut1
                { width: 15 },  // H cut2
                { width: 15 },  // I 文案
                { width: 15 }   // J 空白
            ];
            
            worksheet.properties.defaultRowHeight = 26;

            // 定義樣式物件
            const styles = {
                header: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                orangeHeader: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE67E22' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                normal: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        size: 13 
                    },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                total: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFDA66' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                redFont: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        bold: true, 
                        color: { argb: 'FFFF0000' }, 
                        size: 13 
                    },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                grayBg: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                whiteBg: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                emptyRow: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        color: { argb: 'FF999999' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8F9FA' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                yellowBg: {
                    font: { 
                        name: 'Helvetica',    // ★ 加上這行
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF2CB' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                }
            };

            // 樣式套用輔助函數
            function applyStyle(cell, style) {
                if (style.font) cell.font = style.font;
                if (style.fill) cell.fill = style.fill;
                if (style.alignment) cell.alignment = style.alignment;
                if (style.border) cell.border = style.border;
            }

            // 取得廣告集資訊
            const adsetInfo = currentAdsetInfo || {};
            const pricing = adsetInfo.pricing || { bMode: 'CPC', price: 7.0, currency: 'TWD' };
            const info = adsetInfo.info || { name: '未知活動', adType: '原生互動廣告', budget: 0 };
            
            const activityName = info.name || '請填入活動名稱';
            let adTypeDisplay = info.adType || 'NATIVE';
            if (adTypeDisplay === 'NATIVE') {
                adTypeDisplay = '原生廣告';
            }
            const totalBudget = info.parsedBudget > 0 ? info.parsedBudget : (info.budget || 10000);
            const pricingMode = pricing.bMode || 'CPC';
            const pricingPrice = pricing.price || 7.0;
            const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
            
            // 計算走期相關數據
            const campaignEndDate = currentReportData.campaignEndDate;
            const currentDate = currentReportData.currentDate;
            let remainingDays = 0;
            let isOngoing = true;
            
            if (campaignEndDate && currentDate) {
                const endDate = new Date(campaignEndDate);
                const today = new Date(currentDate);
                const timeDiff = endDate.getTime() - today.getTime();
                remainingDays = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                isOngoing = remainingDays > 0;
            }

            // 解析表格數據
            const trs = currentReportData.table.querySelectorAll('tr');
            const headerRow = trs[0];
            const headers = Array.from(headerRow.querySelectorAll('th,td')).map(h => h.textContent.trim());
            
            // 分析表格結構
            let dateIndex = -1, weekIndex = -1, impIndex = -1, clkIndex = -1, ctrIndex = -1;
            let cutIndices = [];
            let textIndex = -1;
            
            headers.forEach((header, index) => {
                if (header.includes('日期')) dateIndex = index;
                else if (header.includes('星期') || header.includes('週')) weekIndex = index;
                else if (header.includes('曝光數') || header.includes('播放數')) impIndex = index;
                else if (header.includes('點擊數')) clkIndex = index;
                else if (header.includes('點擊率') || header.includes('觀看率')) ctrIndex = index;
                else if (header.includes('文案')) textIndex = index;
                else if (header.includes('cut')) {
                    cutIndices.push({index: index, cutNum: header});
                }
            });
            
            // 處理數據並計算總計
            const dataRows = [];
            let sumImp = 0, sumClk = 0, sumTxt = 0;
            const cutSums = {};
            
            for (let i = 1; i < trs.length; i++) {
                const td = trs[i].querySelectorAll('td,th');
                if (td.length < 2) continue;
                
                const date = dateIndex >= 0 ? td[dateIndex].textContent.trim() : td[0].textContent.trim();
                if (date === 'TOTAL') continue;
                
                // 檢查是否為空白行
                let isEmptyRow = false;
                if (td.length > 2) {
                    const dataCell = td[2];
                    const cellContent = dataCell.textContent.trim();
                    const cellHTML = dataCell.innerHTML.trim();
                    
                    if (cellHTML.includes('color: #ccc') || cellContent === '—' || cellContent === '') {
                        isEmptyRow = true;
                    }
                }
                
                // 提取數據
                let imp = 0, clk = 0, ctr = '', txt = 0;
                const cutValues = {};
                
                if (!isEmptyRow) {
                    if (impIndex >= 0) imp = +(td[impIndex].textContent.replace(/[,—]/g,'')) || 0;
                    if (clkIndex >= 0) clk = +(td[clkIndex].textContent.replace(/[,—]/g,'')) || 0;
                    if (ctrIndex >= 0) ctr = td[ctrIndex].textContent.trim();
                    if (textIndex >= 0) txt = +(td[textIndex].textContent.replace(/[,—]/g,'')) || 0;
                    
                    cutIndices.forEach(cutInfo => {
                        const cutValue = +(td[cutInfo.index].textContent.replace(/[,—]/g,'')) || 0;
                        cutValues[cutInfo.cutNum] = cutValue;
                        if (!cutSums[cutInfo.cutNum]) cutSums[cutInfo.cutNum] = 0;
                        cutSums[cutInfo.cutNum] += cutValue;
                    });
                    
                    sumImp += imp;
                    sumClk += clk;
                    sumTxt += txt;
                }

                dataRows.push({
                    date,
                    isEmpty: isEmptyRow,
                    imp,
                    clk,
                    ctr,
                    cutValues,
                    txt,
                    weekday: weekIndex >= 0 && !isEmptyRow ? td[weekIndex].textContent.trim() : '',
                    originalRow: td
                });
            }

            // 計算剩餘數據
            let targetUnit = 'clicks', targetCount = 0, remainingLabel = '剩餘點擊數';
            let remainingAmount = 0, remainingBudget = 0;
            
            if (pricingMode === 'CPM') {
                targetUnit = 'impressions';
                remainingLabel = '剩餘曝光數';
                targetCount = Math.floor((totalBudget / pricingPrice) * 1000);
                remainingBudget = totalBudget - ((sumImp * pricingPrice) / 1000);
                remainingAmount = Math.floor((remainingBudget / pricingPrice) * 1000);
            } else if (pricingMode === 'CPV') {
                targetUnit = 'views';
                remainingLabel = '剩餘觀看數';
                targetCount = Math.floor(totalBudget / pricingPrice);
                remainingBudget = totalBudget - (sumClk * pricingPrice);
                remainingAmount = Math.floor(remainingBudget / pricingPrice);
            } else {
                targetUnit = 'clicks';
                remainingLabel = '剩餘點擊數';
                targetCount = Math.floor(totalBudget / pricingPrice);
                remainingBudget = totalBudget - (sumClk * pricingPrice);
                remainingAmount = Math.floor(remainingBudget / pricingPrice);
            }
            
            const remainingDailyValue = (remainingDays > 0 && remainingAmount > 0) ? 
                Math.ceil(Math.max(0, remainingAmount) / remainingDays) : 0;

            // === 開始建構 Excel 內容 ===

            // 1. 插入 Logo 圖片
            let logoInserted = false;
            
            // 嘗試載入本地 logo 圖片
            try {
                const response = await fetch('/static/images/logo.png');
                if (response.ok) {
                    const imageBuffer = await response.arrayBuffer();
                    const imageId = workbook.addImage({
                        buffer: imageBuffer,
                        extension: 'jpeg',
                    });
                    
                    // 在 B2:C3 區域插入圖片，調整尺寸適應儲存格
                    worksheet.addImage(imageId, {
                        tl: { col: 1, row: 1 }, // B2 (從0開始計算)
                        ext: { width: 200, height: 60 } // 調整為適合的大小 (原圖 300x300 縮放)
                    });
                    logoInserted = true;
                    console.log('✅ Logo 圖片載入成功');
                }
            } catch (error) {
                console.warn('⚠️ 本地 logo 圖片載入失敗:', error);
            }
            
            // 如果本地圖片載入失敗，嘗試 CDN 備案
            if (!logoInserted) {
                try {
                    // 如果您有 CDN URL，請在這裡替換
                    const cdnUrl = 'https://static.ottercdn.com/trek/media/e19b2b54-641e-4519-a34f-a84deeea878e.png'; // 請替換為您的 CDN URL，例如: 'https://your-cdn.com/logo.jpeg'
                    
                    if (cdnUrl) {
                        console.log('🔄 嘗試 CDN 備案...', cdnUrl);
                        const response = await fetch(cdnUrl);
                        if (response.ok) {
                            const imageBuffer = await response.arrayBuffer();
                            const imageId = workbook.addImage({
                                buffer: imageBuffer,
                                extension: 'jpeg',
                            });
                            
                            worksheet.addImage(imageId, {
                                tl: { col: 1, row: 1 },
                                ext: { width: 80, height: 40 }
                            });
                            logoInserted = true;
                            console.log('✅ CDN Logo 圖片載入成功');
                        }
                    } else {
                        console.log('💡 提示：如需使用 CDN 圖片，請設定 cdnUrl 變數');
                    }
                } catch (cdnError) {
                    console.warn('⚠️ CDN logo 圖片載入失敗:', cdnError);
                }
            }
            
            // 如果圖片都載入失敗，在 Logo 區域放入文字
            if (!logoInserted) {
                worksheet.getCell('B2').value = 'ASEAL';
                applyStyle(worksheet.getCell('B2'), styles.grayBg);
                worksheet.getCell('B2').font = { bold: true, size: 14 };
                console.log('📝 使用文字 Logo 備案');
            }

            // 2. 頂部資訊區域（第2-3行）
            worksheet.getCell('D2').value = '活動名稱';
            applyStyle(worksheet.getCell('D2'), styles.grayBg);
            worksheet.getCell('E2').value = activityName;
            applyStyle(worksheet.getCell('E2'), styles.whiteBg);
            worksheet.getCell('G2').value = '總預算';
            applyStyle(worksheet.getCell('G2'), styles.grayBg);
            worksheet.getCell('H2').value = `${currency}${totalBudget.toLocaleString()}`;
            applyStyle(worksheet.getCell('H2'), styles.whiteBg);

            worksheet.getCell('D3').value = '廣告類型';
            applyStyle(worksheet.getCell('D3'), styles.grayBg);
            worksheet.getCell('E3').value = adTypeDisplay;
            applyStyle(worksheet.getCell('E3'), styles.whiteBg);
            worksheet.getCell('G3').value = '走期預算';
            applyStyle(worksheet.getCell('G3'), styles.grayBg);
            worksheet.getCell('H3').value = `${currency}${totalBudget.toLocaleString()}`;
            applyStyle(worksheet.getCell('H3'), styles.whiteBg);
            worksheet.getCell('H3').font = { bold: true, size: 13, name: 'Helvetica' };

            // 合併儲存格
            worksheet.mergeCells('B2:C3'); // Logo 區域
            worksheet.mergeCells('E2:F2'); // 活動名稱值
            worksheet.mergeCells('E3:F3'); // 廣告類型值

            // 3. 剩餘數據行（第4-5行，往右移一欄）
            worksheet.getCell('B4').value = '剩餘天數';
            applyStyle(worksheet.getCell('B4'), styles.grayBg);
            worksheet.getCell('C4').value = `(${remainingDays})`;
            applyStyle(worksheet.getCell('C4'), styles.redFont);
            worksheet.getCell('D4').value = '計價方式';
            applyStyle(worksheet.getCell('D4'), styles.grayBg);
            worksheet.getCell('E4').value = pricingMode;
            applyStyle(worksheet.getCell('E4'), styles.whiteBg);
            worksheet.getCell('F4').value = `${currency}${pricingPrice}`;
            applyStyle(worksheet.getCell('F4'), styles.whiteBg);
            worksheet.getCell('G4').value = '剩餘花費';
            applyStyle(worksheet.getCell('G4'), styles.grayBg);
            worksheet.getCell('H4').value = isOngoing ? 
                `${currency}${Math.max(0, remainingBudget).toLocaleString()}` : '(已結束)';
            applyStyle(worksheet.getCell('H4'), styles.redFont);

            worksheet.getCell('B5').value = '剩餘每日';
            applyStyle(worksheet.getCell('B5'), styles.grayBg);
            worksheet.getCell('C5').value = remainingDailyValue;
            applyStyle(worksheet.getCell('C5'), styles.redFont);
            worksheet.getCell('D5').value = '廣告目標';
            applyStyle(worksheet.getCell('D5'), styles.grayBg);
            worksheet.getCell('E5').value = targetCount.toLocaleString();
            applyStyle(worksheet.getCell('E5'), styles.whiteBg);
            worksheet.getCell('F5').value = targetUnit;
            applyStyle(worksheet.getCell('F5'), styles.whiteBg);
            worksheet.getCell('G5').value = remainingLabel;
            applyStyle(worksheet.getCell('G5'), styles.grayBg);
            worksheet.getCell('H5').value = isOngoing ? Math.max(0, remainingAmount) : '0';
            applyStyle(worksheet.getCell('H5'), styles.redFont);

            // 4. 表頭（第7行）
            const tableStartRow = 7;
            for (let i = 0; i < headers.length; i++) {
                const cell = worksheet.getCell(tableStartRow, i + 2); // 從B欄開始
                cell.value = headers[i];
                applyStyle(cell, (i < 5) ? styles.header : styles.orangeHeader);
            }

            // 5. 數據行
            let currentRow = tableStartRow + 1;
            for (const rowData of dataRows) {
                // 日期欄（B）
                const dateCell = worksheet.getCell(currentRow, 2);
                dateCell.value = rowData.date;
                applyStyle(dateCell, rowData.isEmpty ? styles.emptyRow : styles.normal);

                // 星期欄（C）
                const weekCell = worksheet.getCell(currentRow, 3);
                if (rowData.weekday) weekCell.value = rowData.weekday;
                applyStyle(weekCell, rowData.isEmpty ? styles.emptyRow : styles.normal);

                // 其他數據欄
                let colIndex = 4; // 從D欄開始（曝光數）
                for (let i = 2; i < headers.length; i++) { // 跳過日期、星期
                    const cell = worksheet.getCell(currentRow, colIndex);
                    const header = headers[i];
                    
                    if (!rowData.isEmpty) {
                        if (header.includes('曝光數') || header.includes('播放數')) {
                            if (rowData.imp > 0) cell.value = rowData.imp;
                        } else if (header.includes('點擊數')) {
                            if (rowData.clk > 0) cell.value = rowData.clk;
                        } else if (header.includes('點擊率') || header.includes('觀看率')) {
                            if (rowData.ctr) cell.value = rowData.ctr;
                        } else if (header.includes('cut')) {
                            const cutValue = rowData.cutValues[header];
                            if (cutValue > 0) cell.value = cutValue;
                        } else if (header.includes('文案')) {
                            if (rowData.txt > 0) cell.value = rowData.txt;
                        } else if (rowData.originalRow[i]) {
                            const cellValue = rowData.originalRow[i].textContent.trim();
                            if (cellValue && cellValue !== '—') cell.value = cellValue;
                        }
                    }
                    
                    applyStyle(cell, rowData.isEmpty ? styles.emptyRow : styles.normal);
                    colIndex++;
                }
                currentRow++;
            }

            // 6. TOTAL 行
            const totalRow = currentRow;
            const totCtr = sumImp ? ((sumClk / sumImp) * 100).toFixed(2) + '%' : '0.00%';

            worksheet.getCell(totalRow, 2).value = 'TOTAL';
            applyStyle(worksheet.getCell(totalRow, 2), styles.total);
            applyStyle(worksheet.getCell(totalRow, 3), styles.total); // 空白星期欄

            // TOTAL 行數據
            let colIndex = 4;
            for (let i = 2; i < headers.length; i++) {
                const cell = worksheet.getCell(totalRow, colIndex);
                const header = headers[i];
                
                if (header.includes('曝光數') || header.includes('播放數')) {
                    cell.value = sumImp;
                    applyStyle(cell, styles.total); // 改為統一的 total 樣式
                } else if (header.includes('點擊數')) {
                    cell.value = sumClk;
                    applyStyle(cell, styles.total);
                } else if (header.includes('點擊率') || header.includes('觀看率')) {
                    cell.value = totCtr;
                    applyStyle(cell, styles.total);
                    cell.font = { bold: true, color: { argb: 'FFFF0000' }, size: 13, name: 'Helvetica' }; // 保持紅色字體
                } else if (header.includes('cut')) {
                    cell.value = cutSums[header] || 0;
                    applyStyle(cell, styles.total);
                } else if (header.includes('文案')) {
                    cell.value = sumTxt;
                    applyStyle(cell, styles.total);
                } else {
                    applyStyle(cell, styles.total);
                }
                colIndex++;
            }

            /* === 6. 產出檔案 (瀏覽器用 writeBuffer) =================== */
            const buffer = await workbook.xlsx.writeBuffer({ useStyles: true });
            const blob   = new Blob([buffer], {
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });
            const url  = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `廣告報表_${currentReportData.setId.slice(0,8)}_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // 顯示成功訊息
            const totalDataRows = dataRows.length;
            const hasDataRows = dataRows.filter(row => !row.isEmpty).length;
            const emptyRows = totalDataRows - hasDataRows;
            
            let successMessage = `✅ Excel 報表已成功產出！檔案已下載。`;
            
            if (currentAdsetInfo && currentAdsetInfo.success) {
                const budgetSource = info.parsedBudget > 0 ? '從活動名稱解析' : '使用原始預算';
                const scheduleInfo = remainingDays > 0 ? `剩餘 ${remainingDays} 天` : '活動已結束';
                successMessage += `\n📊 已套用完整樣式和廣告集資訊：\n- 計價方式：${pricingMode}\n- 價格：${currency}${pricingPrice}\n- 活動名稱：${activityName}\n- 預算：${currency}${totalBudget.toLocaleString()} (${budgetSource})\n- 走期狀態：${scheduleInfo}\n📅 數據統計：${hasDataRows} 筆實際數據，${emptyRows} 筆空白日期`;
            }
            alert(successMessage);

        } catch (err) {
            console.error('產出 Excel 報表失敗:', err);
            alert('❌ 產出 Excel 報表失敗：' + err.message);
        }
    }

    // 建構 slide 廣告報表表格（包含 cut 數據）
    function buildSlideReportTable(originalTable, cutData) {
        // 解析原始表格
        const rows = originalTable.querySelectorAll('tr');
        if (rows.length < 2) return originalTable;

        // 解析表頭
        const originalHeaders = Array.from(rows[0].querySelectorAll('th, td')).map(h => h.textContent.trim());
        
        // 找出各欄位的索引位置
        let dateIndex = -1, impIndex = -1, clkIndex = -1, ctrIndex = -1;
        originalHeaders.forEach((header, index) => {
            if (header.includes('日期')) dateIndex = index;
            else if (header.includes('曝光數') || header.includes('播放數')) impIndex = index;
            else if (header.includes('點擊數')) clkIndex = index;
            else if (header.includes('點擊率') || header.includes('觀看率')) ctrIndex = index;
        });

        // 分析所有 AdUnit 的 cut 數量，找出最大值
        let maxCuts = 0;
        for (const uuid in cutData) {
            const data = cutData[uuid].data;
            if (data.success) {
                const cutKeys = Object.keys(data.success).filter(key => !isNaN(key));
                maxCuts = Math.max(maxCuts, cutKeys.length);
            }
        }

        // 建構新的表頭
        const newHeaders = ['日期', '星期', '曝光數', '點擊數', '點擊率'];
        for (let i = 1; i <= maxCuts; i++) {
            newHeaders.push(`cut${i}`);
        }
        newHeaders.push('文案');

        // 建構新表格
        const newTable = document.createElement('table');
        newTable.className = originalTable.className;

        // 添加表頭
        const headerRow = document.createElement('tr');
        for (let header of newHeaders) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);

        // 處理數據行
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length === 0) continue;

            const dateText = dateIndex >= 0 ? cells[dateIndex].textContent.trim() : cells[0].textContent.trim();
            
            // 跳過 TOTAL 行（稍後處理）
            if (dateText === 'TOTAL') continue;

            // 解析日期
            let rowDate = null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
            } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('/');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
            } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('-');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
            }

            // 取得原始數據
            const imp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const clk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const ctr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';

            // 計算當天的 cut 數據總和
            const cutTotals = new Array(maxCuts).fill(0);
            const formattedDate = rowDate ? formatDateForCutData(rowDate) : null;

            if (formattedDate) {
                for (const uuid in cutData) {
                    const data = cutData[uuid].data;
                    if (data.success) {
                        for (let cutNum = 1; cutNum <= maxCuts; cutNum++) {
                            const cutKey = cutNum.toString();
                            if (data.success[cutKey]) {
                                const dayData = data.success[cutKey].find(d => d._id === formattedDate);
                                if (dayData) {
                                    cutTotals[cutNum - 1] += dayData.totalCount;
                                }
                            }
                        }
                    }
                }
            }

            // 計算文案數量：總點擊數 - 所有 cut 的總和
            const totalCutClicks = cutTotals.reduce((sum, cut) => sum + cut, 0);
            const textClicks = Math.max(0, clk - totalCutClicks);

            // 建構新的數據行
            const newRow = document.createElement('tr');
            
            // 日期
            const dateCell = document.createElement('td');
            dateCell.textContent = dateText;
            newRow.appendChild(dateCell);

            // 星期
            const weekCell = document.createElement('td');
            weekCell.textContent = rowDate ? getWeekdayInChinese(rowDate) : '';
            newRow.appendChild(weekCell);

            // 曝光數
            const impCell = document.createElement('td');
            impCell.textContent = imp > 0 ? imp.toLocaleString() : '';
            newRow.appendChild(impCell);

            // 點擊數
            const clkCell = document.createElement('td');
            clkCell.textContent = clk > 0 ? clk : '';
            newRow.appendChild(clkCell);

            // 點擊率
            const ctrCell = document.createElement('td');
            ctrCell.textContent = ctr;
            newRow.appendChild(ctrCell);

            // Cut 數據
            for (let i = 0; i < maxCuts; i++) {
                const cutCell = document.createElement('td');
                cutCell.textContent = cutTotals[i] > 0 ? cutTotals[i] : '';
                newRow.appendChild(cutCell);
            }

            // 文案
            const textCell = document.createElement('td');
            textCell.textContent = textClicks > 0 ? textClicks : '';
            newRow.appendChild(textCell);

            newTable.appendChild(newRow);
        }

        // 處理 TOTAL 行
        const totalRow = Array.from(rows).find(row => {
            const cells = row.querySelectorAll('td, th');
            return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
        });

        if (totalRow) {
            const cells = totalRow.querySelectorAll('td, th');
            const totalImp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const totalClk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const totalCtr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';

            // 計算總計 cut 數據
            const totalCutTotals = new Array(maxCuts).fill(0);
            for (const uuid in cutData) {
                const data = cutData[uuid].data;
                if (data.success) {
                    for (let cutNum = 1; cutNum <= maxCuts; cutNum++) {
                        const cutKey = cutNum.toString();
                        if (data.success[cutKey]) {
                            const cutTotal = data.success[cutKey].reduce((sum, d) => sum + d.totalCount, 0);
                            totalCutTotals[cutNum - 1] += cutTotal;
                        }
                    }
                }
            }

            const totalCutClicks = totalCutTotals.reduce((sum, cut) => sum + cut, 0);
            const totalTextClicks = Math.max(0, totalClk - totalCutClicks);

            const newTotalRow = document.createElement('tr');
            
            // TOTAL 標籤
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = 'TOTAL';
            newTotalRow.appendChild(totalLabelCell);

            // 空白星期欄
            const emptyWeekCell = document.createElement('td');
            emptyWeekCell.textContent = '';
            newTotalRow.appendChild(emptyWeekCell);

            // 總曝光數
            const totalImpCell = document.createElement('td');
            totalImpCell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
            newTotalRow.appendChild(totalImpCell);

            // 總點擊數
            const totalClkCell = document.createElement('td');
            totalClkCell.textContent = totalClk > 0 ? totalClk : '';
            newTotalRow.appendChild(totalClkCell);

            // 總點擊率
            const totalCtrCell = document.createElement('td');
            totalCtrCell.textContent = totalCtr;
            newTotalRow.appendChild(totalCtrCell);

            // 總 Cut 數據
            for (let i = 0; i < maxCuts; i++) {
                const totalCutCell = document.createElement('td');
                totalCutCell.textContent = totalCutTotals[i] > 0 ? totalCutTotals[i] : '';
                newTotalRow.appendChild(totalCutCell);
            }

            // 總文案
            const totalTextCell = document.createElement('td');
            totalTextCell.textContent = totalTextClicks > 0 ? totalTextClicks : '';
            newTotalRow.appendChild(totalTextCell);

            newTable.appendChild(newTotalRow);
        }

        return newTable;
    }

    // 格式化日期用於 cut 數據查詢
    function formatDateForCutData(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // 添加報表訊息
    function addReportMessages(container, campaignEndDate, currentDate) {
        // 添加成功訊息
        const successMsg = document.createElement('div');
        successMsg.className = 'cookie-status cookie-success';
        successMsg.innerHTML = `✓ 每日報表載入成功！${isSlideAd ? ' (含 Cut 分析數據)' : ''}`;
        container.insertBefore(successMsg, container.firstChild);
        
        // 顯示 slide 廣告資訊
        if (isSlideAd && Object.keys(currentCutData).length > 0) {
            const slideMsg = document.createElement('div');
            slideMsg.className = 'cookie-status';
            slideMsg.style.backgroundColor = '#e1f5fe';
            slideMsg.style.borderColor = '#29b6f6';
            slideMsg.style.color = '#01579b';
            
            const adunitCount = Object.keys(currentCutData).length;
            const adunitNames = Object.values(currentCutData).map(item => 
                item.adunit.title || item.adunit.name || 'Untitled'
            ).join(', ');
            
            slideMsg.innerHTML = `🎬 Slide 廣告資訊：找到 ${adunitCount} 個 AdUnit<br>AdUnit 名稱：${adunitNames}`;
            container.insertBefore(slideMsg, container.firstChild);
        }
        
        // 顯示走期資訊（強調是自動從 AdSet 取得）
        if (campaignEndDate && currentDate) {
            const scheduleMsg = document.createElement('div');
            scheduleMsg.className = 'cookie-status';
            scheduleMsg.style.backgroundColor = '#fff3cd';
            scheduleMsg.style.borderColor = '#ffeaa7';
            scheduleMsg.style.color = '#856404';
            scheduleMsg.innerHTML = `📅 走期設定：結束日期 ${campaignEndDate}（自動從 AdSet.toTime 取得），當前日期 ${currentDate}`;
            container.insertBefore(scheduleMsg, container.firstChild);
        } else if (campaignEndDate) {
            // 只有走期結束日期，沒有當前日期
            const scheduleMsg = document.createElement('div');
            scheduleMsg.className = 'cookie-status';
            scheduleMsg.style.backgroundColor = '#fff3cd';
            scheduleMsg.style.borderColor = '#ffeaa7';
            scheduleMsg.style.color = '#856404';
            scheduleMsg.innerHTML = `📅 走期設定：結束日期 ${campaignEndDate}（自動從 AdSet.toTime 取得）`;
            container.insertBefore(scheduleMsg, container.firstChild);
        }
        
        // 顯示廣告集資訊
        if (currentAdsetInfo && currentAdsetInfo.success) {
            const adsetInfoMsg = document.createElement('div');
            adsetInfoMsg.className = 'cookie-status';
            adsetInfoMsg.style.backgroundColor = '#e8f5e8';
            adsetInfoMsg.style.borderColor = '#4caf50';
            adsetInfoMsg.style.color = '#2e7d32';
            const pricing = currentAdsetInfo.pricing;
            const info = currentAdsetInfo.info;
            const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
            
            // 顯示預算解析資訊
            let budgetInfo = `${currency}${info.budget.toLocaleString()}`;
            if (info.parsedBudget > 0) {
                budgetInfo += ` (從活動名稱解析: ${currency}${info.parsedBudget.toLocaleString()})`;
            }
            
            // 顯示時間戳資訊
            let timestampInfo = '';
            if (info.fromTimestamp && info.toTimestamp) {
                const fromDate = new Date(info.fromTimestamp).toLocaleDateString('zh-TW');
                const toDate = new Date(info.toTimestamp).toLocaleDateString('zh-TW');
                timestampInfo = ` | 📅 走期：${fromDate} ~ ${toDate}`;
            }
            
            adsetInfoMsg.innerHTML = `
                📊 廣告集資訊：${info.name || '未知活動'} | 
                💰 計價方式：${pricing.bMode} (${currency}${pricing.price}) | 
                🎯 廣告類型：${info.adType || 'NATIVE'} | 
                💵 總預算：${budgetInfo}${timestampInfo}
            `;
            container.insertBefore(adsetInfoMsg, container.firstChild);
        }
        
        // 分析表格結構並顯示
        const table = container.querySelector('table');
        if (table) {
            const tableHeaders = Array.from(table.querySelectorAll('tr')[0].querySelectorAll('th,td')).map(h => h.textContent.trim());
            const structureMsg = document.createElement('div');
            structureMsg.className = 'cookie-status';
            structureMsg.style.backgroundColor = '#e3f2fd';
            structureMsg.style.borderColor = '#2196f3';
            structureMsg.style.color = '#1976d2';
            structureMsg.innerHTML = `📋 檢測到的表格欄位：${tableHeaders.join(' | ')}`;
            container.insertBefore(structureMsg, container.firstChild);
        }
    }
});
</script>
{% endblock %} 