{% extends "base.html" %}

{% block title %}GIF å»£å‘Šå»ºç«‹{% endblock %}

{% block page_title %} å»ºç«‹ GIF å»£å‘Š{% endblock %}

{% block additional_styles %}
<style>
    .clear-form-btn {
        background-color: #f44336;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 15px;
    }
    .clear-form-btn:hover {
        background-color: #d32f2f;
    }
    .main-content-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 20px;
    }
    .form-column {
        flex: 1;
        min-width: 0;
    }
    .preview-column {
        width: 300px;
        flex-shrink: 0;
        position: sticky;
        top: 20px;
    }
    .ad-preview-container {
        width: 300px;
        height: 250px;
        border: 2px solid #333;
        margin: 0;
        display: flex;
        flex-direction: column;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        background-color: #000;
        overflow: hidden;
    }
    .ad-preview-header {
        padding: 2px 8px;
        font-size: 12px;
        color: #cd9601;
        text-align: left;
    }
    .ad-preview-main {
        flex-grow: 1;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        height: 157px;
        background-color: #000;
    }
    #preview-background-img {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    #preview-background-placeholder {
        color: #888;
        font-size: 14px;
        padding: 10px;
    }
    .ad-preview-title {
        padding: 4px 8px;
        font-weight: bold;
        font-size: 14px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: white;
    }
    .ad-preview-subtitle {
        padding: 4px 8px;
        font-size: 12px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: gray;
    }
    .ad-preview-footer {
        display: flex;
        font-size: 12px;
    }
    .ad-preview-advertiser {
        flex-grow: 1;
        padding: 4px 8px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: gray;
    }
    .ad-preview-cta {
        padding: 4px 12px;
        font-weight: bold;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background-color: #0d6efd;
        color: white;
        border-radius: 5px;
        margin: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content-wrapper">
    <div class="form-column">
        <button type="button" id="clear-form-button" class="clear-form-btn">æ¸…é™¤æ‰€æœ‰å…§å®¹</button>

        <form action="{{ url_for('main.gif_ad') }}" method="post" id="ad-form">
            <div class="field-group">
                <h3>ğŸ“‹ åŸºæœ¬å»£å‘Šè³‡è¨Š</h3>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="adset_id">Adset ID <span class="required">*</span></label>
                        <input type="text" id="adset_id" name="adset_id" value="{{ adset_id or '' }}" required 
                               placeholder="ä¾‹å¦‚ï¼š00947c1b-f7cd-47c6-a23a-0639e9702cc7">
                        <div class="help-text">å»£å‘Šçµ„IDï¼Œå¿…å¡«</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="display_name">å»£å‘Šå–®å…ƒé¡¯ç¤ºåç¨±</label>
                        <input type="text" id="display_name" name="display_name" value="{{ display_name or '' }}" 
                               placeholder="åƒ…ä¾›å¾Œå°é¡¯ç¤ºä½¿ç”¨">
                        <div class="help-text">åƒ…é¡¯ç¤ºæ–¼å¾Œå°ï¼Œå¯é¸</div>
                    </div>
                </div>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="advertiser">å»£å‘Šå•† <span class="required">*</span></label>
                        <input type="text" id="advertiser" name="advertiser" value="{{ advertiser or '' }}" required 
                               placeholder="å»£å‘Šä¸»åç¨±">
                        <div class="help-text">å»£å‘Šä¸»åç¨±ï¼Œå¿…å¡«</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="main_title">ä¸»æ¨™é¡Œ <span class="required">*</span></label>
                        <input type="text" id="main_title" name="main_title" value="{{ main_title or '' }}" required 
                               placeholder="å»£å‘Šä¸»æ¨™é¡Œ">
                        <div class="help-text">å»£å‘Šä¸»æ¨™é¡Œï¼Œå¿…å¡«</div>
                    </div>
                </div>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="subtitle">æ–‡å­—æ•˜è¿°</label>
                        <input type="text" id="subtitle" name="subtitle" value="{{ subtitle or '' }}" 
                               placeholder="å»£å‘Šå‰¯æ¨™é¡Œï¼ˆå¯é¸ï¼‰">
                        <div class="help-text">å»£å‘Šå‰¯æ¨™é¡Œï¼Œå¯é¸</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="call_to_action">è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—</label>
                        <input type="text" id="call_to_action" name="call_to_action" value="{{ call_to_action or 'ç«‹å³è³¼è²·' }}" 
                               placeholder="ç«‹å³è³¼è²·">
                        <div class="help-text">CTAæŒ‰éˆ•æ–‡å­—ï¼Œé è¨­ç‚ºã€Œç«‹å³è³¼è²·ã€</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <label for="landing_page">åˆ°é”é é¢ç¶²å€ <span class="required">*</span></label>
                    <input type="url" id="landing_page" name="landing_page" placeholder="https://example.com" 
                           value="{{ landing_page or '' }}" required>
                    <div class="help-text">ç”¨æˆ¶é»æ“Šå»£å‘Šå¾Œè·³è½‰çš„ç¶²å€ï¼Œå¿…å¡«</div>
                </div>
            </div>

            <div class="field-group">
                <h3>å»£å‘Šç´ æ</h3>
                <p style="margin-bottom: 20px; color: #666; font-style: italic;">
                    æ‰€æœ‰åœ–ç‰‡å‡ç‚ºå¿…å¡«ã€‚è«‹æä¾›æœ¬åœ°å®Œæ•´æª”æ¡ˆè·¯å¾‘ï¼Œæˆ–ä½¿ç”¨ä¸Šå‚³åŠŸèƒ½ã€‚
                </p>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="image_path_m">å¤§å°ºå¯¸åœ–ç‰‡ 1200x628 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="image_path_m" name="image_path_m" 
                                   placeholder="/path/to/your/image_1200x628.jpg" 
                                   value="{{ image_path_m or '' }}" required>
                            <div class="help-text">å¤§å‹æ©«å¹…åœ–ç‰‡ï¼Œå°ºå¯¸1200x628åƒç´ </div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    ğŸ“ ä¸Šå‚³åœ–ç‰‡
                                    <input type="file" class="file-input" data-target="image_path_m" accept="image/*">
                                </label>
                                <img id="preview_m" class="upload-preview" style="display: none;" alt="é è¦½åœ–">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="image_path_s">å°å°ºå¯¸åœ–ç‰‡ 300x300 <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="text" id="image_path_s" name="image_path_s" 
                                   placeholder="/path/to/your/image_300x300.jpg" 
                                   value="{{ image_path_s or '' }}" required>
                            <div class="help-text">æ–¹å½¢åœ–ç‰‡ï¼Œå°ºå¯¸300x300åƒç´ </div>
                            <div class="preview-container">
                                <label class="custom-file-upload">
                                    ğŸ“ ä¸Šå‚³åœ–ç‰‡
                                    <input type="file" class="file-input" data-target="image_path_s" accept="image/*">
                                </label>
                                <img id="preview_s" class="upload-preview" style="display: none;" alt="é è¦½åœ–">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <label for="background_image">äº’å‹•å»£å‘Šå¢Šæª”èƒŒæ™¯ <span class="required">*</span></label>
                    <input type="text" id="background_image" name="background_image" 
                           placeholder="è«‹è¼¸å…¥èƒŒæ™¯åœ–ç‰‡ç¶²å€" value="{{ background_image or '' }}" required>
                    <div class="help-text">äº’å‹•å»£å‘Šå¢Šæª”èƒŒæ™¯åœ–ç‰‡ç¶²å€</div>
                </div>
            </div>

            <div class="field-group">
                <h3>äº’å‹•å»£å‘Šè¨­å®š</h3>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="background_url">èƒŒæ™¯åœ–ç‰‡ç¶²å€ <span class="required">*</span></label>
                        <input type="url" id="background_url" name="background_url" 
                               placeholder="https://example.com/background.webp" 
                               value="{{ background_url or '' }}" required>
                        <div class="help-text">èƒŒæ™¯åœ–ç‰‡çš„ç¶²å€ï¼Œå¿…å¡«</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="target_url">ç›®æ¨™ç¶²å€ <span class="required">*</span></label>
                        <input type="url" id="target_url" name="target_url" 
                               placeholder="https://example.com" 
                               value="{{ target_url or '' }}" required>
                        <div class="help-text">é»æ“Šå¾Œè·³è½‰çš„ç›®æ¨™ç¶²å€ï¼Œå¿…å¡«</div>
                    </div>
                </div>
                
                <input type="hidden" id="payload_game_widget" name="payload_game_widget">
            </div>
            
            <input type="submit" value="ğŸš€ å»ºç«‹ GIF å»£å‘Š">
        </form>
    </div>

    <div class="preview-column">
        <div class="field-group">
            <h3>ğŸ–¼ï¸ å»£å‘Šå³æ™‚é è¦½</h3>
            <div class="ad-preview-container">
                <div class="ad-preview-header">å»£å‘Š</div>
                <div class="ad-preview-main">
                    <img id="preview-background-img" src="" alt="èƒŒæ™¯é è¦½">
                    <span id="preview-background-placeholder">äº’å‹•å»£å‘Šè¨­å®š-èƒŒæ™¯åœ–ç‰‡ç¶²å€</span>
                </div>
                <div id="preview-main-title" class="ad-preview-title">ä¸»æ¨™é¡Œ</div>
                <div id="preview-subtitle" class="ad-preview-subtitle">æ–‡å­—æ•˜è¿°</div>
                <div class="ad-preview-footer">
                    <div id="preview-advertiser" class="ad-preview-advertiser">å»£å‘Šå•†</div>
                    <div id="preview-call-to-action" class="ad-preview-cta">è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    // GIF å»£å‘Šç‰¹æœ‰çš„ JavaScript å‡½æ•¸
    document.addEventListener('DOMContentLoaded', function() {
        // åœ¨é é¢åŠ è¼‰å®Œæˆå¾Œæ›´æ–° payload
        updateGameWidgetPayload();

        // æ·»åŠ äº‹ä»¶ç›£è½å™¨ï¼Œç•¶ç›¸é—œè¼¸å…¥æ”¹è®Šæ™‚æ›´æ–° payload
        document.getElementById('background_url').addEventListener('input', updateGameWidgetPayload);
        document.getElementById('target_url').addEventListener('input', updateGameWidgetPayload);
        
        // æ·»åŠ æ¸…é™¤è¡¨å–®æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
        document.getElementById('clear-form-button').addEventListener('click', function() {
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡«å¯«çš„å…§å®¹å—ï¼Ÿ')) {
                clearFormInputs();
            }
        });

        // åˆå§‹åŒ–é è¦½
        updateAdPreview();
        
        // ç›£è½è¡¨å–®è¼¸å…¥ä»¥æ›´æ–°é è¦½
        const inputsToTrack = ['advertiser', 'main_title', 'subtitle', 'call_to_action', 'background_url'];
        inputsToTrack.forEach(id => {
            document.getElementById(id).addEventListener('input', updateAdPreview);
        });
    });
    
    // æ¸…é™¤è¡¨å–®æ‰€æœ‰è¼¸å…¥æ¬„ä½çš„å‡½æ•¸
    function clearFormInputs() {
        // æ¸…é™¤æ–‡æœ¬è¼¸å…¥ã€URLã€æ•¸å­—è¼¸å…¥
        document.querySelectorAll('input[type="text"], input[type="url"], input[type="number"]').forEach(input => {
            input.value = '';
        });
        
        // æ¸…é™¤é è¦½åœ–ç‰‡
        document.querySelectorAll('.upload-preview').forEach(img => {
            img.style.display = 'none';
            img.src = '';
        });
        
        // æ¸…ç©º payload
        document.getElementById('payload_game_widget').value = '';
        
        // é‡æ–°è¨­ç½®é è¨­å€¼
        document.getElementById('call_to_action').value = 'ç«‹å³è³¼è²·';

        // æ›´æ–°é è¦½
        updateAdPreview();
    }

    function updateGameWidgetPayload() {
        const backgroundUrl = document.getElementById('background_url').value;
        const targetUrl = document.getElementById('target_url').value;

        if (!backgroundUrl || !targetUrl) return; // å¦‚æœå¿…è¦çš„è¼¸å…¥ç¼ºå¤±ï¼Œä¸æ›´æ–°

        const payload = {
            "type": "SIMPLE",
            "data": {
                "img_background": backgroundUrl
            },
            "invokes": [
                {
                    "action": "OPEN_EXTERNAL_BROWSER",
                    "payload": {
                        "url": targetUrl
                    }
                }
            ],
            "_sys": {
                "popupActionKeys": [
                    "a"
                ]
            }
        };

        document.getElementById('payload_game_widget').value = JSON.stringify(payload);
    }

    // æ›´æ–°å»£å‘Šé è¦½
    function updateAdPreview() {
        // å¾è¡¨å–®ç²å–å€¼ï¼Œå¦‚æœç‚ºç©ºå‰‡ä½¿ç”¨é è¨­æç¤ºæ–‡å­—
        const advertiser = document.getElementById('advertiser').value || 'å»£å‘Šå•†';
        const mainTitle = document.getElementById('main_title').value || 'ä¸»æ¨™é¡Œ';
        const subtitle = document.getElementById('subtitle').value || 'æ–‡å­—æ•˜è¿°';
        const callToAction = document.getElementById('call_to_action').value || 'è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—';
        const backgroundUrl = document.getElementById('background_url').value;

        // æ›´æ–°é è¦½ç•«é¢çš„æ–‡å­—å…§å®¹
        document.getElementById('preview-advertiser').textContent = advertiser;
        document.getElementById('preview-main-title').textContent = mainTitle;
        document.getElementById('preview-subtitle').textContent = subtitle;
        document.getElementById('preview-call-to-action').textContent = callToAction;

        // æ›´æ–°èƒŒæ™¯åœ–ç‰‡
        const bgImg = document.getElementById('preview-background-img');
        const bgPlaceholder = document.getElementById('preview-background-placeholder');
        if (backgroundUrl) {
            bgImg.src = backgroundUrl;
            bgImg.style.display = 'block';
            bgPlaceholder.style.display = 'none';
        } else {
            bgImg.src = '';
            bgImg.style.display = 'none';
            bgPlaceholder.style.display = 'block';
        }
    }

    // å¿«é€Ÿè³‡è¨Šè§£æå‡½æ•¸
    function parseInfoText(text) {
        try {
            // è§£æå»£å‘Šä¸»
            const advertiserMatch = text.match(/[-Â·]\s*å»£å‘Šä¸»[:ï¼š]\s*(.+)/);
            if (advertiserMatch) {
                document.getElementById('advertiser').value = advertiserMatch[1].trim();
            }

            // è§£ææ´»å‹•åç¨±ä½œç‚ºä¸»æ¨™é¡Œ
            const titleMatch = text.match(/[-Â·]\s*æ´»å‹•åç¨±[:ï¼š]\s*(.+)/);
            if (titleMatch) {
                document.getElementById('main_title').value = titleMatch[1].trim();
            }

            // è§£ææ¨™é¡Œ
            const headlineMatch = text.match(/[-Â·]\s*æ¨™é¡Œ[:ï¼š]\s*(.+)/);
            if (headlineMatch) {
                document.getElementById('subtitle').value = headlineMatch[1].trim();
            }

            // è§£æ CTA
            const ctaMatch = text.match(/[-Â·]\s*CTA[:ï¼š]\s*(.+)/);
            if (ctaMatch) {
                document.getElementById('call_to_action').value = ctaMatch[1].trim();
            }

            // è§£æå°é€£
            const landingMatch = text.match(/(?:å°é€£|åˆ°é”é é¢)[:ï¼š]\s*(https?:\/\/[^\s]+)/);
            if (landingMatch) {
                document.getElementById('landing_page').value = landingMatch[1].trim();
            }

            alert('âœ… è³‡è¨Šè§£æå®Œæˆï¼è«‹æª¢æŸ¥å¡«å…¥çš„å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚');
            
            // è§£æå¾Œæ›´æ–°é è¦½
            updateAdPreview();
        } catch (error) {
            console.error('è§£æéŒ¯èª¤:', error);
            alert('âŒ è§£æéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼ã€‚');
        }
    }
</script>
{% endblock %} 