# 專案重構指南

## 🎯 重構目標

將原本 1817 行的 `app.py` 重構為模組化的架構，提高程式碼的可維護性和可讀性。

## 📁 新的專案結構

```
ad-automation-scripts/
├── app/                    # 主要應用程式目錄
│   ├── __init__.py        # Flask 應用工廠
│   ├── models/            # 資料模型
│   │   ├── __init__.py
│   │   ├── database.py    # MongoDB 連接管理
│   │   └── adunit.py      # AdUnit 資料操作
│   ├── routes/            # 路由處理
│   │   ├── __init__.py    # 藍圖註冊
│   │   ├── main.py        # 主要路由
│   │   ├── native_ad.py   # 原生廣告路由
│   │   ├── screenshot.py  # 截圖路由
│   │   └── upload.py      # 檔案上傳路由
│   ├── services/          # 業務邏輯服務
│   │   ├── __init__.py
│   │   └── url_builder.py # URL 建構服務
│   ├── utils/             # 工具函數
│   │   ├── __init__.py
│   │   └── helpers.py     # 通用輔助函數
│   └── static/            # 靜態檔案
│       ├── css/
│       ├── js/
│       └── images/
├── templates/             # 模板檔案
├── uploads/               # 上傳檔案
├── logs/                  # 日誌檔案
├── run.py                 # 新的主要應用檔案
├── app.py                 # 原始檔案（保留作為參考）
├── app_original_backup.py # 原始檔案備份
├── start.sh               # 啟動腳本
└── requirements.txt       # 依賴套件
```

## 🔄 重構步驟

### 1. 已完成的重構

- ✅ 創建應用工廠模式 (`app/__init__.py`)
- ✅ 分離 MongoDB 連接邏輯 (`app/models/database.py`)
- ✅ 分離 AdUnit 資料操作 (`app/models/adunit.py`)
- ✅ 分離 URL 建構邏輯 (`app/services/url_builder.py`)
- ✅ 創建路由藍圖系統 (`app/routes/`)
- ✅ 分離原生廣告路由 (`app/routes/native_ad.py`)
- ✅ 分離截圖路由 (`app/routes/screenshot.py`)
- ✅ 分離檔案上傳路由 (`app/routes/upload.py`)
- ✅ 創建通用工具函數 (`app/utils/helpers.py`)
- ✅ 創建新的主要應用檔案 (`run.py`)
- ✅ 修復模板路徑配置問題
- ✅ 更新模板中的 URL 引用以使用藍圖端點格式
- ✅ 添加基本的其他廣告類型路由
- ✅ **完整移植 create-native-screenshot 路由**
- ✅ **修正模板中的 URL 引用問題**
- ✅ **測試並確認重構後的應用正常運作**

### 2. 重構過程中解決的問題

#### 問題 1: 模板路徑配置
**問題**: Flask 找不到模板檔案
**解決**: 在應用工廠中正確設置 `template_folder` 和 `static_folder` 路徑

#### 問題 2: URL 引用問題
**問題**: 模板中的 `url_for()` 需要更新為藍圖端點格式
**解決**: 更新 `base.html` 和 `native_ad.html` 中的 URL 引用（如 `url_for('main.batch')` 而非 `url_for('batch')`）

#### 問題 3: 缺少路由問題
**問題**: `/create-native-screenshot` 路由在重構後遺失
**解決**: 完整移植原始 `app.py` 中的複雜截圖邏輯到 `app/routes/screenshot.py`

### 3. 待完成的重構

- ⏳ 創建其他廣告類型的完整路由實現 (投票、GIF、滑動等)
- ⏳ 創建截圖服務類
- ⏳ 創建廣告創建服務類
- ⏳ 添加驗證器
- ⏳ 優化錯誤處理
- ⏳ 添加單元測試

## 🚀 如何使用新結構

### 啟動應用

```bash
# 使用啟動腳本
./start.sh

# 或使用新的主要檔案
python run.py

# 或者使用 Flask CLI
export FLASK_APP=run.py
flask run --port=5002
```

### 添加新功能

1. **新增路由**: 在 `app/routes/` 目錄下創建新的藍圖檔案
2. **新增服務**: 在 `app/services/` 目錄下創建業務邏輯
3. **新增模型**: 在 `app/models/` 目錄下創建資料操作
4. **新增工具**: 在 `app/utils/` 目錄下創建通用函數

## 📋 重構的好處

1. **模組化**: 每個功能都有獨立的檔案，易於維護
2. **可測試性**: 小的模組更容易進行單元測試
3. **可擴展性**: 新功能可以獨立開發而不影響現有功能
4. **團隊協作**: 多人可以同時開發不同模組
5. **程式碼重用**: 服務和工具函數可以在多處重用
6. **清晰的職責分離**: 每個檔案都有明確的職責

## 🔧 下一步建議

1. **逐步遷移**: 將剩餘的路由和功能逐步遷移到新結構
2. **添加測試**: 為每個模組添加單元測試
3. **文檔化**: 為每個服務和函數添加詳細的文檔
4. **配置管理**: 將配置項移到專門的配置檔案
5. **錯誤處理**: 統一錯誤處理機制
6. **日誌系統**: 改善日誌記錄和監控

## ⚠️ 注意事項

- 原始的 `app.py` 檔案保留作為參考，不要刪除
- 確保所有的 import 路徑都正確更新
- 測試所有功能確保重構後正常運作
- 逐步遷移，避免一次性改動太多

## 🧪 測試結果

重構完成後的測試結果：
- ✅ 應用正常啟動 (http://127.0.0.1:5002)
- ✅ 主頁重定向正常
- ✅ 原生廣告頁面正常載入
- ✅ Native 廣告截圖頁面正常載入
- ✅ 所有路由正常響應
- ✅ 模板渲染正常
- ✅ 藍圖系統運作正常

## 📊 重構成果

**重構前**: 
- 1 個巨大檔案 (1817 行)
- 難以維護和擴展
- 所有功能混雜在一起

**重構後**:
- 10+ 個小檔案，每個平均 50-200 行
- 清晰的模組化架構
- 職責分離明確
- 易於維護和擴展

重構成功將一個難以維護的大檔案轉換為結構清晰、易於擴展的模組化架構。 