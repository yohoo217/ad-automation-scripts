{% extends "base.html" %}

{% block title %}å€’æ•¸å»£å‘Šå»ºç«‹{% endblock %}

{% block page_title %}â° å»ºç«‹å€’æ•¸å»£å‘Š{% endblock %}

{% block additional_styles %}
<style>
    .clear-form-btn {
        background-color: #f44336;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 15px;
    }
    .clear-form-btn:hover {
        background-color: #d32f2f;
    }
    
    .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
        .form-grid-3 {
            grid-template-columns: 1fr;
        }
        .form-grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 480px) {
        .form-grid-4 {
            grid-template-columns: 1fr;
        }
    }
    
    input[type="color"] {
        width: 60px;
        height: 40px;
        border: 2px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }
    
    input[type="datetime-local"] {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<form action="{{ url_for('main.clear_countdown_form') }}" method="post" style="display: inline;">
    <button type="submit" class="clear-form-btn" onclick="return confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡«å¯«çš„å…§å®¹å—ï¼Ÿ')">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å…§å®¹</button>
</form>

<form action="{{ url_for('main.create_countdown_ad') }}" method="post" id="ad-form">
    <div class="field-group">
        <h3>ğŸ“‹ åŸºæœ¬å»£å‘Šè³‡è¨Š</h3>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="adset_id">Adset ID <span class="required">*</span></label>
                <input type="text" id="adset_id" name="adset_id" value="{{ adset_id or '' }}" required
                       placeholder="ä¾‹å¦‚ï¼š00947c1b-f7cd-47c6-a23a-0639e9702cc7">
                <div class="help-text">å»£å‘Šçµ„IDï¼Œå¿…å¡«</div>
            </div>
            
            <div class="form-row">
                <label for="display_name">å»£å‘Šå–®å…ƒé¡¯ç¤ºåç¨±</label>
                <input type="text" id="display_name" name="display_name" value="{{ display_name or '' }}"
                       placeholder="åƒ…ä¾›å¾Œå°é¡¯ç¤ºä½¿ç”¨">
                <div class="help-text">åƒ…é¡¯ç¤ºæ–¼å¾Œå°ï¼Œå¯é¸</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="advertiser">å»£å‘Šå•† <span class="required">*</span></label>
                <input type="text" id="advertiser" name="advertiser" value="{{ advertiser or '' }}" required
                       placeholder="å»£å‘Šä¸»åç¨±">
                <div class="help-text">å»£å‘Šä¸»åç¨±ï¼Œå¿…å¡«</div>
            </div>
            
            <div class="form-row">
                <label for="main_title">ä¸»æ¨™é¡Œ <span class="required">*</span></label>
                <input type="text" id="main_title" name="main_title" value="{{ main_title or '' }}" required
                       placeholder="å»£å‘Šä¸»æ¨™é¡Œ">
                <div class="help-text">å»£å‘Šä¸»æ¨™é¡Œï¼Œå¿…å¡«</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="subtitle">æ–‡å­—æ•˜è¿°</label>
                <input type="text" id="subtitle" name="subtitle" value="{{ subtitle or '' }}"
                       placeholder="å»£å‘Šå‰¯æ¨™é¡Œï¼ˆå¯é¸ï¼‰">
                <div class="help-text">å»£å‘Šå‰¯æ¨™é¡Œï¼Œå¯é¸</div>
            </div>
            
            <div class="form-row">
                <label for="call_to_action">è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—</label>
                <input type="text" id="call_to_action" name="call_to_action" value="{{ call_to_action or 'ç«‹å³è³¼è²·' }}"
                       placeholder="ç«‹å³è³¼è²·">
                <div class="help-text">CTAæŒ‰éˆ•æ–‡å­—ï¼Œé è¨­ç‚ºã€Œç«‹å³è³¼è²·ã€</div>
            </div>
        </div>
        
        <div class="form-row">
            <label for="landing_page">åˆ°é”é é¢ç¶²å€ <span class="required">*</span></label>
            <input type="url" id="landing_page" name="landing_page" placeholder="https://example.com" 
                   value="{{ landing_page or '' }}" required>
            <div class="help-text">ç”¨æˆ¶é»æ“Šå»£å‘Šå¾Œè·³è½‰çš„ç¶²å€ï¼Œå¿…å¡«</div>
        </div>
    </div>

    <div class="field-group">
        <h3>å»£å‘Šç´ æ</h3>
        <p style="margin-bottom: 20px; color: #666; font-style: italic;">
            æ‰€æœ‰åœ–ç‰‡å‡ç‚ºå¿…å¡«ã€‚è«‹æä¾›æœ¬åœ°å®Œæ•´æª”æ¡ˆè·¯å¾‘ï¼Œæˆ–ä½¿ç”¨ä¸Šå‚³åŠŸèƒ½ã€‚
        </p>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="image_path_m">å¤§å°ºå¯¸åœ–ç‰‡ 1200x628 <span class="required">*</span></label>
                <div class="file-upload-container">
                    <input type="text" id="image_path_m" name="image_path_m" 
                           placeholder="/path/to/your/image_1200x628.jpg" 
                           value="{{ image_path_m or '' }}" required>
                    <div class="help-text">å¤§å‹æ©«å¹…åœ–ç‰‡ï¼Œå°ºå¯¸1200x628åƒç´ </div>
                    <div class="preview-container">
                        <label class="custom-file-upload">
                            ğŸ“ ä¸Šå‚³åœ–ç‰‡
                            <input type="file" class="file-input" data-target="image_path_m" accept="image/*">
                        </label>
                        <img id="preview_m" class="upload-preview" style="display: none;" alt="é è¦½åœ–">
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <label for="image_path_s">å°å°ºå¯¸åœ–ç‰‡ 300x300 <span class="required">*</span></label>
                <div class="file-upload-container">
                    <input type="text" id="image_path_s" name="image_path_s" 
                           placeholder="/path/to/your/image_300x300.jpg" 
                           value="{{ image_path_s or '' }}" required>
                    <div class="help-text">æ–¹å½¢åœ–ç‰‡ï¼Œå°ºå¯¸300x300åƒç´ </div>
                    <div class="preview-container">
                        <label class="custom-file-upload">
                            ğŸ“ ä¸Šå‚³åœ–ç‰‡
                            <input type="file" class="file-input" data-target="image_path_s" accept="image/*">
                        </label>
                        <img id="preview_s" class="upload-preview" style="display: none;" alt="é è¦½åœ–">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-row">
            <label for="background_image">éŠæˆ²å¥—ä»¶é è¨­èƒŒæ™¯ <span class="required">*</span></label>
            <input type="text" id="background_image" name="background_image" 
                   placeholder="è«‹è¼¸å…¥èƒŒæ™¯åœ–ç‰‡ç¶²å€" value="{{ background_image or '' }}" required>
            <div class="help-text">éŠæˆ²å¥—ä»¶é è¨­èƒŒæ™¯åœ–ç‰‡ç¶²å€</div>
        </div>
    </div>

    <div class="field-group">
        <h3>â° å€’æ•¸å»£å‘Šè¨­å®š</h3>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="end_date">å€’æ•¸çµæŸæ™‚é–“ <span class="required">*</span></label>
                <input type="datetime-local" id="end_date" name="end_date" 
                       value="{{ end_date or '' }}" required>
                <div class="help-text">å€’æ•¸è¨ˆæ™‚çš„ç›®æ¨™çµæŸæ™‚é–“ï¼Œå¿…å¡«</div>
            </div>
            
            <div class="form-row">
                <label for="description_text">å€’æ•¸æè¿°æ–‡å­—</label>
                <input type="text" id="description_text" name="description_text" 
                       placeholder="æ´»å‹•æˆªæ­¢å€’æ•¸" 
                       value="{{ description_text or 'æ´»å‹•æˆªæ­¢å€’æ•¸' }}">
                <div class="help-text">å€’æ•¸è¨ˆæ™‚çš„æè¿°æ–‡å­—</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="background_url">èƒŒæ™¯åœ–ç‰‡ç¶²å€ <span class="required">*</span></label>
                <input type="url" id="background_url" name="background_url" 
                       placeholder="https://example.com/countdown-bg.webp" 
                       value="{{ background_url or '' }}" required>
                <div class="help-text">å€’æ•¸èƒŒæ™¯åœ–ç‰‡çš„ç¶²å€ï¼Œå¿…å¡«</div>
            </div>
            
            <div class="form-row">
                <label for="target_url">ç›®æ¨™ç¶²å€ <span class="required">*</span></label>
                <input type="url" id="target_url" name="target_url" 
                       placeholder="https://example.com" 
                       value="{{ target_url or '' }}" required>
                <div class="help-text">é»æ“Šå¾Œè·³è½‰çš„ç›®æ¨™ç¶²å€ï¼Œå¿…å¡«</div>
            </div>
        </div>

        <div class="form-grid-2">
            <div class="form-row">
                <label for="position">å€’æ•¸ä½ç½®</label>
                <select id="position" name="position">
                    <option value="1" {{ 'selected' if position == '1' else '' }}>ä½ç½® 1</option>
                    <option value="2" {{ 'selected' if position == '2' else '' }}>ä½ç½® 2</option>
                    <option value="3" {{ 'selected' if position == '3' else '' }} selected>ä½ç½® 3</option>
                    <option value="4" {{ 'selected' if position == '4' else '' }}>ä½ç½® 4</option>
                </select>
                <div class="help-text">å€’æ•¸è¨ˆæ™‚é¡¯ç¤ºä½ç½®ï¼Œé è¨­ç‚ºä½ç½® 3</div>
            </div>
        </div>

        <h4 style="margin-top: 25px; margin-bottom: 15px; color: #333;">ğŸ¨ å€’æ•¸æ¨£å¼è¨­å®š</h4>
        
        <div class="form-grid-3">
            <div class="form-row">
                <label for="date_number_color">æ•¸å­—é¡è‰²</label>
                <input type="color" id="date_number_color" name="date_number_color" 
                       value="{{ date_number_color or '#FFFFFF' }}">
                <div class="help-text">å€’æ•¸æ•¸å­—çš„é¡è‰²</div>
            </div>
            
            <div class="form-row">
                <label for="description_color">æè¿°æ–‡å­—é¡è‰²</label>
                <input type="color" id="description_color" name="description_color" 
                       value="{{ description_color or '#FFFFFF' }}">
                <div class="help-text">æè¿°æ–‡å­—çš„é¡è‰²</div>
            </div>
            
            <div class="form-row">
                <label for="date_word_color">æ™‚é–“å–®ä½æ–‡å­—é¡è‰²</label>
                <input type="color" id="date_word_color" name="date_word_color" 
                       value="{{ date_word_color or '#FFFFFF' }}">
                <div class="help-text">å¤©/æ™‚/åˆ†/ç§’æ–‡å­—çš„é¡è‰²</div>
            </div>
        </div>

        <div class="form-grid-3">
            <div class="form-row">
                <label for="date_number_size">æ•¸å­—å¤§å°</label>
                <select id="date_number_size" name="date_number_size">
                    <option value="1" {{ 'selected' if date_number_size == '1' else '' }}>æ¥µå°</option>
                    <option value="2" {{ 'selected' if date_number_size == '2' else '' }}>å°</option>
                    <option value="3" {{ 'selected' if date_number_size == '3' else '' }}>ä¸­</option>
                    <option value="4" {{ 'selected' if date_number_size == '4' else '' }} selected>å¤§</option>
                    <option value="5" {{ 'selected' if date_number_size == '5' else '' }}>æ¥µå¤§</option>
                </select>
                <div class="help-text">å€’æ•¸æ•¸å­—çš„å¤§å°</div>
            </div>
            
            <div class="form-row">
                <label for="description_size">æè¿°æ–‡å­—å¤§å°</label>
                <select id="description_size" name="description_size">
                    <option value="1" {{ 'selected' if description_size == '1' else '' }}>æ¥µå°</option>
                    <option value="2" {{ 'selected' if description_size == '2' else '' }}>å°</option>
                    <option value="3" {{ 'selected' if description_size == '3' else '' }}>ä¸­</option>
                    <option value="4" {{ 'selected' if description_size == '4' else '' }} selected>å¤§</option>
                    <option value="5" {{ 'selected' if description_size == '5' else '' }}>æ¥µå¤§</option>
                </select>
                <div class="help-text">æè¿°æ–‡å­—çš„å¤§å°</div>
            </div>
            
            <div class="form-row">
                <label for="date_word_size">æ™‚é–“å–®ä½æ–‡å­—å¤§å°</label>
                <select id="date_word_size" name="date_word_size">
                    <option value="1" {{ 'selected' if date_word_size == '1' else '' }}>æ¥µå°</option>
                    <option value="2" {{ 'selected' if date_word_size == '2' else '' }}>å°</option>
                    <option value="3" {{ 'selected' if date_word_size == '3' else '' }}>ä¸­</option>
                    <option value="4" {{ 'selected' if date_word_size == '4' else '' }} selected>å¤§</option>
                    <option value="5" {{ 'selected' if date_word_size == '5' else '' }}>æ¥µå¤§</option>
                </select>
                <div class="help-text">å¤©/æ™‚/åˆ†/ç§’æ–‡å­—çš„å¤§å°</div>
            </div>
        </div>

        <h4 style="margin-top: 25px; margin-bottom: 15px; color: #333;">âŒš é¡¯ç¤ºè¨­å®š</h4>
        
        <div class="form-grid-4">
            <div class="form-row">
                <label>
                    <input type="checkbox" id="show_day" name="show_day" 
                           {{ 'checked' if show_day != 'false' else '' }} checked 
                           style="margin-right: 8px;">
                    é¡¯ç¤ºã€Œå¤©ã€
                </label>
                <div class="help-text">æ˜¯å¦é¡¯ç¤ºå¤©æ•¸</div>
            </div>
            
            <div class="form-row">
                <label>
                    <input type="checkbox" id="show_hour" name="show_hour" 
                           {{ 'checked' if show_hour != 'false' else '' }} checked 
                           style="margin-right: 8px;">
                    é¡¯ç¤ºã€Œæ™‚ã€
                </label>
                <div class="help-text">æ˜¯å¦é¡¯ç¤ºå°æ™‚</div>
            </div>
            
            <div class="form-row">
                <label>
                    <input type="checkbox" id="show_min" name="show_min" 
                           {{ 'checked' if show_min != 'false' else '' }} checked 
                           style="margin-right: 8px;">
                    é¡¯ç¤ºã€Œåˆ†ã€
                </label>
                <div class="help-text">æ˜¯å¦é¡¯ç¤ºåˆ†é˜</div>
            </div>
            
            <div class="form-row">
                <label>
                    <input type="checkbox" id="show_sec" name="show_sec" 
                           {{ 'checked' if show_sec != 'false' else '' }} checked 
                           style="margin-right: 8px;">
                    é¡¯ç¤ºã€Œç§’ã€
                </label>
                <div class="help-text">æ˜¯å¦é¡¯ç¤ºç§’æ•¸</div>
            </div>
        </div>
        
        <input type="hidden" id="payload_game_widget" name="payload_game_widget">
    </div>
    
    <input type="submit" value="â° å»ºç«‹å€’æ•¸å»£å‘Š">
</form>
{% endblock %}

{% block additional_scripts %}
<script>
    // å€’æ•¸å»£å‘Šç‰¹æœ‰çš„ JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // åœ¨é é¢åŠ è¼‰å®Œæˆå¾Œæ›´æ–° payload
        updateGameWidgetPayload();

        // æ·»åŠ äº‹ä»¶ç›£è½å™¨ï¼Œç•¶ç›¸é—œè¼¸å…¥æ”¹è®Šæ™‚æ›´æ–° payload
        const inputIds = [
            'end_date', 'description_text', 'background_url', 'target_url', 'position',
            'date_number_color', 'description_color', 'date_word_color',
            'date_number_size', 'description_size', 'date_word_size',
            'show_day', 'show_hour', 'show_min', 'show_sec'
        ];
        
        inputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateGameWidgetPayload);
                element.addEventListener('change', updateGameWidgetPayload);
            }
        });
    });

    function updateGameWidgetPayload() {
        const endDate = document.getElementById('end_date').value;
        const backgroundUrl = document.getElementById('background_url').value;
        const targetUrl = document.getElementById('target_url').value;
        const descriptionText = document.getElementById('description_text').value || 'æ´»å‹•æˆªæ­¢å€’æ•¸';
        const position = parseInt(document.getElementById('position').value) || 3;
        
        // é¡è‰²è¨­å®š
        const dateNumberColor = document.getElementById('date_number_color').value || '#FFFFFF';
        const descriptionColor = document.getElementById('description_color').value || '#FFFFFF';
        const dateWordColor = document.getElementById('date_word_color').value || '#FFFFFF';
        
        // å¤§å°è¨­å®š
        const dateNumberSize = document.getElementById('date_number_size').value || '4';
        const descriptionSize = document.getElementById('description_size').value || '4';
        const dateWordSize = document.getElementById('date_word_size').value || '4';
        
        // é¡¯ç¤ºè¨­å®š
        const showDay = document.getElementById('show_day').checked;
        const showHour = document.getElementById('show_hour').checked;
        const showMin = document.getElementById('show_min').checked;
        const showSec = document.getElementById('show_sec').checked;

        if (!endDate || !backgroundUrl || !targetUrl) return; // å¦‚æœå¿…è¦çš„è¼¸å…¥ç¼ºå¤±ï¼Œä¸æ›´æ–°

        // è½‰æ›æ—¥æœŸæ™‚é–“æ ¼å¼ (å¾ YYYY-MM-DDTHH:MM è½‰æ›ç‚º YYYY-MM-DD HH:MM:SS)
        let formattedEndDate = endDate;
        if (endDate.includes('T')) {
            formattedEndDate = endDate.replace('T', ' ') + ':00';
        }

        const payload = {
            "type": "COUNTDOWN",
            "imgProperty": {
                "endDate": formattedEndDate,
                "backgroundImage": backgroundUrl,
                "descriptionText": descriptionText,
                "position": position,
                "dateNumberColor": dateNumberColor,
                "descriptionColor": descriptionColor,
                "dateWordColor": dateWordColor,
                "dateNumberSize": dateNumberSize,
                "descriptionSize": descriptionSize,
                "dateWordSize": dateWordSize,
                "showDay": showDay,
                "showHour": showHour,
                "showMin": showMin,
                "showSec": showSec
            },
            "invokes": [
                {
                    "action": "OPEN_EXTERNAL_BROWSER",
                    "payload": {
                        "url": targetUrl
                    }
                }
            ]
        };

        document.getElementById('payload_game_widget').value = JSON.stringify(payload);
        console.log('Updated payload:', payload); // ç”¨æ–¼èª¿è©¦
    }

    // å¿«é€Ÿè³‡è¨Šè§£æå‡½æ•¸
    function parseInfoText(text) {
        try {
            // è§£æå»£å‘Šä¸»
            const advertiserMatch = text.match(/[-Â·]\s*å»£å‘Šä¸»[:ï¼š]\s*(.+)/);
            if (advertiserMatch) {
                document.getElementById('advertiser').value = advertiserMatch[1].trim();
            }

            // è§£ææ´»å‹•åç¨±ä½œç‚ºä¸»æ¨™é¡Œ
            const titleMatch = text.match(/[-Â·]\s*æ´»å‹•åç¨±[:ï¼š]\s*(.+)/);
            if (titleMatch) {
                document.getElementById('main_title').value = titleMatch[1].trim();
            }

            // è§£ææ¨™é¡Œ
            const headlineMatch = text.match(/[-Â·]\s*æ¨™é¡Œ[:ï¼š]\s*(.+)/);
            if (headlineMatch) {
                document.getElementById('subtitle').value = headlineMatch[1].trim();
            }

            // è§£æ CTA
            const ctaMatch = text.match(/[-Â·]\s*CTA[:ï¼š]\s*(.+)/);
            if (ctaMatch) {
                document.getElementById('call_to_action').value = ctaMatch[1].trim();
            }

            // è§£æå°é€£
            const landingMatch = text.match(/(?:å°é€£|åˆ°é”é é¢)[:ï¼š]\s*(https?:\/\/[^\s]+)/);
            if (landingMatch) {
                document.getElementById('landing_page').value = landingMatch[1].trim();
                document.getElementById('target_url').value = landingMatch[1].trim();
            }

            // è§£æç´ æä½œç‚ºèƒŒæ™¯
            const materialMatch = text.match(/ç´ æ[:ï¼š]\s*(https?:\/\/[^\s]+)/);
            if (materialMatch) {
                document.getElementById('background_url').value = materialMatch[1].trim();
                document.getElementById('background_image').value = materialMatch[1].trim();
            }

            // è§£æå€’æ•¸æè¿°æ–‡å­—
            const descriptionMatch = text.match(/[-Â·]\s*æè¿°[:ï¼š]\s*(.+)/);
            if (descriptionMatch) {
                document.getElementById('description_text').value = descriptionMatch[1].trim();
            }

            updateGameWidgetPayload();
            alert('âœ… è³‡è¨Šè§£æå®Œæˆï¼è«‹æª¢æŸ¥å¡«å…¥çš„å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚');
        } catch (error) {
            console.error('è§£æéŒ¯èª¤:', error);
            alert('âŒ è§£æéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼ã€‚');
        }
    }
</script>
{% endblock %} 