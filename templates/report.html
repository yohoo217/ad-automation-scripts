{% extends "base.html" %}

{% block title %}廣告報表{% endblock %}
{% block page_title %}廣告報表{% endblock %}

{% block additional_styles %}
<!-- 改用 ExcelJS 庫 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>

<style>
    .report-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .input-section {
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #f8faff 0%, #f1f5ff 100%);
        border-radius: 12px;
        border: 1px solid #e0e6ed;
    }
    
    .report-content {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .report-content iframe {
        width: 100%;
        height: 100%;
        border: none;
        min-height: 500px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error {
        color: #dc3545;
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
    }
    
    .daily-report-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid #007bff;
    }
    
    .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .report-table th,
    .report-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }
    
    .report-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .report-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .cookie-status {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .cookie-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .cookie-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .export-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 10px;
    }
    
    .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }
    
    .export-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* 新增樣式：選擇器相關 */
    .selection-section {
        display: none;
        margin-top: 20px;
        padding: 20px;
        background: #f8fff9;
        border-radius: 8px;
        border: 1px solid #28a745;
    }
    
    .selection-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .selection-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .selection-group label {
        font-weight: 600;
        color: #2e7d32;
        font-size: 14px;
    }
    
    .selection-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        background: white;
    }
    
    .selection-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .selection-item:last-child {
        border-bottom: none;
    }
    
    .selection-item input[type="checkbox"] {
        transform: scale(1.1);
    }
    
    .selection-item-label {
        flex: 1;
        font-size: 13px;
        color: #333;
    }
    
    .selection-item-subtitle {
        font-size: 11px;
        color: #666;
        margin-left: 20px;
    }
    
    .batch-settings {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .batch-settings label {
        font-size: 14px;
        color: #495057;
    }
    
    .batch-settings input {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 80px;
    }
    
    .selection-summary {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 6px;
        margin-top: 10px;
        font-size: 13px;
        color: #1976d2;
    }
    
    /* 新增樣式：自訂時間區段 */
    .custom-time-section {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .custom-time-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .time-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .time-input-group label {
        font-weight: 600;
        color: #2e7d32;
        font-size: 14px;
    }
    
    .time-input-group input[type="date"] {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 150px;
    }
    
    .time-help {
        font-size: 12px;
        color: #666;
    }
    
    /* 新增：並排 AdUnit 報表樣式 */
    .merged-adunit-table {
        margin-top: 15px;
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
    }
    
    .merged-adunit-table th {
        background-color: #2196f3;
        color: white;
        padding: 8px 6px;
        text-align: center;
        border: 1px solid #1976d2;
        font-weight: bold;
        font-size: 11px;
    }
    
    .merged-adunit-table .date-week-header {
        background-color: #4472c4;
        color: white;
        vertical-align: middle;
    }
    
    .merged-adunit-table .adunit-name-header {
        background-color: #2196f3;
        color: white;
        font-size: 12px;
        font-weight: bold;
        border-bottom: 2px solid #1976d2;
    }
    
    .merged-adunit-table .metric-header {
        background-color: #f5f5f5;
        color: #333;
        font-size: 10px;
    }
    
    .merged-adunit-table td {
        padding: 6px 4px;
        text-align: center;
        border: 1px solid #ddd;
        font-size: 11px;
    }
    
    .merged-adunit-table .total-row {
        background-color: #fff3cd;
        font-weight: bold;
    }
    
    .merged-adunit-table .total-row .ctr-cell {
        color: #dc3545;
        font-weight: bold;
    }
    
    /* AdSet 表格 TOTAL 行樣式 */
    .report-table .total-row {
        background-color: #f8f9fa;
        border-top: 2px solid #28a745;
    }
    
    .report-table .total-row td {
        font-weight: bold !important;
        border-top: 2px solid #28a745;
    }
    
    /* AdUnit 圖片預覽樣式 */
    .adunit-images-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #ffffff;
        border-radius: 8px;
        border: 2px solid #e3f2fd;
    }
    
    .adunit-images-section h6 {
        color: #1976d2;
        margin-bottom: 15px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .adunit-images-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: flex-start;
    }
    
    .adunit-image-item {
        text-align: center;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        background: #fafafa;
        max-width: 200px;
        transition: all 0.3s ease;
    }
    
    .adunit-image-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .adunit-image-item .name {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
        font-weight: bold;
        word-break: break-word;
    }
    
    .adunit-image-item img {
        max-width: 180px;
        max-height: 120px;
        object-fit: contain;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    
    .adunit-image-item img:hover {
        transform: scale(1.05);
    }
    
    .adunit-image-item .no-image {
        color: #999;
        font-size: 11px;
        padding: 20px 10px;
        border: 1px dashed #ccc;
        border-radius: 4px;
        background: #f9f9f9;
    }
    
    .adunit-image-item .error-message {
        color: #999;
        font-size: 11px;
        padding: 20px 10px;
    }

    /* 新增：垂直排列 AdUnit 報表樣式 */
    .vertical-adunit-section {
        margin: 10px 0 20px 20px;
        padding: 15px;
        border: 1px solid #007bff;
        border-radius: 8px;
        background: #f8f9ff;
    }
    
    .vertical-adunit-section h6 {
        color: #007bff;
        margin-bottom: 15px;
        font-size: 14px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 8px;
    }
    
    .vertical-adunit-item {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .vertical-adunit-item:last-child {
        margin-bottom: 0;
    }
    
    .vertical-adunit-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .vertical-adunit-name {
        font-size: 16px;
        font-weight: bold;
        color: #495057;
        flex: 1;
    }
    
    .vertical-adunit-uuid {
        font-size: 12px;
        color: #6c757d;
        font-family: monospace;
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
    }
    
    .vertical-adunit-image {
        text-align: center;
        margin-bottom: 15px;
    }
    
    .vertical-adunit-image img {
        max-width: 200px;
        max-height: 150px;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    
    .vertical-adunit-image img:hover {
        transform: scale(1.05);
    }
    
    .vertical-adunit-image .no-image {
        color: #999;
        font-size: 12px;
        padding: 30px 20px;
        border: 1px dashed #ccc;
        border-radius: 8px;
        background: #f9f9f9;
        display: inline-block;
    }
    
    .vertical-adunit-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-top: 10px;
    }
    
    .vertical-adunit-table th {
        background-color: #007bff;
        color: white;
        padding: 8px 6px;
        text-align: center;
        border: 1px solid #0056b3;
        font-weight: bold;
        font-size: 11px;
    }
    
    .vertical-adunit-table td {
        padding: 6px 4px;
        text-align: center;
        border: 1px solid #ddd;
        font-size: 11px;
    }
    
    .vertical-adunit-table .total-row {
        background-color: #e7f3ff;
        font-weight: bold;
    }
    
    .vertical-adunit-table .total-row td {
        border-top: 2px solid #007bff;
    }

    /* 響應式設計 */
    @media (max-width: 1200px) {
        .merged-adunit-table {
            font-size: 10px;
        }
        
        .merged-adunit-table th,
        .merged-adunit-table td {
            padding: 4px 2px;
        }
        
        .adunit-images-grid {
            gap: 10px;
        }
        
        .adunit-image-item {
            max-width: 150px;
        }
        
        .adunit-image-item img {
            max-width: 130px;
            max-height: 100px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div id="cookie-status" class="cookie-status cookie-success">
        ✓ Cookie 已自動設置成功
    </div>
    
    <div class="input-section">
        <h3>廣告報表查詢</h3>
        <div class="form-row">
            <label for="campaignId">廣告活動 ID <span class="required">*</span></label>
            <input type="text" id="campaignId" name="campaignId" placeholder="請輸入廣告活動 ID，例如：02698ef0-faac-4df1-af75-fa2a21674778" required>
            <div class="help-text">輸入您要查詢的廣告活動 ID，系統會自動取得該活動下所有廣告集和走期時間</div>
        </div>

        <div class="form-row">
            <label for="isSlideAd">
                <input type="checkbox" id="isSlideAd" name="isSlideAd" style="margin-right: 8px;">
                🎬 這是 Slide 廣告（會顯示 cut 分析數據）
            </label>
            <div class="help-text">勾選此項目將會查詢所有 AdUnit 並顯示各 cut 的詳細數據</div>
        </div>
        
        <!-- 修改：查詢策略設定 -->
        <div class="form-row">
            <div class="batch-settings">
                <label for="queryStrategy">AdUnit 查詢策略：</label>
                <select id="queryStrategy" name="queryStrategy">
                    <option value="sequential">逐一查詢（保護線上服務，較慢但安全）</option>
                    <option value="disabled">停用 AdUnit 查詢（只查詢 AdSet 層級）</option>
                </select>
                <span style="font-size: 12px; color: #666;">為了不影響線上功能，建議使用逐一查詢，每個 AdUnit 間會等待 3 秒</span>
            </div>
        </div>
        
        <!-- 新增：過濾提示 -->
        <div class="form-row">
            <div style="padding: 10px; background: #e8f5e8; border-radius: 6px; border: 1px solid #28a745;">
                <span style="font-size: 12px; color: #2e7d32;">📋 注意：系統會自動過濾掉名稱包含 "demo" 的廣告集</span>
            </div>
        </div>
        
        <!-- 新增：緩存說明 -->
        <div class="form-row">
            <div style="padding: 10px; background: #e8f4fd; border-radius: 6px; border: 1px solid #42a5f5;">
                <span style="font-size: 12px; color: #1565c0;">
                    🎯 智能緩存：相同查詢條件的數據會緩存 6 小時，提升查詢速度並減少服務器負擔
                    <span id="cacheStatus" style="margin-left: 10px;"></span>
                </span>
            </div>
        </div>
        
        <!-- 新增：自訂時間區段設定 -->
        <div class="form-row">
            <label for="useCustomTime">
                <input type="checkbox" id="useCustomTime" name="useCustomTime" style="margin-right: 8px;">
                🕒 使用自訂時間區段（預設自動從 Campaign 取得走期時間）
            </label>
            <div class="help-text">勾選後可手動設定查詢的開始和結束時間，否則使用活動的完整走期時間</div>
        </div>
        
        <!-- 摺疊式自訂時間選擇區域 -->
        <div id="customTimeSection" class="custom-time-section" style="display: none;">
            <div class="custom-time-controls">
                <div class="time-input-group">
                    <label for="customStartDate">開始日期：</label>
                    <input type="date" id="customStartDate" name="customStartDate">
                </div>
                <div class="time-input-group">
                    <label for="customEndDate">結束日期：</label>
                    <input type="date" id="customEndDate" name="customEndDate">
                </div>
                <div class="time-help">
                    <span style="font-size: 12px; color: #666;">
                        💡 提示：未填寫時將使用活動的完整走期時間
                    </span>
                </div>
            </div>
        </div>
        
        <!-- 隱藏的輸入框，用於儲存從 Campaign 取得的數據 -->
        <input type="hidden" id="sinceDate" name="sinceDate">
        <input type="hidden" id="toDate" name="toDate">
        <input type="hidden" id="campaignEndDate" name="campaignEndDate">
        <input type="hidden" id="currentDate" name="currentDate">
        
        <button type="button" id="fetchReport" class="button">📈 取得報表</button>
        <button type="button" id="exportExcel" class="export-button" disabled>📊 產出 XLSX 報表</button>
        <button type="button" id="clearAllCaches" class="button" style="background: #6c757d; margin-left: 10px;">🗑️ 清除所有緩存</button>
        <button type="button" id="clearCurrentCache" class="button" style="background: #dc3545; margin-left: 10px;">🗑️ 清除當前活動緩存</button>
    </div>
    
    <!-- 新增：選擇報表內容區域 -->
    <div id="selectionSection" class="selection-section">
        <h4>🎯 選擇要顯示的報表內容</h4>
        <div class="selection-controls">
            <div class="selection-group">
                <label>📊 廣告集 (AdSet)</label>
                <div class="selection-list" id="adsetSelectionList">
                    <!-- AdSet 選項將動態生成 -->
                </div>
            </div>
            <div class="selection-group">
                <label>🎯 廣告單元 (AdUnit)</label>
                <div class="selection-list" id="adunitSelectionList">
                    <!-- AdUnit 選項將動態生成 -->
                </div>
            </div>
        </div>
        <div class="selection-controls">
            <button type="button" id="selectAllAdsets" class="button" style="background: #17a2b8;">全選 AdSet</button>
            <button type="button" id="deselectAllAdsets" class="button" style="background: #dc3545;">取消全選 AdSet</button>
            <button type="button" id="selectAllAdunits" class="button" style="background: #17a2b8;">全選 AdUnit</button>
            <button type="button" id="deselectAllAdunits" class="button" style="background: #dc3545;">取消全選 AdUnit</button>
            <button type="button" id="updateReport" class="button" style="background: #ffc107; color: #000;">🔄 更新報表顯示</button>
        </div>
        
        <!-- 新增：AdUnit 報表佈局切換選項 -->
        <div class="layout-controls" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="font-weight: bold; color: #495057; margin-bottom: 8px; display: block;">📊 AdUnit 報表顯示方式</label>
            <div style="display: flex; gap: 15px; align-items: center;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="adunitLayout" value="horizontal" id="layoutHorizontal" checked style="margin-right: 6px;">
                    <span style="color: #28a745;">🔗 並排顯示</span>
                    <small style="color: #6c757d; margin-left: 8px;">(合併在同一表格)</small>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="adunitLayout" value="vertical" id="layoutVertical" style="margin-right: 6px;">
                    <span style="color: #007bff;">📋 垂直排列</span>
                    <small style="color: #6c757d; margin-left: 8px;">(每個 AdUnit 獨立表格)</small>
                </label>
            </div>
            <div style="font-size: 12px; color: #6c757d; margin-top: 8px;">
                💡 提示：並排顯示適合比較 AdUnit 數據，垂直排列適合詳細查看個別 AdUnit
            </div>
        </div>
        <div id="selectionSummary" class="selection-summary"></div>
    </div>
    
    <div id="reportContent" class="report-content" style="display: none;">
        <h3>📈 每日報表</h3>
        <div id="dailyReportContainer">
            <!-- 報表內容將在這裡顯示 -->
        </div>
    </div>
    
    <div id="loadingMessage" class="loading" style="display: none;">
        <p>📊 正在載入報表資料...</p>
        <div style="margin-top: 10px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #667eea; animation: spin 1s linear infinite;"></div>
        </div>
    </div>
    
    <div id="errorMessage" class="error" style="display: none;">
        <!-- 錯誤訊息將在這裡顯示 -->
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block additional_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 自動設置 Cookie
    const defaultCookie = "AOTTERBD_SESSION=757418f543a95a889184e798ec5ab66d4fad04e5-lats=1724229220332&sso=PIg4zu/Vdnn/A15vMEimFlVAGliNhoWlVd5FTvtEMRAFpk/VvBGvAetanw8DLATSLexy9pee/t52uNojvoFS2Q==;aotter=eyJ1c2VyIjp7ImlkIjoiNjNkYjRkNDBjOTFiNTUyMmViMjk4YjBkIiwiZW1haWwiOiJpYW4uY2hlbkBhb3R0ZXIubmV0IiwiY3JlYXRlZEF0IjoxNjc1MzE2NTQ0LCJlbWFpbFZlcmlmaWVkIjp0cnVlLCJsZWdhY3lJZCI6bnVsbCwibGVnYWN5U2VxSWQiOjE2NzUzMTY1NDQ3ODI5NzQwMDB9LCJhY2Nlc3NUb2tlbiI6IjJkYjQyZTNkOTM5MDUzMjdmODgyZmYwMDRiZmI4YmEzZjBhNTlmMDQwYzhiN2Y4NGY5MmZmZTIzYTU0ZTQ2MDQiLCJ1ZWEiOm51bGx9; _Secure-1PSID=vlPPgXupFroiSjP1/A02minugZVZDgIG4K; _Secure-1PSIDCC=g.a000mwhavReSVd1vN09AVTswXkPAhyuW7Tgj8-JFhj-FZya9I_l1B6W2gqTIWAtQUTQMkTxoAwACgYKAW0SARISFQHGX2MiC--NJ2PzCzDpJ0m3odxHhxoVAUF8yKr8r49abq8oe4UxCA0t_QCW0076; _Secure-3PSID=AKEyXzUuXI1zywmFmkEBEBHfg6GRkRM9cJ9BiJZxmaR46x5im_krhaPtmL4Jhw8gQsz5uFFkfbc; _Secure-3PSIDCC=sidts-CjEBUFGohzUF6oK3ZMACCk2peoDBDp6djBwJhGc4Lxgu2zOlzbVFeVpXF4q1TYZ5ba6cEAA";
    
    try {
        // 解析並設置各個 cookie
        const cookies = defaultCookie.split(';');
        cookies.forEach(cookie => {
            if (cookie.trim()) {
                document.cookie = cookie.trim() + "; path=/; SameSite=Lax";
            }
        });
        
        document.getElementById('cookie-status').className = 'cookie-status cookie-success';
        document.getElementById('cookie-status').innerHTML = '✓ Cookie 已自動設置成功';
    } catch (error) {
        console.error('設置 Cookie 時發生錯誤:', error);
        document.getElementById('cookie-status').className = 'cookie-status cookie-error';
        document.getElementById('cookie-status').innerHTML = '✗ Cookie 設置失敗: ' + error.message;
    }
    
    // 取得報表按鈕
    document.getElementById('fetchReport').addEventListener('click', function() {
        const campaignId = document.getElementById('campaignId').value.trim();
        
        if (!campaignId) {
            alert('請輸入廣告活動 ID');
            return;
        }
        
        // 使用預設時間戳，實際會從 Campaign 自動取得正確的時間戳
        const defaultSinceDate = Date.now() - (30 * 24 * 60 * 60 * 1000); // 30天前
        const defaultToDate = Date.now(); // 當前時間
        
        console.log('開始查詢報表，Campaign ID:', campaignId);
        fetchReportData(campaignId, defaultSinceDate, defaultToDate);
    });
    
    // 產出 Excel 報表按鈕
    document.getElementById('exportExcel').addEventListener('click', function() {
        exportToExcel();
    });
    
    // 清除所有緩存按鈕
    document.getElementById('clearAllCaches').addEventListener('click', function() {
        const clearedCount = clearAllCampaignCaches();
        if (clearedCount > 0) {
            alert(`✅ 已清除 ${clearedCount} 個廣告活動緩存`);
            updateCacheStatus(); // 更新緩存狀態顯示
        } else {
            alert('ℹ️ 沒有找到需要清除的緩存');
        }
    });
    
    // 清除當前活動緩存按鈕
    document.getElementById('clearCurrentCache').addEventListener('click', function() {
        clearCurrentCampaignCache();
    });
    
    // 新增：選擇控制按鈕事件
    document.getElementById('selectAllAdsets').addEventListener('click', function() {
        toggleAllCheckboxes('adsetSelectionList', true);
        updateSelectionSummary();
    });
    
    document.getElementById('deselectAllAdsets').addEventListener('click', function() {
        toggleAllCheckboxes('adsetSelectionList', false);
        updateSelectionSummary();
    });
    
    document.getElementById('selectAllAdunits').addEventListener('click', function() {
        toggleAllCheckboxes('adunitSelectionList', true);
        updateSelectionSummary();
    });
    
    document.getElementById('deselectAllAdunits').addEventListener('click', function() {
        toggleAllCheckboxes('adunitSelectionList', false);
        updateSelectionSummary();
    });
    
    document.getElementById('updateReport').addEventListener('click', function() {
        updateReportDisplay();
    });
    
    // 新增：佈局切換事件監聽器
    document.querySelectorAll('input[name="adunitLayout"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (currentReportData) {
                console.log('🔄 切換 AdUnit 顯示方式為:', this.value);
                updateReportDisplay();
            }
        });
    });
    
    // 新增：自訂時間切換事件
    document.getElementById('useCustomTime').addEventListener('change', function() {
        const customTimeSection = document.getElementById('customTimeSection');
        if (this.checked) {
            customTimeSection.style.display = 'block';
            // 設定預設的日期範圍（最近30天）
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('customEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('customStartDate').value = startDate.toISOString().split('T')[0];
        } else {
            customTimeSection.style.display = 'none';
        }
    });
    
    // 儲存報表資料供導出使用
    let currentReportData = null;
    let currentAdsetInfo = null; // 儲存廣告集資訊
    let currentCutData = {}; // 儲存 cut 數據
    let isSlideAd = false; // 是否為 slide 廣告
    let allAdsetReports = {}; // 儲存所有 AdSet 的報表數據
    let allAdunitReports = {}; // 儲存所有 AdUnit 的報表數據
    let adunitByAdset = {}; // 按 AdSet 分組的 AdUnit 報表數據
    
    // 緩存管理
    const CACHE_DURATION = 6 * 60 * 60 * 1000; // 6小時（毫秒）
    const CACHE_PREFIX = 'adCampaignCache_';
    
    // 新增：選擇狀態
    let selectedAdsets = new Set(); // 選中的 AdSet ID
    let selectedAdunits = new Set(); // 選中的 AdUnit UUID
    
    // 將選擇狀態設為全域變數
    window.selectedAdsets = selectedAdsets;
    window.selectedAdunits = selectedAdunits;
    
    // 緩存管理函數
    function getCacheKey(campaignId, queryParams) {
        // 生成緩存鍵，包含廣告活動ID和查詢參數
        const key = `${campaignId}_${queryParams.isSlideAd}_${queryParams.queryStrategy}_${queryParams.sinceDate}_${queryParams.toDate}`;
        const cacheKey = CACHE_PREFIX + btoa(key).replace(/[^a-zA-Z0-9]/g, ''); // Base64編碼並清理特殊字符
        console.log('🔑 生成緩存鍵值詳情:', {
            原始鍵值: key,
            編碼後: cacheKey,
            參數: queryParams
        });
        return cacheKey;
    }
    
    function setCampaignCache(cacheKey, data) {
        try {
            const cacheData = {
                timestamp: Date.now(),
                data: data
            };
            localStorage.setItem(cacheKey, JSON.stringify(cacheData));
            console.log(`✅ 緩存已保存: ${cacheKey}`);
        } catch (error) {
            console.warn('⚠️ 緩存保存失敗:', error);
        }
    }
    
    function getCampaignCache(cacheKey) {
        try {
            console.log(`🔍 檢查緩存: ${cacheKey}`);
            const cached = localStorage.getItem(cacheKey);
            if (!cached) {
                console.log(`❌ 未找到緩存: ${cacheKey}`);
                return null;
            }
            
            const cacheData = JSON.parse(cached);
            const now = Date.now();
            
            // 檢查緩存是否過期
            if (now - cacheData.timestamp > CACHE_DURATION) {
                console.log(`⏰ 緩存已過期，將清除: ${cacheKey} (${Math.round((now - cacheData.timestamp) / 60000)} 分鐘前創建)`);
                localStorage.removeItem(cacheKey);
                return null;
            }
            
            console.log(`🎯 使用緩存數據: ${cacheKey} (${Math.round((now - cacheData.timestamp) / 60000)} 分鐘前)`);
            return cacheData.data;
        } catch (error) {
            console.warn('⚠️ 緩存讀取失敗:', error);
            return null;
        }
    }
    
    function clearExpiredCaches() {
        try {
            const keys = Object.keys(localStorage);
            const now = Date.now();
            let clearedCount = 0;
            
            keys.forEach(key => {
                if (key.startsWith(CACHE_PREFIX)) {
                    try {
                        const cached = JSON.parse(localStorage.getItem(key));
                        if (now - cached.timestamp > CACHE_DURATION) {
                            localStorage.removeItem(key);
                            clearedCount++;
                        }
                    } catch (error) {
                        // 清除損壞的緩存
                        localStorage.removeItem(key);
                        clearedCount++;
                    }
                }
            });
            
            if (clearedCount > 0) {
                console.log(`🧹 清理了 ${clearedCount} 個過期緩存`);
            }
        } catch (error) {
            console.warn('⚠️ 緩存清理失敗:', error);
        }
    }
    
    function clearAllCampaignCaches() {
        try {
            const keys = Object.keys(localStorage);
            let clearedCount = 0;
            
            keys.forEach(key => {
                if (key.startsWith(CACHE_PREFIX)) {
                    localStorage.removeItem(key);
                    clearedCount++;
                }
            });
            
            console.log(`🗑️ 清除了所有 ${clearedCount} 個廣告活動緩存`);
            return clearedCount;
        } catch (error) {
            console.warn('⚠️ 緩存清除失敗:', error);
            return 0;
        }
    }
    
    // 頁面載入時清理過期緩存
    clearExpiredCaches();
    
    // 更新緩存狀態顯示
    function updateCacheStatus() {
        const cacheStatusElement = document.getElementById('cacheStatus');
        if (!cacheStatusElement) return;
        
        try {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(key => key.startsWith(CACHE_PREFIX));
            const validCaches = cacheKeys.filter(key => {
                try {
                    const cached = JSON.parse(localStorage.getItem(key));
                    return (Date.now() - cached.timestamp) <= CACHE_DURATION;
                } catch {
                    return false;
                }
            });
            
            if (validCaches.length > 0) {
                cacheStatusElement.textContent = `(${validCaches.length} 個活動已緩存)`;
                cacheStatusElement.style.color = '#28a745';
            } else {
                cacheStatusElement.textContent = '(無緩存)';
                cacheStatusElement.style.color = '#6c757d';
            }
        } catch (error) {
            cacheStatusElement.textContent = '(狀態未知)';
            cacheStatusElement.style.color = '#dc3545';
        }
    }
    
    // 初始化緩存狀態顯示
    updateCacheStatus();
    
    // 定期更新緩存狀態 (每30秒)
    setInterval(updateCacheStatus, 30000);
    
    // 顯示緩存提示訊息
    function showCacheMessage(cacheTimestamp) {
        const now = Date.now();
        const ageMinutes = Math.round((now - cacheTimestamp) / 60000);
        const ageHours = Math.round(ageMinutes / 60);
        
        let ageText = '';
        if (ageMinutes < 60) {
            ageText = `${ageMinutes} 分鐘前`;
        } else {
            ageText = `${ageHours} 小時前`;
        }
        
        const cacheMsg = document.createElement('div');
        cacheMsg.className = 'cookie-status';
        cacheMsg.style.backgroundColor = '#e8f4fd';
        cacheMsg.style.borderColor = '#42a5f5';
        cacheMsg.style.color = '#1565c0';
        cacheMsg.innerHTML = `
            🎯 使用緩存數據 (${ageText} 緩存)
            <button onclick="clearCurrentCampaignCache()" style="margin-left: 10px; font-size: 11px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                🗑️ 清除緩存
            </button>
        `;
        
        const container = document.getElementById('dailyReportContainer');
        if (container) {
            container.insertBefore(cacheMsg, container.firstChild);
        }
    }
    

    
    // 取得報表資料
    async function fetchReportData(campaignId, sinceDate, toDate) {
        const loadingElement = document.getElementById('loadingMessage');
        const reportElement = document.getElementById('reportContent');
        const errorElement = document.getElementById('errorMessage');
        const selectionSection = document.getElementById('selectionSection');
        
        // 檢查是否為 slide 廣告
        isSlideAd = document.getElementById('isSlideAd').checked;
        
        // 取得查詢策略設定
        const queryStrategy = document.getElementById('queryStrategy').value;
        
        // 顯示載入中
        loadingElement.style.display = 'block';
        reportElement.style.display = 'none';
        errorElement.style.display = 'none';
        selectionSection.style.display = 'none';
        
        try {
            // 第一步：先查詢廣告活動資訊，取得正確的時間戳
            console.log('正在查詢廣告活動資訊:', `/api/adset-info?campaignId=${encodeURIComponent(campaignId)}`);
            
            // 先嘗試從緩存獲取廣告活動基本資訊
            const basicCacheKey = `${CACHE_PREFIX}basic_${campaignId}`;
            let adsetInfo = getCampaignCache(basicCacheKey);
            
            if (!adsetInfo) {
                // 沒有緩存，調用 API
                const adsetResponse = await fetch(`/api/adset-info?campaignId=${encodeURIComponent(campaignId)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (adsetResponse.ok) {
                    adsetInfo = await adsetResponse.json();
                    console.log('收到廣告活動資訊:', adsetInfo);
                    
                            // 緩存基本資訊（6小時，與報表緩存一致）
        setCampaignCache(basicCacheKey, adsetInfo);
                } else {
                    console.warn('查詢廣告活動資訊失敗，將使用預設值');
                    adsetInfo = {
                        success: false,
                        pricing: { bMode: 'CPC', price: 7.0, currency: 'TWD' },
                        info: { 
                            name: '未知活動', 
                            adType: '原生互動廣告', 
                            budget: 0, 
                            campaignEndDate: null,
                            fromTimestamp: null,
                            toTimestamp: null
                        }
                    };
                }
            } else {
                console.log('🎯 使用緩存的廣告活動基本資訊');
            }
            
            currentAdsetInfo = adsetInfo;
            
            let actualSinceDate = sinceDate;
            let actualToDate = toDate;
            
            // 處理廣告活動資訊
            if (adsetInfo.success && adsetInfo.info) {
                // 自動設置走期結束日期
                if (adsetInfo.info.campaignEndDate) {
                    document.getElementById('campaignEndDate').value = adsetInfo.info.campaignEndDate;
                    console.log('自動設置走期結束日期:', adsetInfo.info.campaignEndDate);
                }
                
                // 自動設置開始和結束時間戳
                if (adsetInfo.info.fromTimestamp) {
                    actualSinceDate = adsetInfo.info.fromTimestamp;
                    document.getElementById('sinceDate').value = actualSinceDate;
                    console.log('自動設置開始時間戳:', actualSinceDate);
                }
                if (adsetInfo.info.toTimestamp) {
                    actualToDate = adsetInfo.info.toTimestamp;
                    document.getElementById('toDate').value = actualToDate;
                    console.log('自動設置結束時間戳:', actualToDate);
                }
                
                // 設置當前日期
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('currentDate').value = today;
            }
            
            // 檢查是否使用自訂時間
            const useCustomTime = document.getElementById('useCustomTime').checked;
            if (useCustomTime) {
                const customStartDate = document.getElementById('customStartDate').value;
                const customEndDate = document.getElementById('customEndDate').value;
                
                if (customStartDate && customEndDate) {
                    // 將日期轉換為時間戳
                    const startDateTime = new Date(customStartDate + 'T00:00:00');
                    const endDateTime = new Date(customEndDate + 'T23:59:59');
                    
                    actualSinceDate = startDateTime.getTime();
                    actualToDate = endDateTime.getTime();
                    
                    console.log('使用自訂時間區段:', {
                        startDate: customStartDate,
                        endDate: customEndDate,
                        sinceTimestamp: actualSinceDate,
                        toTimestamp: actualToDate
                    });
                } else {
                    console.warn('自訂時間未完整填寫，將使用自動取得的時間');
                }
            }
            
            // 現在生成緩存參數和鍵值（使用正確的時間戳）
            const queryParams = {
                isSlideAd: isSlideAd,
                queryStrategy: queryStrategy,
                sinceDate: actualSinceDate,
                toDate: actualToDate,
                useCustomTime: document.getElementById('useCustomTime').checked,
                customStartDate: document.getElementById('customStartDate').value,
                customEndDate: document.getElementById('customEndDate').value
            };
            
            const cacheKey = getCacheKey(campaignId, queryParams);
            console.log('🔑 生成緩存鍵值:', cacheKey, '參數:', queryParams);
            
            // 檢查報表數據緩存
            const cachedData = getCampaignCache(cacheKey);
            if (cachedData) {
                console.log('🎯 使用緩存的報表數據，跳過網路請求');
                
                // 從緩存恢復數據
                allAdsetReports = cachedData.allAdsetReports;
                allAdunitReports = cachedData.allAdunitReports;
                adunitByAdset = cachedData.adunitByAdset;
                currentCutData = cachedData.currentCutData;
                
                // 恢復隱藏欄位的值
                if (cachedData.hiddenFieldValues) {
                    Object.keys(cachedData.hiddenFieldValues).forEach(fieldId => {
                        const element = document.getElementById(fieldId);
                        if (element) {
                            element.value = cachedData.hiddenFieldValues[fieldId];
                        }
                    });
                }
                
                // 直接顯示結果，跳過網路請求
                loadingElement.style.display = 'none';
                
                // 初始化選擇狀態（預設全選）
                initializeSelections();
                
                // 建立選擇器界面
                buildSelectionInterface();
                
                // 顯示緩存提示
                showCacheMessage(cachedData.cacheTimestamp);
                
                // 解析並顯示合併的每日報表
                if (allAdsetReports && Object.keys(allAdsetReports).length > 0) {
                    const firstReport = Object.values(allAdsetReports)[0];
                    if (firstReport && firstReport.content) {
                        displayMergedDailyReport(firstReport.content, cachedData.summary);
                    }
                }
                
                // 顯示選擇區域（緩存時也需要顯示）
                const selectionSection = document.getElementById('selectionSection');
                if (selectionSection) {
                    selectionSection.style.display = 'block';
                }
                
                return; // 使用緩存，直接返回
            }
            
            // 第二步：使用正確的時間戳查詢報表
            console.log('正在查詢報表，使用時間戳:', `從 ${actualSinceDate} 到 ${actualToDate}`);
            console.log('使用查詢策略:', queryStrategy);
            
            const queries = [
                // 查詢 AdSet 層級報表資料
                fetch(`/api/report-proxy?campaignId=${encodeURIComponent(campaignId)}&sinceDate=${encodeURIComponent(actualSinceDate)}&toDate=${encodeURIComponent(actualToDate)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                })
            ];
            
            // 根據查詢策略決定是否查詢 AdUnit 層級報表
            if (queryStrategy === 'sequential') {
                queries.push(
                    fetch(`/api/adunit-reports-sequential?campaignId=${encodeURIComponent(campaignId)}&sinceDate=${encodeURIComponent(actualSinceDate)}&toDate=${encodeURIComponent(actualToDate)}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                );
            }
            
            // 如果是 slide 廣告，加入 AdUnit 查詢
            if (isSlideAd) {
                queries.push(
                    fetch(`/api/adunits?campaignId=${encodeURIComponent(campaignId)}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                );
                console.log('正在查詢 AdUnit:', `/api/adunits?campaignId=${encodeURIComponent(campaignId)}`);
            }
            
            // 並行查詢
            const responses = await Promise.all(queries);
            const [reportResponse, adunitReportResponse, adunitResponse] = responses;
            
            // 處理 AdSet 層級報表回應
            if (!reportResponse.ok) {
                throw new Error(`AdSet 報表請求失敗: HTTP ${reportResponse.status}: ${reportResponse.statusText}`);
            }
            
            const jsonResponse = await reportResponse.json();
            console.log('收到 AdSet 代理回應:', jsonResponse);
            
            // 儲存所有 AdSet 的報表數據
            allAdsetReports = jsonResponse.adset_reports || {};
            
            // 處理 AdUnit 層級報表回應
            if (adunitReportResponse && adunitReportResponse.ok) {
                const adunitJsonResponse = await adunitReportResponse.json();
                console.log('收到 AdUnit 報表回應:', adunitJsonResponse);
                
                if (adunitJsonResponse.success) {
                    allAdunitReports = adunitJsonResponse.adunit_reports || {};
                    adunitByAdset = adunitJsonResponse.adunit_by_adset || {};
                    
                    // 儲存查詢效能資訊到全域變數
                    if (adunitJsonResponse.summary) {
                        window.adunitQuerySummary = adunitJsonResponse.summary;
                        console.log('AdUnit 查詢效能:', adunitJsonResponse.summary);
                    }
                }
            } else {
                console.warn('AdUnit 報表查詢失敗或跳過');
                allAdunitReports = {};
                adunitByAdset = {};
                window.adunitQuerySummary = null;
            }
            
            // 處理 AdUnit 和 cut 數據
            let cutData = {};
            if (isSlideAd && adunitResponse && adunitResponse.ok) {
                const adunitResult = await adunitResponse.json();
                console.log('收到 AdUnit 資訊:', adunitResult);
                
                if (adunitResult.success && adunitResult.adunits.length > 0) {
                    // 逐一查詢每個 AdUnit 的 cut 數據，避免對線上服務造成壓力
                    console.log(`🎬 開始逐一查詢 ${adunitResult.adunits.length} 個 AdUnit 的 cut 數據`);
                    
                    // 顯示專門的 Cut 數據查詢提示
                    loadingElement.innerHTML = `
                        <p>📊 正在載入報表資料...</p>
                        <p style="color: #f39c12; font-weight: bold;">🎬 正在查詢 Cut 數據，這可能需要較長時間...</p>
                        <p style="font-size: 14px; color: #666;">
                            查詢 cut 需要較長時間，通常會大於 3 分鐘，請耐心等待<br>
                            📝 正在查詢 ${adunitResult.adunits.length} 個 AdUnit 的詳細數據<br>
                            ⚡ 為確保系統穩定，每個查詢間會有 2 秒間隔
                        </p>
                        <div style="margin-top: 15px;">
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; border-left: 4px solid #f39c12;">
                                <div id="cutDataProgress" style="font-weight: bold; color: #2c3e50;">準備開始...</div>
                                <div style="background: #e9ecef; height: 8px; border-radius: 4px; margin-top: 8px;">
                                    <div id="cutDataProgressBar" style="background: #f39c12; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    for (let i = 0; i < adunitResult.adunits.length; i++) {
                        const adunit = adunitResult.adunits[i];
                        const adunitName = adunit.title || adunit.name || 'Untitled';
                        
                        try {
                            console.log(`⏳ 查詢 AdUnit ${i + 1}/${adunitResult.adunits.length}: ${adunitName}`);
                            
                            // 更新進度顯示
                            const progressElement = document.getElementById('cutDataProgress');
                            const progressBarElement = document.getElementById('cutDataProgressBar');
                            if (progressElement && progressBarElement) {
                                progressElement.textContent = `正在查詢第 ${i + 1}/${adunitResult.adunits.length} 個 AdUnit: ${adunitName}`;
                                const progressPercent = Math.round(((i + 1) / adunitResult.adunits.length) * 100);
                                progressBarElement.style.width = `${progressPercent}%`;
                            }
                            
                            const response = await fetch(`/api/cut-data?uuid=${encodeURIComponent(adunit.uuid)}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                            });
                        
                        if (response.ok) {
                            const cutResult = await response.json();
                            if (cutResult.success) {
                                cutData[adunit.uuid] = {
                                    adunit: adunit,
                                    data: cutResult.data
                                };
                                    
                                    // 計算 cut 數據統計
                                    const successData = cutResult.data.success || {};
                                    const cutCount = Object.keys(successData).length;
                                    let totalClicks = 0;
                                    
                                    Object.values(successData).forEach(cutInfo => {
                                        totalClicks += cutInfo.reduce((sum, item) => sum + (item.totalCount || 0), 0);
                                    });
                                    
                                    console.log(`✅ AdUnit ${adunitName}: 找到 ${cutCount} 個 cut，總點擊 ${totalClicks}`);
                                } else {
                                    console.log(`⚠️ AdUnit ${adunitName}: cut 數據查詢失敗`);
                                }
                            } else {
                                console.log(`❌ AdUnit ${adunitName}: API 請求失敗 (${response.status})`);
                                
                                // 如果是超時錯誤，給予特別提示
                                if (response.status === 500) {
                                    const progressElement = document.getElementById('cutDataProgress');
                                    if (progressElement) {
                                        progressElement.innerHTML = `
                                            <span style="color: #e74c3c;">⚠️ AdUnit ${adunitName} 查詢超時</span><br>
                                            <span style="font-size: 12px; color: #666;">繼續查詢下一個...</span>
                                        `;
                                    }
                                }
                            }
                            
                            // 在查詢之間加入延遲，保護線上服務
                            if (i < adunitResult.adunits.length - 1) {
                                console.log(`⏸️ 等待 2 秒後查詢下一個 AdUnit...`);
                                await new Promise(resolve => setTimeout(resolve, 2000));
                            }
                            
                        } catch (error) {
                            console.error(`❌ 查詢 AdUnit ${adunitName} 時發生錯誤:`, error);
                            }
                        }
                    
                    console.log(`🎉 完成所有 cut 數據查詢，成功取得 ${Object.keys(cutData).length} 個 AdUnit 的數據`);
                    
                    // 更新進度為完成狀態
                    const progressElement = document.getElementById('cutDataProgress');
                    const progressBarElement = document.getElementById('cutDataProgressBar');
                    if (progressElement && progressBarElement) {
                        progressElement.innerHTML = `
                            <span style="color: #27ae60;">✅ Cut 數據查詢完成！</span><br>
                            <span style="font-size: 12px; color: #666;">成功取得 ${Object.keys(cutData).length} 個 AdUnit 的數據</span>
                        `;
                        progressBarElement.style.width = '100%';
                        progressBarElement.style.background = '#27ae60';
                    }
                    
                    // 2 秒後恢復正常載入狀態
                    setTimeout(() => {
                        loadingElement.innerHTML = '<p>📊 正在處理報表資料...</p>';
                    }, 2000);
                }
            }
            
            currentCutData = cutData;
            
            if (jsonResponse.success) {
                const htmlContent = jsonResponse.content;
                console.log('收到 HTML 內容，長度:', htmlContent.length);
                
                // 保存到緩存
                const cacheData = {
                    currentAdsetInfo: currentAdsetInfo,
                    allAdsetReports: allAdsetReports,
                    allAdunitReports: allAdunitReports,
                    adunitByAdset: adunitByAdset,
                    currentCutData: currentCutData,
                    summary: jsonResponse.summary,
                    cacheTimestamp: Date.now(),
                    hiddenFieldValues: {
                        sinceDate: document.getElementById('sinceDate').value,
                        toDate: document.getElementById('toDate').value,
                        campaignEndDate: document.getElementById('campaignEndDate').value,
                        currentDate: document.getElementById('currentDate').value
                    }
                };
                
                setCampaignCache(cacheKey, cacheData);
                
                // 初始化選擇狀態（預設全選）
                initializeSelections();
                
                // 建立選擇器界面
                buildSelectionInterface();
                
                // 解析並顯示合併的每日報表
                displayMergedDailyReport(htmlContent, jsonResponse.summary);
                
                // 顯示選擇區域
                selectionSection.style.display = 'block';
            } else {
                throw new Error(jsonResponse.error || '代理請求失敗');
            }
            
        } catch (error) {
            console.error('取得報表時發生錯誤:', error);
            
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            errorElement.innerHTML = `
                <h4>❌ 取得報表失敗</h4>
                <p><strong>錯誤詳情:</strong> ${error.message}</p>
                <p><strong>可能原因:</strong></p>
                <ul>
                    <li>網路連線問題</li>
                    <li>廣告活動 ID 不正確</li>
                    <li>Cookie 可能已過期</li>
                    <li>伺服器代理服務異常</li>
                    ${isSlideAd ? '<li>AdUnit 或 cut 數據查詢失敗</li>' : ''}
                </ul>
                <p><strong>建議解決方法:</strong></p>
                <ul>
                    <li>確認廣告活動 ID 是否正確</li>
                    <li>檢查網路連線</li>
                    <li>嘗試重新整理頁面</li>
                    <li>如果問題持續，請聯絡技術支援</li>
                </ul>
            `;
        }
    }
    
    // 新增：檢查 AdSet 是否應該被過濾（包含 demo）
    function shouldFilterAdset(report) {
        if (!report || !report.name) return false;
        return report.name.toLowerCase().includes('demo');
    }
    
    // 新增：初始化選擇狀態
    function initializeSelections() {
        selectedAdsets.clear();
        selectedAdunits.clear();
        
        // 預設選擇在時間區段內且成功的 AdSet（過濾掉包含 demo 的）
        for (const adsetId in allAdsetReports) {
            const report = allAdsetReports[adsetId];
            if (report.success && isAdsetInTimeRange(report) && !shouldFilterAdset(report)) {
                selectedAdsets.add(adsetId);
                console.log(`預設選擇 AdSet: ${report.name}`);
            } else {
                const filterReason = shouldFilterAdset(report) ? '包含 demo' : `成功: ${report.success}, 在時間區段: ${isAdsetInTimeRange(report)}`;
                console.log(`跳過 AdSet: ${report.name} (${filterReason})`);
            }
        }
        
        // 預設選擇在時間區段內且成功的 AdUnit（同時過濾掉包含 demo 的 AdSet 下的 AdUnit）
        for (const adunitUuid in allAdunitReports) {
            const report = allAdunitReports[adunitUuid];
            
            // 檢查對應的 AdSet 是否包含 demo
            let shouldSkipForDemo = false;
            for (const [adsetId, adsetData] of Object.entries(adunitByAdset)) {
                const adsetReport = allAdsetReports[adsetId];
                if (adsetData.adunits.some(adunit => adunit.uuid === adunitUuid) && 
                    adsetReport && shouldFilterAdset(adsetReport)) {
                    shouldSkipForDemo = true;
                    console.log(`跳過 AdUnit: ${report.name} (所屬 AdSet "${adsetReport.name}" 包含 demo)`);
                    break;
                }
            }
            
            if (!shouldSkipForDemo && report.success && isAdunitInTimeRange(report)) {
                selectedAdunits.add(adunitUuid);
                console.log(`預設選擇 AdUnit: ${report.name}`);
            } else if (!shouldSkipForDemo) {
                console.log(`跳過 AdUnit: ${report.name} (成功: ${report.success}, 在時間區段: ${isAdunitInTimeRange(report)})`);
            }
        }
        
        // 同步到全域變數
        window.selectedAdsets = selectedAdsets;
        window.selectedAdunits = selectedAdunits;
        
        console.log(`初始化完成 - 選擇的 AdSet: ${selectedAdsets.size}/${Object.keys(allAdsetReports).length}, AdUnit: ${selectedAdunits.size}/${Object.keys(allAdunitReports).length}`);
    }
    
    // 新增：建立選擇器界面
    function buildSelectionInterface() {
        const adsetList = document.getElementById('adsetSelectionList');
        const adunitList = document.getElementById('adunitSelectionList');
        
        // 清空現有內容
        adsetList.innerHTML = '';
        adunitList.innerHTML = '';
        
        // 建立 AdSet 選擇器（過濾掉包含 demo 的）
        for (const [adsetId, report] of Object.entries(allAdsetReports)) {
            // 過濾包含 demo 的 AdSet
            if (shouldFilterAdset(report)) {
                console.log(`過濾掉包含 demo 的 AdSet: ${report.name}`);
                continue;
            }
            
            const item = document.createElement('div');
            item.className = 'selection-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `adset_${adsetId}`;
            checkbox.value = adsetId;
            checkbox.checked = selectedAdsets.has(adsetId) && report.success;
            checkbox.disabled = !report.success;
            checkbox.addEventListener('change', updateSelectionSummary);
            
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.className = 'selection-item-label';
            label.textContent = `${report.name} ${report.success ? '✅' : '❌'}`;
            
            if (!report.success) {
                const errorInfo = document.createElement('div');
                errorInfo.className = 'selection-item-subtitle';
                errorInfo.textContent = `錯誤: ${report.error}`;
                label.appendChild(errorInfo);
            }
            
            item.appendChild(checkbox);
            item.appendChild(label);
            adsetList.appendChild(item);
        }
        
        // 建立 AdUnit 選擇器（過濾掉包含 demo 的 AdSet）
        for (const [adsetId, adsetData] of Object.entries(adunitByAdset)) {
            // 檢查對應的 AdSet 是否應該被過濾
            const adsetReport = allAdsetReports[adsetId];
            if (adsetReport && shouldFilterAdset(adsetReport)) {
                console.log(`過濾掉包含 demo 的 AdSet 下的 AdUnit: ${adsetData.adsetName}`);
                continue;
            }
            
            // 添加 AdSet 標題
            const adsetHeader = document.createElement('div');
            adsetHeader.style.fontWeight = 'bold';
            adsetHeader.style.color = '#2e7d32';
            adsetHeader.style.marginTop = '10px';
            adsetHeader.style.marginBottom = '5px';
            adsetHeader.textContent = `📊 ${adsetData.adsetName}`;
            adunitList.appendChild(adsetHeader);
            
            // 添加該 AdSet 下的所有 AdUnit
            for (const adunitReport of adsetData.adunits) {
                const item = document.createElement('div');
                item.className = 'selection-item';
                item.style.marginLeft = '15px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `adunit_${adunitReport.uuid}`;
                checkbox.value = adunitReport.uuid;
                checkbox.checked = selectedAdunits.has(adunitReport.uuid) && adunitReport.success;
                checkbox.disabled = !adunitReport.success;
                checkbox.addEventListener('change', updateSelectionSummary);
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.className = 'selection-item-label';
                label.textContent = `${adunitReport.name} ${adunitReport.success ? '✅' : '❌'}`;
                
                const subtitle = document.createElement('div');
                subtitle.className = 'selection-item-subtitle';
                subtitle.textContent = `UUID: ${adunitReport.uuid.slice(0, 8)}...`;
                
                if (!adunitReport.success) {
                    subtitle.textContent += ` | 錯誤: ${adunitReport.error}`;
                }
                
                label.appendChild(subtitle);
                
                item.appendChild(checkbox);
                item.appendChild(label);
                adunitList.appendChild(item);
            }
        }
        
        updateSelectionSummary();
    }
    
    // 新增：切換所有 checkbox
    function toggleAllCheckboxes(listId, checked) {
        const list = document.getElementById(listId);
        const checkboxes = list.querySelectorAll('input[type="checkbox"]:not(:disabled)');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
            
            if (listId === 'adsetSelectionList') {
                if (checked) {
                    selectedAdsets.add(checkbox.value);
                } else {
                    selectedAdsets.delete(checkbox.value);
                }
            } else if (listId === 'adunitSelectionList') {
                if (checked) {
                    selectedAdunits.add(checkbox.value);
                } else {
                    selectedAdunits.delete(checkbox.value);
                }
            }
        });
    }
    
    // 新增：更新選擇摘要
    function updateSelectionSummary() {
        // 從 DOM 更新選擇狀態
        selectedAdsets.clear();
        selectedAdunits.clear();
        
        document.querySelectorAll('#adsetSelectionList input[type="checkbox"]:checked').forEach(cb => {
            selectedAdsets.add(cb.value);
        });
        
        document.querySelectorAll('#adunitSelectionList input[type="checkbox"]:checked').forEach(cb => {
            selectedAdunits.add(cb.value);
        });
        
        const summary = document.getElementById('selectionSummary');
        const totalAdsets = Object.keys(allAdsetReports).filter(id => allAdsetReports[id].success && !shouldFilterAdset(allAdsetReports[id])).length;
        
        // 計算不屬於包含 demo 的 AdSet 的 AdUnit 總數
        const totalAdunits = Object.keys(allAdunitReports).filter(adunitUuid => {
            const report = allAdunitReports[adunitUuid];
            if (!report.success) return false;
            
            // 檢查對應的 AdSet 是否包含 demo
            for (const [adsetId, adsetData] of Object.entries(adunitByAdset)) {
                const adsetReport = allAdsetReports[adsetId];
                if (adsetData.adunits.some(adunit => adunit.uuid === adunitUuid) && 
                    adsetReport && shouldFilterAdset(adsetReport)) {
                    return false; // 排除屬於包含 demo 的 AdSet 的 AdUnit
                }
            }
            return true;
        }).length;
        
        summary.innerHTML = `
            📊 已選擇：${selectedAdsets.size}/${totalAdsets} 個 AdSet，${selectedAdunits.size}/${totalAdunits} 個 AdUnit
            ${selectedAdsets.size === 0 && selectedAdunits.size === 0 ? '<br>⚠️ 請至少選擇一個項目' : ''}
        `;
    }
    
    // 新增：更新報表顯示
    function updateReportDisplay() {
        if (selectedAdsets.size === 0 && selectedAdunits.size === 0) {
            alert('請至少選擇一個 AdSet 或 AdUnit');
            return;
        }
        
        // 重新顯示報表，只包含選中的項目
        const htmlContent = allAdsetReports[Object.keys(allAdsetReports)[0]]?.content || '';
        displayMergedDailyReport(htmlContent, {
            total_adsets: selectedAdsets.size,
            successful_reports: selectedAdsets.size,
            failed_reports: 0
        }, true); // 傳入 true 表示這是更新顯示
    }

    // 顯示合併的每日報表
    function displayMergedDailyReport(primaryHtmlContent, summary, isUpdate) {
        const loadingElement = document.getElementById('loadingMessage');
        const reportElement = document.getElementById('reportContent');
        const dailyReportContainer = document.getElementById('dailyReportContainer');
        
        // 獲取走期和當前日期設定
        const campaignEndDate = document.getElementById('campaignEndDate').value;
        const currentDate = document.getElementById('currentDate').value;
        
        loadingElement.style.display = 'none';
        
        try {
            // 首先顯示活動概覽
            let reportContent = `
                <div class="daily-report-section">
                    <h4>📊 活動概覽</h4>
                    <p><strong>活動名稱:</strong> ${currentAdsetInfo?.info?.name || '未知活動'}</p>
                    <p><strong>廣告集數量:</strong> ${currentAdsetInfo?.info?.adsetCount || 0} 個</p>
                    <p><strong>報表狀態:</strong> ${summary?.successful_reports || 0} 個成功 / ${summary?.total_adsets || 0} 個總計</p>
                    ${summary?.failed_reports > 0 ? `<p style="color: #dc3545;"><strong>⚠️ ${summary.failed_reports} 個廣告集查詢失敗</strong></p>` : ''}
                </div>
            `;
            
            // 合併所有成功的報表數據
            const mergedTable = mergeAllAdsetReports();
            if (mergedTable) {
                // 如果是 slide 廣告，需要重新構建表格以包含 cut 數據
                let finalTable = mergedTable;
                if (isSlideAd && Object.keys(currentCutData).length > 0) {
                    finalTable = buildSlideReportTable(mergedTable, currentCutData);
                } else {
                    // 對於非 slide 廣告，確保有 TOTAL 行
                    finalTable = ensureTableHasTotal(finalTable);
                }
                
                // 處理表格內容，根據走期設定調整顯示
                if (campaignEndDate && currentDate) {
                    finalTable = processTableBySchedule(finalTable, campaignEndDate, currentDate);
                }
                
                // 顯示合併的總表格
                reportContent += `
                    <div class="daily-report-section">
                        <h4>📈 合併報表數據${isSlideAd ? '（含 Cut 分析數據）' : ''}</h4>
                        ${finalTable.outerHTML}
                    </div>
                `;
                
                // 顯示個別 AdSet 的報表
                reportContent += displayIndividualAdsetReports();
                
                dailyReportContainer.innerHTML = reportContent;
                
                // 美化表格
                const tables = dailyReportContainer.querySelectorAll('table');
                tables.forEach(table => {
                    table.className = 'report-table';
                });
                
                reportElement.style.display = 'block';
                
                // 顯示成功訊息和各種資訊
                addReportMessages(dailyReportContainer, campaignEndDate, currentDate);
                
                // 啟用導出按鈕並儲存報表資料
                enableExportButton();
                
                // 綁定重新生成按鈕事件
                const refreshBtn = document.getElementById('refreshReportBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', regenerateMergedReport);
                }
                
                currentReportData = {
                    campaignId: document.getElementById('campaignId').value.trim(),
                    sinceDate: document.getElementById('sinceDate').value,
                    toDate: document.getElementById('toDate').value,
                    campaignEndDate: campaignEndDate,
                    currentDate: currentDate,
                    table: finalTable,
                    isSlideAd: isSlideAd,
                    cutData: currentCutData,
                    allAdsetReports: allAdsetReports,
                    allAdunitReports: allAdunitReports,
                    adunitByAdset: adunitByAdset
                };
            } else {
                throw new Error('無法合併報表數據');
            }
            
        } catch (error) {
            console.error('解析 HTML 內容時發生錯誤:', error);
            
            // 如果解析失敗，顯示錯誤訊息
            dailyReportContainer.innerHTML = `
                <div class="daily-report-section">
                    <h4>⚠️ 無法合併報表數據</h4>
                    <p style="color: #6c757d;">
                        <strong>錯誤:</strong> ${error.message}
                    </p>
                    <p style="color: #6c757d; font-size: 14px;">
                        可能原因：報表格式已變更或數據不完整。請檢查廣告活動 ID 是否正確。
                    </p>
                </div>
            `;
            reportElement.style.display = 'block';
        }
    }
    
    // 合併所有 AdSet 的報表數據
    function mergeAllAdsetReports() {
        if (!allAdsetReports || Object.keys(allAdsetReports).length === 0) {
            return null;
        }
        
        // 根據選擇過濾 AdSet 報表，並過濾時間區段和包含 demo 的
        const filteredReports = Object.entries(allAdsetReports)
            .filter(([adsetId, report]) => {
                if (!selectedAdsets.has(adsetId) || !report.success) {
                    return false;
                }
                
                // 過濾包含 demo 的 AdSet
                if (shouldFilterAdset(report)) {
                    console.log(`合併報表時過濾掉包含 demo 的 AdSet: ${report.name}`);
                    return false;
                }
                
                // 檢查時間區段過濾
                if (!isAdsetInTimeRange(report)) {
                    return false;
                }
                
                return true;
            })
            .map(([adsetId, report]) => report);
        
        if (filteredReports.length === 0) {
            return null;
        }
        
        console.log(`開始合併 ${filteredReports.length} 個選中且在時間區段內的報表`);
        
        // 解析所有選中的報表表格
        const parsedTables = [];
        for (const report of filteredReports) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(report.content, 'text/html');
            const table = findDailyReportTable(doc);
            if (table) {
                parsedTables.push({
                    name: report.name,
                    table: table
                });
            }
        }
        
        if (parsedTables.length === 0) {
            return null;
        }
        
        // 如果只有一個表格，直接返回
        if (parsedTables.length === 1) {
            return parsedTables[0].table;
        }
        
        // 合併多個表格的數據
        return mergeTables(parsedTables);
    }
    
    // 新增：檢查 AdSet 是否在時間區段內
    function isAdsetInTimeRange(report) {
        const useCustomTime = document.getElementById('useCustomTime').checked;
        if (!useCustomTime) {
            return true; // 如果沒有使用自訂時間，所有 AdSet 都顯示
        }
        
        const customStartDate = document.getElementById('customStartDate').value;
        const customEndDate = document.getElementById('customEndDate').value;
        
        if (!customStartDate || !customEndDate) {
            return true; // 如果時間設定不完整，顯示所有
        }
        
        console.log(`檢查 AdSet 時間區段: ${report.name}, 區段: ${customStartDate} ~ ${customEndDate}`);
        
        // 解析報表內容，檢查是否有在時間區段內的數據
        const parser = new DOMParser();
        const doc = parser.parseFromString(report.content, 'text/html');
        const table = findDailyReportTable(doc);
        
        if (!table) {
            console.log(`AdSet ${report.name}: 找不到表格`);
            return true;
        }
        
        const rows = table.querySelectorAll('tr');
        const startTime = new Date(customStartDate).getTime();
        const endTime = new Date(customEndDate + 'T23:59:59').getTime();
        
        console.log(`時間區段範圍: ${startTime} ~ ${endTime}`);
        
        let hasDataInRange = false;
        
        // 檢查表格中是否有在時間區段內的數據行
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].querySelectorAll('td, th');
            if (cells.length === 0) continue;
            
            const dateText = cells[0].textContent.trim();
            if (dateText === 'TOTAL') continue;
            
            // 解析日期 - 增強版本
            let rowDate = null;
            
            // 格式 1: YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
            } 
            // 格式 2: MM/DD (使用當前年份)
            else if (/^\d{1,2}\/\d{1,2}$/.test(dateText)) {
                const [month, day] = dateText.split('/').map(num => parseInt(num));
                const currentYear = new Date().getFullYear();
                rowDate = new Date(currentYear, month - 1, day);
            } 
            // 格式 3: MM-DD (使用當前年份)
            else if (/^\d{1,2}-\d{1,2}$/.test(dateText)) {
                const [month, day] = dateText.split('-').map(num => parseInt(num));
                const currentYear = new Date().getFullYear();
                rowDate = new Date(currentYear, month - 1, day);
            }
            // 格式 4: YYYY/MM/DD
            else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateText)) {
                const [year, month, day] = dateText.split('/').map(num => parseInt(num));
                rowDate = new Date(year, month - 1, day);
            }
            // 格式 5: DD/MM/YYYY (某些地區格式)
            else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateText)) {
                const parts = dateText.split('/').map(num => parseInt(num));
                // 假設是 DD/MM/YYYY 格式
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                rowDate = new Date(year, month - 1, day);
            }
            
            if (rowDate && !isNaN(rowDate.getTime())) {
                const rowTime = rowDate.getTime();
                console.log(`  檢查日期: ${dateText} -> ${rowDate.toISOString().split('T')[0]} (${rowTime})`);
                
                if (rowTime >= startTime && rowTime <= endTime) {
                    console.log(`    ✅ 在區段內!`);
                    hasDataInRange = true;
                    break; // 找到一筆在範圍內的數據就足夠了
                } else {
                    console.log(`    ❌ 不在區段內`);
                }
            } else {
                console.log(`  無法解析日期: ${dateText}`);
            }
        }
        
        console.log(`AdSet ${report.name} 最終結果: ${hasDataInRange ? '顯示' : '隱藏'}`);
        return hasDataInRange;
    }
    
    // 新增：檢查 AdUnit 是否在時間區段內
    function isAdunitInTimeRange(adunitReport) {
        const useCustomTime = document.getElementById('useCustomTime').checked;
        if (!useCustomTime) {
            return true;
        }
        
        const customStartDate = document.getElementById('customStartDate').value;
        const customEndDate = document.getElementById('customEndDate').value;
        
        if (!customStartDate || !customEndDate) {
            return true;
        }
        
        console.log(`檢查 AdUnit 時間區段: ${adunitReport.name}, 區段: ${customStartDate} ~ ${customEndDate}`);
        
        // 解析 AdUnit 報表內容
        const parser = new DOMParser();
        const doc = parser.parseFromString(adunitReport.content, 'text/html');
        const table = findDailyReportTable(doc);
        
        if (!table) {
            console.log(`AdUnit ${adunitReport.name}: 找不到表格`);
            return true;
        }
        
        const rows = table.querySelectorAll('tr');
        const startTime = new Date(customStartDate).getTime();
        const endTime = new Date(customEndDate + 'T23:59:59').getTime();
        
        let hasDataInRange = false;
        
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].querySelectorAll('td, th');
            if (cells.length === 0) continue;
            
            const dateText = cells[0].textContent.trim();
            if (dateText === 'TOTAL') continue;
            
            // 解析日期 - 增強版本 (與 AdSet 相同邏輯)
            let rowDate = null;
            
            // 格式 1: YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
            } 
            // 格式 2: MM/DD (使用當前年份)
            else if (/^\d{1,2}\/\d{1,2}$/.test(dateText)) {
                const [month, day] = dateText.split('/').map(num => parseInt(num));
                const currentYear = new Date().getFullYear();
                rowDate = new Date(currentYear, month - 1, day);
            } 
            // 格式 3: MM-DD (使用當前年份)
            else if (/^\d{1,2}-\d{1,2}$/.test(dateText)) {
                const [month, day] = dateText.split('-').map(num => parseInt(num));
                const currentYear = new Date().getFullYear();
                rowDate = new Date(currentYear, month - 1, day);
            }
            // 格式 4: YYYY/MM/DD
            else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateText)) {
                const [year, month, day] = dateText.split('/').map(num => parseInt(num));
                rowDate = new Date(year, month - 1, day);
            }
            // 格式 5: DD/MM/YYYY (某些地區格式)
            else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateText)) {
                const parts = dateText.split('/').map(num => parseInt(num));
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                rowDate = new Date(year, month - 1, day);
            }
            
            if (rowDate && !isNaN(rowDate.getTime())) {
                const rowTime = rowDate.getTime();
                console.log(`  檢查 AdUnit 日期: ${dateText} -> ${rowDate.toISOString().split('T')[0]} (${rowTime})`);
                
                if (rowTime >= startTime && rowTime <= endTime) {
                    console.log(`    ✅ AdUnit 在區段內!`);
                    hasDataInRange = true;
                    break;
                } else {
                    console.log(`    ❌ AdUnit 不在區段內`);
                }
            } else {
                console.log(`  無法解析 AdUnit 日期: ${dateText}`);
            }
        }
        
        console.log(`AdUnit ${adunitReport.name} 最終結果: ${hasDataInRange ? '顯示' : '隱藏'}`);
        return hasDataInRange;
    }
    
    // 合併多個表格的函數
    function mergeTables(parsedTables) {
        if (!parsedTables || parsedTables.length === 0) return null;
        
        // 取第一個表格作為基礎
        const baseTable = parsedTables[0].table.cloneNode(true);
        const baseRows = baseTable.querySelectorAll('tr');
        
        if (baseRows.length < 2) return baseTable;
        
        // 建立日期到數據的對照表
        const mergedData = {};
        let headers = [];
        
        // 取得表頭
        const headerCells = baseRows[0].querySelectorAll('th, td');
        for (let cell of headerCells) {
            headers.push(cell.textContent.trim());
        }
        
        // 處理每個表格的數據
        for (const {table} of parsedTables) {
            const rows = table.querySelectorAll('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td, th');
                
                if (cells.length > 0) {
                    const dateText = cells[0].textContent.trim();
                    
                    // 跳過 TOTAL 行
                    if (dateText === 'TOTAL') continue;
                    
                    if (!mergedData[dateText]) {
                        mergedData[dateText] = {};
                    }
                    
                    // 合併數值數據
                    for (let j = 1; j < cells.length; j++) {
                        const cellText = cells[j].textContent.trim();
                        
                        if (!mergedData[dateText][j]) {
                            mergedData[dateText][j] = {
                                value: 0,
                                isPercentage: false,
                                impressions: 0,
                                clicks: 0
                            };
                        }
                        
                        // 檢查是否為百分比欄位
                        if (cellText.includes('%')) {
                            mergedData[dateText][j].isPercentage = true;
                        } else {
                            const cellValue = parseFloat(cellText.replace(/[,]/g, '')) || 0;
                            mergedData[dateText][j].value += cellValue;
                            
                            // 特別處理曝光數和點擊數，用於重新計算點擊率
                            if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                                mergedData[dateText][j].impressions += cellValue;
                            } else if (headers[j] && headers[j].includes('點擊數')) {
                                mergedData[dateText][j].clicks += cellValue;
                            }
                        }
                    }
                }
            }
        }
        
        // 重建表格
        const newTable = document.createElement('table');
        newTable.className = baseTable.className;
        
        // 添加表頭
        const headerRow = document.createElement('tr');
        for (let header of headers) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);
        
        // 添加合併後的數據行
        const sortedDates = Object.keys(mergedData).sort();
        let totalImp = 0, totalClk = 0;
        
        for (const date of sortedDates) {
            const row = document.createElement('tr');
            const dateCell = document.createElement('td');
            dateCell.textContent = date;
            row.appendChild(dateCell);
            
            const rowData = mergedData[date];
            for (let j = 1; j < headers.length; j++) {
                const cell = document.createElement('td');
                const data = rowData[j] || { value: 0, isPercentage: false, impressions: 0, clicks: 0 };
                
                if (data.isPercentage) {
                    // 重新計算點擊率/觀看率
                    let impressions = 0, clicks = 0;
                    
                    // 找到曝光數和點擊數欄位
                    for (let k = 1; k < headers.length; k++) {
                        if (headers[k].includes('曝光數') || headers[k].includes('播放數')) {
                            impressions = rowData[k] ? rowData[k].value : 0;
                        } else if (headers[k].includes('點擊數')) {
                            clicks = rowData[k] ? rowData[k].value : 0;
                        }
                    }
                    
                    if (impressions > 0) {
                        cell.textContent = ((clicks / impressions) * 100).toFixed(2) + '%';
                    } else {
                        cell.textContent = '0.00%';
                    }
                } else {
                    const value = data.value;
                    if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                        totalImp += value;
                        cell.textContent = value > 0 ? value.toLocaleString() : '';
                    } else if (headers[j] && headers[j].includes('點擊數')) {
                        totalClk += value;
                        cell.textContent = value > 0 ? value.toString() : '';
                    } else {
                        cell.textContent = value > 0 ? value.toString() : '';
                    }
                }
                
                row.appendChild(cell);
            }
            
            newTable.appendChild(row);
        }
        
        // 添加 TOTAL 行
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        
        // 為每個表頭欄位創建對應的 TOTAL 欄位
        for (let j = 0; j < headers.length; j++) {
            const cell = document.createElement('td');
            cell.style.fontWeight = 'bold';
            
            if (j === 0) {
                // 第一欄顯示 TOTAL
                cell.textContent = 'TOTAL';
            } else if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                cell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
            } else if (headers[j] && headers[j].includes('點擊數')) {
                cell.textContent = totalClk > 0 ? totalClk.toString() : '';
            } else if (headers[j] && (headers[j].includes('點擊率') || headers[j].includes('觀看率'))) {
                if (totalImp > 0) {
                    cell.textContent = ((totalClk / totalImp) * 100).toFixed(2) + '%';
                    cell.style.color = '#dc3545';
                } else {
                    cell.textContent = '0.00%';
                }
            } else {
                // 其他欄位留空
                cell.textContent = '';
            }
            
            totalRow.appendChild(cell);
        }
        
        newTable.appendChild(totalRow);
        
        return newTable;
    }
    
    // 顯示個別 AdSet 的報表
    function displayIndividualAdsetReports() {
        let content = '';
        
        if (!allAdsetReports || Object.keys(allAdsetReports).length === 0) {
            return content;
        }
        
        content += `<div class="daily-report-section">
            <h4>📋 個別廣告集報表 <button id="refreshReportBtn" class="button" style="margin-left: 10px; font-size: 12px;">🔄 重新生成總合報表</button></h4>
        `;
        
        // 過濾並顯示在時間區段內且不包含 demo 的 AdSet
        const filteredAdsets = Object.entries(allAdsetReports).filter(([adsetId, report]) => {
            return report.success && isAdsetInTimeRange(report) && !shouldFilterAdset(report);
        });
        
        if (filteredAdsets.length === 0) {
            content += `
                <div style="margin: 20px 0; padding: 15px; border: 1px solid #ffc107; border-radius: 8px; background: #fff3cd;">
                    <p style="color: #856404; margin: 0;">📅 在當前時間區段內沒有找到任何廣告集數據</p>
                </div>
            `;
        }
        
        for (const [adsetId, report] of filteredAdsets) {
            const isCollapsed = !selectedAdsets.has(adsetId);
            const buttonText = isCollapsed ? '➕' : '➖';
            const buttonStyle = isCollapsed ? 'background: #6c757d; color: white;' : 'background: #28a745; color: white;';
            const displayStyle = isCollapsed ? 'display: none;' : '';
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(report.content, 'text/html');
            const table = findDailyReportTable(doc);
            
            if (table) {
                content += `
                    <div style="margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="color: #495057; margin: 0;">📊 ${report.name}</h5>
                            <button onclick="toggleAdsetCollapse('${adsetId}')" class="button" style="${buttonStyle} font-size: 12px; padding: 6px 12px;">
                                ${buttonText}
                            </button>
                        </div>
                        <div id="adset-content-${adsetId}" style="${displayStyle}">
                            ${ensureAdsetTableHasTotal(table, adsetId).outerHTML}
                        </div>
                    </div>
                `;
                
                // 添加該 AdSet 下在時間區段內的 AdUnit 報表（並排顯示）
                if (adunitByAdset[adsetId] && adunitByAdset[adsetId].adunits.length > 0) {
                    // 過濾在時間區段內且被選中的 AdUnit
                    const filteredAdunits = adunitByAdset[adsetId].adunits.filter(adunitReport => {
                        return adunitReport.success && isAdunitInTimeRange(adunitReport) && selectedAdunits.has(adunitReport.uuid);
                    });
                    
                    if (filteredAdunits.length > 0) {
                        content += `
                            <div id="adunit-section-${adsetId}" style="margin: 10px 0 20px 20px; padding: 15px; border: 1px solid #28a745; border-radius: 8px; background: #f8fff9; ${displayStyle}">
                        `;
                        
                        // 根據選擇的佈局方式顯示 AdUnit 報表
                        const layoutMode = document.querySelector('input[name="adunitLayout"]:checked')?.value || 'horizontal';
                        
                        if (layoutMode === 'horizontal') {
                            // 原來的並排顯示
                            content += generateAdunitImagesSection(filteredAdunits);
                            content += `<h6 style="color: #28a745; margin-bottom: 15px;">🎯 AdUnit 報表 (${filteredAdunits.length} 個並排顯示)</h6>`;
                            
                            const mergedAdunitTable = mergeAdunitReportsForAdset(filteredAdunits);
                            if (mergedAdunitTable) {
                                content += `<div style="overflow-x: auto;">${mergedAdunitTable.outerHTML}</div>`;
                            } else {
                                content += `<p style="color: #dc3545;">無法生成並排的 AdUnit 報表</p>`;
                            }
                        } else {
                            // 新的垂直排列顯示
                            content += `<h6 style="color: #007bff; margin-bottom: 15px;">🎯 AdUnit 報表 (${filteredAdunits.length} 個垂直排列)</h6>`;
                            content += generateVerticalAdunitReports(filteredAdunits);
                        }
                        
                        content += `</div>`;
                    }
                }
            }
        }
        
        content += '</div>';
        return content;
    }
    
    // 新增：生成 AdUnit 圖片展示區域
    function generateAdunitImagesSection(adunitReports) {
        if (!adunitReports || adunitReports.length === 0) return '';
        
        let imagesHTML = `
            <div class="adunit-images-section">
                <h6>📸 AdUnit 圖片預覽</h6>
                <div class="adunit-images-grid">
        `;
        
        adunitReports.forEach(adunit => {
            const imgMain = adunit.img_main || '';
            const adunitName = adunit.name || adunit.uuid?.substring(0, 8) || 'Unknown';
            
            if (imgMain) {
                imagesHTML += `
                    <div class="adunit-image-item">
                        <div class="name">${adunitName}</div>
                        <img src="${imgMain}" 
                             alt="${adunitName}" 
                             title="點擊查看大圖"
                             onclick="window.open('${imgMain}', '_blank')"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="error-message" style="display: none;">圖片載入失敗</div>
                    </div>
                `;
            } else {
                imagesHTML += `
                    <div class="adunit-image-item">
                        <div class="name">${adunitName}</div>
                        <div class="no-image">無圖片</div>
                    </div>
                `;
            }
        });
        
        imagesHTML += `
                </div>
            </div>
        `;
        
        return imagesHTML;
    }

    // 新增：生成垂直排列的 AdUnit 報表
    function generateVerticalAdunitReports(adunitReports) {
        if (!adunitReports || adunitReports.length === 0) return '';
        
        let verticalHTML = '';
        
        adunitReports.forEach((adunitReport, index) => {
            const adunitName = adunitReport.name || adunitReport.uuid?.substring(0, 8) || 'Unknown';
            const adunitUuid = adunitReport.uuid || '';
            const imgMain = adunitReport.img_main || '';
            
            verticalHTML += `
                <div class="vertical-adunit-item">
                    <div class="vertical-adunit-header">
                        <div class="vertical-adunit-name">📱 ${adunitName}</div>
                        <div class="vertical-adunit-uuid">${adunitUuid.substring(0, 8)}...</div>
                    </div>
            `;
            
            // 添加圖片（如果有的話）
            if (imgMain) {
                verticalHTML += `
                    <div class="vertical-adunit-image">
                        <img src="${imgMain}" 
                             alt="${adunitName}" 
                             title="點擊查看大圖 - ${adunitName}"
                             onclick="window.open('${imgMain}', '_blank')"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="no-image" style="display: none;">圖片載入失敗</div>
                    </div>
                `;
            } else {
                verticalHTML += `
                    <div class="vertical-adunit-image">
                        <div class="no-image">無圖片</div>
                    </div>
                `;
            }
            
            // 生成該 AdUnit 的報表表格
            const parser = new DOMParser();
            const doc = parser.parseFromString(adunitReport.content, 'text/html');
            const table = findDailyReportTable(doc);
            
            if (table) {
                // 複製表格並應用垂直樣式
                let verticalTable = table.cloneNode(true);
                verticalTable.className = 'vertical-adunit-table';
                
                // 如果是 slide 廣告且有 cut 數據，為這個單獨的 AdUnit 建構包含 cut 數據的表格
                if (isSlideAd && Object.keys(currentCutData).length > 0 && currentCutData[adunitUuid]) {
                    console.log(`🎬 為垂直排列的 AdUnit ${adunitName} 添加 cut 數據`);
                    
                    // 為單個 AdUnit 建構 cut 數據表格（已包含 TOTAL 行）
                    const singleAdunitCutData = {};
                    singleAdunitCutData[adunitUuid] = currentCutData[adunitUuid];
                    
                    verticalTable = buildSlideReportTableForSingleAdunit(verticalTable, singleAdunitCutData, adunitUuid);
                    
                    // 添加 cut 數據說明
                    verticalHTML += `
                        <div style="background: #e8f4fd; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; color: #0066cc;">
                            🎬 <strong>包含 Cut 分析數據</strong> - 顯示各 cut 區塊的點擊數據分佈
                        </div>
                    `;
                } else {
                    // 確保有 TOTAL 行
                    verticalTable = ensureAdunitTableHasTotal(verticalTable, adunitName);
                }
                
                verticalHTML += `<div style="overflow-x: auto;">${verticalTable.outerHTML}</div>`;
            } else {
                verticalHTML += `
                    <p style="color: #dc3545; text-align: center; padding: 20px;">
                        ❌ 無法解析 ${adunitName} 的報表數據
                    </p>
                `;
            }
            
            verticalHTML += `</div>`;
        });
        
        return verticalHTML;
    }

    // 新增：通用的確保表格有 TOTAL 行的函數（可處理任何表格，包括有 cut 數據的表格）
    function ensureTableHasTotal(originalTable) {
        if (!originalTable) return originalTable;
        
        const table = originalTable.cloneNode(true);
        const rows = table.querySelectorAll('tr');
        
        // 檢查是否已經有 TOTAL 行
        const hasTotalRow = Array.from(rows).some(row => {
            const cells = row.querySelectorAll('td, th');
            return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
        });
        
        if (hasTotalRow) {
            return table; // 已經有 TOTAL 行，直接返回
        }
        
        // 如果沒有 TOTAL 行，計算並添加
        if (rows.length < 2) return table; // 沒有數據行
        
        const headerRow = rows[0];
        const headers = Array.from(headerRow.querySelectorAll('th, td')).map(h => h.textContent.trim());
        
        // 計算總數 - 支援任何類型的表格
        const totals = {};
        const dataRows = Array.from(rows).slice(1); // 跳過表頭
        
        // 初始化總計對象
        for (let j = 0; j < headers.length; j++) {
            totals[j] = {
                sum: 0,
                impressions: 0,
                clicks: 0,
                isNumeric: false,
                isPercentage: false
            };
        }
        
        // 計算每欄的總和
        dataRows.forEach(row => {
            const cells = row.querySelectorAll('td, th');
            for (let j = 0; j < cells.length && j < headers.length; j++) {
                const cellText = cells[j].textContent.trim();
                
                if (cellText.includes('%')) {
                    totals[j].isPercentage = true;
                } else {
                    const cellValue = parseFloat(cellText.replace(/[,]/g, ''));
                    if (!isNaN(cellValue) && cellValue > 0) {
                        totals[j].isNumeric = true;
                        totals[j].sum += cellValue;
                        
                        // 特別處理曝光數和點擊數
                        if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                            totals[j].impressions += cellValue;
                        } else if (headers[j] && (headers[j].includes('點擊數') || headers[j].includes('clicks'))) {
                            totals[j].clicks += cellValue;
                        }
                        // 處理 cut 數據欄位
                        else if (headers[j] && (headers[j].includes('cut') || headers[j].includes('文案'))) {
                            totals[j].clicks += cellValue;
                        }
                    }
                }
            }
        });
        
        // 創建 TOTAL 行
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        
        for (let j = 0; j < headers.length; j++) {
            const cell = document.createElement('td');
            cell.style.fontWeight = 'bold';
            
            if (j === 0) {
                // 第一欄顯示 TOTAL
                cell.textContent = 'TOTAL';
            } else if (totals[j].isPercentage) {
                // 計算百分比 - 需要找到對應的曝光數和點擊數
                let totalImpressions = 0;
                let totalClicks = 0;
                
                // 在所有欄位中尋找曝光數和點擊數
                for (let k = 0; k < headers.length; k++) {
                    if (headers[k] && (headers[k].includes('曝光數') || headers[k].includes('播放數'))) {
                        totalImpressions = totals[k].sum;
                    } else if (headers[k] && headers[k].includes('點擊數') && !headers[k].includes('cut') && !headers[k].includes('文案')) {
                        // 這是總點擊數欄位，不是 cut 相關的
                        totalClicks = totals[k].sum;
                    }
                }
                
                // 如果沒找到總點擊數，計算所有 cut 和文案的總和
                if (totalClicks === 0) {
                    for (let k = 0; k < headers.length; k++) {
                        if (headers[k] && (headers[k].includes('cut') || headers[k].includes('文案'))) {
                            totalClicks += totals[k].sum;
                        }
                    }
                }
                
                if (totalImpressions > 0) {
                    cell.textContent = ((totalClicks / totalImpressions) * 100).toFixed(2) + '%';
                    cell.style.color = '#dc3545';
                } else {
                    cell.textContent = '0.00%';
                }
            } else if (totals[j].isNumeric && totals[j].sum > 0) {
                // 顯示數值總和
                if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                    cell.textContent = totals[j].sum.toLocaleString();
                } else {
                    cell.textContent = totals[j].sum.toString();
                }
                
                // 為 cut 相關欄位添加背景色
                if (headers[j] && headers[j].includes('cut')) {
                    cell.style.backgroundColor = '#fff3cd';
                } else if (headers[j] && headers[j].includes('文案')) {
                    cell.style.backgroundColor = '#d1ecf1';
                }
            } else {
                cell.textContent = ''; // 其他欄位留空
            }
            
            totalRow.appendChild(cell);
        }
        
        table.appendChild(totalRow);
        return table;
    }

    // 新增：確保 AdUnit 表格有 TOTAL 行（針對單個 AdUnit）
    function ensureAdunitTableHasTotal(originalTable, adunitName = '') {
        if (!originalTable) return originalTable;
        
        const table = originalTable.cloneNode(true);
        const rows = table.querySelectorAll('tr');
        
        // 檢查是否已經有 TOTAL 行
        const hasTotalRow = Array.from(rows).some(row => {
            const cells = row.querySelectorAll('td, th');
            return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
        });
        
        if (hasTotalRow) {
            return table; // 已經有 TOTAL 行，直接返回
        }
        
        // 如果沒有 TOTAL 行，計算並添加
        if (rows.length < 2) return table; // 沒有數據行
        
        const headerRow = rows[0];
        const headers = Array.from(headerRow.querySelectorAll('th, td')).map(h => h.textContent.trim());
        
        // 計算總數
        let totalImp = 0, totalClk = 0;
        const dataRows = Array.from(rows).slice(1); // 跳過表頭
        
        dataRows.forEach(row => {
            const cells = row.querySelectorAll('td, th');
            for (let j = 0; j < cells.length && j < headers.length; j++) {
                const cellText = cells[j].textContent.trim();
                const cellValue = parseFloat(cellText.replace(/[,]/g, ''));
                
                if (!isNaN(cellValue) && cellValue > 0) {
                    if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                        totalImp += cellValue;
                    } else if (headers[j] && headers[j].includes('點擊數')) {
                        totalClk += cellValue;
                    }
                }
            }
        });
        
        // 創建 TOTAL 行
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        
        // 第一欄顯示 TOTAL
        const totalLabelCell = document.createElement('td');
        totalLabelCell.textContent = 'TOTAL';
        totalLabelCell.style.fontWeight = 'bold';
        totalRow.appendChild(totalLabelCell);
        
        // 其他欄位
        for (let j = 1; j < headers.length; j++) {
            const cell = document.createElement('td');
            cell.style.fontWeight = 'bold';
            
            if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                cell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
            } else if (headers[j] && headers[j].includes('點擊數')) {
                cell.textContent = totalClk > 0 ? totalClk.toString() : '';
            } else if (headers[j] && (headers[j].includes('點擊率') || headers[j].includes('觀看率'))) {
                if (totalImp > 0) {
                    cell.textContent = ((totalClk / totalImp) * 100).toFixed(2) + '%';
                    cell.style.color = '#dc3545';
                } else {
                    cell.textContent = '0.00%';
                }
            } else {
                cell.textContent = ''; // 其他欄位留空
            }
            
            totalRow.appendChild(cell);
        }
        
        table.appendChild(totalRow);
        return table;
    }

    // 新增：計算廣告集下所有 AdUnit 的 cut 數據總和
    function calculateAdsetCutDataSummary(adsetId) {
        if (!isSlideAd || !currentCutData || Object.keys(currentCutData).length === 0) {
            return null;
        }

        if (!adunitByAdset[adsetId] || !adunitByAdset[adsetId].adunits) {
            return null;
        }

        // 收集該廣告集下所有 AdUnit 的 cut 數據
        const adsetCutSummary = {};
        let hasAnyCutData = false;

        adunitByAdset[adsetId].adunits.forEach(adunit => {
            const adunitUuid = adunit.uuid;
            if (currentCutData[adunitUuid] && currentCutData[adunitUuid].data && currentCutData[adunitUuid].data.success) {
                hasAnyCutData = true;
                const cutData = currentCutData[adunitUuid].data.success;
                
                // 遍歷每個 cut 區塊
                Object.keys(cutData).forEach(cutKey => {
                    if (!isNaN(cutKey)) { // 確保是數字 key
                        if (!adsetCutSummary[cutKey]) {
                            adsetCutSummary[cutKey] = {};
                        }

                        // 遍歷每個日期的數據
                        cutData[cutKey].forEach(dayData => {
                            const date = dayData._id;
                            if (!adsetCutSummary[cutKey][date]) {
                                adsetCutSummary[cutKey][date] = 0;
                            }
                            adsetCutSummary[cutKey][date] += dayData.totalCount;
                        });
                    }
                });
            }
        });

        return hasAnyCutData ? adsetCutSummary : null;
    }

    // 新增：建立包含 cut 數據的廣告集表格
    function buildAdsetTableWithCutData(originalTable, cutDataSummary, adsetId) {
        if (!originalTable) return originalTable;

        const rows = originalTable.querySelectorAll('tr');
        if (rows.length < 2) return originalTable;

        // 解析原始表頭
        const originalHeaders = Array.from(rows[0].querySelectorAll('th, td')).map(h => h.textContent.trim());
        
        // 找出各欄位的索引位置
        let dateIndex = -1, impIndex = -1, clkIndex = -1, ctrIndex = -1;
        originalHeaders.forEach((header, index) => {
            if (header.includes('日期')) dateIndex = index;
            else if (header.includes('曝光數') || header.includes('播放數')) impIndex = index;
            else if (header.includes('點擊數')) clkIndex = index;
            else if (header.includes('點擊率') || header.includes('觀看率')) ctrIndex = index;
        });

        // 收集所有 cut keys
        const allCutKeys = new Set();
        Object.keys(cutDataSummary).forEach(cutKey => {
            if (!isNaN(cutKey)) {
                allCutKeys.add(cutKey);
            }
        });
        const sortedCutKeys = Array.from(allCutKeys).sort((a, b) => parseInt(a) - parseInt(b));

        // 建構新的表頭
        const newHeaders = ['日期', '星期', '曝光數', '點擊數', '點擊率'];
        sortedCutKeys.forEach(cutKey => {
            newHeaders.push(`cut${cutKey}`);
        });
        newHeaders.push('文案');

        // 建構新表格
        const newTable = document.createElement('table');
        newTable.className = originalTable.className;

        // 添加表頭
        const headerRow = document.createElement('tr');
        for (let header of newHeaders) {
            const th = document.createElement('th');
            th.textContent = header;
            if (header.startsWith('cut') || header === '文案') {
                th.style.backgroundColor = '#f39c12';
                th.style.color = 'white';
                th.title = `廣告集下所有 AdUnit 的 ${header} 總和`;
            }
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);

        // 累計總數變數
        let totalImp = 0, totalClk = 0;
        const totalCutValues = {};
        sortedCutKeys.forEach(cutKey => totalCutValues[cutKey] = 0);
        let totalTextClicks = 0;

        // 處理數據行
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length === 0) continue;

            const dateText = dateIndex >= 0 ? cells[dateIndex].textContent.trim() : cells[0].textContent.trim();
            
            // 跳過 TOTAL 行（稍後處理）
            if (dateText === 'TOTAL') continue;

            // 解析日期
            let rowDate = null;
            let formattedDate = null;
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
                formattedDate = dateText;
            } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('/');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
                formattedDate = `${new Date().getFullYear()}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('-');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
                formattedDate = `${new Date().getFullYear()}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }

            // 取得原始數據
            const imp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const clk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const ctr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';

            // 累計到總數
            totalImp += imp;
            totalClk += clk;

            // 計算當天的 cut 數據總和
            const cutValues = {};
            sortedCutKeys.forEach(cutKey => {
                let cutValue = 0;
                if (formattedDate && cutDataSummary[cutKey] && cutDataSummary[cutKey][formattedDate]) {
                    cutValue = cutDataSummary[cutKey][formattedDate];
                }
                cutValues[cutKey] = cutValue;
                totalCutValues[cutKey] += cutValue;
            });

            // 計算文案數量：總點擊數 - 所有 cut 的總和
            const dayCutTotal = Object.values(cutValues).reduce((sum, cut) => sum + cut, 0);
            const textClicks = Math.max(0, clk - dayCutTotal);
            totalTextClicks += textClicks;

            // 建構新的數據行
            const newRow = document.createElement('tr');
            
            // 日期
            const dateCell = document.createElement('td');
            dateCell.textContent = dateText;
            newRow.appendChild(dateCell);

            // 星期
            const weekCell = document.createElement('td');
            weekCell.textContent = rowDate ? getWeekdayInChinese(rowDate) : '';
            newRow.appendChild(weekCell);

            // 曝光數
            const impCell = document.createElement('td');
            impCell.textContent = imp > 0 ? imp.toLocaleString() : '';
            newRow.appendChild(impCell);

            // 點擊數
            const clkCell = document.createElement('td');
            clkCell.textContent = clk > 0 ? clk : '';
            newRow.appendChild(clkCell);

            // 點擊率
            const ctrCell = document.createElement('td');
            ctrCell.textContent = ctr;
            newRow.appendChild(ctrCell);

            // Cut 數據
            sortedCutKeys.forEach(cutKey => {
                const cutCell = document.createElement('td');
                const cutValue = cutValues[cutKey];
                cutCell.textContent = cutValue > 0 ? cutValue : '';
                cutCell.style.backgroundColor = cutValue > 0 ? '#fff3cd' : '';
                cutCell.title = `廣告集下所有 AdUnit 的 cut${cutKey} 總和`;
                newRow.appendChild(cutCell);
            });

            // 文案
            const textCell = document.createElement('td');
            textCell.textContent = textClicks > 0 ? textClicks : '';
            textCell.style.backgroundColor = textClicks > 0 ? '#d1ecf1' : '';
            textCell.title = '廣告集下所有 AdUnit 的文案點擊總和';
            newRow.appendChild(textCell);

            newTable.appendChild(newRow);
        }

        // 添加 TOTAL 行
        const newTotalRow = document.createElement('tr');
        newTotalRow.className = 'total-row';

        // TOTAL 標籤
        const totalLabelCell = document.createElement('td');
        totalLabelCell.textContent = 'TOTAL';
        totalLabelCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(totalLabelCell);

        // 星期欄位（空白）
        const weekTotalCell = document.createElement('td');
        weekTotalCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(weekTotalCell);

        // 總曝光數
        const impTotalCell = document.createElement('td');
        impTotalCell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
        impTotalCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(impTotalCell);

        // 總點擊數
        const clkTotalCell = document.createElement('td');
        clkTotalCell.textContent = totalClk > 0 ? totalClk : '';
        clkTotalCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(clkTotalCell);

        // 總點擊率
        const ctrTotalCell = document.createElement('td');
        if (totalImp > 0) {
            ctrTotalCell.textContent = ((totalClk / totalImp) * 100).toFixed(2) + '%';
            ctrTotalCell.style.color = '#dc3545';
        } else {
            ctrTotalCell.textContent = '0.00%';
        }
        ctrTotalCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(ctrTotalCell);

        // Cut 總數
        sortedCutKeys.forEach(cutKey => {
            const cutTotalCell = document.createElement('td');
            const cutTotal = totalCutValues[cutKey];
            cutTotalCell.textContent = cutTotal > 0 ? cutTotal : '';
            cutTotalCell.style.backgroundColor = cutTotal > 0 ? '#fff3cd' : '';
            cutTotalCell.style.fontWeight = 'bold';
            newTotalRow.appendChild(cutTotalCell);
        });

        // 文案總數
        const textTotalCell = document.createElement('td');
        textTotalCell.textContent = totalTextClicks > 0 ? totalTextClicks : '';
        textTotalCell.style.backgroundColor = totalTextClicks > 0 ? '#d1ecf1' : '';
        textTotalCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(textTotalCell);

        newTable.appendChild(newTotalRow);

        return newTable;
    }

    // 新增：格式化日期為 cut 數據使用的格式
    function formatDateForCutData(date) {
        if (!date) return null;
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // 新增：取得中文星期
    function getWeekdayInChinese(date) {
        if (!date) return '';
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        return weekdays[date.getDay()];
    }

    // 新增：確保 AdSet 表格有 TOTAL 行，並添加 cut 數據欄位
    function ensureAdsetTableHasTotal(originalTable, adsetId) {
        if (!originalTable) return originalTable;
        
        // 取得 cut 數據總和
        const cutDataSummary = calculateAdsetCutDataSummary(adsetId);
        
        const table = originalTable.cloneNode(true);
        const rows = table.querySelectorAll('tr');
        
        // 檢查是否已經有 cut 欄位
        const headerRow = rows[0];
        const originalHeaders = Array.from(headerRow.querySelectorAll('th, td')).map(h => h.textContent.trim());
        const hasCutColumns = originalHeaders.some(header => header.startsWith('cut') || header === '文案');
        
        // 如果已經有 cut 欄位，直接返回
        if (hasCutColumns) {
            return table;
        }
        
        // 如果有 cut 數據且是 slide 廣告，需要重建表格以包含 cut 欄位
        if (cutDataSummary && isSlideAd) {
            console.log(`🎬 為廣告集 ${adsetId} 添加 cut 數據欄位`);
            return buildAdsetTableWithCutData(originalTable, cutDataSummary, adsetId);
        }
        
        // 否則只處理常規的 TOTAL 行
        // 檢查是否已經有 TOTAL 行
        const hasTotalRow = Array.from(rows).some(row => {
            const cells = row.querySelectorAll('td, th');
            return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
        });
        
        if (hasTotalRow) {
            return table; // 已經有 TOTAL 行，直接返回
        }
        
        // 如果沒有 TOTAL 行，計算並添加
        if (rows.length < 2) return table; // 沒有數據行
        
        const headers = originalHeaders;
        
        // 計算總數
        let totalImp = 0, totalClk = 0;
        const dataRows = Array.from(rows).slice(1); // 跳過表頭
        
        dataRows.forEach(row => {
            const cells = row.querySelectorAll('td, th');
            for (let j = 0; j < cells.length && j < headers.length; j++) {
                const cellText = cells[j].textContent.trim();
                const cellValue = parseFloat(cellText.replace(/[,]/g, ''));
                
                if (!isNaN(cellValue) && cellValue > 0) {
                    if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                        totalImp += cellValue;
                    } else if (headers[j] && headers[j].includes('點擊數')) {
                        totalClk += cellValue;
                    }
                }
            }
        });
        
        // 創建 TOTAL 行
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        
        // 第一欄顯示 TOTAL
        const totalLabelCell = document.createElement('td');
        totalLabelCell.textContent = 'TOTAL';
        totalLabelCell.style.fontWeight = 'bold';
        totalRow.appendChild(totalLabelCell);
        
        // 其他欄位
        for (let j = 1; j < headers.length; j++) {
            const cell = document.createElement('td');
            cell.style.fontWeight = 'bold';
            
            if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                cell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
            } else if (headers[j] && headers[j].includes('點擊數')) {
                cell.textContent = totalClk > 0 ? totalClk.toString() : '';
            } else if (headers[j] && (headers[j].includes('點擊率') || headers[j].includes('觀看率'))) {
                if (totalImp > 0) {
                    cell.textContent = ((totalClk / totalImp) * 100).toFixed(2) + '%';
                    cell.style.color = '#dc3545';
                } else {
                    cell.textContent = '0.00%';
                }
            } else {
                cell.textContent = ''; // 其他欄位留空
            }
            
            totalRow.appendChild(cell);
        }
        
        table.appendChild(totalRow);
        return table;
    }

    // 新增：合併同一個 AdSet 下的 AdUnit 報表為並排格式
    function mergeAdunitReportsForAdset(adunitReports) {
        if (!adunitReports || adunitReports.length === 0) return null;
        
        // 解析所有 AdUnit 的報表數據
        const parsedAdunits = [];
        
        for (const adunitReport of adunitReports) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(adunitReport.content, 'text/html');
            const table = findDailyReportTable(doc);
            
            if (table) {
                const rows = table.querySelectorAll('tr');
                const headers = Array.from(rows[0].querySelectorAll('th, td')).map(h => h.textContent.trim());
                const data = {};
                
                // 解析數據行
                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].querySelectorAll('td, th');
                    if (cells.length === 0) continue;
                    
                    const dateText = cells[0].textContent.trim();
                    if (dateText === 'TOTAL') continue; // 稍後處理 TOTAL 行
                    
                    const rowData = {};
                    for (let j = 0; j < cells.length; j++) {
                        const header = headers[j] || `col_${j}`;
                        rowData[header] = cells[j].textContent.trim();
                    }
                    data[dateText] = rowData;
                }
                
                // 處理 TOTAL 行
                const totalRow = Array.from(rows).find(row => {
                    const cells = row.querySelectorAll('td, th');
                    return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
                });
                
                let totalData = null;
                if (totalRow) {
                    const totalCells = totalRow.querySelectorAll('td, th');
                    totalData = {};
                    for (let j = 0; j < totalCells.length; j++) {
                        const header = headers[j] || `col_${j}`;
                        totalData[header] = totalCells[j].textContent.trim();
                    }
                }
                
                // 如果沒有 TOTAL 數據，計算並生成
                if (!totalData) {
                    totalData = calculateAdunitTotalData(data, headers);
                    console.log(`為 AdUnit ${adunitReport.name} 計算的 TOTAL 數據:`, totalData);
                }
                
                parsedAdunits.push({
                    name: adunitReport.name,
                    uuid: adunitReport.uuid,
                    headers: headers,
                    data: data,
                    totalData: totalData
                });
            }
        }
        
        if (parsedAdunits.length === 0) return null;
        
        // 收集所有唯一的日期
        const allDates = new Set();
        parsedAdunits.forEach(adunit => {
            Object.keys(adunit.data).forEach(date => allDates.add(date));
        });
        
        const sortedDates = Array.from(allDates).sort();
        
        // 建立新的表格
        const newTable = document.createElement('table');
        newTable.className = 'merged-adunit-table';
        
        // 建立表頭結構（兩層）
        const headerRow1 = document.createElement('tr');
        const headerRow2 = document.createElement('tr');
        
        // 日期和星期欄位
        const dateHeader1 = document.createElement('th');
        dateHeader1.textContent = '日期';
        dateHeader1.rowSpan = 2;
        dateHeader1.className = 'date-week-header';
        dateHeader1.style.verticalAlign = 'middle';
        headerRow1.appendChild(dateHeader1);
        
        const weekHeader1 = document.createElement('th');
        weekHeader1.textContent = '星期';
        weekHeader1.rowSpan = 2;
        weekHeader1.className = 'date-week-header';
        weekHeader1.style.verticalAlign = 'middle';
        headerRow1.appendChild(weekHeader1);
        
        // 為每個 AdUnit 添加表頭
        parsedAdunits.forEach(adunit => {
            // 第一層：AdUnit 名稱（跨 3 欄）
            const adunitHeader = document.createElement('th');
            adunitHeader.textContent = adunit.name;
            adunitHeader.colSpan = 3;
            adunitHeader.className = 'adunit-name-header';
            adunitHeader.style.textAlign = 'center';
            headerRow1.appendChild(adunitHeader);
            
            // 第二層：曝光數、點擊數、點擊率
            const impHeader = document.createElement('th');
            impHeader.textContent = '曝光數';
            impHeader.className = 'metric-header';
            headerRow2.appendChild(impHeader);
            
            const clkHeader = document.createElement('th');
            clkHeader.textContent = '點擊數';
            clkHeader.className = 'metric-header';
            headerRow2.appendChild(clkHeader);
            
            const ctrHeader = document.createElement('th');
            ctrHeader.textContent = '點擊率';
            ctrHeader.className = 'metric-header';
            headerRow2.appendChild(ctrHeader);
        });
        
        newTable.appendChild(headerRow1);
        newTable.appendChild(headerRow2);
        
        // 建立數據行
        sortedDates.forEach(dateText => {
            const row = document.createElement('tr');
            
            // 日期欄
            const dateCell = document.createElement('td');
            dateCell.textContent = dateText;
            row.appendChild(dateCell);
            
            // 星期欄
            const weekCell = document.createElement('td');
            const date = parseDateText(dateText);
            weekCell.textContent = date ? getWeekdayInChinese(date) : '';
            row.appendChild(weekCell);
            
            // 為每個 AdUnit 添加數據
            parsedAdunits.forEach(adunit => {
                const adunitData = adunit.data[dateText] || {};
                
                // 曝光數
                const impCell = document.createElement('td');
                const impValue = extractNumericValue(adunitData, ['曝光數', '播放數']);
                impCell.textContent = impValue > 0 ? impValue.toLocaleString() : '';
                row.appendChild(impCell);
                
                // 點擊數
                const clkCell = document.createElement('td');
                const clkValue = extractNumericValue(adunitData, ['點擊數']);
                clkCell.textContent = clkValue > 0 ? clkValue.toString() : '';
                row.appendChild(clkCell);
                
                // 點擊率
                const ctrCell = document.createElement('td');
                const ctrValue = extractPercentageValue(adunitData, ['點擊率', '觀看率']);
                ctrCell.textContent = ctrValue || '';
                row.appendChild(ctrCell);
            });
            
            newTable.appendChild(row);
        });
        
        // 建立 TOTAL 行
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        
        // TOTAL 標籤
        const totalLabelCell = document.createElement('td');
        totalLabelCell.textContent = 'TOTAL';
        totalRow.appendChild(totalLabelCell);
        
        // 空的星期欄
        const emptyWeekCell = document.createElement('td');
        emptyWeekCell.textContent = '';
        totalRow.appendChild(emptyWeekCell);
        
        // 為每個 AdUnit 添加 TOTAL 數據
        parsedAdunits.forEach(adunit => {
            const totalData = adunit.totalData || {};
            
            // 總曝光數
            const totalImpCell = document.createElement('td');
            const totalImpValue = extractNumericValue(totalData, ['曝光數', '播放數']);
            totalImpCell.textContent = totalImpValue > 0 ? totalImpValue.toLocaleString() : '';
            totalRow.appendChild(totalImpCell);
            
            // 總點擊數
            const totalClkCell = document.createElement('td');
            const totalClkValue = extractNumericValue(totalData, ['點擊數']);
            totalClkCell.textContent = totalClkValue > 0 ? totalClkValue.toString() : '';
            totalRow.appendChild(totalClkCell);
            
            // 總點擊率
            const totalCtrCell = document.createElement('td');
            const totalCtrValue = extractPercentageValue(totalData, ['點擊率', '觀看率']);
            totalCtrCell.textContent = totalCtrValue || '';
            totalCtrCell.className = 'ctr-cell';
            totalRow.appendChild(totalCtrCell);
        });
        
        newTable.appendChild(totalRow);
        
        return newTable;
    }
    
    // 輔助函數：解析日期文字
    function parseDateText(dateText) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
            return new Date(dateText);
        } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
            const [month, day] = dateText.split('/');
            return new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
        } else if (/^\d{2}-\d{2}$/.test(dateText)) {
            const [month, day] = dateText.split('-');
            return new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
        }
        return null;
    }
    
    // 輔助函數：從數據對象中提取數字值
    function extractNumericValue(data, possibleKeys) {
        for (const key of possibleKeys) {
            // 先嘗試直接匹配
            if (data[key] !== undefined) {
                const value = data[key].replace(/[,]/g, '');
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    return numValue;
                }
            }
            
            // 再嘗試模糊匹配
            for (const dataKey in data) {
                if (dataKey.includes(key)) {
                    const value = data[dataKey].replace(/[,]/g, '');
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        return numValue;
                    }
                }
            }
        }
        
        return 0;
    }
    
    // 輔助函數：從數據對象中提取百分比值
    function extractPercentageValue(data, possibleKeys) {
        for (const key of possibleKeys) {
            // 先嘗試直接匹配
            if (data[key] !== undefined) {
                return data[key];
            }
            
            // 再嘗試模糊匹配
            for (const dataKey in data) {
                if (dataKey.includes(key)) {
                    return data[dataKey];
                }
            }
        }
        
        return '';
    }
    
    // 新增：計算 AdUnit TOTAL 數據
    function calculateAdunitTotalData(data, headers) {
        const totalData = {};
        let totalImp = 0, totalClk = 0;
        
        // 遍歷所有數據行，累加數值
        for (const dateKey in data) {
            const rowData = data[dateKey];
            for (const header of headers) {
                if (rowData[header]) {
                    const cellValue = parseFloat(rowData[header].replace(/[,]/g, ''));
                    
                    if (!isNaN(cellValue) && cellValue > 0) {
                        if (header.includes('曝光數') || header.includes('播放數')) {
                            totalImp += cellValue;
                        } else if (header.includes('點擊數')) {
                            totalClk += cellValue;
                        }
                    }
                }
            }
        }
        
        // 生成 TOTAL 數據
        for (const header of headers) {
            if (header.includes('曝光數') || header.includes('播放數')) {
                totalData[header] = totalImp > 0 ? totalImp.toLocaleString() : '0';
            } else if (header.includes('點擊數')) {
                totalData[header] = totalClk > 0 ? totalClk.toString() : '0';
            } else if (header.includes('點擊率') || header.includes('觀看率')) {
                if (totalImp > 0) {
                    totalData[header] = ((totalClk / totalImp) * 100).toFixed(2) + '%';
                } else {
                    totalData[header] = '0.00%';
                }
            } else if (header === '日期') {
                totalData[header] = 'TOTAL';
            } else {
                totalData[header] = '';
            }
        }
        
        return totalData;
    }
    
    // 新增：切換 AdSet 收合狀態
    function toggleAdsetCollapse(adsetId) {
        const contentDiv = document.getElementById(`adset-content-${adsetId}`);
        const adunitSection = document.getElementById(`adunit-section-${adsetId}`);
        const button = event.target;
        
        if (selectedAdsets.has(adsetId)) {
            // 當前是展開狀態，要收合
            selectedAdsets.delete(adsetId);
            contentDiv.style.display = 'none';
            if (adunitSection) adunitSection.style.display = 'none';
            button.textContent = '➕';
            button.style.background = '#6c757d';
        } else {
            // 當前是收合狀態，要展開
            selectedAdsets.add(adsetId);
            contentDiv.style.display = 'block';
            if (adunitSection) adunitSection.style.display = 'block';
            button.textContent = '➖';
            button.style.background = '#28a745';
        }
    }
    
    // 新增：切換 AdUnit 收合狀態
    function toggleAdunitCollapse(adunitUuid) {
        const contentDiv = document.getElementById(`adunit-content-${adunitUuid}`);
        const button = event.target;
        
        if (selectedAdunits.has(adunitUuid)) {
            // 當前是展開狀態，要收合
            selectedAdunits.delete(adunitUuid);
            contentDiv.style.display = 'none';
            button.textContent = '➕';
            button.style.background = '#6c757d';
        } else {
            // 當前是收合狀態，要展開
            selectedAdunits.add(adunitUuid);
            contentDiv.style.display = 'block';
            button.textContent = '➖';
            button.style.background = '#28a745';
        }
    }
    
    // 尋找每日報表表格
    function findDailyReportTable(doc) {
        // 專門查找每日報表的表格
        let dailyReportTable = null;
        
        // 查找包含"每日報表"文字的元素
        const allElements = doc.querySelectorAll('*');
        let dailyReportSection = null;
        
        for (let element of allElements) {
            if (element.textContent && element.textContent.includes('每日報表')) {
                dailyReportSection = element;
                break;
            }
        }
        
        if (dailyReportSection) {
            // 找到每日報表標題，尋找其後的表格
            let nextElement = dailyReportSection.nextElementSibling;
            
            // 循環查找表格，可能需要跨越一些 div 容器
            while (nextElement) {
                if (nextElement.tagName === 'TABLE') {
                    dailyReportTable = nextElement;
                    break;
                } else if (nextElement.tagName === 'DIV') {
                    // 在 div 容器內查找表格
                    const tableInDiv = nextElement.querySelector('table');
                    if (tableInDiv) {
                        dailyReportTable = tableInDiv;
                        break;
                    }
                }
                nextElement = nextElement.nextElementSibling;
            }
        }
        
        if (!dailyReportTable) {
            // 如果沒找到每日報表表格，嘗試通過表格內容來識別
            const tables = doc.querySelectorAll('table');
            
            for (let table of tables) {
                const tableText = table.textContent || '';
                // 檢查表格是否包含日期格式的內容（YYYY-MM-DD）
                if (tableText.includes('播放數') || tableText.includes('觀看數') || 
                    tableText.includes('點擊數') || tableText.includes('觀看率') ||
                    tableText.includes('曝光數') || tableText.includes('點擊率') ||
                    /\d{4}-\d{2}-\d{2}/.test(tableText)) {
                    dailyReportTable = table;
                    break;
                }
            }
        }
        
        return dailyReportTable;
    }
    
    // 根據走期設定處理表格內容
    function processTableBySchedule(table, campaignEndDate, currentDate) {
        const clonedTable = table.cloneNode(true);
        const rows = clonedTable.querySelectorAll('tr');
        
        if (rows.length < 2) return clonedTable; // 如果沒有數據行，直接返回
        
        // 轉換日期格式用於比較
        const campaignEnd = new Date(campaignEndDate);
        const current = new Date(currentDate);
        
        // 解析現有數據
        const tableData = [];
        const headers = [];
        let totalRow = null;
        
        // 獲取表頭
        const headerCells = rows[0].querySelectorAll('th, td');
        for (let cell of headerCells) {
            headers.push(cell.textContent.trim());
        }
        
        // === 新增：若表頭缺「星期」，插入後續自動補值 ===
        let needInsertWeekCol = true;
        headers.forEach(h => {
            if (h.includes('星期') || h.includes('週')) needInsertWeekCol = false;
        });
        if (needInsertWeekCol) {
            headers.splice(1, 0, '星期'); // 日期後插一欄
        }
        
        // 解析數據行，跳過TOTAL行
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length > 0) {
                const firstCellText = cells[0].textContent.trim();
                
                if (firstCellText === 'TOTAL') {
                    // 保存TOTAL行供後續使用
                    totalRow = row.cloneNode(true);
                    continue;
                }
                
                // 嘗試解析日期格式
                let rowDate = null;
                const dateText = firstCellText;
                
                // 格式解析邏輯
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                    rowDate = new Date(dateText);
                } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                    const [month, day] = dateText.split('/');
                    rowDate = new Date(current.getFullYear(), parseInt(month) - 1, parseInt(day));
                } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                    const [month, day] = dateText.split('-');
                    rowDate = new Date(current.getFullYear(), parseInt(month) - 1, parseInt(day));
                }
                
                if (rowDate) {
                    const rowData = [];
                    for (let j = 0; j < cells.length; j++) {
                        rowData.push(cells[j].textContent.trim());
                    }
                    // after rowData push 完
                    if (needInsertWeekCol) {
                        const weekStr = getWeekdayInChinese(rowDate);
                        rowData.splice(1, 0, weekStr); // 把星期填到第 2 格
                    }
                    tableData.push({
                        date: rowDate,
                        dateText: dateText,
                        data: rowData,
                        hasData: true
                    });
                }
            }
        }
        
        // 生成完整的日期範圍（從最早的數據日期到走期結束日期）
        let startDate = null;
        let endDate = campaignEnd;
        
        if (tableData.length > 0) {
            // 找到最早的數據日期
            startDate = new Date(Math.min(...tableData.map(item => item.date.getTime())));
            
            // 如果有數據的最後日期晚於走期結束日期，則擴展到該日期
            const lastDataDate = new Date(Math.max(...tableData.map(item => item.date.getTime())));
            if (lastDataDate > endDate) {
                endDate = lastDataDate;
            }
        } else {
            // 如果沒有現有數據，從當前日期開始到走期結束
            startDate = current;
        }
        
        // 生成完整的日期序列
        const completeData = [];
        const currentDateIter = new Date(startDate);
        
        while (currentDateIter <= endDate) {
            const dateStr = formatDateToMatch(currentDateIter, tableData.length > 0 ? tableData[0].dateText : null);
            const weekday = getWeekdayInChinese(currentDateIter);
            
            // 檢查是否有現有數據
            const existingData = tableData.find(item => 
                item.date.getTime() === currentDateIter.getTime()
            );
            
            if (existingData) {
                // 使用現有數據
                completeData.push(existingData);
            } else {
                // 創建空白行
                const emptyRowData = [dateStr, weekday];
                
                // 根據表頭數量填充空白欄位
                for (let i = 2; i < headers.length; i++) {
                    emptyRowData.push('');
                }
                
                completeData.push({
                    date: new Date(currentDateIter),
                    dateText: dateStr,
                    data: emptyRowData,
                    hasData: false
                });
            }
            
            // 移到下一天
            currentDateIter.setDate(currentDateIter.getDate() + 1);
        }
        
        // 重新構建表格
        const newTable = document.createElement('table');
        newTable.className = clonedTable.className;
        
        // 添加表頭
        const headerRow = document.createElement('tr');
        for (let header of headers) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);
        
        // 添加數據行
        for (let item of completeData) {
            const row = document.createElement('tr');
            
            for (let i = 0; i < item.data.length; i++) {
                const cell = document.createElement('td');
                
                if (!item.hasData && i >= 2) {
                    // 對於空白數據，顯示特殊標記
                    if (item.date > current) {
                        cell.innerHTML = '<span style="color: #ccc;">—</span>';
                        cell.style.backgroundColor = '#f8f9fa';
                    } else if (item.date > campaignEnd) {
                        cell.innerHTML = '<span style="color: #ccc;">—</span>';
                        cell.style.backgroundColor = '#fff3cd';
                    } else {
                        cell.innerHTML = '<span style="color: #ccc;">—</span>';
                        cell.style.backgroundColor = '#f8f9fa';
                    }
                } else {
                    cell.textContent = item.data[i] || '';
                }
                
                row.appendChild(cell);
            }
            
            // 添加未到期的視覺標示
            if (!item.hasData) {
                if (item.date > current) {
                    row.style.backgroundColor = '#f8f9fa';
                    row.style.opacity = '0.6';
                    row.firstChild.innerHTML += ' <span style="color: #ffc107;"></span>';
                } else if (item.date > campaignEnd) {
                    row.style.backgroundColor = '#fff3cd';
                    row.style.opacity = '0.8';
                    row.firstChild.innerHTML += ' <span style="color: #dc3545;">📅</span>';
                }
            }
            
            newTable.appendChild(row);
        }
        
        // 添加TOTAL行
        if (totalRow) {
            // 如果我們動態加入了「星期」欄，那麼 TOTAL 行也需要插入一個對應的空儲存格
            if (needInsertWeekCol) {
                const newTotalRow = totalRow.cloneNode(true);
                const emptyTd = document.createElement('td');
                // total-row 的 class 在 TR 上，所以 TD 會自動繼承樣式，我們只需插入即可
                newTotalRow.insertBefore(emptyTd, newTotalRow.children[1]);
                newTable.appendChild(newTotalRow);
            } else {
                newTable.appendChild(totalRow);
            }
        }
        
        return newTable;
    }
    
    // 輔助函數：格式化日期以匹配現有格式
    function formatDateToMatch(date, sampleDateText) {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        
        if (!sampleDateText) {
            return `${month}/${day}`;
        }
        
        // 根據樣本格式決定輸出格式
        if (sampleDateText.includes('-')) {
            if (sampleDateText.length > 5) {
                // YYYY-MM-DD 格式
                return `${date.getFullYear()}-${month}-${day}`;
            } else {
                // MM-DD 格式
                return `${month}-${day}`;
            }
        } else {
            // MM/DD 格式
            return `${month}/${day}`;
        }
    }
    
    // 輔助函數：獲取中文星期
    function getWeekdayInChinese(date) {
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        return weekdays[date.getDay()];
    }
    
    // 初始化預設日期
    setDefaultDates();
    
    // 啟用導出按鈕
    function enableExportButton() {
        const exportBtn = document.getElementById('exportExcel');
        exportBtn.disabled = false;
    }
    
    // 產出 Excel 報表
    async function exportToExcel() {
        if (!currentReportData) {
            alert('請先取得報表資料');
            return;
        }

        try {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('廣告報表');
            
            // 設定欄寬
            worksheet.columns = [
                { width: 4, },   // A 外框
                { width: 12 },  // B 日期
                { width: 15 },   // C 星期
                { width: 15 },  // D 曝光
                { width: 20 },  // E 點擊
                { width: 28 },  // F CTR
                { width: 15 },  // G cut1
                { width: 15 },  // H cut2
                { width: 15 },  // I 文案
                { width: 15 }   // J 空白
            ];
            
            worksheet.properties.defaultRowHeight = 26;

            // 定義樣式物件
            const styles = {
                header: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                orangeHeader: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE67E22' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                normal: {
                    font: { 
                        name: 'Helvetica',
                        size: 13 
                    },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                total: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFDA66' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                redFont: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        color: { argb: 'FFFF0000' }, 
                        size: 13 
                    },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                grayBg: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                whiteBg: {
                    font: { 
                        name: 'Helvetica',
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                emptyRow: {
                    font: { 
                        name: 'Helvetica',
                        color: { argb: 'FF999999' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8F9FA' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                yellowBg: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF2CB' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                sectionHeader: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 14 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2E7D32' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                }
            };

            // 樣式套用輔助函數
            function applyStyle(cell, style) {
                if (style.font) cell.font = style.font;
                if (style.fill) cell.fill = style.fill;
                if (style.alignment) cell.alignment = style.alignment;
                if (style.border) cell.border = style.border;
            }

            // 取得廣告集資訊
            const adsetInfo = currentAdsetInfo || {};
            const pricing = adsetInfo.pricing || { bMode: 'CPC', price: 7.0, currency: 'TWD' };
            const info = adsetInfo.info || { name: '未知活動', adType: '原生互動廣告', budget: 0 };
            
            const activityName = info.name || '請填入活動名稱';
            let adTypeDisplay = info.adType || 'NATIVE';
            if (adTypeDisplay === 'NATIVE') {
                adTypeDisplay = '原生廣告';
            }
            // 優先使用從 Campaign 取得的總預算
            const totalBudget = info.campaignBudget !== undefined ? info.campaignBudget : (info.parsedBudget > 0 ? info.parsedBudget : (info.budget || 10000));
            const pricingMode = pricing.bMode || 'CPC';
            const pricingPrice = pricing.price || 7.0;
            const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
            
            // 計算走期相關數據
            const campaignEndDate = currentReportData.campaignEndDate;
            const currentDate = currentReportData.currentDate;
            let remainingDays = 0;
            let isOngoing = true;
            
            if (campaignEndDate && currentDate) {
                const endDate = new Date(campaignEndDate);
                const today = new Date(currentDate);
                const timeDiff = endDate.getTime() - today.getTime();
                remainingDays = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                isOngoing = remainingDays > 0;
            }

            let currentRow = 1;

            // 1. 插入 Logo 圖片（同原本邏輯）
            let logoInserted = false;
            
            // 嘗試載入本地 logo 圖片
            try {
                const response = await fetch('/static/images/logo.png');
                if (response.ok) {
                    const imageBuffer = await response.arrayBuffer();
                    const imageId = workbook.addImage({
                        buffer: imageBuffer,
                        extension: 'jpeg',
                    });
                    
                    worksheet.addImage(imageId, {
                        tl: { col: 1, row: 1 },
                        ext: { width: 200, height: 60 }
                    });
                    logoInserted = true;
                    console.log('✅ Logo 圖片載入成功');
                }
            } catch (error) {
                console.warn('⚠️ 本地 logo 圖片載入失敗:', error);
            }
            
            if (!logoInserted) {
                try {
                    const cdnUrl = 'https://static.ottercdn.com/trek/media/e19b2b54-641e-4519-a34f-a84deeea878e.png';
                    
                    if (cdnUrl) {
                        console.log('🔄 嘗試 CDN 備案...', cdnUrl);
                        const response = await fetch(cdnUrl);
                        if (response.ok) {
                            const imageBuffer = await response.arrayBuffer();
                            const imageId = workbook.addImage({
                                buffer: imageBuffer,
                                extension: 'jpeg',
                            });
                            
                            worksheet.addImage(imageId, {
                                tl: { col: 1, row: 1 },
                                ext: { width: 360, height: 188 }
                            });
                            logoInserted = true;
                            console.log('✅ CDN Logo 圖片載入成功');
                        }
                    }
                } catch (cdnError) {
                    console.warn('⚠️ CDN logo 圖片載入失敗:', cdnError);
                }
            }
            
            if (!logoInserted) {
                worksheet.getCell('B2').value = 'ASEAL';
                applyStyle(worksheet.getCell('B2'), styles.grayBg);
                worksheet.getCell('B2').font = { bold: true, size: 14 };
                console.log('📝 使用文字 Logo 備案');
            }

            // 2. 頂部資訊區域（第2-3行）
            worksheet.getCell('D2').value = '活動名稱';
            applyStyle(worksheet.getCell('D2'), styles.grayBg);
            worksheet.getCell('E2').value = activityName;
            applyStyle(worksheet.getCell('E2'), styles.whiteBg);
            worksheet.getCell('G2').value = '總預算';
            applyStyle(worksheet.getCell('G2'), styles.grayBg);
            worksheet.getCell('H2').value = `${currency}${totalBudget.toLocaleString()}`;
            applyStyle(worksheet.getCell('H2'), styles.whiteBg);

            worksheet.getCell('D3').value = '廣告類型';
            applyStyle(worksheet.getCell('D3'), styles.grayBg);
            worksheet.getCell('E3').value = adTypeDisplay;
            applyStyle(worksheet.getCell('E3'), styles.whiteBg);
            worksheet.getCell('G3').value = '走期預算';
            applyStyle(worksheet.getCell('G3'), styles.grayBg);
            worksheet.getCell('H3').value = `${currency}${totalBudget.toLocaleString()}`;
            applyStyle(worksheet.getCell('H3'), styles.whiteBg);
            worksheet.getCell('H3').font = { bold: true, size: 13, name: 'Helvetica' };

            // 合併儲存格
            worksheet.mergeCells('B2:C3'); // Logo 區域
            worksheet.mergeCells('E2:F2'); // 活動名稱值
            worksheet.mergeCells('E3:F3'); // 廣告類型值
            
            // 3. 剩餘數據行（第4-5行）
            const remainingDailyValue = calculateRemainingDailyValue(totalBudget, pricingMode, pricingPrice, remainingDays);

            worksheet.getCell('B4').value = '剩餘天數';
            applyStyle(worksheet.getCell('B4'), styles.grayBg);
            worksheet.getCell('C4').value = `(${remainingDays})`;
            applyStyle(worksheet.getCell('C4'), styles.redFont);
            worksheet.getCell('D4').value = '計價方式';
            applyStyle(worksheet.getCell('D4'), styles.grayBg);
            worksheet.getCell('E4').value = pricingMode;
            applyStyle(worksheet.getCell('E4'), styles.whiteBg);
            worksheet.getCell('F4').value = `${currency}${pricingPrice}`;
            applyStyle(worksheet.getCell('F4'), styles.whiteBg);
            worksheet.getCell('G4').value = '剩餘花費';
            applyStyle(worksheet.getCell('G4'), styles.grayBg);
            worksheet.getCell('H4').value = isOngoing ? `${currency}${Math.max(0, remainingDailyValue.remainingBudget).toLocaleString()}` : '(已結束)';
            applyStyle(worksheet.getCell('H4'), styles.redFont);

            worksheet.getCell('B5').value = '剩餘每日';
            applyStyle(worksheet.getCell('B5'), styles.grayBg);
            worksheet.getCell('C5').value = remainingDailyValue.remainingDaily;
            applyStyle(worksheet.getCell('C5'), styles.redFont);
            worksheet.getCell('D5').value = '廣告目標';
            applyStyle(worksheet.getCell('D5'), styles.grayBg);
            worksheet.getCell('E5').value = remainingDailyValue.targetCount.toLocaleString();
            applyStyle(worksheet.getCell('E5'), styles.whiteBg);
            worksheet.getCell('F5').value = remainingDailyValue.targetUnit;
            applyStyle(worksheet.getCell('F5'), styles.whiteBg);
            worksheet.getCell('G5').value = remainingDailyValue.remainingLabel;
            applyStyle(worksheet.getCell('G5'), styles.grayBg);
            worksheet.getCell('H5').value = isOngoing ? Math.max(0, remainingDailyValue.remainingAmount) : '0';
            applyStyle(worksheet.getCell('H5'), styles.redFont);

            currentRow = 7;

            // 4. 總合報表區段
            currentRow = await addMergedReportSection(worksheet, styles, currentRow, applyStyle);

            // 5. 個別 AdSet 報表區段
            if (currentReportData.allAdsetReports) {
                currentRow = await addIndividualAdsetSections(worksheet, styles, currentRow, applyStyle);
            }

            // 產出檔案
            const buffer = await workbook.xlsx.writeBuffer({ useStyles: true });
            const blob = new Blob([buffer], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${activityName}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // 顯示成功訊息
            const totalDataRows = countTotalDataRows();
            const hasDataRows = countHasDataRows();
            const emptyRows = totalDataRows - hasDataRows;
            
            let successMessage = `✅ Excel 報表已成功產出！檔案已下載。`;
            
            if (currentAdsetInfo && currentAdsetInfo.success) {
                const budgetSource = info.campaignBudget !== undefined ? '從 Campaign 取得' : (info.parsedBudget > 0 ? '從活動名稱解析' : '使用原始預算');
                const scheduleInfo = remainingDays > 0 ? `剩餘 ${remainingDays} 天` : '活動已結束';
                const adsetCount = info.adsetCount || 1;
                
                // 計算選擇的統計
                const totalAvailableAdsets = Object.keys(currentReportData.allAdsetReports || {}).filter(id => currentReportData.allAdsetReports[id].success && !shouldFilterAdset(currentReportData.allAdsetReports[id])).length;
                const selectedAdsetCount = selectedAdsets.size;
                
                // 計算不屬於包含 demo 的 AdSet 的可用 AdUnit 總數
                const totalAvailableAdunits = Object.keys(currentReportData.allAdunitReports || {}).filter(adunitUuid => {
                    const report = currentReportData.allAdunitReports[adunitUuid];
                    if (!report.success) return false;
                    
                    // 檢查對應的 AdSet 是否包含 demo
                    for (const [adsetId, adsetData] of Object.entries(currentReportData.adunitByAdset || {})) {
                        const adsetReport = currentReportData.allAdsetReports[adsetId];
                        if (adsetData.adunits.some(adunit => adunit.uuid === adunitUuid) && 
                            adsetReport && shouldFilterAdset(adsetReport)) {
                            return false; // 排除屬於包含 demo 的 AdSet 的 AdUnit
                        }
                    }
                    return true;
                }).length;
                const selectedAdunitCount = selectedAdunits.size;
                
                // 效能資訊
                let performanceInfo = '';
                if (window.adunitQuerySummary) {
                    const summary = window.adunitQuerySummary;
                    const method = summary.processing_method === 'batch_processing' ? '分批處理' : '並行處理';
                    const batchInfo = summary.total_batches ? ` (${summary.total_batches} 批次, 每批 ${summary.batch_size} 個)` : ` (${summary.max_workers || 0} 執行緒)`;
                    performanceInfo = `\n- 查詢效能：${summary.query_duration}秒 ${method}${batchInfo}`;
                }
                
                successMessage += `\n📊 已匯出選擇的報表內容：\n- 活動名稱：${activityName}\n- 選擇的廣告集：${selectedAdsetCount}/${totalAvailableAdsets} 個\n- 選擇的 AdUnit：${selectedAdunitCount}/${totalAvailableAdunits} 個${performanceInfo}\n- 計價方式：${pricingMode} (${currency}${pricingPrice})\n- 總預算：${currency}${totalBudget.toLocaleString()} (${budgetSource})\n- 走期狀態：${scheduleInfo}\n📅 包含總合數據、${selectedAdsetCount} 個廣告集詳細數據，以及 ${selectedAdunitCount} 個 AdUnit 詳細數據`;
            }
            alert(successMessage);

        } catch (err) {
            console.error('產出 Excel 報表失敗:', err);
            alert('❌ 產出 Excel 報表失敗：' + err.message);
        }
    }

    // 計算剩餘每日數值的輔助函數
    function calculateRemainingDailyValue(totalBudget, pricingMode, pricingPrice, remainingDays) {
        // 解析表格數據以計算已使用的預算
        const trs = currentReportData.table.querySelectorAll('tr');
        let sumImp = 0, sumClk = 0;
        
        for (let i = 1; i < trs.length; i++) {
            const td = trs[i].querySelectorAll('td,th');
            if (td.length < 2) continue;
            
            const date = td[0].textContent.trim();
            if (date === 'TOTAL') continue;
            
            // 提取曝光數和點擊數
            if (td.length > 2) {
                const imp = +(td[2].textContent.replace(/[,—]/g,'')) || 0;
                sumImp += imp;
            }
            if (td.length > 3) {
                const clk = +(td[3].textContent.replace(/[,—]/g,'')) || 0;
                sumClk += clk;
            }
        }
        
        let targetUnit = 'clicks', targetCount = 0, remainingLabel = '剩餘點擊數';
        let remainingAmount = 0, remainingBudget = 0;
        
        if (pricingMode === 'CPM') {
            targetUnit = 'impressions';
            remainingLabel = '剩餘曝光數';
            targetCount = Math.floor((totalBudget / pricingPrice) * 1000);
            remainingBudget = totalBudget - ((sumImp * pricingPrice) / 1000);
            remainingAmount = Math.floor((remainingBudget / pricingPrice) * 1000);
        } else if (pricingMode === 'CPV') {
            targetUnit = 'views';
            remainingLabel = '剩餘觀看數';
            targetCount = Math.floor(totalBudget / pricingPrice);
            remainingBudget = totalBudget - (sumClk * pricingPrice);
            remainingAmount = Math.floor(remainingBudget / pricingPrice);
        } else {
            targetUnit = 'clicks';
            remainingLabel = '剩餘點擊數';
            targetCount = Math.floor(totalBudget / pricingPrice);
            remainingBudget = totalBudget - (sumClk * pricingPrice);
            remainingAmount = Math.floor(remainingBudget / pricingPrice);
        }
        
        const remainingDaily = (remainingDays > 0 && remainingAmount > 0) ? 
            Math.ceil(Math.max(0, remainingAmount) / remainingDays) : 0;

        return {
            targetUnit,
            targetCount,
            remainingLabel,
            remainingAmount,
            remainingBudget,
            remainingDaily
        };
    }

    // 添加總合報表區段
    async function addMergedReportSection(worksheet, styles, startRow, applyStyle) {
        // 添加區段標題
        worksheet.mergeCells(startRow, 2, startRow, 9);
        const sectionCell = worksheet.getCell(startRow, 2);
        sectionCell.value = '📈 總合報表數據';
        applyStyle(sectionCell, styles.sectionHeader);
        
        let currentRow = startRow + 2;
        
        // 解析總合表格數據
        const trs = currentReportData.table.querySelectorAll('tr');
        const headerRow = trs[0];
        const headers = Array.from(headerRow.querySelectorAll('th,td')).map(h => h.textContent.trim());
        
        // 添加表頭
            for (let i = 0; i < headers.length; i++) {
            const cell = worksheet.getCell(currentRow, i + 2);
                cell.value = headers[i];
                applyStyle(cell, (i < 5) ? styles.header : styles.orangeHeader);
            }
        currentRow++;
        
        // 添加數據行
        for (let i = 1; i < trs.length; i++) {
            const td = trs[i].querySelectorAll('td,th');
            if (td.length < 2) continue;
            
            const date = td[0].textContent.trim();
            
            for (let j = 0; j < td.length; j++) {
                const cell = worksheet.getCell(currentRow, j + 2);
                const cellValue = td[j].textContent.trim();
                
                if (!isNaN(cellValue.replace(/[,]/g, '')) && cellValue !== '') {
                    cell.value = +cellValue.replace(/[,]/g, '');
                } else {
                    cell.value = cellValue;
                }
                
                if (date === 'TOTAL') {
                    applyStyle(cell, styles.total);
                    if (cellValue.includes('%')) {
                        cell.font = { bold: true, color: { argb: 'FFFF0000' }, size: 13, name: 'Helvetica' };
                    }
                } else {
                    applyStyle(cell, styles.normal);
                }
                }
                currentRow++;
            }

        return currentRow + 2; // 留一些空間
    }

    // 添加個別 AdSet 報表區段
    async function addIndividualAdsetSections(worksheet, styles, startRow, applyStyle) {
        let currentRow = startRow;
        
        // 添加個別報表區段標題
        worksheet.mergeCells(currentRow, 2, currentRow, 9);
        const sectionCell = worksheet.getCell(currentRow, 2);
        sectionCell.value = '📋 個別廣告集報表';
        applyStyle(sectionCell, styles.sectionHeader);
        
        currentRow += 2;
        
        // 處理每個選中的 AdSet 的報表（過濾掉包含 demo 的）
        for (const [adsetId, report] of Object.entries(currentReportData.allAdsetReports)) {
            if (!selectedAdsets.has(adsetId)) {
                continue; // 跳過未選中的 AdSet
            }
            
            // 過濾包含 demo 的 AdSet
            if (shouldFilterAdset(report)) {
                console.log(`Excel 導出時過濾掉包含 demo 的 AdSet: ${report.name}`);
                continue;
            }
            
            if (report.success) {
                // 添加 AdSet 名稱
                worksheet.mergeCells(currentRow, 2, currentRow, 9);
                const adsetTitleCell = worksheet.getCell(currentRow, 2);
                adsetTitleCell.value = `📊 ${report.name}`;
                adsetTitleCell.font = { name: 'Helvetica', bold: true, size: 12, color: { argb: 'FF2E7D32' } };
                adsetTitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
                
                currentRow += 1;
                
                // 解析並添加 AdSet 表格，確保有 TOTAL 行
                const parser = new DOMParser();
                const doc = parser.parseFromString(report.content, 'text/html');
                const originalTable = findDailyReportTable(doc);
                const table = ensureAdsetTableHasTotal(originalTable, adsetId);
                
                if (table) {
                    const rows = table.querySelectorAll('tr');
                    
                    // 添加表頭
                    const headerCellsNode = rows[0].querySelectorAll('th,td');
                    let headerCells = Array.from(headerCellsNode).map(c => c.textContent.trim());
                    const hasWeekColumn = headerCells.some(h => h.includes('星期') || h.includes('週'));
                    if (!hasWeekColumn) {
                        headerCells.splice(1, 0, '星期');
                    }
                    for (let j = 0; j < headerCells.length; j++) {
                        const cell = worksheet.getCell(currentRow, j + 2);
                        cell.value = headerCells[j];
                        applyStyle(cell, (j < 5) ? styles.header : styles.orangeHeader);
                    }
                    currentRow++;
                    
                    // 添加數據行
                    for (let i = 1; i < rows.length; i++) {
                        const rowCellsNode = rows[i].querySelectorAll('td,th');
                        if (rowCellsNode.length < 1) continue;
                        
                        let rowCells = Array.from(rowCellsNode).map(c => c.textContent.trim());
                        const dateText = rowCells[0];
                        const isTotalRow = dateText === 'TOTAL';

                        if (!hasWeekColumn) {
                            if (isTotalRow) {
                                rowCells.splice(1, 0, ''); // TOTAL 行的星期欄留空
                            } else {
                                const date = parseDateText(dateText);
                                rowCells.splice(1, 0, date ? getWeekdayInChinese(date) : '');
                            }
                        }
                        
                        for (let j = 0; j < rowCells.length; j++) {
                            const cell = worksheet.getCell(currentRow, j + 2);
                            const cellValue = rowCells[j];
                            
                            if (!isNaN(cellValue.replace(/[,]/g, '')) && cellValue !== '') {
                                cell.value = +cellValue.replace(/[,]/g, '');
                            } else {
                                cell.value = cellValue;
                            }
                            
                            if (isTotalRow) {
                                applyStyle(cell, styles.total);
                                if (cellValue.includes('%')) {
                                    cell.font = { bold: true, color: { argb: 'FFFF0000' }, size: 13, name: 'Helvetica' };
                                }
                            } else {
                                applyStyle(cell, styles.normal);
                            }
                        }
                        currentRow++;
                    }
                }
                
                // 添加該 AdSet 下的選中 AdUnit 報表
                if (currentReportData.adunitByAdset[adsetId] && currentReportData.adunitByAdset[adsetId].adunits.length > 0) {
                    // 過濾選中的 AdUnit
                    const selectedAdunitReports = currentReportData.adunitByAdset[adsetId].adunits.filter(
                        adunitReport => selectedAdunits.has(adunitReport.uuid)
                    );
                    
                    if (selectedAdunitReports.length > 0) {
                        currentRow += 1;
                        
                        // 在 B:C 欄合併並插入 AdSet 標題
                        worksheet.mergeCells(currentRow, 2, currentRow, 3);
                        const adsetForAdunitTitleCell = worksheet.getCell(currentRow, 2);
                        adsetForAdunitTitleCell.value = report.name; // AdSet title
                        adsetForAdunitTitleCell.font = { name: 'Helvetica', bold: true, size: 12, color: { argb: 'FF2E7D32' } };
                        adsetForAdunitTitleCell.alignment = { vertical: 'middle', horizontal: 'center' };
                        
                        // 根據選擇的佈局方式插入 AdUnit 報表
                        const layoutMode = document.querySelector('input[name="adunitLayout"]:checked')?.value || 'horizontal';
                        
                        if (layoutMode === 'horizontal') {
                            // 使用原來的並排方式
                            currentRow = await addMergedAdunitReportToExcel(worksheet, styles, currentRow, applyStyle, selectedAdunitReports);
                        } else {
                            // 使用新的垂直排列方式
                            currentRow = await addVerticalAdunitReportsToExcel(worksheet, styles, currentRow, applyStyle, selectedAdunitReports);
                        }
                    }
                }
            } else {
                // 顯示失敗的 AdSet
                                worksheet.mergeCells(currentRow, 2, currentRow, 9);
                const errorCell = worksheet.getCell(currentRow, 2);
                errorCell.value = `❌ ${report.name} - 查詢失敗: ${report.error}`;
                errorCell.font = { name: 'Helvetica', bold: true, size: 12, color: { argb: 'FFDC3545' } };
                errorCell.alignment = { vertical: 'middle', horizontal: 'left' };
                                currentRow += 1;
            }
            
            currentRow += 2; // 在每個 AdSet 之間留空間
        }
        
        return currentRow;
    }
    
    // 新增：添加 AdUnit 圖片到 Excel
    async function addAdunitImagesToExcel(worksheet, startRow, adunitReports) {
        if (!adunitReports || adunitReports.length === 0) {
            return startRow;
        }
        
        let currentRow = startRow;
        const imageRowHeight = 188.4; // 圖片行的高度（像素）- 增加以容納更大的圖片
        
        // 檢查是否有圖片
        const hasImages = adunitReports.some(adunit => adunit.img_main);
        
        if (hasImages) {
            // 設置圖片行的高度
            worksheet.getRow(currentRow).height = imageRowHeight;
            
            let colIndex = 4; // 從第4欄(D)開始，因為 B,C 已被 AdSet title 使用
            
            // 為每個 AdUnit 添加圖片
            for (const adunit of adunitReports) {
                const imgMain = adunit.img_main;
                const adunitName = adunit.name || adunit.uuid?.substring(0, 8) || 'Unknown';
                
                // 為圖片容器合併 D,E,F 欄
                worksheet.mergeCells(currentRow, colIndex, currentRow, colIndex + 2);

                if (imgMain) {
                    try {
                        console.log(`正在下載圖片: ${adunitName} - ${imgMain}`);
                        
                        // 使用代理方式下載圖片
                        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(imgMain)}`;
                        const imageResponse = await fetch(proxyUrl);
                        
                        if (imageResponse.ok) {
                            const imageBlob = await imageResponse.blob();
                            const arrayBuffer = await imageBlob.arrayBuffer();
                            
                            // 獲取圖片副檔名
                            const extension = getImageExtension(imgMain);
                            
                            // 創建圖片 ID
                            const imageId = worksheet.workbook.addImage({
                                buffer: arrayBuffer,
                                extension: extension
                            });
                            
                            // 計算圖片位置和大小
                            const imageWidth = 360; // 圖片寬度（調整為更大）
                            const imageHeight = 188.4;  // 圖片高度（調整為更大）
                            
                            // 添加圖片到工作表，置中對齊到3欄的中間
                            worksheet.addImage(imageId, {
                                tl: { col: colIndex - 0.1, row: currentRow - 0.8 }, // 圖片左上角位置
                                ext: { width: imageWidth, height: imageHeight }       // 圖片大小
                            });
                            
                            console.log(`成功添加圖片到 Excel: ${adunitName}`);
                        } else {
                            console.warn(`無法下載圖片: ${imgMain} - HTTP ${imageResponse.status}`);
                            
                            // 添加無圖片提示到第一欄
                            const noImageCell = worksheet.getCell(currentRow, colIndex);
                            noImageCell.value = '圖片載入失敗';
                            noImageCell.font = { name: 'Helvetica', size: 8, italic: true, color: { argb: 'FF999999' } };
                            noImageCell.alignment = { vertical: 'middle', horizontal: 'center' };
                        }
                    } catch (error) {
                        console.error(`下載圖片時發生錯誤: ${adunitName}`, error);
                        
                        // 添加錯誤提示
                        const errorCell = worksheet.getCell(currentRow, colIndex);
                        errorCell.value = '圖片處理錯誤';
                        errorCell.font = { name: 'Helvetica', size: 8, italic: true, color: { argb: 'FFCC0000' } };
                        errorCell.alignment = { vertical: 'middle', horizontal: 'center' };
                    }
                } else {
                    // 添加無圖片提示
                    const noImageCell = worksheet.getCell(currentRow, colIndex);
                    noImageCell.value = '無圖片';
                    noImageCell.font = { name: 'Helvetica', size: 8, italic: true, color: { argb: 'FF999999' } };
                    noImageCell.alignment = { vertical: 'middle', horizontal: 'center' };
                }
                
                colIndex += 3; // 每個 AdUnit 佔用 3 欄（對應後面的曝光、點擊、點擊率）
            }
            
            currentRow += 1; // 跳過圖片行
        }
        
        return currentRow;
    }
    
    // 輔助函數：取得圖片副檔名
    function getImageExtension(url) {
        if (!url) return 'jpeg';
        
        const extension = url.split('.').pop().toLowerCase().split('?')[0]; // 移除查詢參數
        switch (extension) {
            case 'jpg':
            case 'jpeg':
                return 'jpeg';
            case 'png':
                return 'png';
            case 'gif':
                return 'gif';
            case 'webp':
                return 'webp';
            case 'bmp':
                return 'bmp';
            default:
                return 'jpeg'; // 預設為 jpeg
        }
    }

    // 新增：添加垂直排列的 AdUnit 報表到 Excel
    async function addVerticalAdunitReportsToExcel(worksheet, styles, startRow, applyStyle, adunitReports) {
        let currentRow = startRow;
        
        if (!adunitReports || adunitReports.length === 0) {
            return currentRow;
        }
        
        // 為每個 AdUnit 單獨生成報表
        for (let i = 0; i < adunitReports.length; i++) {
            const adunitReport = adunitReports[i];
            const adunitName = adunitReport.name || adunitReport.uuid?.substring(0, 8) || 'Unknown';
            const adunitUuid = adunitReport.uuid || '';
            
            // 添加 AdUnit 標題行
            currentRow += 1;
            worksheet.mergeCells(currentRow, 2, currentRow, 6);
            const adunitTitleCell = worksheet.getCell(currentRow, 2);
            adunitTitleCell.value = `📱 ${adunitName} (${adunitUuid.substring(0, 8)}...)`;
            adunitTitleCell.font = { name: 'Helvetica', bold: true, size: 11, color: { argb: 'FF007BFF' } };
            adunitTitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
            adunitTitleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8F9FF' } };
            
            // 添加邊框
            const adunitTitleBorder = {
                top: { style: 'thin', color: { argb: 'FF007BFF' } },
                left: { style: 'thin', color: { argb: 'FF007BFF' } },
                bottom: { style: 'thin', color: { argb: 'FF007BFF' } },
                right: { style: 'thin', color: { argb: 'FF007BFF' } }
            };
            
            for (let col = 2; col <= 6; col++) {
                worksheet.getCell(currentRow, col).border = adunitTitleBorder;
            }
            
            currentRow += 1;
            
            // 添加 AdUnit 圖片（如果有的話）
            const imgMain = adunitReport.img_main;
            if (imgMain) {
                try {
                    console.log(`正在為垂直佈局下載圖片: ${adunitName} - ${imgMain}`);
                    
                    const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(imgMain)}`;
                    const imageResponse = await fetch(proxyUrl);
                    
                    if (imageResponse.ok) {
                        const imageBlob = await imageResponse.blob();
                        const arrayBuffer = await imageBlob.arrayBuffer();
                        const extension = getImageExtension(imgMain);
                        
                        const imageId = worksheet.workbook.addImage({
                            buffer: arrayBuffer,
                            extension: extension
                        });
                        
                        // 設置圖片行高度
                        worksheet.getRow(currentRow).height = 120;
                        
                        // 合併圖片區域
                        worksheet.mergeCells(currentRow, 2, currentRow, 4);
                        
                        // 添加圖片
                        worksheet.addImage(imageId, {
                            tl: { col: 1.8, row: currentRow - 0.8 },
                            ext: { width: 200, height: 120 }
                        });
                        
                        console.log(`成功添加垂直佈局圖片: ${adunitName}`);
                        currentRow += 1;
                    } else {
                        // 添加無圖片提示
                        worksheet.mergeCells(currentRow, 2, currentRow, 4);
                        const noImageCell = worksheet.getCell(currentRow, 2);
                        noImageCell.value = '圖片載入失敗';
                        noImageCell.font = { name: 'Helvetica', size: 10, italic: true, color: { argb: 'FF999999' } };
                        noImageCell.alignment = { vertical: 'middle', horizontal: 'center' };
                        currentRow += 1;
                    }
                } catch (error) {
                    console.error(`垂直佈局下載圖片時發生錯誤: ${adunitName}`, error);
                    // 添加錯誤提示
                    worksheet.mergeCells(currentRow, 2, currentRow, 4);
                    const errorCell = worksheet.getCell(currentRow, 2);
                    errorCell.value = '圖片處理錯誤';
                    errorCell.font = { name: 'Helvetica', size: 10, italic: true, color: { argb: 'FFCC0000' } };
                    errorCell.alignment = { vertical: 'middle', horizontal: 'center' };
                    currentRow += 1;
                }
            } else {
                // 添加無圖片提示
                worksheet.mergeCells(currentRow, 2, currentRow, 4);
                const noImageCell = worksheet.getCell(currentRow, 2);
                noImageCell.value = '無圖片';
                noImageCell.font = { name: 'Helvetica', size: 10, italic: true, color: { argb: 'FF999999' } };
                noImageCell.alignment = { vertical: 'middle', horizontal: 'center' };
                currentRow += 1;
            }
            
            // 解析並添加 AdUnit 的報表數據
            if (adunitReport.success) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(adunitReport.content, 'text/html');
                let table = findDailyReportTable(doc);
                
                if (table) {
                    // 🎬 如果是 slide 廣告且有 cut 數據，處理 cut 數據
                    if (isSlideAd && Object.keys(currentCutData).length > 0 && currentCutData[adunitUuid]) {
                        console.log(`🎬 為垂直排列 Excel 的 AdUnit ${adunitName} 添加 cut 數據`);
                        
                        // 為單個 AdUnit 建構 cut 數據表格
                        const singleAdunitCutData = {};
                        singleAdunitCutData[adunitUuid] = currentCutData[adunitUuid];
                        
                        table = buildSlideReportTableForSingleAdunit(table, singleAdunitCutData, adunitUuid);
                    }
                    
                    const rows = table.querySelectorAll('tr');
                    if (rows.length > 0) {
                        // 添加表頭
                        const headerRow = rows[0];
                        const headers = Array.from(headerRow.querySelectorAll('th, td')).map(h => h.textContent.trim());
                        
                        // 確定需要的欄位數量 - 移除固定的6欄限制，以支援 slide cut 報表
                        const colCount = headers.length;
                        
                        // 添加表頭
                        for (let j = 0; j < colCount; j++) {
                            const headerCell = worksheet.getCell(currentRow, j + 2); // 從第2欄開始
                            headerCell.value = headers[j] || '';
                            headerCell.font = { name: 'Helvetica', bold: true, size: 13, color: { argb: 'FFFFFFFF' } };
                            
                            // 為 cut 相關欄位設定特殊樣式
                            if (headers[j] && (headers[j].startsWith('cut') || headers[j] === '文案')) {
                                headerCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE67E22' } }; // 橘色
                            } else {
                                headerCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } }; // 標準藍色
                            }
                            
                            headerCell.alignment = { vertical: 'middle', horizontal: 'center' };
                            headerCell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        }
                        currentRow += 1;
                        
                        // 添加數據行
                        let totalImp = 0, totalClk = 0;
                        const cutTotals = {}; // 存儲各 cut 的總數
                        let totalTextClicks = 0; // 文案點擊數總計
                        
                        for (let i = 1; i < rows.length; i++) {
                            const dataRow = rows[i];
                            const cells = dataRow.querySelectorAll('td, th');
                            
                            if (cells.length === 0) continue;
                            
                            const dateText = cells[0].textContent.trim();
                            if (dateText === 'TOTAL') continue; // 跳過現有的 TOTAL 行，我們稍後會自己計算
                            
                            // 添加數據到 Excel
                            for (let j = 0; j < cells.length; j++) {
                                const cellValue = cells[j].textContent.trim();
                                const excelCell = worksheet.getCell(currentRow, j + 2);
                                
                                excelCell.value = cellValue;
                                excelCell.font = { name: 'Helvetica', size: 13 };
                                excelCell.alignment = { vertical: 'middle', horizontal: 'center' };
                                excelCell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                                
                                // 特殊處理：為包含 cut 數據的儲存格加上背景色
                                if (headers[j] && headers[j].startsWith('cut')) {
                                    excelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                                } else if (headers[j] && headers[j] === '文案') {
                                    excelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD1ECF1' } };
                                }
                                
                                // 收集數據用於計算總數
                                if (j > 0) { // 跳過日期欄
                                    const numValue = parseFloat(cellValue.replace(/[,]/g, ''));
                                    if (!isNaN(numValue) && numValue > 0) {
                                        if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                                            totalImp += numValue;
                                        } else if (headers[j] && headers[j].includes('點擊數')) {
                                            totalClk += numValue;
                                        } else if (headers[j] && headers[j].startsWith('cut')) {
                                            // 累計各 cut 的總數
                                            if (!cutTotals[headers[j]]) cutTotals[headers[j]] = 0;
                                            cutTotals[headers[j]] += numValue;
                                        } else if (headers[j] && headers[j] === '文案') {
                                            totalTextClicks += numValue;
                                        }
                                    }
                                }
                            }
                            currentRow += 1;
                        }
                        
                        // 添加 TOTAL 行
                        for (let j = 0; j < colCount; j++) {
                            const totalCell = worksheet.getCell(currentRow, j + 2);
                            let isCutOrText = false;

                            if (j === 0) {
                                totalCell.value = 'TOTAL';
                            } else if (headers[j] && headers[j] === '星期') {
                                totalCell.value = ''; // 星期欄留空
                            } else if (headers[j] && (headers[j].includes('曝光數') || headers[j].includes('播放數'))) {
                                totalCell.value = totalImp > 0 ? totalImp.toLocaleString() : '';
                            } else if (headers[j] && headers[j].includes('點擊數') && !headers[j].startsWith('cut') && headers[j] !== '文案') {
                                totalCell.value = totalClk > 0 ? totalClk.toString() : '';
                            } else if (headers[j] && (headers[j].includes('點擊率') || headers[j].includes('觀看率'))) {
                                if (totalImp > 0) {
                                    totalCell.value = ((totalClk / totalImp) * 100).toFixed(2) + '%';
                                } else {
                                    totalCell.value = '0.00%';
                                }
                            } else if (headers[j] && headers[j].startsWith('cut')) {
                                isCutOrText = true;
                                const cutTotal = cutTotals[headers[j]] || 0;
                                totalCell.value = cutTotal > 0 ? cutTotal.toString() : '';
                                totalCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE67E22' } };
                                totalCell.font = { name: 'Helvetica', bold: true, size: 13, color: { argb: 'FFFFFFFF' } };
                            } else if (headers[j] && headers[j] === '文案') {
                                isCutOrText = true;
                                totalCell.value = totalTextClicks > 0 ? totalTextClicks.toString() : '';
                                totalCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF17A2B8' } };
                                totalCell.font = { name: 'Helvetica', bold: true, size: 13, color: { argb: 'FFFFFFFF' } };
                            } else {
                                totalCell.value = '';
                            }

                            if (!isCutOrText) {
                                totalCell.font = { name: 'Helvetica', bold: true, size: 13 };
                                totalCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFDA66' } };
                            }
                            
                            totalCell.alignment = { vertical: 'middle', horizontal: 'center' };
                            totalCell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        }
                        currentRow += 2; // 增加間距
                    }
                } else {
                    // 無法解析報表數據
                    worksheet.mergeCells(currentRow, 2, currentRow, 6);
                    const errorCell = worksheet.getCell(currentRow, 2);
                    errorCell.value = `❌ 無法解析 ${adunitName} 的報表數據`;
                    errorCell.font = { name: 'Helvetica', size: 10, color: { argb: 'FFDC3545' } };
                    errorCell.alignment = { vertical: 'middle', horizontal: 'center' };
                    currentRow += 1;
                }
            } else {
                // AdUnit 查詢失敗
                worksheet.mergeCells(currentRow, 2, currentRow, 6);
                const failCell = worksheet.getCell(currentRow, 2);
                failCell.value = `❌ ${adunitName} 查詢失敗: ${adunitReport.error || '未知錯誤'}`;
                failCell.font = { name: 'Helvetica', size: 10, color: { argb: 'FFDC3545' } };
                failCell.alignment = { vertical: 'middle', horizontal: 'center' };
                currentRow += 1;
            }
            
            // 在每個 AdUnit 之間添加空行
            if (i < adunitReports.length - 1) {
                currentRow += 1;
            }
        }
        
        return currentRow;
    }


    // 新增：添加並排的 AdUnit 報表到 Excel
    async function addMergedAdunitReportToExcel(worksheet, styles, startRow, applyStyle, adunitReports) {
        let currentRow = startRow;
        
        if (!adunitReports || adunitReports.length === 0) {
            return currentRow;
        }
        
        // 先添加 AdUnit 圖片行
        currentRow = await addAdunitImagesToExcel(worksheet, currentRow, adunitReports);
        
        // 移除圖片和標題之間的空行
        // currentRow += 1;
        
        // 解析所有 AdUnit 的報表數據
        const parsedAdunits = [];
        
        for (const adunitReport of adunitReports) {
            if (!adunitReport.success) continue;
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(adunitReport.content, 'text/html');
            const table = findDailyReportTable(doc);
                                
            if (table) {
                const rows = table.querySelectorAll('tr');
                const headers = Array.from(rows[0].querySelectorAll('th, td')).map(h => h.textContent.trim());
                const data = {};
                
                // 解析數據行
                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].querySelectorAll('td, th');
                    if (cells.length === 0) continue;
                    
                    const dateText = cells[0].textContent.trim();
                    if (dateText === 'TOTAL') continue;
                    
                    const rowData = {};
                    for (let j = 0; j < cells.length; j++) {
                        const header = headers[j] || `col_${j}`;
                        rowData[header] = cells[j].textContent.trim();
                                    }
                    data[dateText] = rowData;
                }
                
                // 處理 TOTAL 行
                const totalRow = Array.from(rows).find(row => {
                    const cells = row.querySelectorAll('td, th');
                    return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
                });
                
                let totalData = null;
                if (totalRow) {
                    const totalCells = totalRow.querySelectorAll('td, th');
                    totalData = {};
                    for (let j = 0; j < totalCells.length; j++) {
                        const header = headers[j] || `col_${j}`;
                        totalData[header] = totalCells[j].textContent.trim();
                    }
                }
                
                // 如果沒有 TOTAL 數據，計算並生成
                if (!totalData) {
                    totalData = calculateAdunitTotalData(data, headers);
                    console.log(`為 Excel AdUnit ${adunitReport.name} 計算的 TOTAL 數據:`, totalData);
                }
                
                parsedAdunits.push({
                    name: adunitReport.name,
                    uuid: adunitReport.uuid,
                    headers: headers,
                    data: data,
                    totalData: totalData
                });
            }
        }
        
        if (parsedAdunits.length === 0) {
            return currentRow;
        }
        
        // 收集所有唯一的日期
        const allDates = new Set();
        parsedAdunits.forEach(adunit => {
            Object.keys(adunit.data).forEach(date => allDates.add(date));
        });
        
        const sortedDates = Array.from(allDates).sort();
        
        // 第一層表頭：AdUnit 名稱
        const headerRow1 = currentRow;
        
        // 日期和星期欄位
        const dateHeader1 = worksheet.getCell(headerRow1, 2);
        dateHeader1.value = '日期';
        worksheet.mergeCells(headerRow1, 2, headerRow1 + 1, 2);
        applyStyle(dateHeader1, styles.header);
        dateHeader1.alignment = { vertical: 'middle', horizontal: 'center' };
        
        const weekHeader1 = worksheet.getCell(headerRow1, 3);
        weekHeader1.value = '星期';
        worksheet.mergeCells(headerRow1, 3, headerRow1 + 1, 3);
        applyStyle(weekHeader1, styles.header);
        weekHeader1.alignment = { vertical: 'middle', horizontal: 'center' };
        
        let colIndex = 4;
        
        // 為每個 AdUnit 添加表頭
        parsedAdunits.forEach(adunit => {
            // 第一層：AdUnit 名稱（跨 3 欄）
            const adunitHeader = worksheet.getCell(headerRow1, colIndex);
            adunitHeader.value = adunit.name;
            worksheet.mergeCells(headerRow1, colIndex, headerRow1, colIndex + 2);
            adunitHeader.font = { name: 'Helvetica', bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            adunitHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2196F3' } };
            adunitHeader.alignment = { vertical: 'middle', horizontal: 'center' };
            adunitHeader.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
            
            colIndex += 3;
        });
        
        // 第二層表頭：曝光數、點擊數、點擊率
        const headerRow2 = currentRow + 1;
        colIndex = 4;
        
        parsedAdunits.forEach(adunit => {
            // 曝光數
            const impHeader = worksheet.getCell(headerRow2, colIndex);
            impHeader.value = '曝光數';
            applyStyle(impHeader, styles.header);
            
            // 點擊數
            const clkHeader = worksheet.getCell(headerRow2, colIndex + 1);
            clkHeader.value = '點擊數';
            applyStyle(clkHeader, styles.header);
            
            // 點擊率
            const ctrHeader = worksheet.getCell(headerRow2, colIndex + 2);
            ctrHeader.value = '點擊率';
            applyStyle(ctrHeader, styles.header);
            
            colIndex += 3;
        });
        
        currentRow += 2; // 跳過兩個表頭行
        
        // 建立數據行
        sortedDates.forEach(dateText => {
            // 日期欄
            const dateCell = worksheet.getCell(currentRow, 2);
            dateCell.value = dateText;
            applyStyle(dateCell, styles.normal);
            
            // 星期欄
            const weekCell = worksheet.getCell(currentRow, 3);
            const date = parseDateText(dateText);
            weekCell.value = date ? getWeekdayInChinese(date) : '';
            applyStyle(weekCell, styles.normal);
            
            colIndex = 4;
            
            // 為每個 AdUnit 添加數據
            parsedAdunits.forEach(adunit => {
                const adunitData = adunit.data[dateText] || {};
                
                // 曝光數
                const impCell = worksheet.getCell(currentRow, colIndex);
                const impValue = extractNumericValue(adunitData, ['曝光數', '播放數']);
                impCell.value = impValue > 0 ? impValue : '';
                applyStyle(impCell, styles.normal);
                
                // 點擊數
                const clkCell = worksheet.getCell(currentRow, colIndex + 1);
                const clkValue = extractNumericValue(adunitData, ['點擊數']);
                clkCell.value = clkValue > 0 ? clkValue : '';
                applyStyle(clkCell, styles.normal);
                
                // 點擊率
                const ctrCell = worksheet.getCell(currentRow, colIndex + 2);
                const ctrValue = extractPercentageValue(adunitData, ['點擊率', '觀看率']);
                ctrCell.value = ctrValue || '';
                applyStyle(ctrCell, styles.normal);
                
                colIndex += 3;
            });
            
            currentRow++;
        });
        
        // 建立 TOTAL 行
        const totalRowIndex = currentRow;
        
        // TOTAL 標籤
        const totalLabelCell = worksheet.getCell(totalRowIndex, 2);
        totalLabelCell.value = 'TOTAL';
        applyStyle(totalLabelCell, styles.total);
        
        // 空的星期欄
        const emptyWeekCell = worksheet.getCell(totalRowIndex, 3);
        emptyWeekCell.value = '';
        applyStyle(emptyWeekCell, styles.total);
        
        colIndex = 4;
        
        // 為每個 AdUnit 添加 TOTAL 數據
        parsedAdunits.forEach(adunit => {
            const totalData = adunit.totalData || {};
            
            // 總曝光數
            const totalImpCell = worksheet.getCell(totalRowIndex, colIndex);
            const totalImpValue = extractNumericValue(totalData, ['曝光數', '播放數']);
            totalImpCell.value = totalImpValue > 0 ? totalImpValue : '';
            applyStyle(totalImpCell, styles.total);
            
            // 總點擊數
            const totalClkCell = worksheet.getCell(totalRowIndex, colIndex + 1);
            const totalClkValue = extractNumericValue(totalData, ['點擊數']);
            totalClkCell.value = totalClkValue > 0 ? totalClkValue : '';
            applyStyle(totalClkCell, styles.total);
            
            // 總點擊率
            const totalCtrCell = worksheet.getCell(totalRowIndex, colIndex + 2);
            const totalCtrValue = extractPercentageValue(totalData, ['點擊率', '觀看率']);
            totalCtrCell.value = totalCtrValue || '';
            totalCtrCell.font = { bold: true, color: { argb: 'FFFF0000' }, size: 13, name: 'Helvetica' };
            totalCtrCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFDA66' } };
            totalCtrCell.alignment = { vertical: 'middle', horizontal: 'center' };
            totalCtrCell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
            
            colIndex += 3;
        });
        
        return currentRow + 2;
    }

    // 計算總數據行數的輔助函數
    function countTotalDataRows() {
        if (!currentReportData.table) return 0;
        const rows = currentReportData.table.querySelectorAll('tr');
        return Math.max(0, rows.length - 1); // 扣除表頭
    }

    // 計算有數據的行數的輔助函數
    function countHasDataRows() {
        if (!currentReportData.table) return 0;
        const rows = currentReportData.table.querySelectorAll('tr');
        let count = 0;
        
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].querySelectorAll('td,th');
            if (cells.length > 2) {
                const cellContent = cells[2].textContent.trim();
                if (cellContent && cellContent !== '—' && cellContent !== 'TOTAL') {
                    count++;
                }
            }
        }
        
        return count;
    }

    // 建構單個 AdUnit 的 slide 廣告報表表格（包含 cut 數據）
    function buildSlideReportTableForSingleAdunit(originalTable, cutData, adunitUuid) {
        // 這個函數專門處理單個 AdUnit 的 cut 數據，用於垂直排列
        if (!cutData[adunitUuid] || !cutData[adunitUuid].data || !cutData[adunitUuid].data.success) {
            console.log(`⚠️ AdUnit ${adunitUuid} 沒有有效的 cut 數據`);
            return originalTable;
        }

        const data = cutData[adunitUuid].data;
        const cutKeys = Object.keys(data.success).filter(key => !isNaN(key));
        
        if (cutKeys.length === 0) {
            console.log(`⚠️ AdUnit ${adunitUuid} 沒有 cut 數據`);
            return originalTable;
        }

        // 解析原始表格
        const rows = originalTable.querySelectorAll('tr');
        if (rows.length < 2) return originalTable;

        // 解析表頭
        const originalHeaders = Array.from(rows[0].querySelectorAll('th, td')).map(h => h.textContent.trim());
        
        // 找出各欄位的索引位置
        let dateIndex = -1, impIndex = -1, clkIndex = -1, ctrIndex = -1;
        originalHeaders.forEach((header, index) => {
            if (header.includes('日期')) dateIndex = index;
            else if (header.includes('曝光數') || header.includes('播放數')) impIndex = index;
            else if (header.includes('點擊數')) clkIndex = index;
            else if (header.includes('點擊率') || header.includes('觀看率')) ctrIndex = index;
        });

        // 建構新的表頭
        const newHeaders = ['日期', '星期', '曝光數', '點擊數', '點擊率'];
        cutKeys.forEach(cutKey => {
            newHeaders.push(`cut${cutKey}`);
        });
        newHeaders.push('文案');

        // 建構新表格
        const newTable = document.createElement('table');
        newTable.className = originalTable.className;

        // 添加表頭
        const headerRow = document.createElement('tr');
        for (let header of newHeaders) {
            const th = document.createElement('th');
            th.textContent = header;
            if (header.startsWith('cut') || header === '文案') {
                th.style.backgroundColor = '#f39c12';
                th.style.color = 'white';
            }
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);

        // 處理數據行
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length === 0) continue;

            const dateText = dateIndex >= 0 ? cells[dateIndex].textContent.trim() : cells[0].textContent.trim();
            
            // 跳過 TOTAL 行（稍後處理）
            if (dateText === 'TOTAL') continue;

            // 解析日期
            let rowDate = null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
            } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('/');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
            } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('-');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
            }

            // 取得原始數據
            const imp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const clk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const ctr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';

            // 計算當天的 cut 數據
            const cutValues = [];
            const formattedDate = rowDate ? formatDateForCutData(rowDate) : null;

            cutKeys.forEach(cutKey => {
                let cutValue = 0;
                if (formattedDate && data.success[cutKey]) {
                    const dayData = data.success[cutKey].find(d => d._id === formattedDate);
                    if (dayData) {
                        cutValue = dayData.totalCount;
                    }
                }
                cutValues.push(cutValue);
            });

            // 計算文案數量：總點擊數 - 所有 cut 的總和
            const totalCutClicks = cutValues.reduce((sum, cut) => sum + cut, 0);
            const textClicks = Math.max(0, clk - totalCutClicks);

            // 建構新的數據行
            const newRow = document.createElement('tr');
            
            // 日期
            const dateCell = document.createElement('td');
            dateCell.textContent = dateText;
            newRow.appendChild(dateCell);

            // 星期
            const weekCell = document.createElement('td');
            weekCell.textContent = rowDate ? getWeekdayInChinese(rowDate) : '';
            newRow.appendChild(weekCell);

            // 曝光數
            const impCell = document.createElement('td');
            impCell.textContent = imp > 0 ? imp.toLocaleString() : '';
            newRow.appendChild(impCell);

            // 點擊數
            const clkCell = document.createElement('td');
            clkCell.textContent = clk > 0 ? clk : '';
            newRow.appendChild(clkCell);

            // 點擊率
            const ctrCell = document.createElement('td');
            ctrCell.textContent = ctr;
            newRow.appendChild(ctrCell);

            // Cut 數據
            cutValues.forEach(cutValue => {
                const cutCell = document.createElement('td');
                cutCell.textContent = cutValue > 0 ? cutValue : '';
                cutCell.style.backgroundColor = cutValue > 0 ? '#fff3cd' : '';
                newRow.appendChild(cutCell);
            });

            // 文案
            const textCell = document.createElement('td');
            textCell.textContent = textClicks > 0 ? textClicks : '';
            textCell.style.backgroundColor = textClicks > 0 ? '#d1ecf1' : '';
            newRow.appendChild(textCell);

            newTable.appendChild(newRow);
        }

        // 處理 TOTAL 行 - 無論原表格是否有 TOTAL 行都要重新計算並添加
        const totalRow = Array.from(rows).find(row => {
            const cells = row.querySelectorAll('td, th');
            return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
        });

        // 計算總數（從原始 TOTAL 行或從數據行重新計算）
        let totalImp = 0, totalClk = 0;
        let totalCtr = '';
        
        if (totalRow) {
            // 如果有原始 TOTAL 行，使用其數據
            const cells = totalRow.querySelectorAll('td, th');
            totalImp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            totalClk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            totalCtr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';
        } else {
            // 如果沒有原始 TOTAL 行，從數據行計算
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td, th');
                if (cells.length === 0) continue;
                
                const dateText = dateIndex >= 0 ? cells[dateIndex].textContent.trim() : cells[0].textContent.trim();
                if (dateText === 'TOTAL') continue; // 跳過可能的 TOTAL 行
                
                const imp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
                const clk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
                
                totalImp += imp;
                totalClk += clk;
            }
            
            // 計算總點擊率
            if (totalImp > 0) {
                totalCtr = ((totalClk / totalImp) * 100).toFixed(2) + '%';
            } else {
                totalCtr = '0.00%';
            }
        }

        // 計算總計 cut 數據
        const totalCutValues = [];
        cutKeys.forEach(cutKey => {
            let cutTotal = 0;
            if (data.success[cutKey]) {
                cutTotal = data.success[cutKey].reduce((sum, d) => sum + d.totalCount, 0);
            }
            totalCutValues.push(cutTotal);
        });

        const totalCutClicks = totalCutValues.reduce((sum, cut) => sum + cut, 0);
        const totalTextClicks = Math.max(0, totalClk - totalCutClicks);

        const newTotalRow = document.createElement('tr');
        newTotalRow.className = 'total-row';
        newTotalRow.style.fontWeight = 'bold';
        
        // TOTAL 標籤
        const totalLabelCell = document.createElement('td');
        totalLabelCell.textContent = 'TOTAL';
        totalLabelCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(totalLabelCell);

        // 空白星期欄
        const emptyWeekCell = document.createElement('td');
        emptyWeekCell.textContent = '';
        newTotalRow.appendChild(emptyWeekCell);

        // 總曝光數
        const totalImpCell = document.createElement('td');
        totalImpCell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
        totalImpCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(totalImpCell);

        // 總點擊數
        const totalClkCell = document.createElement('td');
        totalClkCell.textContent = totalClk > 0 ? totalClk : '';
        totalClkCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(totalClkCell);

        // 總點擊率
        const totalCtrCell = document.createElement('td');
        totalCtrCell.textContent = totalCtr;
        totalCtrCell.style.fontWeight = 'bold';
        totalCtrCell.style.color = '#dc3545';
        newTotalRow.appendChild(totalCtrCell);

        // 總 Cut 數據
        totalCutValues.forEach(cutTotal => {
            const cutCell = document.createElement('td');
            cutCell.textContent = cutTotal > 0 ? cutTotal : '';
            cutCell.style.fontWeight = 'bold';
            cutCell.style.backgroundColor = cutTotal > 0 ? '#fff3cd' : '';
            newTotalRow.appendChild(cutCell);
        });

        // 總文案
        const totalTextCell = document.createElement('td');
        totalTextCell.textContent = totalTextClicks > 0 ? totalTextClicks : '';
        totalTextCell.style.fontWeight = 'bold';
        totalTextCell.style.backgroundColor = totalTextClicks > 0 ? '#d1ecf1' : '';
        newTotalRow.appendChild(totalTextCell);

        newTable.appendChild(newTotalRow);

        return newTable;
    }

    // 建構 slide 廣告報表表格（包含 cut 數據）
    function buildSlideReportTable(originalTable, cutData) {
        // 解析原始表格
        const rows = originalTable.querySelectorAll('tr');
        if (rows.length < 2) return originalTable;

        // 解析表頭
        const originalHeaders = Array.from(rows[0].querySelectorAll('th, td')).map(h => h.textContent.trim());
        
        // 找出各欄位的索引位置
        let dateIndex = -1, impIndex = -1, clkIndex = -1, ctrIndex = -1;
        originalHeaders.forEach((header, index) => {
            if (header.includes('日期')) dateIndex = index;
            else if (header.includes('曝光數') || header.includes('播放數')) impIndex = index;
            else if (header.includes('點擊數')) clkIndex = index;
            else if (header.includes('點擊率') || header.includes('觀看率')) ctrIndex = index;
        });

        // 分析所有 AdUnit 的 cut 數量，找出最大值
        let maxCuts = 0;
        for (const uuid in cutData) {
            const data = cutData[uuid].data;
            if (data.success) {
                const cutKeys = Object.keys(data.success).filter(key => !isNaN(key));
                maxCuts = Math.max(maxCuts, cutKeys.length);
            }
        }

        // 建構新的表頭
        const newHeaders = ['日期', '星期', '曝光數', '點擊數', '點擊率'];
        for (let i = 1; i <= maxCuts; i++) {
            newHeaders.push(`cut${i}`);
        }
        newHeaders.push('文案');

        // 建構新表格
        const newTable = document.createElement('table');
        newTable.className = originalTable.className;

        // 添加表頭
        const headerRow = document.createElement('tr');
        for (let header of newHeaders) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);

        // 處理數據行
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length === 0) continue;

            const dateText = dateIndex >= 0 ? cells[dateIndex].textContent.trim() : cells[0].textContent.trim();
            
            // 跳過 TOTAL 行（稍後處理）
            if (dateText === 'TOTAL') continue;

            // 解析日期
            let rowDate = null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
            } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('/');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
            } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('-');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
            }

            // 取得原始數據
            const imp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const clk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            const ctr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';

            // 計算當天的 cut 數據總和
            const cutTotals = new Array(maxCuts).fill(0);
            const formattedDate = rowDate ? formatDateForCutData(rowDate) : null;

            if (formattedDate) {
                for (const uuid in cutData) {
                    const data = cutData[uuid].data;
                    if (data.success) {
                        for (let cutNum = 1; cutNum <= maxCuts; cutNum++) {
                            const cutKey = cutNum.toString();
                            if (data.success[cutKey]) {
                                const dayData = data.success[cutKey].find(d => d._id === formattedDate);
                                if (dayData) {
                                    cutTotals[cutNum - 1] += dayData.totalCount;
                                }
                            }
                        }
                    }
                }
            }

            // 計算文案數量：總點擊數 - 所有 cut 的總和
            const totalCutClicks = cutTotals.reduce((sum, cut) => sum + cut, 0);
            const textClicks = Math.max(0, clk - totalCutClicks);

            // 建構新的數據行
            const newRow = document.createElement('tr');
            
            // 日期
            const dateCell = document.createElement('td');
            dateCell.textContent = dateText;
            newRow.appendChild(dateCell);

            // 星期
            const weekCell = document.createElement('td');
            weekCell.textContent = rowDate ? getWeekdayInChinese(rowDate) : '';
            newRow.appendChild(weekCell);

            // 曝光數
            const impCell = document.createElement('td');
            impCell.textContent = imp > 0 ? imp.toLocaleString() : '';
            newRow.appendChild(impCell);

            // 點擊數
            const clkCell = document.createElement('td');
            clkCell.textContent = clk > 0 ? clk : '';
            newRow.appendChild(clkCell);

            // 點擊率
            const ctrCell = document.createElement('td');
            ctrCell.textContent = ctr;
            newRow.appendChild(ctrCell);

            // Cut 數據
            for (let i = 0; i < maxCuts; i++) {
                const cutCell = document.createElement('td');
                cutCell.textContent = cutTotals[i] > 0 ? cutTotals[i] : '';
                newRow.appendChild(cutCell);
            }

            // 文案
            const textCell = document.createElement('td');
            textCell.textContent = textClicks > 0 ? textClicks : '';
            newRow.appendChild(textCell);

            newTable.appendChild(newRow);
        }

        // 處理 TOTAL 行 - 無論原表格是否有 TOTAL 行都要重新計算並添加
        const totalRow = Array.from(rows).find(row => {
            const cells = row.querySelectorAll('td, th');
            return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
        });

        // 計算總數（從原始 TOTAL 行或從數據行重新計算）
        let totalImp = 0, totalClk = 0;
        let totalCtr = '';
        
        if (totalRow) {
            // 如果有原始 TOTAL 行，使用其數據
            const cells = totalRow.querySelectorAll('td, th');
            totalImp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            totalClk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
            totalCtr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';
        } else {
            // 如果沒有原始 TOTAL 行，從數據行計算
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td, th');
                if (cells.length === 0) continue;
                
                const dateText = dateIndex >= 0 ? cells[dateIndex].textContent.trim() : cells[0].textContent.trim();
                if (dateText === 'TOTAL') continue; // 跳過可能的 TOTAL 行
                
                const imp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
                const clk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,—]/g,'')) || 0 : 0;
                
                totalImp += imp;
                totalClk += clk;
            }
            
            // 計算總點擊率
            if (totalImp > 0) {
                totalCtr = ((totalClk / totalImp) * 100).toFixed(2) + '%';
            } else {
                totalCtr = '0.00%';
            }
        }

        // 計算總計 cut 數據
        const totalCutTotals = new Array(maxCuts).fill(0);
        for (const uuid in cutData) {
            const data = cutData[uuid].data;
            if (data.success) {
                for (let cutNum = 1; cutNum <= maxCuts; cutNum++) {
                    const cutKey = cutNum.toString();
                    if (data.success[cutKey]) {
                        const cutTotal = data.success[cutKey].reduce((sum, d) => sum + d.totalCount, 0);
                        totalCutTotals[cutNum - 1] += cutTotal;
                    }
                }
            }
        }

        const totalCutClicks = totalCutTotals.reduce((sum, cut) => sum + cut, 0);
        const totalTextClicks = Math.max(0, totalClk - totalCutClicks);

        const newTotalRow = document.createElement('tr');
        newTotalRow.className = 'total-row';
        newTotalRow.style.fontWeight = 'bold';
        
        // TOTAL 標籤
        const totalLabelCell = document.createElement('td');
        totalLabelCell.textContent = 'TOTAL';
        totalLabelCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(totalLabelCell);

        // 空白星期欄
        const emptyWeekCell = document.createElement('td');
        emptyWeekCell.textContent = '';
        newTotalRow.appendChild(emptyWeekCell);

        // 總曝光數
        const totalImpCell = document.createElement('td');
        totalImpCell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
        totalImpCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(totalImpCell);

        // 總點擊數
        const totalClkCell = document.createElement('td');
        totalClkCell.textContent = totalClk > 0 ? totalClk : '';
        totalClkCell.style.fontWeight = 'bold';
        newTotalRow.appendChild(totalClkCell);

        // 總點擊率
        const totalCtrCell = document.createElement('td');
        totalCtrCell.textContent = totalCtr;
        totalCtrCell.style.fontWeight = 'bold';
        totalCtrCell.style.color = '#dc3545';
        newTotalRow.appendChild(totalCtrCell);

        // 總 Cut 數據
        for (let i = 0; i < maxCuts; i++) {
            const totalCutCell = document.createElement('td');
            totalCutCell.textContent = totalCutTotals[i] > 0 ? totalCutTotals[i] : '';
            totalCutCell.style.fontWeight = 'bold';
            totalCutCell.style.backgroundColor = '#fff3cd';
            newTotalRow.appendChild(totalCutCell);
        }

        // 總文案
        const totalTextCell = document.createElement('td');
        totalTextCell.textContent = totalTextClicks > 0 ? totalTextClicks : '';
        totalTextCell.style.fontWeight = 'bold';
        totalTextCell.style.backgroundColor = '#d1ecf1';
        newTotalRow.appendChild(totalTextCell);

        newTable.appendChild(newTotalRow);

        return newTable;
    }

    // 格式化日期用於 cut 數據查詢
    function formatDateForCutData(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // 添加報表訊息
    function addReportMessages(container, campaignEndDate, currentDate) {
        // 添加成功訊息
        const successMsg = document.createElement('div');
        successMsg.className = 'cookie-status cookie-success';
        successMsg.innerHTML = `✓ 每日報表載入成功！${isSlideAd ? ' (含 Cut 分析數據)' : ''}`;
        container.insertBefore(successMsg, container.firstChild);
        
        // 顯示 AdUnit 統計資訊
        if (Object.keys(allAdunitReports).length > 0) {
            const adunitMsg = document.createElement('div');
            adunitMsg.className = 'cookie-status';
            adunitMsg.style.backgroundColor = '#e8f5e8';
            adunitMsg.style.borderColor = '#4caf50';
            adunitMsg.style.color = '#2e7d32';
            
            const totalAdunits = Object.keys(allAdunitReports).length;
            const successfulAdunits = Object.values(allAdunitReports).filter(report => report.success).length;
            const failedAdunits = totalAdunits - successfulAdunits;
            
            // 按 AdSet 分組顯示
            let adunitBreakdown = '';
            for (const [adsetId, adsetData] of Object.entries(adunitByAdset)) {
                const adsetAdunits = adsetData.adunits.length;
                const adsetSuccess = adsetData.adunits.filter(unit => unit.success).length;
                adunitBreakdown += `\n  • ${adsetData.adsetName}: ${adsetSuccess}/${adsetAdunits} 個 AdUnit`;
            }
            
            // 檢查是否有效能資訊
            let performanceInfo = '';
            if (window.adunitQuerySummary) {
                const summary = window.adunitQuerySummary;
                performanceInfo = ` | ⚡ 並行查詢耗時: ${summary.query_duration}秒 (${summary.max_workers} 執行緒)`;
            }
            
            adunitMsg.innerHTML = `🎯 AdUnit 報表統計：成功查詢 ${successfulAdunits}/${totalAdunits} 個 AdUnit${performanceInfo}${adunitBreakdown}`;
            container.insertBefore(adunitMsg, container.firstChild);
        }
        
        // 顯示 slide 廣告資訊
        if (isSlideAd && Object.keys(currentCutData).length > 0) {
            const slideMsg = document.createElement('div');
            slideMsg.className = 'cookie-status';
            slideMsg.style.backgroundColor = '#e1f5fe';
            slideMsg.style.borderColor = '#29b6f6';
            slideMsg.style.color = '#01579b';
            
            const adunitCount = Object.keys(currentCutData).length;
            const adunitNames = Object.values(currentCutData).map(item => 
                item.adunit.title || item.adunit.name || 'Untitled'
            ).join(', ');
            
            slideMsg.innerHTML = `🎬 Slide 廣告資訊：找到 ${adunitCount} 個 AdUnit<br>AdUnit 名稱：${adunitNames}`;
            container.insertBefore(slideMsg, container.firstChild);
        }
        
        // 顯示查詢時間範圍資訊
        const useCustomTime = document.getElementById('useCustomTime').checked;
        if (useCustomTime) {
            const customStartDate = document.getElementById('customStartDate').value;
            const customEndDate = document.getElementById('customEndDate').value;
            
            if (customStartDate && customEndDate) {
                const timeRangeMsg = document.createElement('div');
                timeRangeMsg.className = 'cookie-status';
                timeRangeMsg.style.backgroundColor = '#e8f4fd';
                timeRangeMsg.style.borderColor = '#42a5f5';
                timeRangeMsg.style.color = '#1565c0';
                timeRangeMsg.innerHTML = `🕒 使用自訂時間區段：${customStartDate} ~ ${customEndDate}（用戶手動設定）`;
                container.insertBefore(timeRangeMsg, container.firstChild);
            }
        }
        
        // 顯示走期資訊（強調是自動從 Campaign 取得）
        if (campaignEndDate && currentDate) {
            const scheduleMsg = document.createElement('div');
            scheduleMsg.className = 'cookie-status';
            scheduleMsg.style.backgroundColor = '#fff3cd';
            scheduleMsg.style.borderColor = '#ffeaa7';
            scheduleMsg.style.color = '#856404';
            scheduleMsg.innerHTML = `📅 走期設定：結束日期 ${campaignEndDate}（自動從 Campaign.toTime 取得），當前日期 ${currentDate}`;
            container.insertBefore(scheduleMsg, container.firstChild);
        } else if (campaignEndDate) {
            // 只有走期結束日期，沒有當前日期
            const scheduleMsg = document.createElement('div');
            scheduleMsg.className = 'cookie-status';
            scheduleMsg.style.backgroundColor = '#fff3cd';
            scheduleMsg.style.borderColor = '#ffeaa7';
            scheduleMsg.style.color = '#856404';
            scheduleMsg.innerHTML = `📅 走期設定：結束日期 ${campaignEndDate}（自動從 Campaign.toTime 取得）`;
            container.insertBefore(scheduleMsg, container.firstChild);
        }
        
        // 顯示廣告集資訊
        if (currentAdsetInfo && currentAdsetInfo.success) {
            const adsetInfoMsg = document.createElement('div');
            adsetInfoMsg.className = 'cookie-status';
            adsetInfoMsg.style.backgroundColor = '#e8f5e8';
            adsetInfoMsg.style.borderColor = '#4caf50';
            adsetInfoMsg.style.color = '#2e7d32';
            const pricing = currentAdsetInfo.pricing;
            const info = currentAdsetInfo.info;
            const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
            
            // 顯示預算解析資訊
            let budgetInfo = '';
            if (info.campaignBudget !== undefined) {
                budgetInfo = `${currency}${info.campaignBudget.toLocaleString()} (從 Campaign 取得)`;
            } else if (info.parsedBudget > 0) {
                budgetInfo = `${currency}${info.parsedBudget.toLocaleString()} (從活動名稱解析)`;
            } else {
                budgetInfo = `${currency}${info.budget.toLocaleString()} (原始預算)`;
            }
            
            // 顯示時間戳資訊
            let timestampInfo = '';
            if (info.fromTimestamp && info.toTimestamp) {
                const fromDate = new Date(info.fromTimestamp).toLocaleDateString('zh-TW');
                const toDate = new Date(info.toTimestamp).toLocaleDateString('zh-TW');
                timestampInfo = ` | 📅 走期：${fromDate} ~ ${toDate}`;
            }
            
            // 檢查計價方式來源
            let pricingSource = '';
            if (info.adsets) {
                const nonDemoAdsets = info.adsets.filter(adset => !adset.isDemo);
                const demoAdsets = info.adsets.filter(adset => adset.isDemo);
                
                console.log(`💰 計價方式分析 - 廣告活動: ${document.getElementById('campaignId').value}`);
                console.log(`  非 demo AdSet (${nonDemoAdsets.length} 個):`);
                nonDemoAdsets.forEach(adset => {
                    console.log(`    - ${adset.name}: ${adset.pricing.bMode} $${adset.pricing.price}`);
                });
                console.log(`  Demo AdSet (${demoAdsets.length} 個):`);
                demoAdsets.forEach(adset => {
                    console.log(`    - ${adset.name}: ${adset.pricing.bMode} $${adset.pricing.price}`);
                });
                console.log(`  最終選擇: ${pricing.bMode} $${pricing.price}`);
                
                if (nonDemoAdsets.length > 0) {
                    const primaryAdset = nonDemoAdsets.find(adset => 
                        adset.pricing.bMode === pricing.bMode && adset.pricing.price === pricing.price
                    );
                    if (primaryAdset) {
                        pricingSource = ` (來自: ${primaryAdset.name.slice(0, 20)}...)`;
                        console.log(`  ✅ 計價來源: 非 demo AdSet "${primaryAdset.name}"`);
                    } else {
                        pricingSource = ` (來自非 demo 廣告集)`;
                        console.log(`  ✅ 計價來源: 某個非 demo AdSet`);
                    }
                } else if (demoAdsets.length > 0) {
                    pricingSource = ` (⚠️ 僅有 demo 廣告集)`;
                    console.log(`  ⚠️ 計價來源: 僅有 demo AdSet 可用`);
                } else {
                    pricingSource = ` (預設值)`;
                    console.log(`  🔧 計價來源: 系統預設值`);
                }
            }
            
            adsetInfoMsg.innerHTML = `
                📊 廣告集資訊：${info.name || '未知活動'} | 
                💰 計價方式：${pricing.bMode} (${currency}${pricing.price})${pricingSource} | 
                🎯 廣告類型：${info.adType || 'NATIVE'} | 
                💵 總預算：${budgetInfo}${timestampInfo}
            `;
            container.insertBefore(adsetInfoMsg, container.firstChild);
        }
        
        // 分析表格結構並顯示
        const table = container.querySelector('table');
        if (table) {
            const tableHeaders = Array.from(table.querySelectorAll('tr')[0].querySelectorAll('th,td')).map(h => h.textContent.trim());
            const structureMsg = document.createElement('div');
            structureMsg.className = 'cookie-status';
            structureMsg.style.backgroundColor = '#e3f2fd';
            structureMsg.style.borderColor = '#2196f3';
            structureMsg.style.color = '#1976d2';
            structureMsg.innerHTML = `📋 檢測到的表格欄位：${tableHeaders.join(' | ')}`;
            container.insertBefore(structureMsg, container.firstChild);
        }
    }

    // 新增：切換 AdSet 選擇狀態
    function toggleAdsetSelection(adsetId) {
        toggleAdsetCollapse(adsetId);
    }
    
    // 新增：切換 AdUnit 選擇狀態
    function toggleAdunitSelection(adunitUuid) {
        toggleAdunitCollapse(adunitUuid);
    }
    
    // 新增：重新顯示個別報表
    function refreshIndividualReports() {
        const container = document.getElementById('dailyReportContainer');
        
        // 保留現有的訊息和總合報表，只更新個別報表部分
        const reports = container.querySelectorAll('.daily-report-section');
        
        // 找到個別報表區域並替換
        for (let report of reports) {
            const title = report.querySelector('h4');
            if (title && title.textContent.includes('個別廣告集報表')) {
                const newReportContent = displayIndividualAdsetReports();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newReportContent;
                report.replaceWith(tempDiv.firstElementChild);
                
                // 重新綁定重新生成按鈕事件
                const refreshBtn = document.getElementById('refreshReportBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', regenerateMergedReport);
                }
                break;
            }
        }
    }
    
    // 新增：重新生成總合報表
    function regenerateMergedReport() {
        const container = document.getElementById('dailyReportContainer');
        
        // 重新生成合併報表
        const mergedTable = mergeAllAdsetReports();
        if (mergedTable) {
            // 處理 slide 廣告和走期
            let finalTable = mergedTable;
            if (isSlideAd && Object.keys(currentCutData).length > 0) {
                finalTable = buildSlideReportTable(mergedTable, currentCutData);
            }
            
            const campaignEndDate = currentReportData.campaignEndDate;
            const currentDate = currentReportData.currentDate;
            if (campaignEndDate && currentDate) {
                finalTable = processTableBySchedule(finalTable, campaignEndDate, currentDate);
            }
            
            // 更新總合報表區域
            const reports = container.querySelectorAll('.daily-report-section');
            for (let report of reports) {
                const title = report.querySelector('h4');
                if (title && title.textContent.includes('總合報表數據')) {
                    const newContent = `
                        <h4>📈 總合報表數據${isSlideAd ? '（含 Cut 分析數據）' : ''}</h4>
                        ${finalTable.outerHTML}
                    `;
                    report.innerHTML = newContent;
                    
                    // 美化表格
                    const table = report.querySelector('table');
                    if (table) {
                        table.className = 'report-table';
                    }
                    break;
                }
            }
            
            // 更新報表資料
            currentReportData.table = finalTable;
            
            // 顯示成功訊息
            const selectedAdsetCount = selectedAdsets.size;
            const selectedAdunitCount = selectedAdunits.size;
            alert(`✅ 總合報表已重新生成！\n已包含 ${selectedAdsetCount} 個 AdSet 和 ${selectedAdunitCount} 個 AdUnit 的數據。`);
        } else {
            alert('❌ 無法生成總合報表，請確保至少選擇一個 AdSet。');
        }
    }
});

// 全域緩存管理函數
function clearCurrentCampaignCache() {
    const campaignId = document.getElementById('campaignId').value.trim();
    if (!campaignId) {
        alert('請先輸入廣告活動 ID');
        return;
    }
    
    const CACHE_PREFIX = 'adCampaignCache_';
    
    try {
        // 清除基本資訊緩存
        const basicCacheKey = `${CACHE_PREFIX}basic_${campaignId}`;
        localStorage.removeItem(basicCacheKey);
        
        // 清除所有相關的報表緩存
        const keys = Object.keys(localStorage);
        let clearedCount = 0;
        
        keys.forEach(key => {
            if (key.startsWith(CACHE_PREFIX) && key.includes(campaignId)) {
                localStorage.removeItem(key);
                clearedCount++;
                console.log(`🗑️ 已清除緩存: ${key}`);
            }
        });
        
        alert(`✅ 已清除該廣告活動的所有緩存 (共 ${clearedCount} 個)，下次查詢將重新從伺服器獲取數據`);
        
        // 更新緩存狀態顯示
        if (typeof updateCacheStatus === 'function') {
            updateCacheStatus();
        }
    } catch (error) {
        alert('❌ 清除緩存失敗: ' + error.message);
    }
}

// 在 DOMContentLoaded 外部定義全域函數，供按鈕點擊事件使用
function toggleAdsetCollapse(adsetId) {
    const contentDiv = document.getElementById(`adset-content-${adsetId}`);
    const adunitSection = document.getElementById(`adunit-section-${adsetId}`);
    const button = event.target;
    
    // 更新全域的 selectedAdsets
    if (window.selectedAdsets && window.selectedAdsets.has(adsetId)) {
        // 當前是展開狀態，要收合
        window.selectedAdsets.delete(adsetId);
        contentDiv.style.display = 'none';
        if (adunitSection) adunitSection.style.display = 'none';
        button.textContent = '➕';
        button.style.background = '#6c757d';
    } else {
        // 當前是收合狀態，要展開
        if (!window.selectedAdsets) window.selectedAdsets = new Set();
        window.selectedAdsets.add(adsetId);
        contentDiv.style.display = 'block';
        if (adunitSection) adunitSection.style.display = 'block';
        button.textContent = '➖';
        button.style.background = '#28a745';
    }
}

function toggleAdunitCollapse(adunitUuid) {
    const contentDiv = document.getElementById(`adunit-content-${adunitUuid}`);
    const button = event.target;
    
    // 更新全域的 selectedAdunits
    if (window.selectedAdunits && window.selectedAdunits.has(adunitUuid)) {
        // 當前是展開狀態，要收合
        window.selectedAdunits.delete(adunitUuid);
        contentDiv.style.display = 'none';
        button.textContent = '➕';
        button.style.background = '#6c757d';
    } else {
        // 當前是收合狀態，要展開
        if (!window.selectedAdunits) window.selectedAdunits = new Set();
        window.selectedAdunits.add(adunitUuid);
        contentDiv.style.display = 'block';
        button.textContent = '➖';
        button.style.background = '#28a745';
    }
}
</script>
{% endblock %} 