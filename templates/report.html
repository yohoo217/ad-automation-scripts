{% extends "base.html" %}

{% block title %}å»£å‘Šå ±è¡¨{% endblock %}
{% block page_title %}å»£å‘Šå ±è¡¨{% endblock %}

{% block additional_styles %}
<!-- æ·»åŠ  SheetJS åº« -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    .report-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .input-section {
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #f8faff 0%, #f1f5ff 100%);
        border-radius: 12px;
        border: 1px solid #e0e6ed;
    }
    
    .report-content {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .report-content iframe {
        width: 100%;
        height: 100%;
        border: none;
        min-height: 500px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error {
        color: #dc3545;
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
    }
    
    .daily-report-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid #007bff;
    }
    
    .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .report-table th,
    .report-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }
    
    .report-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .report-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .cookie-status {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .cookie-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .cookie-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .export-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 10px;
    }
    
    .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }
    
    .export-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div id="cookie-status" class="cookie-status cookie-success">
        âœ“ Cookie å·²è‡ªå‹•è¨­ç½®æˆåŠŸ
    </div>
    
    <div class="input-section">
        <h3>ğŸ“Š å»£å‘Šå ±è¡¨æŸ¥è©¢</h3>
        <div class="form-row">
            <label for="setId">å»£å‘Šé›† ID <span class="required">*</span></label>
            <input type="text" id="setId" name="setId" placeholder="è«‹è¼¸å…¥å»£å‘Šé›† IDï¼Œä¾‹å¦‚ï¼š82000801-b829-4812-aefb-eae6a9b27040" required>
            <div class="help-text">è¼¸å…¥æ‚¨è¦æŸ¥è©¢çš„å»£å‘Šé›† ID</div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="sinceDate">é–‹å§‹æ—¥æœŸ (timestamp)</label>
                <input type="number" id="sinceDate" name="sinceDate" value="1746028740000" placeholder="æ¯«ç§’æ™‚é–“æˆ³">
                <div class="help-text">é è¨­ç‚ºç•¶å‰æ™‚é–“å‰30å¤©</div>
            </div>
            
            <div class="form-row">
                <label for="toDate">çµæŸæ—¥æœŸ (timestamp)</label>
                <input type="number" id="toDate" name="toDate" value="1748534340000" placeholder="æ¯«ç§’æ™‚é–“æˆ³">
                <div class="help-text">é è¨­ç‚ºç•¶å‰æ™‚é–“</div>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="form-row">
                <label for="campaignEndDate">ğŸ“… èµ°æœŸçµæŸæ—¥æœŸ</label>
                <input type="date" id="campaignEndDate" name="campaignEndDate" placeholder="é¸æ“‡èµ°æœŸçµæŸæ—¥æœŸ">
                <div class="help-text">ç”¨æ–¼åˆ¤æ–·å“ªäº›æ—¥æœŸæ‡‰è©²é¡¯ç¤ºç©ºç™½ï¼ˆæœªåˆ°æœŸï¼‰</div>
            </div>
            
            <div class="form-row">
                <label for="currentDate">ğŸ“… ç•¶å‰æ—¥æœŸï¼ˆç”¨æ–¼æ¯”è¼ƒï¼‰</label>
                <input type="date" id="currentDate" name="currentDate" placeholder="ç•¶å‰æ—¥æœŸ">
                <div class="help-text">ç”¨æ–¼åˆ¤æ–·å“ªäº›æ—¥æœŸå·²ç¶“éæœŸï¼Œé è¨­ç‚ºä»Šå¤©</div>
            </div>
        </div>
        
        <button type="button" id="fetchReport" class="button">ğŸ“ˆ å–å¾—å ±è¡¨</button>
        <button type="button" id="resetDates" class="button nav-button">ğŸ”„ é‡ç½®ç‚ºé è¨­æ—¥æœŸ</button>
        <button type="button" id="exportExcel" class="export-button" disabled>ğŸ“Š ç”¢å‡º XLSX å ±è¡¨</button>
    </div>
    
    <div id="reportContent" class="report-content" style="display: none;">
        <h3>ğŸ“ˆ æ¯æ—¥å ±è¡¨</h3>
        <div id="dailyReportContainer">
            <!-- å ±è¡¨å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
    </div>
    
    <div id="loadingMessage" class="loading" style="display: none;">
        <p>ğŸ“Š æ­£åœ¨è¼‰å…¥å ±è¡¨è³‡æ–™...</p>
        <div style="margin-top: 10px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #667eea; animation: spin 1s linear infinite;"></div>
        </div>
    </div>
    
    <div id="errorMessage" class="error" style="display: none;">
        <!-- éŒ¯èª¤è¨Šæ¯å°‡åœ¨é€™è£¡é¡¯ç¤º -->
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block additional_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è‡ªå‹•è¨­ç½® Cookie
    const defaultCookie = "AOTTERBD_SESSION=757418f543a95a889184e798ec5ab66d4fad04e5-lats=1724229220332&sso=PIg4zu/Vdnn/A15vMEimFlVAGliNhoWlVd5FTvtEMRAFpk/VvBGvAetanw8DLATSLexy9pee/t52uNojvoFS2Q==;aotter=eyJ1c2VyIjp7ImlkIjoiNjNkYjRkNDBjOTFiNTUyMmViMjk4YjBkIiwiZW1haWwiOiJpYW4uY2hlbkBhb3R0ZXIubmV0IiwiY3JlYXRlZEF0IjoxNjc1MzE2NTQ0LCJlbWFpbFZlcmlmaWVkIjp0cnVlLCJsZWdhY3lJZCI6bnVsbCwibGVnYWN5U2VxSWQiOjE2NzUzMTY1NDQ3ODI5NzQwMDB9LCJhY2Nlc3NUb2tlbiI6IjJkYjQyZTNkOTM5MDUzMjdmODgyZmYwMDRiZmI4YmEzZjBhNTlmMDQwYzhiN2Y4NGY5MmZmZTIzYTU0ZTQ2MDQiLCJ1ZWEiOm51bGx9; _Secure-1PSID=vlPPgXupFroiSjP1/A02minugZVZDgIG4K; _Secure-1PSIDCC=g.a000mwhavReSVd1vN09AVTswXkPAhyuW7Tgj8-JFhj-FZya9I_l1B6W2gqTIWAtQUTQMkTxoAwACgYKAW0SARISFQHGX2MiC--NJ2PzCzDpJ0m3odxHhxoVAUF8yKr8r49abq8oe4UxCA0t_QCW0076; _Secure-3PSID=AKEyXzUuXI1zywmFmkEBEBHfg6GRkRM9cJ9BiJZxmaR46x5im_krhaPtmL4Jhw8gQsz5uFFkfbc; _Secure-3PSIDCC=sidts-CjEBUFGohzUF6oK3ZMACCk2peoDBDp6djBwJhGc4Lxgu2zOlzbVFeVpXF4q1TYZ5ba6cEAA";
    
    try {
        // è§£æä¸¦è¨­ç½®å„å€‹ cookie
        const cookies = defaultCookie.split(';');
        cookies.forEach(cookie => {
            if (cookie.trim()) {
                document.cookie = cookie.trim() + "; path=/; SameSite=Lax";
            }
        });
        
        document.getElementById('cookie-status').className = 'cookie-status cookie-success';
        document.getElementById('cookie-status').innerHTML = 'âœ“ Cookie å·²è‡ªå‹•è¨­ç½®æˆåŠŸ';
    } catch (error) {
        console.error('è¨­ç½® Cookie æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        document.getElementById('cookie-status').className = 'cookie-status cookie-error';
        document.getElementById('cookie-status').innerHTML = 'âœ— Cookie è¨­ç½®å¤±æ•—: ' + error.message;
    }
    
    // è¨­ç½®é è¨­æ—¥æœŸï¼ˆç•¶å‰æ™‚é–“å‰30å¤©åˆ°ç•¶å‰æ™‚é–“ï¼‰
    function setDefaultDates() {
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        document.getElementById('sinceDate').value = thirtyDaysAgo.getTime();
        document.getElementById('toDate').value = now.getTime();
        
        // è¨­ç½®ç•¶å‰æ—¥æœŸ
        const today = now.toISOString().split('T')[0];
        document.getElementById('currentDate').value = today;
        
        // é è¨­èµ°æœŸçµæŸæ—¥æœŸç‚º7å¤©å¾Œ
        const weekLater = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));
        const weekLaterStr = weekLater.toISOString().split('T')[0];
        document.getElementById('campaignEndDate').value = weekLaterStr;
    }
    
    // é‡ç½®æ—¥æœŸæŒ‰éˆ•
    document.getElementById('resetDates').addEventListener('click', setDefaultDates);
    
    // å–å¾—å ±è¡¨æŒ‰éˆ•
    document.getElementById('fetchReport').addEventListener('click', function() {
        const setId = document.getElementById('setId').value.trim();
        const sinceDate = document.getElementById('sinceDate').value;
        const toDate = document.getElementById('toDate').value;
        
        if (!setId) {
            alert('è«‹è¼¸å…¥å»£å‘Šé›† ID');
            return;
        }
        
        if (!sinceDate || !toDate) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
            return;
        }
        
        fetchReportData(setId, sinceDate, toDate);
    });
    
    // ç”¢å‡º Excel å ±è¡¨æŒ‰éˆ•
    document.getElementById('exportExcel').addEventListener('click', function() {
        exportToExcel();
    });
    
    // å„²å­˜å ±è¡¨è³‡æ–™ä¾›å°å‡ºä½¿ç”¨
    let currentReportData = null;
    let currentAdsetInfo = null; // å„²å­˜å»£å‘Šé›†è³‡è¨Š
    let currentCutData = null; // å„²å­˜ CPM cut æ•¸æ“š
    
    // å–å¾—å ±è¡¨è³‡æ–™
    async function fetchReportData(setId, sinceDate, toDate) {
        const loadingElement = document.getElementById('loadingMessage');
        const reportElement = document.getElementById('reportContent');
        const errorElement = document.getElementById('errorMessage');
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        loadingElement.style.display = 'block';
        reportElement.style.display = 'none';
        errorElement.style.display = 'none';
        
        try {
            // ä¸¦è¡ŒæŸ¥è©¢å ±è¡¨è³‡æ–™å’Œå»£å‘Šé›†è³‡è¨Š
            const [reportResponse, adsetResponse] = await Promise.all([
                // æŸ¥è©¢å ±è¡¨è³‡æ–™
                fetch(`/api/report-proxy?setId=${encodeURIComponent(setId)}&sinceDate=${encodeURIComponent(sinceDate)}&toDate=${encodeURIComponent(toDate)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                }),
                // æŸ¥è©¢å»£å‘Šé›†è³‡è¨Š
                fetch(`/api/adset-info?adsetId=${encodeURIComponent(setId)}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
                })
            ]);
            
            console.log('æ­£åœ¨ç™¼é€è«‹æ±‚åˆ°ä»£ç†è·¯ç”±:', `/api/report-proxy?setId=${encodeURIComponent(setId)}&sinceDate=${encodeURIComponent(sinceDate)}&toDate=${encodeURIComponent(toDate)}`);
            console.log('æ­£åœ¨æŸ¥è©¢å»£å‘Šé›†è³‡è¨Š:', `/api/adset-info?adsetId=${encodeURIComponent(setId)}`);
            
            // è™•ç†å ±è¡¨å›æ‡‰
            if (!reportResponse.ok) {
                throw new Error(`å ±è¡¨è«‹æ±‚å¤±æ•—: HTTP ${reportResponse.status}: ${reportResponse.statusText}`);
            }
            
            const jsonResponse = await reportResponse.json();
            console.log('æ”¶åˆ°ä»£ç†å›æ‡‰:', jsonResponse);
            
            // è™•ç†å»£å‘Šé›†è³‡è¨Šå›æ‡‰
            let adsetInfo = null;
            if (adsetResponse.ok) {
                adsetInfo = await adsetResponse.json();
                console.log('æ”¶åˆ°å»£å‘Šé›†è³‡è¨Š:', adsetInfo);
                currentAdsetInfo = adsetInfo; // å„²å­˜å»£å‘Šé›†è³‡è¨Š
            } else {
                console.warn('æŸ¥è©¢å»£å‘Šé›†è³‡è¨Šå¤±æ•—ï¼Œå°‡ä½¿ç”¨é è¨­å€¼');
                currentAdsetInfo = {
                    success: false,
                    pricing: { bMode: 'CPC', price: 7.0, currency: 'TWD' },
                    info: { name: 'æœªçŸ¥æ´»å‹•', adType: 'åŸç”Ÿäº’å‹•å»£å‘Š', budget: 0 }
                };
            }
            
            // å¦‚æœè¨ˆåƒ¹æ–¹å¼ç‚º CPMï¼ŒæŸ¥è©¢ cut æ•¸æ“š
            if (adsetInfo && adsetInfo.success && adsetInfo.pricing.bMode === 'CPM') {
                console.log('æª¢æ¸¬åˆ° CPM è¨ˆåƒ¹æ–¹å¼ï¼Œæ­£åœ¨æŸ¥è©¢ cut æ•¸æ“š...');
                try {
                    const cutResponse = await fetch(`/api/cpm-cut-data?adsetId=${encodeURIComponent(setId)}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (cutResponse.ok) {
                        const cutData = await cutResponse.json();
                        console.log('æ”¶åˆ° CPM cut æ•¸æ“š:', cutData);
                        currentCutData = cutData.success ? cutData.cutData : null;
                    } else {
                        console.warn('æŸ¥è©¢ CPM cut æ•¸æ“šå¤±æ•—');
                        currentCutData = null;
                    }
                } catch (cutError) {
                    console.error('æŸ¥è©¢ CPM cut æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', cutError);
                    currentCutData = null;
                }
            } else {
                currentCutData = null;
            }
            
            if (jsonResponse.success) {
                const htmlContent = jsonResponse.content;
                console.log('æ”¶åˆ° HTML å…§å®¹ï¼Œé•·åº¦:', htmlContent.length);
                
                // è§£æä¸¦é¡¯ç¤ºæ¯æ—¥å ±è¡¨
                displayDailyReport(htmlContent);
            } else {
                throw new Error(jsonResponse.error || 'ä»£ç†è«‹æ±‚å¤±æ•—');
            }
            
        } catch (error) {
            console.error('å–å¾—å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            errorElement.innerHTML = `
                <h4>âŒ å–å¾—å ±è¡¨å¤±æ•—</h4>
                <p><strong>éŒ¯èª¤è©³æƒ…:</strong> ${error.message}</p>
                <p><strong>å¯èƒ½åŸå› :</strong></p>
                <ul>
                    <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                    <li>å»£å‘Šé›† ID ä¸æ­£ç¢º</li>
                    <li>Cookie å¯èƒ½å·²éæœŸ</li>
                    <li>ä¼ºæœå™¨ä»£ç†æœå‹™ç•°å¸¸</li>
                </ul>
                <p><strong>å»ºè­°è§£æ±ºæ–¹æ³•:</strong></p>
                <ul>
                    <li>ç¢ºèªå»£å‘Šé›† ID æ˜¯å¦æ­£ç¢º</li>
                    <li>æª¢æŸ¥ç¶²è·¯é€£ç·š</li>
                    <li>å˜—è©¦é‡æ–°æ•´ç†é é¢</li>
                    <li>å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯çµ¡æŠ€è¡“æ”¯æ´</li>
                </ul>
            `;
        }
    }
    
    // é¡¯ç¤ºæ¯æ—¥å ±è¡¨
    function displayDailyReport(htmlContent) {
        const loadingElement = document.getElementById('loadingMessage');
        const reportElement = document.getElementById('reportContent');
        const dailyReportContainer = document.getElementById('dailyReportContainer');
        
        // ç²å–èµ°æœŸå’Œç•¶å‰æ—¥æœŸè¨­å®š
        const campaignEndDate = document.getElementById('campaignEndDate').value;
        const currentDate = document.getElementById('currentDate').value;
        
        loadingElement.style.display = 'none';
        
        try {
            // å‰µå»ºè‡¨æ™‚ DOM ä¾†è§£æ HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // å°ˆé–€æŸ¥æ‰¾æ¯æ—¥å ±è¡¨çš„è¡¨æ ¼
            let dailyReportTable = null;
            
            // æŸ¥æ‰¾åŒ…å«"æ¯æ—¥å ±è¡¨"æ–‡å­—çš„å…ƒç´ 
            const allElements = doc.querySelectorAll('*');
            let dailyReportSection = null;
            
            for (let element of allElements) {
                if (element.textContent && element.textContent.includes('æ¯æ—¥å ±è¡¨')) {
                    dailyReportSection = element;
                    break;
                }
            }
            
            if (dailyReportSection) {
                // æ‰¾åˆ°æ¯æ—¥å ±è¡¨æ¨™é¡Œï¼Œå°‹æ‰¾å…¶å¾Œçš„è¡¨æ ¼
                let nextElement = dailyReportSection.nextElementSibling;
                
                // å¾ªç’°æŸ¥æ‰¾è¡¨æ ¼ï¼Œå¯èƒ½éœ€è¦è·¨è¶Šä¸€äº› div å®¹å™¨
                while (nextElement) {
                    if (nextElement.tagName === 'TABLE') {
                        dailyReportTable = nextElement;
                        break;
                    } else if (nextElement.tagName === 'DIV') {
                        // åœ¨ div å®¹å™¨å…§æŸ¥æ‰¾è¡¨æ ¼
                        const tableInDiv = nextElement.querySelector('table');
                        if (tableInDiv) {
                            dailyReportTable = tableInDiv;
                            break;
                        }
                    }
                    nextElement = nextElement.nextElementSibling;
                }
            }
            
            if (dailyReportTable) {
                // è™•ç†è¡¨æ ¼å…§å®¹ï¼Œæ ¹æ“šèµ°æœŸè¨­å®šèª¿æ•´é¡¯ç¤º
                if (campaignEndDate && currentDate) {
                    dailyReportTable = processTableBySchedule(dailyReportTable, campaignEndDate, currentDate);
                }
                
                // æ‰¾åˆ°æ¯æ—¥å ±è¡¨è¡¨æ ¼ï¼Œåªé¡¯ç¤ºé€™å€‹è¡¨æ ¼
                let dailyReportContent = `
                    <div class="daily-report-section">
                        <h4>ğŸ“Š æ¯æ—¥å ±è¡¨æ•¸æ“š</h4>
                        ${dailyReportTable.outerHTML}
                    </div>
                `;
                
                dailyReportContainer.innerHTML = dailyReportContent;
                
                // ç¾åŒ–è¡¨æ ¼
                const table = dailyReportContainer.querySelector('table');
                if (table) {
                    table.className = 'report-table';
                }
                
                reportElement.style.display = 'block';
                
                // æ·»åŠ æˆåŠŸè¨Šæ¯
                const successMsg = document.createElement('div');
                successMsg.className = 'cookie-status cookie-success';
                successMsg.innerHTML = 'âœ“ æ¯æ—¥å ±è¡¨è¼‰å…¥æˆåŠŸï¼';
                dailyReportContainer.insertBefore(successMsg, dailyReportContainer.firstChild);
                
                // é¡¯ç¤ºèµ°æœŸè³‡è¨Š
                if (campaignEndDate && currentDate) {
                    const scheduleMsg = document.createElement('div');
                    scheduleMsg.className = 'cookie-status';
                    scheduleMsg.style.backgroundColor = '#fff3cd';
                    scheduleMsg.style.borderColor = '#ffeaa7';
                    scheduleMsg.style.color = '#856404';
                    scheduleMsg.innerHTML = `ğŸ“… èµ°æœŸè¨­å®šï¼šçµæŸæ—¥æœŸ ${campaignEndDate}ï¼Œç•¶å‰æ—¥æœŸ ${currentDate}`;
                    dailyReportContainer.insertBefore(scheduleMsg, dailyReportContainer.firstChild);
                }
                
                // é¡¯ç¤ºå»£å‘Šé›†è³‡è¨Š
                if (currentAdsetInfo && currentAdsetInfo.success) {
                    const adsetInfoMsg = document.createElement('div');
                    adsetInfoMsg.className = 'cookie-status';
                    adsetInfoMsg.style.backgroundColor = '#e8f5e8';
                    adsetInfoMsg.style.borderColor = '#4caf50';
                    adsetInfoMsg.style.color = '#2e7d32';
                    const pricing = currentAdsetInfo.pricing;
                    const info = currentAdsetInfo.info;
                    const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
                    
                    // é¡¯ç¤ºé ç®—è§£æè³‡è¨Š
                    let budgetInfo = `${currency}${info.budget.toLocaleString()}`;
                    if (info.parsedBudget > 0) {
                        budgetInfo += ` (å¾æ´»å‹•åç¨±è§£æ: ${currency}${info.parsedBudget.toLocaleString()})`;
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ cut æ•¸æ“š
                    let cutDataInfo = '';
                    if (pricing.bMode === 'CPM') {
                        if (currentCutData && Object.keys(currentCutData).length > 0) {
                            const cutKeys = Object.keys(currentCutData).sort();
                            cutDataInfo = ` | ğŸ“Š Cut æ•¸æ“šï¼šå·²è¼‰å…¥ (${cutKeys.join(', ')})`;
                        } else {
                            cutDataInfo = ` | âš ï¸ Cut æ•¸æ“šï¼šæœªæ‰¾åˆ°å°æ‡‰çš„ AdUnit æˆ–æ•¸æ“š`;
                        }
                    }
                    
                    adsetInfoMsg.innerHTML = `
                        ğŸ“Š å»£å‘Šé›†è³‡è¨Šï¼š${info.name || 'æœªçŸ¥æ´»å‹•'} | 
                        ğŸ’° è¨ˆåƒ¹æ–¹å¼ï¼š${pricing.bMode} (${currency}${pricing.price}) | 
                        ğŸ¯ å»£å‘Šé¡å‹ï¼š${info.adType || 'NATIVE'} | 
                        ğŸ’µ ç¸½é ç®—ï¼š${budgetInfo}${cutDataInfo}
                    `;
                    dailyReportContainer.insertBefore(adsetInfoMsg, dailyReportContainer.firstChild);
                }
                
                // åˆ†æè¡¨æ ¼çµæ§‹ä¸¦é¡¯ç¤º
                const tableHeaders = Array.from(dailyReportTable.querySelectorAll('tr')[0].querySelectorAll('th,td')).map(h => h.textContent.trim());
                const structureMsg = document.createElement('div');
                structureMsg.className = 'cookie-status';
                structureMsg.style.backgroundColor = '#e3f2fd';
                structureMsg.style.borderColor = '#2196f3';
                structureMsg.style.color = '#1976d2';
                structureMsg.innerHTML = `ğŸ“‹ æª¢æ¸¬åˆ°çš„è¡¨æ ¼æ¬„ä½ï¼š${tableHeaders.join(' | ')}`;
                dailyReportContainer.insertBefore(structureMsg, dailyReportContainer.firstChild);
                
                // å•Ÿç”¨å°å‡ºæŒ‰éˆ•ä¸¦å„²å­˜å ±è¡¨è³‡æ–™
                enableExportButton();
                currentReportData = {
                    setId: document.getElementById('setId').value.trim(),
                    sinceDate: document.getElementById('sinceDate').value,
                    toDate: document.getElementById('toDate').value,
                    campaignEndDate: campaignEndDate,
                    currentDate: currentDate,
                    table: dailyReportTable
                };
            } else {
                // å¦‚æœæ²’æ‰¾åˆ°æ¯æ—¥å ±è¡¨è¡¨æ ¼ï¼Œå˜—è©¦é€šéè¡¨æ ¼å…§å®¹ä¾†è­˜åˆ¥
                const tables = doc.querySelectorAll('table');
                let foundDailyTable = null;
                
                for (let table of tables) {
                    const tableText = table.textContent || '';
                    // æª¢æŸ¥è¡¨æ ¼æ˜¯å¦åŒ…å«æ—¥æœŸæ ¼å¼çš„å…§å®¹ï¼ˆYYYY-MM-DDï¼‰
                    if (tableText.includes('æ’­æ”¾æ•¸') || tableText.includes('è§€çœ‹æ•¸') || 
                        tableText.includes('é»æ“Šæ•¸') || tableText.includes('è§€çœ‹ç‡') ||
                        tableText.includes('æ›å…‰æ•¸') || tableText.includes('é»æ“Šç‡') ||
                        /\d{4}-\d{2}-\d{2}/.test(tableText)) {
                        foundDailyTable = table;
                        break;
                    }
                }
                
                if (foundDailyTable) {
                    // è™•ç†è¡¨æ ¼å…§å®¹ï¼Œæ ¹æ“šèµ°æœŸè¨­å®šèª¿æ•´é¡¯ç¤º
                    if (campaignEndDate && currentDate) {
                        foundDailyTable = processTableBySchedule(foundDailyTable, campaignEndDate, currentDate);
                    }
                    
                    let dailyReportContent = `
                        <div class="daily-report-section">
                            <h4>ğŸ“Š æ¯æ—¥å ±è¡¨æ•¸æ“š</h4>
                            ${foundDailyTable.outerHTML}
                        </div>
                    `;
                    
                    dailyReportContainer.innerHTML = dailyReportContent;
                    
                    // ç¾åŒ–è¡¨æ ¼
                    const table = dailyReportContainer.querySelector('table');
                    if (table) {
                        table.className = 'report-table';
                    }
                    
                    reportElement.style.display = 'block';
                    
                    // æ·»åŠ æˆåŠŸè¨Šæ¯
                    const successMsg = document.createElement('div');
                    successMsg.className = 'cookie-status cookie-success';
                    successMsg.innerHTML = 'âœ“ æ¯æ—¥å ±è¡¨è¼‰å…¥æˆåŠŸï¼';
                    dailyReportContainer.insertBefore(successMsg, dailyReportContainer.firstChild);
                    
                    // é¡¯ç¤ºèµ°æœŸè³‡è¨Š
                    if (campaignEndDate && currentDate) {
                        const scheduleMsg = document.createElement('div');
                        scheduleMsg.className = 'cookie-status';
                        scheduleMsg.style.backgroundColor = '#fff3cd';
                        scheduleMsg.style.borderColor = '#ffeaa7';
                        scheduleMsg.style.color = '#856404';
                        scheduleMsg.innerHTML = `ğŸ“… èµ°æœŸè¨­å®šï¼šçµæŸæ—¥æœŸ ${campaignEndDate}ï¼Œç•¶å‰æ—¥æœŸ ${currentDate}`;
                        dailyReportContainer.insertBefore(scheduleMsg, dailyReportContainer.firstChild);
                    }
                    
                    // é¡¯ç¤ºå»£å‘Šé›†è³‡è¨Š
                    if (currentAdsetInfo && currentAdsetInfo.success) {
                        const adsetInfoMsg = document.createElement('div');
                        adsetInfoMsg.className = 'cookie-status';
                        adsetInfoMsg.style.backgroundColor = '#e8f5e8';
                        adsetInfoMsg.style.borderColor = '#4caf50';
                        adsetInfoMsg.style.color = '#2e7d32';
                        const pricing = currentAdsetInfo.pricing;
                        const info = currentAdsetInfo.info;
                        const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
                        
                        // é¡¯ç¤ºé ç®—è§£æè³‡è¨Š
                        let budgetInfo = `${currency}${info.budget.toLocaleString()}`;
                        if (info.parsedBudget > 0) {
                            budgetInfo += ` (å¾æ´»å‹•åç¨±è§£æ: ${currency}${info.parsedBudget.toLocaleString()})`;
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰ cut æ•¸æ“š
                        let cutDataInfo = '';
                        if (pricing.bMode === 'CPM') {
                            if (currentCutData && Object.keys(currentCutData).length > 0) {
                                const cutKeys = Object.keys(currentCutData).sort();
                                cutDataInfo = ` | ğŸ“Š Cut æ•¸æ“šï¼šå·²è¼‰å…¥ (${cutKeys.join(', ')})`;
                            } else {
                                cutDataInfo = ` | âš ï¸ Cut æ•¸æ“šï¼šæœªæ‰¾åˆ°å°æ‡‰çš„ AdUnit æˆ–æ•¸æ“š`;
                            }
                        }
                        
                        adsetInfoMsg.innerHTML = `
                            ğŸ“Š å»£å‘Šé›†è³‡è¨Šï¼š${info.name || 'æœªçŸ¥æ´»å‹•'} | 
                            ğŸ’° è¨ˆåƒ¹æ–¹å¼ï¼š${pricing.bMode} (${currency}${pricing.price}) | 
                            ğŸ¯ å»£å‘Šé¡å‹ï¼š${info.adType || 'NATIVE'} | 
                            ğŸ’µ ç¸½é ç®—ï¼š${budgetInfo}${cutDataInfo}
                        `;
                        dailyReportContainer.insertBefore(adsetInfoMsg, dailyReportContainer.firstChild);
                    }
                    
                    // åˆ†æè¡¨æ ¼çµæ§‹ä¸¦é¡¯ç¤º
                    const tableHeaders = Array.from(foundDailyTable.querySelectorAll('tr')[0].querySelectorAll('th,td')).map(h => h.textContent.trim());
                    const structureMsg = document.createElement('div');
                    structureMsg.className = 'cookie-status';
                    structureMsg.style.backgroundColor = '#e3f2fd';
                    structureMsg.style.borderColor = '#2196f3';
                    structureMsg.style.color = '#1976d2';
                    structureMsg.innerHTML = `ğŸ“‹ æª¢æ¸¬åˆ°çš„è¡¨æ ¼æ¬„ä½ï¼š${tableHeaders.join(' | ')}`;
                    dailyReportContainer.insertBefore(structureMsg, dailyReportContainer.firstChild);
                    
                    // å•Ÿç”¨å°å‡ºæŒ‰éˆ•ä¸¦å„²å­˜å ±è¡¨è³‡æ–™
                    enableExportButton();
                    currentReportData = {
                        setId: document.getElementById('setId').value.trim(),
                        sinceDate: document.getElementById('sinceDate').value,
                        toDate: document.getElementById('toDate').value,
                        campaignEndDate: campaignEndDate,
                        currentDate: currentDate,
                        table: foundDailyTable
                    };
                } else {
                    throw new Error('åœ¨è¿”å›çš„ HTML ä¸­æ‰¾ä¸åˆ°æ¯æ—¥å ±è¡¨è¡¨æ ¼');
                }
            }
            
        } catch (error) {
            console.error('è§£æ HTML å…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            
            // å¦‚æœè§£æå¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            dailyReportContainer.innerHTML = `
                <div class="daily-report-section">
                    <h4>âš ï¸ ç„¡æ³•æ‰¾åˆ°æ¯æ—¥å ±è¡¨</h4>
                    <p style="color: #6c757d;">
                        <strong>éŒ¯èª¤:</strong> ${error.message}
                    </p>
                    <p style="color: #6c757d; font-size: 14px;">
                        å¯èƒ½åŸå› ï¼šå ±è¡¨æ ¼å¼å·²è®Šæ›´æˆ–æ•¸æ“šä¸å®Œæ•´ã€‚è«‹æª¢æŸ¥å»£å‘Šé›† ID æ˜¯å¦æ­£ç¢ºã€‚
                    </p>
                </div>
            `;
            reportElement.style.display = 'block';
        }
    }
    
    // æ ¹æ“šèµ°æœŸè¨­å®šè™•ç†è¡¨æ ¼å…§å®¹
    function processTableBySchedule(table, campaignEndDate, currentDate) {
        const clonedTable = table.cloneNode(true);
        const rows = clonedTable.querySelectorAll('tr');
        
        if (rows.length < 2) return clonedTable; // å¦‚æœæ²’æœ‰æ•¸æ“šè¡Œï¼Œç›´æ¥è¿”å›
        
        // è½‰æ›æ—¥æœŸæ ¼å¼ç”¨æ–¼æ¯”è¼ƒ
        const campaignEnd = new Date(campaignEndDate);
        const current = new Date(currentDate);
        
        // è§£æç¾æœ‰æ•¸æ“š
        const tableData = [];
        const headers = [];
        let totalRow = null;
        
        // ç²å–è¡¨é ­
        const headerCells = rows[0].querySelectorAll('th, td');
        for (let cell of headerCells) {
            headers.push(cell.textContent.trim());
        }
        
        // === æ–°å¢ï¼šè‹¥è¡¨é ­ç¼ºã€Œæ˜ŸæœŸã€ï¼Œæ’å…¥å¾ŒçºŒè‡ªå‹•è£œå€¼ ===
        let needInsertWeekCol = true;
        headers.forEach(h => {
            if (h.includes('æ˜ŸæœŸ') || h.includes('é€±')) needInsertWeekCol = false;
        });
        if (needInsertWeekCol) {
            headers.splice(1, 0, 'æ˜ŸæœŸ'); // æ—¥æœŸå¾Œæ’ä¸€æ¬„
        }
        
        // è§£ææ•¸æ“šè¡Œï¼Œè·³éTOTALè¡Œ
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length > 0) {
                const firstCellText = cells[0].textContent.trim();
                
                if (firstCellText === 'TOTAL') {
                    // ä¿å­˜TOTALè¡Œä¾›å¾ŒçºŒä½¿ç”¨
                    totalRow = row.cloneNode(true);
                    continue;
                }
                
                // å˜—è©¦è§£ææ—¥æœŸæ ¼å¼
                let rowDate = null;
                const dateText = firstCellText;
                
                // æ ¼å¼è§£æé‚è¼¯
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                    rowDate = new Date(dateText);
                } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                    const [month, day] = dateText.split('/');
                    rowDate = new Date(current.getFullYear(), parseInt(month) - 1, parseInt(day));
                } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                    const [month, day] = dateText.split('-');
                    rowDate = new Date(current.getFullYear(), parseInt(month) - 1, parseInt(day));
                }
                
                if (rowDate) {
                    const rowData = [];
                    for (let j = 0; j < cells.length; j++) {
                        rowData.push(cells[j].textContent.trim());
                    }
                    // after rowData push å®Œ
                    if (needInsertWeekCol) {
                        const weekStr = getWeekdayInChinese(rowDate);
                        rowData.splice(1, 0, weekStr); // æŠŠæ˜ŸæœŸå¡«åˆ°ç¬¬ 2 æ ¼
                    }
                    tableData.push({
                        date: rowDate,
                        dateText: dateText,
                        data: rowData,
                        hasData: true
                    });
                }
            }
        }
        
        // ç”Ÿæˆå®Œæ•´çš„æ—¥æœŸç¯„åœï¼ˆå¾æœ€æ—©çš„æ•¸æ“šæ—¥æœŸåˆ°èµ°æœŸçµæŸæ—¥æœŸï¼‰
        let startDate = null;
        let endDate = campaignEnd;
        
        if (tableData.length > 0) {
            // æ‰¾åˆ°æœ€æ—©çš„æ•¸æ“šæ—¥æœŸ
            startDate = new Date(Math.min(...tableData.map(item => item.date.getTime())));
            
            // å¦‚æœæœ‰æ•¸æ“šçš„æœ€å¾Œæ—¥æœŸæ™šæ–¼èµ°æœŸçµæŸæ—¥æœŸï¼Œå‰‡æ“´å±•åˆ°è©²æ—¥æœŸ
            const lastDataDate = new Date(Math.max(...tableData.map(item => item.date.getTime())));
            if (lastDataDate > endDate) {
                endDate = lastDataDate;
            }
        } else {
            // å¦‚æœæ²’æœ‰ç¾æœ‰æ•¸æ“šï¼Œå¾ç•¶å‰æ—¥æœŸé–‹å§‹åˆ°èµ°æœŸçµæŸ
            startDate = current;
        }
        
        // ç”Ÿæˆå®Œæ•´çš„æ—¥æœŸåºåˆ—
        const completeData = [];
        const currentDateIter = new Date(startDate);
        
        while (currentDateIter <= endDate) {
            const dateStr = formatDateToMatch(currentDateIter, tableData.length > 0 ? tableData[0].dateText : null);
            const weekday = getWeekdayInChinese(currentDateIter);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰æ•¸æ“š
            const existingData = tableData.find(item => 
                item.date.getTime() === currentDateIter.getTime()
            );
            
            if (existingData) {
                // ä½¿ç”¨ç¾æœ‰æ•¸æ“š
                completeData.push(existingData);
            } else {
                // å‰µå»ºç©ºç™½è¡Œ
                const emptyRowData = [dateStr, weekday];
                
                // æ ¹æ“šè¡¨é ­æ•¸é‡å¡«å……ç©ºç™½æ¬„ä½
                for (let i = 2; i < headers.length; i++) {
                    emptyRowData.push('');
                }
                
                completeData.push({
                    date: new Date(currentDateIter),
                    dateText: dateStr,
                    data: emptyRowData,
                    hasData: false
                });
            }
            
            // ç§»åˆ°ä¸‹ä¸€å¤©
            currentDateIter.setDate(currentDateIter.getDate() + 1);
        }
        
        // é‡æ–°æ§‹å»ºè¡¨æ ¼
        const newTable = document.createElement('table');
        newTable.className = clonedTable.className;
        
        // æ·»åŠ è¡¨é ­
        const headerRow = document.createElement('tr');
        for (let header of headers) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);
        
        // æ·»åŠ æ•¸æ“šè¡Œ
        for (let item of completeData) {
            const row = document.createElement('tr');
            
            for (let i = 0; i < item.data.length; i++) {
                const cell = document.createElement('td');
                
                if (!item.hasData && i >= 2) {
                    // å°æ–¼ç©ºç™½æ•¸æ“šï¼Œé¡¯ç¤ºç‰¹æ®Šæ¨™è¨˜
                    if (item.date > current) {
                        cell.innerHTML = '<span style="color: #ccc;">â€”</span>';
                        cell.style.backgroundColor = '#f8f9fa';
                    } else if (item.date > campaignEnd) {
                        cell.innerHTML = '<span style="color: #ccc;">â€”</span>';
                        cell.style.backgroundColor = '#fff3cd';
                    } else {
                        cell.innerHTML = '<span style="color: #ccc;">â€”</span>';
                        cell.style.backgroundColor = '#f8f9fa';
                    }
                } else {
                    cell.textContent = item.data[i] || '';
                }
                
                row.appendChild(cell);
            }
            
            // æ·»åŠ æœªåˆ°æœŸçš„è¦–è¦ºæ¨™ç¤º
            if (!item.hasData) {
                if (item.date > current) {
                    row.style.backgroundColor = '#f8f9fa';
                    row.style.opacity = '0.6';
                    row.firstChild.innerHTML += ' <span style="color: #ffc107;"></span>';
                } else if (item.date > campaignEnd) {
                    row.style.backgroundColor = '#fff3cd';
                    row.style.opacity = '0.8';
                    row.firstChild.innerHTML += ' <span style="color: #dc3545;">ğŸ“…</span>';
                }
            }
            
            newTable.appendChild(row);
        }
        
        // æ·»åŠ TOTALè¡Œ
        if (totalRow) {
            newTable.appendChild(totalRow);
        }
        
        return newTable;
    }
    
    // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸä»¥åŒ¹é…ç¾æœ‰æ ¼å¼
    function formatDateToMatch(date, sampleDateText) {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        
        if (!sampleDateText) {
            return `${month}/${day}`;
        }
        
        // æ ¹æ“šæ¨£æœ¬æ ¼å¼æ±ºå®šè¼¸å‡ºæ ¼å¼
        if (sampleDateText.includes('-')) {
            if (sampleDateText.length > 5) {
                // YYYY-MM-DD æ ¼å¼
                return `${date.getFullYear()}-${month}-${day}`;
            } else {
                // MM-DD æ ¼å¼
                return `${month}-${day}`;
            }
        } else {
            // MM/DD æ ¼å¼
            return `${month}/${day}`;
        }
    }
    
    // è¼”åŠ©å‡½æ•¸ï¼šç²å–ä¸­æ–‡æ˜ŸæœŸ
    function getWeekdayInChinese(date) {
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        return weekdays[date.getDay()];
    }
    
    // åˆå§‹åŒ–é è¨­æ—¥æœŸ
    setDefaultDates();
    
    // å•Ÿç”¨å°å‡ºæŒ‰éˆ•
    function enableExportButton() {
        const exportBtn = document.getElementById('exportExcel');
        exportBtn.disabled = false;
    }
    
    // ç”¢å‡º Excel å ±è¡¨
    function exportToExcel() {
        if (!currentReportData) {
            alert('è«‹å…ˆå–å¾—å ±è¡¨è³‡æ–™');
            return;
        }

        try {
            /* === ä¸€ã€çµ„å‡ºå·¥ä½œè¡¨åŸå§‹è³‡æ–™ =========================== */
            const wb = XLSX.utils.book_new();
            const wsData = [];
            
            // å®šç¾© getWeekdayInChinese å‡½æ•¸ï¼ˆåœ¨ Excel å°å‡ºä¸­ä½¿ç”¨ï¼‰
            function getWeekdayInChinese(date) {
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return weekdays[date.getDay()];
            }

            /* 1. Logo å€ï¼ˆB2:E5ï¼‰é ç•™ç©ºç™½ */
            wsData.push(['','','','','','','','','','']); // ç¬¬ 0 åˆ— (Excel ç¬¬1è¡Œ)
            wsData.push(['','','','','','','','','','']); // ç¬¬ 1 åˆ— (Excel ç¬¬2è¡Œ)
            wsData.push(['','','','','','','','','','']); // ç¬¬ 2 åˆ— (Excel ç¬¬3è¡Œ)
            wsData.push(['','','','','','','','','','']); // ç¬¬ 3 åˆ— (Excel ç¬¬4è¡Œ)
            wsData.push(['','','','','','','','','','']); // ç¬¬ 4 åˆ— (Excel ç¬¬5è¡Œ)
            wsData.push(['','','','','','','','','','']); // ç¬¬ 5 åˆ— (Excel ç¬¬6è¡Œ)

            /* 2. å³å´æ´»å‹•æ‘˜è¦ï¼ˆä½¿ç”¨æŸ¥è©¢åˆ°çš„å»£å‘Šé›†è³‡è¨Šï¼‰ */
            const adsetInfo = currentAdsetInfo || {};
            const pricing = adsetInfo.pricing || { bMode: 'CPC', price: 7.0, currency: 'TWD' };
            const info = adsetInfo.info || { name: 'æœªçŸ¥æ´»å‹•', adType: 'åŸç”Ÿäº’å‹•å»£å‘Š', budget: 10000 };
            
            // æ´»å‹•åç¨±ï¼ˆä½¿ç”¨æŸ¥è©¢åˆ°çš„ name æˆ–é è¨­å€¼ï¼‰
            const activityName = info.name || 'è«‹å¡«å…¥æ´»å‹•åç¨±';
            // å»£å‘Šé¡å‹ï¼ˆä½¿ç”¨æŸ¥è©¢åˆ°çš„ adTypeï¼‰
            let adTypeDisplay = info.adType || 'NATIVE';
            if (adTypeDisplay === 'NATIVE') {
                adTypeDisplay = 'åŸç”Ÿäº’å‹•å»£å‘Š';
            }
            // ç¸½é ç®—ï¼ˆå„ªå…ˆä½¿ç”¨å¾æ´»å‹•åç¨±è§£æçš„é ç®—ï¼‰
            const totalBudget = info.parsedBudget > 0 ? info.parsedBudget : (info.budget || 10000);
            // è¨ˆåƒ¹æ–¹å¼å’Œåƒ¹æ ¼ï¼ˆä½¿ç”¨æŸ¥è©¢åˆ°çš„ bMode å’Œå°æ‡‰åƒ¹æ ¼ï¼‰
            const pricingMode = pricing.bMode || 'CPC';
            const pricingPrice = pricing.price || 7.0;
            const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
            
            // èµ°æœŸç›¸é—œè¨ˆç®—
            const campaignEndDate = currentReportData.campaignEndDate;
            const currentDate = currentReportData.currentDate;
            let remainingDays = 0;
            let isOngoing = true;
            
            if (campaignEndDate && currentDate) {
                const endDate = new Date(campaignEndDate);
                const today = new Date(currentDate);
                const timeDiff = endDate.getTime() - today.getTime();
                remainingDays = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                isOngoing = remainingDays > 0;
            }

            wsData[1][3] = 'æ´»å‹•åç¨±'; wsData[1][4] = activityName; wsData[1][6] = 'ç¸½é ç®—'; wsData[1][7] = `${currency}${totalBudget.toLocaleString()}`;

            wsData[2][3] = 'å»£å‘Šé¡å‹'; wsData[2][4] = adTypeDisplay; wsData[2][6] = 'èµ°æœŸé ç®—'; wsData[2][7] = `${currency}${totalBudget.toLocaleString()}`;

            wsData[3][1] = 'å‰©é¤˜å¤©æ•¸'; wsData[3][2] = `(${remainingDays})`; wsData[3][3] = 'è¨ˆåƒ¹æ–¹å¼'; wsData[3][4] = pricingMode; wsData[3][5] = `${currency}${pricingPrice}`; wsData[3][6] = 'å‰©é¤˜èŠ±è²»'; wsData[3][7] = 'è¨ˆç®—ä¸­...';

            // å…ˆè¨­å®šåˆå§‹å€¼ï¼Œå¾Œé¢æœƒé‡æ–°è¨ˆç®—
            wsData[4][1] = 'å‰©é¤˜æ¯æ—¥'; wsData[4][2] = 'è¨ˆç®—ä¸­...'; wsData[4][3] = 'å»£å‘Šç›®æ¨™'; wsData[4][4] = 'è¨ˆç®—ä¸­...'; wsData[4][5] = 'units'; wsData[4][6] = 'å‰©é¤˜æ•¸é‡'; wsData[4][7] = 'è¨ˆç®—ä¸­...';

            /* 3. è¡¨é ­ï¼ˆè—ï¼æ©˜åº•ï¼‰ */
            // æ ¹æ“šè¨ˆåƒ¹æ–¹å¼æ±ºå®š cut æ¬„ä½åç¨±
            let cut1Header = 'cut1';
            let cut2Header = 'cut2';
            
            if (pricingMode === 'CPM') {
                cut1Header = 'cut1';
                cut2Header = 'cut2';
                // å¦‚æœæœ‰ cut æ•¸æ“šï¼Œå¯ä»¥ä½¿ç”¨æ›´å…·é«”çš„åç¨±
                if (currentCutData && Object.keys(currentCutData).length > 0) {
                    const cutKeys = Object.keys(currentCutData).sort();
                    if (cutKeys.includes('1')) cut1Header = 'cut1';
                    if (cutKeys.includes('2')) cut2Header = 'cut2';
                }
            }
            
            wsData.push(['','æ—¥æœŸ','æ˜ŸæœŸ','æ›å…‰æ•¸','é»æ“Šæ•¸','é»æ“Šç‡',cut1Header,cut2Header,'æ–‡æ¡ˆ','']);
            
            /* 4. æ³¨å…¥æ¯æ—¥æ•¸æ“šï¼ˆåŒ…å«ç©ºç™½è¡Œï¼‰ */
            const trs = currentReportData.table.querySelectorAll('tr');
            let sumImp=0,sumClk=0,sumC1=0,sumC2=0,sumTxt=0;

            // å‹•æ…‹è­˜åˆ¥è¡¨æ ¼æ¨™é¡Œçµæ§‹
            const tableHeader = trs[0];
            const headers = Array.from(tableHeader.querySelectorAll('th,td')).map(h => h.textContent.trim());
            
            console.log('è­˜åˆ¥åˆ°çš„è¡¨æ ¼æ¨™é¡Œ:', headers);
            
            // æ‰¾å‡ºå„æ¬„ä½çš„ç´¢å¼•ä½ç½®
            let dateIndex = -1, weekIndex = -1, impIndex = -1, clkIndex = -1, ctrIndex = -1;
            let playIndex = -1, viewIndex = -1, viewRateIndex = -1;
            
            headers.forEach((header, index) => {
                if (header.includes('æ—¥æœŸ')) dateIndex = index;
                else if (header.includes('æ˜ŸæœŸ') || header.includes('é€±')) weekIndex = index;
                else if (header.includes('æ›å…‰æ•¸')) impIndex = index;
                else if (header.includes('é»æ“Šæ•¸')) clkIndex = index;
                else if (header.includes('é»æ“Šç‡')) ctrIndex = index;
                else if (header.includes('æ’­æ”¾æ•¸')) playIndex = index;
                else if (header.includes('è§€çœ‹æ•¸')) viewIndex = index;
                else if (header.includes('è§€çœ‹ç‡')) viewRateIndex = index;
            });
            
            console.log('æ¬„ä½ç´¢å¼•:', {dateIndex, weekIndex, impIndex, clkIndex, ctrIndex, playIndex, viewIndex, viewRateIndex});

            for (let i=1;i<trs.length;i++){
                const td=trs[i].querySelectorAll('td,th');
                if(td.length < 2) continue; // æ¸›å°‘æœ€å°‘åˆ—æ•¸è¦æ±‚
                
                const date = dateIndex >= 0 ? td[dateIndex].textContent.trim() : (td[0] ? td[0].textContent.trim() : '');
                
                // è·³é TOTAL è¡Œï¼ˆåœ¨æœ€å¾Œè™•ç†ï¼‰
                if (date === 'TOTAL') continue;
                
                // æ”¹é€²æ˜ŸæœŸæ¬„ä½å–å¾—
                let wk = '';
                if (weekIndex >= 0 && td[weekIndex]) {
                    wk = td[weekIndex].textContent.trim();
                }
                if (!wk && td[1]) wk = td[1].textContent.trim(); // å¯èƒ½æ˜¯è‡ªå‹•æ’å…¥çš„æ˜ŸæœŸ
                if (!wk && date) {
                    const d = new Date(date.replace(/-/g, '/'));
                    if (!isNaN(d)) wk = getWeekdayInChinese(d);
                }
                
                // åˆ¤æ–·é€™æ˜¯å¦ç‚ºç©ºç™½è¡Œï¼ˆæ²’æœ‰å¯¦éš›æ•¸æ“šï¼‰
                let isEmptyRow = false;
                
                // æª¢æŸ¥æ•¸æ“šæ¬„ä½æ˜¯å¦ç‚ºç©ºç™½æˆ–åŒ…å«ç‰¹æ®Šæ¨™è¨˜
                if (td.length > 2) {
                    const dataCell = td[2]; // ç¬¬ä¸‰æ¬„é€šå¸¸æ˜¯æ•¸æ“šæ¬„ä½
                    const cellContent = dataCell.textContent.trim();
                    const cellHTML = dataCell.innerHTML.trim();
                    
                    // å¦‚æœåŒ…å«æˆ‘å€‘çš„ç©ºç™½æ¨™è¨˜ï¼Œå‰‡è¦–ç‚ºç©ºç™½è¡Œ
                    if (cellHTML.includes('color: #ccc') || cellContent === 'â€”' || cellContent === '') {
                        isEmptyRow = true;
                    }
                }
                
                // æ ¹æ“šä¸åŒçš„è¡¨æ ¼æ ¼å¼è®€å–è³‡æ–™
                let imp = 0, clk = 0, ctr = '';
                
                if (!isEmptyRow) {
                    if (impIndex >= 0 && clkIndex >= 0 && ctrIndex >= 0) {
                        // æ›å…‰æ•¸æ ¼å¼ï¼šæ—¥æœŸã€æ›å…‰æ•¸ã€é»æ“Šæ•¸ã€é»æ“Šç‡
                        imp = +(td[impIndex].textContent.replace(/[,â€”]/g,'')) || 0;
                        clk = +(td[clkIndex].textContent.replace(/[,â€”]/g,'')) || 0;
                        ctr = td[ctrIndex].textContent.trim();
                    } else if (playIndex >= 0 && viewIndex >= 0 && clkIndex >= 0 && viewRateIndex >= 0) {
                        // æ’­æ”¾æ•¸æ ¼å¼ï¼šæ—¥æœŸã€æ’­æ”¾æ•¸ã€è§€çœ‹æ•¸ã€é»æ“Šæ•¸ã€è§€çœ‹ç‡
                        imp = +(td[playIndex].textContent.replace(/[,â€”]/g,'')) || 0;
                        const views = +(td[viewIndex].textContent.replace(/[,â€”]/g,'')) || 0;
                        clk = +(td[clkIndex].textContent.replace(/[,â€”]/g,'')) || 0;
                        ctr = td[viewRateIndex].textContent.trim();
                        
                        console.log(`æ—¥æœŸ ${date}: æ’­æ”¾æ•¸=${imp}, è§€çœ‹æ•¸=${views}, é»æ“Šæ•¸=${clk}`);
                    } else {
                        // å˜—è©¦å¾å‰©é¤˜æ¬„ä½æ¨æ¸¬
                        if (td.length >= 3) {
                            imp = +(td[2].textContent.replace(/[,â€”]/g,'')) || 0;
                            clk = td[3] ? +(td[3].textContent.replace(/[,â€”]/g,'')) || 0 : 0;
                            ctr = td[4] ? td[4].textContent.trim() : '';
                        }
                    }
                }

                // CPM è¨ˆåƒ¹æ–¹å¼ä½¿ç”¨å¯¦éš› cut æ•¸æ“šï¼Œå…¶ä»–è¨ˆåƒ¹æ–¹å¼ä½¿ç”¨è¨ˆç®—å€¼
                let c1 = 0, c2 = 0, txt = 0;
                
                if (!isEmptyRow) {
                    if (pricingMode === 'CPM' && currentCutData) {
                        // ä½¿ç”¨å¯¦éš› cut æ•¸æ“š
                        // è½‰æ›æ—¥æœŸæ ¼å¼ä»¥åŒ¹é… cut æ•¸æ“šçš„æ—¥æœŸæ ¼å¼ (YYYY-MM-DD)
                        let cutDataDate = date;
                        
                        // å¦‚æœæ—¥æœŸæ ¼å¼æ˜¯ MM/DD æˆ– MM-DDï¼Œéœ€è¦è½‰æ›æˆ YYYY-MM-DD
                        if (/^\d{2}[\/\-]\d{2}$/.test(date)) {
                            const currentYear = new Date().getFullYear();
                            const [month, day] = date.split(/[\/\-]/);
                            cutDataDate = `${currentYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        } else if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                            cutDataDate = date;
                        } else {
                            // å˜—è©¦è§£æå…¶ä»–æ ¼å¼
                            const parsedDate = new Date(date);
                            if (!isNaN(parsedDate)) {
                                const year = parsedDate.getFullYear();
                                const month = (parsedDate.getMonth() + 1).toString().padStart(2, '0');
                                const day = parsedDate.getDate().toString().padStart(2, '0');
                                cutDataDate = `${year}-${month}-${day}`;
                            }
                        }
                        
                        // å¾ cut æ•¸æ“šä¸­ç²å–å¯¦éš›æ•¸å€¼
                        c1 = currentCutData['1'] && currentCutData['1'][cutDataDate] ? currentCutData['1'][cutDataDate] : 0;
                        c2 = currentCutData['2'] && currentCutData['2'][cutDataDate] ? currentCutData['2'][cutDataDate] : 0;
                        
                        // å¦‚æœæœ‰æ›´å¤šçš„ cutï¼Œå¯ä»¥ç¹¼çºŒæ·»åŠ 
                        let totalCuts = c1 + c2;
                        
                        // è¨ˆç®—æ–‡æ¡ˆæ¬„ä½ï¼ˆç¸½é»æ“Šæ•¸æ¸›å»æ‰€æœ‰ cutï¼‰
                        txt = Math.max(0, clk - totalCuts);
                        
                        console.log(`æ—¥æœŸ ${cutDataDate}: ä½¿ç”¨å¯¦éš› cut æ•¸æ“š - cut1=${c1}, cut2=${c2}, æ–‡æ¡ˆ=${txt}`);
                    } else {
                        // ä½¿ç”¨åŸä¾†çš„è¨ˆç®—æ–¹å¼
                        c1 = Math.floor(clk * 0.30);
                        c2 = Math.floor(clk * 0.20);
                        txt = clk - c1 - c2;
                    }
                }

                // ç©ºç™½è¡Œçš„é¡¯ç¤ºè™•ç†
                const impDisplay = isEmptyRow ? '' : (imp > 0 ? imp.toLocaleString() : '');
                const clkDisplay = isEmptyRow ? '' : (clk > 0 ? clk : '');
                const ctrDisplay = isEmptyRow ? '' : ctr;
                const c1Display = isEmptyRow ? '' : (c1 > 0 ? c1 : '');
                const c2Display = isEmptyRow ? '' : (c2 > 0 ? c2 : '');
                const txtDisplay = isEmptyRow ? '' : (txt > 0 ? txt : '');

                wsData.push([
                    '', date, wk, impDisplay, clkDisplay, ctrDisplay, c1Display, c2Display, txtDisplay, ''
                ]);

                // åªæœ‰éç©ºç™½è¡Œæ‰åŠ å…¥ç¸½è¨ˆ
                if (!isEmptyRow) {
                    sumImp+=imp;sumClk+=clk;sumC1+=c1;sumC2+=c2;sumTxt+=txt;
                }
            }

            /* 5. TOTAL è¡Œ */
            const totCtr = sumImp?((sumClk/sumImp)*100).toFixed(2)+'%':'0.00%';
            wsData.push(['', 'TOTAL', '', sumImp.toLocaleString(), sumClk, totCtr, sumC1, sumC2, sumTxt, '']);
            
            // === ç¾åœ¨é‡æ–°è¨ˆç®—å‰©é¤˜èŠ±è²»å’Œå»£å‘Šç›®æ¨™ ===
            let targetUnit = 'clicks';
            let targetCount = 0;
            let remainingLabel = 'å‰©é¤˜é»æ“Šæ•¸';
            let remainingAmount = 0;
            let remainingBudget = 0;
            
            if (pricingMode === 'CPM') {
                targetUnit = 'impressions';
                remainingLabel = 'å‰©é¤˜æ›å…‰æ•¸';
                // CPM: (èµ°æœŸé ç®— / è¨ˆåƒ¹æ–¹å¼é‡‘é¡) * 1000
                targetCount = Math.floor((totalBudget / pricingPrice) * 1000);
                // å‰©é¤˜èŠ±è²» = èµ°æœŸé ç®— - [(æ›å…‰æ•¸total * è¨ˆåƒ¹æ–¹å¼é‡‘é¡) / 1000]
                remainingBudget = totalBudget - ((sumImp * pricingPrice) / 1000);
                remainingAmount = Math.floor((remainingBudget / pricingPrice) * 1000);
            } else if (pricingMode === 'CPV') {
                targetUnit = 'views';
                remainingLabel = 'å‰©é¤˜è§€çœ‹æ•¸';
                // CPV: èµ°æœŸé ç®— / è¨ˆåƒ¹æ–¹å¼é‡‘é¡
                targetCount = Math.floor(totalBudget / pricingPrice);
                // å‰©é¤˜èŠ±è²» = èµ°æœŸé ç®— - (è§€çœ‹æ•¸total * è¨ˆåƒ¹æ–¹å¼é‡‘é¡)
                remainingBudget = totalBudget - (sumClk * pricingPrice); // å‡è¨­è§€çœ‹æ•¸ç”¨é»æ“Šæ•¸ä»£æ›¿
                remainingAmount = Math.floor(remainingBudget / pricingPrice);
            } else { // CPC
                targetUnit = 'clicks';
                remainingLabel = 'å‰©é¤˜é»æ“Šæ•¸';
                // CPC: èµ°æœŸé ç®— / è¨ˆåƒ¹æ–¹å¼é‡‘é¡
                targetCount = Math.floor(totalBudget / pricingPrice);
                // å‰©é¤˜èŠ±è²» = èµ°æœŸé ç®— - (é»æ“Šæ•¸total * è¨ˆåƒ¹æ–¹å¼é‡‘é¡)
                remainingBudget = totalBudget - (sumClk * pricingPrice);
                remainingAmount = Math.floor(remainingBudget / pricingPrice);
            }
            
            // æ›´æ–°è¨ˆç®—çµæœ
            wsData[3][7] = isOngoing ? `${currency}${Math.max(0, remainingBudget).toLocaleString()}` : '(å·²çµæŸ)';
            const remainingDailyValue = (remainingDays > 0 && remainingAmount > 0) ? Math.ceil(Math.max(0, remainingAmount) / remainingDays) : 0;

            wsData[4][2] = remainingDailyValue;
            wsData[4][4] = targetCount.toLocaleString();
            wsData[4][5] = targetUnit;
            wsData[4][6] = remainingLabel;
            wsData[4][7] = isOngoing ? Math.max(0, remainingAmount) : '0';
            
            /* === äºŒã€è½‰æˆ Sheet ä¸¦åšé€²éšæ ¼å¼ ======================= */
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            /* 1. æ¬„å¯¬ï¼ˆèˆ‡æˆªåœ–å°ç…§ï¼‰ */
            ws['!cols'] = [
                {wch:4},   // A å¤–æ¡†
                {wch:11},  // B æ—¥æœŸ
                {wch:8},   // C æ˜ŸæœŸ
                {wch:14},  // D æ›å…‰
                {wch:10},  // E é»æ“Š
                {wch:10},  // F CTR
                {wch:10},  // G cut1
                {wch:10},  // H cut2
                {wch:10},  // I æ–‡æ¡ˆ
                {wch:10}   // J ç©ºç™½
            ];

            /* 2. åˆä½µç¯„åœ */
            ws['!merges'] = [
                {s:{r:1,c:1},e:{r:2,c:2}},   // Logo å€åŸŸ B2:D3 (æ›´å°çš„logoç©ºé–“)
                {s:{r:1,c:4},e:{r:1,c:5}},   // æ´»å‹•åç¨± value
                {s:{r:2,c:4},e:{r:2,c:5}},   // å»£å‘Šé¡å‹ value
            ];

            /* 3. å…¨è¡¨é‚Šæ¡† + ç½®ä¸­ */
            const rng = XLSX.utils.decode_range(ws['!ref']);
            for(let R=rng.s.r;R<=rng.e.r;++R){
                for(let C=rng.s.c;C<=rng.e.c;++C){
                    const addr = XLSX.utils.encode_cell({r:R,c:C});
                    ws[addr] = ws[addr]||{t:'s',v:''};
                    ws[addr].s ??= {};
                    ws[addr].s.alignment = {vertical:'middle', horizontal:'center'};
                    ws[addr].s.border = {
                        top:{style:'thin',color:{rgb:'000000'}},
                        bottom:{style:'thin',color:{rgb:'000000'}},
                        left:{style:'thin',color:{rgb:'000000'}},
                        right:{style:'thin',color:{rgb:'000000'}}
                    };
                }
            }

            /* 4. èƒŒæ™¯ / å­—è‰² */
            const paint = (cells,bg,font={})=>cells.forEach(a=>{
                ws[a].s.fill={fgColor:{rgb:bg}}; ws[a].s.font={...(ws[a].s.font||{}),...font};
            });

            // ç°åº•å³å´æ¬„ä½åŠæ¨™ç±¤ç²—é«”
            paint(['E2','F2','G2','H2','E3','F3','G3','H3'],'D9D9D9',{bold:true});
            // å·¦å´æŒ‡æ¨™æ–‡å­—ç²—é«”
            ['A4','A5'].forEach(a=>ws[a].s.font={bold:true});
            // ç´…å­—æ•¸å€¼
            ['B4','I4','I5'].forEach(a=>ws[a].s.font={color:{rgb:'FF0000'},bold:true});
            // è¡¨é ­è—åº• / æ©˜åº•
            const tableHeaderRow = 6; // è¡¨é ­å›ºå®šåœ¨ç¬¬7è¡Œï¼ˆindex 6ï¼‰
            paint([`A${tableHeaderRow+1}`,`B${tableHeaderRow+1}`,`C${tableHeaderRow+1}`,`D${tableHeaderRow+1}`,`E${tableHeaderRow+1}`],'4472C4',{color:{rgb:'FFFFFF'},bold:true});
            paint([`F${tableHeaderRow+1}`,`G${tableHeaderRow+1}`,`H${tableHeaderRow+1}`,`I${tableHeaderRow+1}`],'E67E22',{color:{rgb:'FFFFFF'},bold:true});
            
            // ç‚ºç©ºç™½è¡Œè¨­ç½®ç°è‰²èƒŒæ™¯
            const dataStartRow = 7; // æ•¸æ“šå¾ç¬¬8è¡Œé–‹å§‹ï¼ˆindex 7ï¼‰
            for(let i = dataStartRow; i < wsData.length - 1; i++) { // æ’é™¤TOTALè¡Œ
                const rowData = wsData[i];
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºç™½è¡Œï¼ˆæ•¸æ“šæ¬„ä½ç‚ºç©ºï¼‰
                if (rowData[3] === '' || rowData[4] === '') {
                    // ç‚ºç©ºç™½è¡Œè¨­ç½®ç°è‰²èƒŒæ™¯
                    ['A','B','C','D','E','F','G','H','I','J'].forEach(col => {
                        const addr = `${col}${i+1}`;
                        if (ws[addr]) {
                            ws[addr].s.fill = {fgColor:{rgb:'F8F9FA'}};
                            ws[addr].s.font = {color:{rgb:'999999'}};
                        }
                    });
                }
            }
            
            // TOTAL è¡Œ
            const totalRow = wsData.length; // TOTAL è¡Œæ‰€åœ¨ä½ç½®
            paint([`C${totalRow}`],'FFF2CB',{bold:true}); // æ›å…‰æ•¸é»ƒåº•
            ws[`E${totalRow}`].s.font={color:{rgb:'FF0000'},bold:true}; // é»æ“Šç‡ç´…å­—
            ['A','B','D','F','G','H','J'].forEach(col=>{
                const addr = `${col}${totalRow}`;
                if (ws[addr]) {
                    ws[addr].s.font={...(ws[addr].s.font||{}),bold:true};
                }
            });

            /* === ä¸‰ã€è¼¸å‡ºæª”æ¡ˆ ====================================== */
            XLSX.utils.book_append_sheet(wb,ws,'å»£å‘Šå ±è¡¨');
            const name = `å»£å‘Šå ±è¡¨_${currentReportData.setId.slice(0,8)}_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb,name);
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼ŒåŒ…å«å»£å‘Šé›†è³‡è¨Šå’Œæ—¥æœŸç¯„åœ
            let successMessage = `âœ… Excel å ±è¡¨å·²æˆåŠŸç”¢å‡ºï¼æª”æ¡ˆåç¨±ï¼š${name}`;
            
            // è¨ˆç®—å¯¦éš›æ•¸æ“šè¡Œæ•¸å’Œç©ºç™½è¡Œæ•¸
            const totalDataRows = wsData.length - 7 - 1; // æ¸›å»è¡¨é ­å’ŒTOTALè¡Œ
            const hasDataRows = wsData.slice(7, -1).filter(row => row[3] !== '').length;
            const emptyRows = totalDataRows - hasDataRows;
            
            if (currentAdsetInfo && currentAdsetInfo.success) {
                const budgetSource = info.parsedBudget > 0 ? 'å¾æ´»å‹•åç¨±è§£æ' : 'ä½¿ç”¨åŸå§‹é ç®—';
                const scheduleInfo = remainingDays > 0 ? `å‰©é¤˜ ${remainingDays} å¤©` : 'æ´»å‹•å·²çµæŸ';
                successMessage += `\nğŸ“Š å·²å¥—ç”¨å»£å‘Šé›†è³‡è¨Šï¼š\n- è¨ˆåƒ¹æ–¹å¼ï¼š${pricingMode}\n- åƒ¹æ ¼ï¼š${currency}${pricingPrice}\n- æ´»å‹•åç¨±ï¼š${activityName}\n- é ç®—ï¼š${currency}${totalBudget.toLocaleString()} (${budgetSource})\n- èµ°æœŸç‹€æ…‹ï¼š${scheduleInfo}\nğŸ“… æ—¥æœŸç¯„åœï¼šåŒ…å« ${hasDataRows} ç­†å¯¦éš›æ•¸æ“šï¼Œ${emptyRows} ç­†ç©ºç™½æ—¥æœŸ`;
            }
            alert(successMessage);

        } catch (err) {
            console.error(err);
            alert('âŒ ç”¢å‡º Excel å ±è¡¨å¤±æ•—ï¼š'+err.message);
        }
    }
});
</script>
{% endblock %} 