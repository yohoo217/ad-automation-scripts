{% extends "base.html" %}

{% block title %}å»£å‘Šå ±è¡¨{% endblock %}
{% block page_title %}å»£å‘Šå ±è¡¨{% endblock %}

{% block additional_styles %}
<!-- æ”¹ç”¨ ExcelJS åº« -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>

<style>
    .report-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .input-section {
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #f8faff 0%, #f1f5ff 100%);
        border-radius: 12px;
        border: 1px solid #e0e6ed;
    }
    
    .report-content {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .report-content iframe {
        width: 100%;
        height: 100%;
        border: none;
        min-height: 500px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error {
        color: #dc3545;
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
    }
    
    .daily-report-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid #007bff;
    }
    
    .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .report-table th,
    .report-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }
    
    .report-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .report-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .cookie-status {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .cookie-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .cookie-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .export-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 10px;
    }
    
    .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }
    
    .export-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* æ–°å¢æ¨£å¼ï¼šé¸æ“‡å™¨ç›¸é—œ */
    .selection-section {
        display: none;
        margin-top: 20px;
        padding: 20px;
        background: #f8fff9;
        border-radius: 8px;
        border: 1px solid #28a745;
    }
    
    .selection-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .selection-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .selection-group label {
        font-weight: 600;
        color: #2e7d32;
        font-size: 14px;
    }
    
    .selection-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        background: white;
    }
    
    .selection-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .selection-item:last-child {
        border-bottom: none;
    }
    
    .selection-item input[type="checkbox"] {
        transform: scale(1.1);
    }
    
    .selection-item-label {
        flex: 1;
        font-size: 13px;
        color: #333;
    }
    
    .selection-item-subtitle {
        font-size: 11px;
        color: #666;
        margin-left: 20px;
    }
    
    .batch-settings {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .batch-settings label {
        font-size: 14px;
        color: #495057;
    }
    
    .batch-settings input {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 80px;
    }
    
    .selection-summary {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 6px;
        margin-top: 10px;
        font-size: 13px;
        color: #1976d2;
    }
    
    /* æ–°å¢æ¨£å¼ï¼šè‡ªè¨‚æ™‚é–“å€æ®µ */
    .custom-time-section {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .custom-time-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .time-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .time-input-group label {
        font-weight: 600;
        color: #2e7d32;
        font-size: 14px;
    }
    
    .time-input-group input[type="date"] {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 150px;
    }
    
    .time-help {
        font-size: 12px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div id="cookie-status" class="cookie-status cookie-success">
        âœ“ Cookie å·²è‡ªå‹•è¨­ç½®æˆåŠŸ
    </div>
    
    <div class="input-section">
        <h3>ğŸ“Š å»£å‘Šå ±è¡¨æŸ¥è©¢</h3>
        <div class="form-row">
            <label for="campaignId">å»£å‘Šæ´»å‹• ID <span class="required">*</span></label>
            <input type="text" id="campaignId" name="campaignId" placeholder="è«‹è¼¸å…¥å»£å‘Šæ´»å‹• IDï¼Œä¾‹å¦‚ï¼š02698ef0-faac-4df1-af75-fa2a21674778" required>
            <div class="help-text">è¼¸å…¥æ‚¨è¦æŸ¥è©¢çš„å»£å‘Šæ´»å‹• IDï¼Œç³»çµ±æœƒè‡ªå‹•å–å¾—è©²æ´»å‹•ä¸‹æ‰€æœ‰å»£å‘Šé›†å’Œèµ°æœŸæ™‚é–“</div>
        </div>

        <div class="form-row">
            <label for="isSlideAd">
                <input type="checkbox" id="isSlideAd" name="isSlideAd" style="margin-right: 8px;">
                ğŸ¬ é€™æ˜¯ Slide å»£å‘Šï¼ˆæœƒé¡¯ç¤º cut åˆ†ææ•¸æ“šï¼‰
            </label>
            <div class="help-text">å‹¾é¸æ­¤é …ç›®å°‡æœƒæŸ¥è©¢æ‰€æœ‰ AdUnit ä¸¦é¡¯ç¤ºå„ cut çš„è©³ç´°æ•¸æ“š</div>
        </div>
        
        <!-- ä¿®æ”¹ï¼šæŸ¥è©¢ç­–ç•¥è¨­å®š -->
        <div class="form-row">
            <div class="batch-settings">
                <label for="queryStrategy">AdUnit æŸ¥è©¢ç­–ç•¥ï¼š</label>
                <select id="queryStrategy" name="queryStrategy">
                    <option value="sequential">é€ä¸€æŸ¥è©¢ï¼ˆä¿è­·ç·šä¸Šæœå‹™ï¼Œè¼ƒæ…¢ä½†å®‰å…¨ï¼‰</option>
                    <option value="disabled">åœç”¨ AdUnit æŸ¥è©¢ï¼ˆåªæŸ¥è©¢ AdSet å±¤ç´šï¼‰</option>
                </select>
                <span style="font-size: 12px; color: #666;">ç‚ºäº†ä¸å½±éŸ¿ç·šä¸ŠåŠŸèƒ½ï¼Œå»ºè­°ä½¿ç”¨é€ä¸€æŸ¥è©¢ï¼Œæ¯å€‹ AdUnit é–“æœƒç­‰å¾… 3 ç§’</span>
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šéæ¿¾æç¤º -->
        <div class="form-row">
            <div style="padding: 10px; background: #e8f5e8; border-radius: 6px; border: 1px solid #28a745;">
                <span style="font-size: 12px; color: #2e7d32;">ğŸ“‹ æ³¨æ„ï¼šç³»çµ±æœƒè‡ªå‹•éæ¿¾æ‰åç¨±åŒ…å« "demo" çš„å»£å‘Šé›†</span>
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šç·©å­˜èªªæ˜ -->
        <div class="form-row">
            <div style="padding: 10px; background: #e8f4fd; border-radius: 6px; border: 1px solid #42a5f5;">
                <span style="font-size: 12px; color: #1565c0;">
                    ğŸ¯ æ™ºèƒ½ç·©å­˜ï¼šç›¸åŒæŸ¥è©¢æ¢ä»¶çš„æ•¸æ“šæœƒç·©å­˜ 6 å°æ™‚ï¼Œæå‡æŸ¥è©¢é€Ÿåº¦ä¸¦æ¸›å°‘æœå‹™å™¨è² æ“”
                    <span id="cacheStatus" style="margin-left: 10px;"></span>
                </span>
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šè‡ªè¨‚æ™‚é–“å€æ®µè¨­å®š -->
        <div class="form-row">
            <label for="useCustomTime">
                <input type="checkbox" id="useCustomTime" name="useCustomTime" style="margin-right: 8px;">
                ğŸ•’ ä½¿ç”¨è‡ªè¨‚æ™‚é–“å€æ®µï¼ˆé è¨­è‡ªå‹•å¾ Campaign å–å¾—èµ°æœŸæ™‚é–“ï¼‰
            </label>
            <div class="help-text">å‹¾é¸å¾Œå¯æ‰‹å‹•è¨­å®šæŸ¥è©¢çš„é–‹å§‹å’ŒçµæŸæ™‚é–“ï¼Œå¦å‰‡ä½¿ç”¨æ´»å‹•çš„å®Œæ•´èµ°æœŸæ™‚é–“</div>
        </div>
        
        <!-- æ‘ºç–Šå¼è‡ªè¨‚æ™‚é–“é¸æ“‡å€åŸŸ -->
        <div id="customTimeSection" class="custom-time-section" style="display: none;">
            <div class="custom-time-controls">
                <div class="time-input-group">
                    <label for="customStartDate">é–‹å§‹æ—¥æœŸï¼š</label>
                    <input type="date" id="customStartDate" name="customStartDate">
                </div>
                <div class="time-input-group">
                    <label for="customEndDate">çµæŸæ—¥æœŸï¼š</label>
                    <input type="date" id="customEndDate" name="customEndDate">
                </div>
                <div class="time-help">
                    <span style="font-size: 12px; color: #666;">
                        ğŸ’¡ æç¤ºï¼šæœªå¡«å¯«æ™‚å°‡ä½¿ç”¨æ´»å‹•çš„å®Œæ•´èµ°æœŸæ™‚é–“
                    </span>
                </div>
            </div>
        </div>
        
        <!-- éš±è—çš„è¼¸å…¥æ¡†ï¼Œç”¨æ–¼å„²å­˜å¾ Campaign å–å¾—çš„æ•¸æ“š -->
        <input type="hidden" id="sinceDate" name="sinceDate">
        <input type="hidden" id="toDate" name="toDate">
        <input type="hidden" id="campaignEndDate" name="campaignEndDate">
        <input type="hidden" id="currentDate" name="currentDate">
        
        <button type="button" id="fetchReport" class="button">ğŸ“ˆ å–å¾—å ±è¡¨</button>
        <button type="button" id="exportExcel" class="export-button" disabled>ğŸ“Š ç”¢å‡º XLSX å ±è¡¨</button>
        <button type="button" id="clearAllCaches" class="button" style="background: #6c757d; margin-left: 10px;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç·©å­˜</button>
    </div>
    
    <!-- æ–°å¢ï¼šé¸æ“‡å ±è¡¨å…§å®¹å€åŸŸ -->
    <div id="selectionSection" class="selection-section">
        <h4>ğŸ¯ é¸æ“‡è¦é¡¯ç¤ºçš„å ±è¡¨å…§å®¹</h4>
        <div class="selection-controls">
            <div class="selection-group">
                <label>ğŸ“Š å»£å‘Šé›† (AdSet)</label>
                <div class="selection-list" id="adsetSelectionList">
                    <!-- AdSet é¸é …å°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            <div class="selection-group">
                <label>ğŸ¯ å»£å‘Šå–®å…ƒ (AdUnit)</label>
                <div class="selection-list" id="adunitSelectionList">
                    <!-- AdUnit é¸é …å°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        <div class="selection-controls">
            <button type="button" id="selectAllAdsets" class="button" style="background: #17a2b8;">å…¨é¸ AdSet</button>
            <button type="button" id="deselectAllAdsets" class="button" style="background: #dc3545;">å–æ¶ˆå…¨é¸ AdSet</button>
            <button type="button" id="selectAllAdunits" class="button" style="background: #17a2b8;">å…¨é¸ AdUnit</button>
            <button type="button" id="deselectAllAdunits" class="button" style="background: #dc3545;">å–æ¶ˆå…¨é¸ AdUnit</button>
            <button type="button" id="updateReport" class="button" style="background: #ffc107; color: #000;">ğŸ”„ æ›´æ–°å ±è¡¨é¡¯ç¤º</button>
        </div>
        <div id="selectionSummary" class="selection-summary"></div>
    </div>
    
    <div id="reportContent" class="report-content" style="display: none;">
        <h3>ğŸ“ˆ æ¯æ—¥å ±è¡¨</h3>
        <div id="dailyReportContainer">
            <!-- å ±è¡¨å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
    </div>
    
    <div id="loadingMessage" class="loading" style="display: none;">
        <p>ğŸ“Š æ­£åœ¨è¼‰å…¥å ±è¡¨è³‡æ–™...</p>
        <div style="margin-top: 10px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #667eea; animation: spin 1s linear infinite;"></div>
        </div>
    </div>
    
    <div id="errorMessage" class="error" style="display: none;">
        <!-- éŒ¯èª¤è¨Šæ¯å°‡åœ¨é€™è£¡é¡¯ç¤º -->
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block additional_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è‡ªå‹•è¨­ç½® Cookie
    const defaultCookie = "AOTTERBD_SESSION=757418f543a95a889184e798ec5ab66d4fad04e5-lats=1724229220332&sso=PIg4zu/Vdnn/A15vMEimFlVAGliNhoWlVd5FTvtEMRAFpk/VvBGvAetanw8DLATSLexy9pee/t52uNojvoFS2Q==;aotter=eyJ1c2VyIjp7ImlkIjoiNjNkYjRkNDBjOTFiNTUyMmViMjk4YjBkIiwiZW1haWwiOiJpYW4uY2hlbkBhb3R0ZXIubmV0IiwiY3JlYXRlZEF0IjoxNjc1MzE2NTQ0LCJlbWFpbFZlcmlmaWVkIjp0cnVlLCJsZWdhY3lJZCI6bnVsbCwibGVnYWN5U2VxSWQiOjE2NzUzMTY1NDQ3ODI5NzQwMDB9LCJhY2Nlc3NUb2tlbiI6IjJkYjQyZTNkOTM5MDUzMjdmODgyZmYwMDRiZmI4YmEzZjBhNTlmMDQwYzhiN2Y4NGY5MmZmZTIzYTU0ZTQ2MDQiLCJ1ZWEiOm51bGx9; _Secure-1PSID=vlPPgXupFroiSjP1/A02minugZVZDgIG4K; _Secure-1PSIDCC=g.a000mwhavReSVd1vN09AVTswXkPAhyuW7Tgj8-JFhj-FZya9I_l1B6W2gqTIWAtQUTQMkTxoAwACgYKAW0SARISFQHGX2MiC--NJ2PzCzDpJ0m3odxHhxoVAUF8yKr8r49abq8oe4UxCA0t_QCW0076; _Secure-3PSID=AKEyXzUuXI1zywmFmkEBEBHfg6GRkRM9cJ9BiJZxmaR46x5im_krhaPtmL4Jhw8gQsz5uFFkfbc; _Secure-3PSIDCC=sidts-CjEBUFGohzUF6oK3ZMACCk2peoDBDp6djBwJhGc4Lxgu2zOlzbVFeVpXF4q1TYZ5ba6cEAA";
    
    try {
        // è§£æä¸¦è¨­ç½®å„å€‹ cookie
        const cookies = defaultCookie.split(';');
        cookies.forEach(cookie => {
            if (cookie.trim()) {
                document.cookie = cookie.trim() + "; path=/; SameSite=Lax";
            }
        });
        
        document.getElementById('cookie-status').className = 'cookie-status cookie-success';
        document.getElementById('cookie-status').innerHTML = 'âœ“ Cookie å·²è‡ªå‹•è¨­ç½®æˆåŠŸ';
    } catch (error) {
        console.error('è¨­ç½® Cookie æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        document.getElementById('cookie-status').className = 'cookie-status cookie-error';
        document.getElementById('cookie-status').innerHTML = 'âœ— Cookie è¨­ç½®å¤±æ•—: ' + error.message;
    }
    
    // å–å¾—å ±è¡¨æŒ‰éˆ•
    document.getElementById('fetchReport').addEventListener('click', function() {
        const campaignId = document.getElementById('campaignId').value.trim();
        
        if (!campaignId) {
            alert('è«‹è¼¸å…¥å»£å‘Šæ´»å‹• ID');
            return;
        }
        
        // ä½¿ç”¨é è¨­æ™‚é–“æˆ³ï¼Œå¯¦éš›æœƒå¾ Campaign è‡ªå‹•å–å¾—æ­£ç¢ºçš„æ™‚é–“æˆ³
        const defaultSinceDate = Date.now() - (30 * 24 * 60 * 60 * 1000); // 30å¤©å‰
        const defaultToDate = Date.now(); // ç•¶å‰æ™‚é–“
        
        console.log('é–‹å§‹æŸ¥è©¢å ±è¡¨ï¼ŒCampaign ID:', campaignId);
        fetchReportData(campaignId, defaultSinceDate, defaultToDate);
    });
    
    // ç”¢å‡º Excel å ±è¡¨æŒ‰éˆ•
    document.getElementById('exportExcel').addEventListener('click', function() {
        exportToExcel();
    });
    
    // æ¸…é™¤æ‰€æœ‰ç·©å­˜æŒ‰éˆ•
    document.getElementById('clearAllCaches').addEventListener('click', function() {
        const clearedCount = clearAllCampaignCaches();
        if (clearedCount > 0) {
            alert(`âœ… å·²æ¸…é™¤ ${clearedCount} å€‹å»£å‘Šæ´»å‹•ç·©å­˜`);
            updateCacheStatus(); // æ›´æ–°ç·©å­˜ç‹€æ…‹é¡¯ç¤º
        } else {
            alert('â„¹ï¸ æ²’æœ‰æ‰¾åˆ°éœ€è¦æ¸…é™¤çš„ç·©å­˜');
        }
    });
    
    // æ–°å¢ï¼šé¸æ“‡æ§åˆ¶æŒ‰éˆ•äº‹ä»¶
    document.getElementById('selectAllAdsets').addEventListener('click', function() {
        toggleAllCheckboxes('adsetSelectionList', true);
        updateSelectionSummary();
    });
    
    document.getElementById('deselectAllAdsets').addEventListener('click', function() {
        toggleAllCheckboxes('adsetSelectionList', false);
        updateSelectionSummary();
    });
    
    document.getElementById('selectAllAdunits').addEventListener('click', function() {
        toggleAllCheckboxes('adunitSelectionList', true);
        updateSelectionSummary();
    });
    
    document.getElementById('deselectAllAdunits').addEventListener('click', function() {
        toggleAllCheckboxes('adunitSelectionList', false);
        updateSelectionSummary();
    });
    
    document.getElementById('updateReport').addEventListener('click', function() {
        updateReportDisplay();
    });
    
    // æ–°å¢ï¼šè‡ªè¨‚æ™‚é–“åˆ‡æ›äº‹ä»¶
    document.getElementById('useCustomTime').addEventListener('change', function() {
        const customTimeSection = document.getElementById('customTimeSection');
        if (this.checked) {
            customTimeSection.style.display = 'block';
            // è¨­å®šé è¨­çš„æ—¥æœŸç¯„åœï¼ˆæœ€è¿‘30å¤©ï¼‰
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('customEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('customStartDate').value = startDate.toISOString().split('T')[0];
        } else {
            customTimeSection.style.display = 'none';
        }
    });
    
    // å„²å­˜å ±è¡¨è³‡æ–™ä¾›å°å‡ºä½¿ç”¨
    let currentReportData = null;
    let currentAdsetInfo = null; // å„²å­˜å»£å‘Šé›†è³‡è¨Š
    let currentCutData = {}; // å„²å­˜ cut æ•¸æ“š
    let isSlideAd = false; // æ˜¯å¦ç‚º slide å»£å‘Š
    let allAdsetReports = {}; // å„²å­˜æ‰€æœ‰ AdSet çš„å ±è¡¨æ•¸æ“š
    let allAdunitReports = {}; // å„²å­˜æ‰€æœ‰ AdUnit çš„å ±è¡¨æ•¸æ“š
    let adunitByAdset = {}; // æŒ‰ AdSet åˆ†çµ„çš„ AdUnit å ±è¡¨æ•¸æ“š
    
    // ç·©å­˜ç®¡ç†
    const CACHE_DURATION = 6 * 60 * 60 * 1000; // 6å°æ™‚ï¼ˆæ¯«ç§’ï¼‰
    const CACHE_PREFIX = 'adCampaignCache_';
    
    // æ–°å¢ï¼šé¸æ“‡ç‹€æ…‹
    let selectedAdsets = new Set(); // é¸ä¸­çš„ AdSet ID
    let selectedAdunits = new Set(); // é¸ä¸­çš„ AdUnit UUID
    
    // å°‡é¸æ“‡ç‹€æ…‹è¨­ç‚ºå…¨åŸŸè®Šæ•¸
    window.selectedAdsets = selectedAdsets;
    window.selectedAdunits = selectedAdunits;
    
    // ç·©å­˜ç®¡ç†å‡½æ•¸
    function getCacheKey(campaignId, queryParams) {
        // ç”Ÿæˆç·©å­˜éµï¼ŒåŒ…å«å»£å‘Šæ´»å‹•IDå’ŒæŸ¥è©¢åƒæ•¸
        const key = `${campaignId}_${queryParams.isSlideAd}_${queryParams.queryStrategy}_${queryParams.sinceDate}_${queryParams.toDate}`;
        const cacheKey = CACHE_PREFIX + btoa(key).replace(/[^a-zA-Z0-9]/g, ''); // Base64ç·¨ç¢¼ä¸¦æ¸…ç†ç‰¹æ®Šå­—ç¬¦
        console.log('ğŸ”‘ ç”Ÿæˆç·©å­˜éµå€¼è©³æƒ…:', {
            åŸå§‹éµå€¼: key,
            ç·¨ç¢¼å¾Œ: cacheKey,
            åƒæ•¸: queryParams
        });
        return cacheKey;
    }
    
    function setCampaignCache(cacheKey, data) {
        try {
            const cacheData = {
                timestamp: Date.now(),
                data: data
            };
            localStorage.setItem(cacheKey, JSON.stringify(cacheData));
            console.log(`âœ… ç·©å­˜å·²ä¿å­˜: ${cacheKey}`);
        } catch (error) {
            console.warn('âš ï¸ ç·©å­˜ä¿å­˜å¤±æ•—:', error);
        }
    }
    
    function getCampaignCache(cacheKey) {
        try {
            console.log(`ğŸ” æª¢æŸ¥ç·©å­˜: ${cacheKey}`);
            const cached = localStorage.getItem(cacheKey);
            if (!cached) {
                console.log(`âŒ æœªæ‰¾åˆ°ç·©å­˜: ${cacheKey}`);
                return null;
            }
            
            const cacheData = JSON.parse(cached);
            const now = Date.now();
            
            // æª¢æŸ¥ç·©å­˜æ˜¯å¦éæœŸ
            if (now - cacheData.timestamp > CACHE_DURATION) {
                console.log(`â° ç·©å­˜å·²éæœŸï¼Œå°‡æ¸…é™¤: ${cacheKey} (${Math.round((now - cacheData.timestamp) / 60000)} åˆ†é˜å‰å‰µå»º)`);
                localStorage.removeItem(cacheKey);
                return null;
            }
            
            console.log(`ğŸ¯ ä½¿ç”¨ç·©å­˜æ•¸æ“š: ${cacheKey} (${Math.round((now - cacheData.timestamp) / 60000)} åˆ†é˜å‰)`);
            return cacheData.data;
        } catch (error) {
            console.warn('âš ï¸ ç·©å­˜è®€å–å¤±æ•—:', error);
            return null;
        }
    }
    
    function clearExpiredCaches() {
        try {
            const keys = Object.keys(localStorage);
            const now = Date.now();
            let clearedCount = 0;
            
            keys.forEach(key => {
                if (key.startsWith(CACHE_PREFIX)) {
                    try {
                        const cached = JSON.parse(localStorage.getItem(key));
                        if (now - cached.timestamp > CACHE_DURATION) {
                            localStorage.removeItem(key);
                            clearedCount++;
                        }
                    } catch (error) {
                        // æ¸…é™¤æå£çš„ç·©å­˜
                        localStorage.removeItem(key);
                        clearedCount++;
                    }
                }
            });
            
            if (clearedCount > 0) {
                console.log(`ğŸ§¹ æ¸…ç†äº† ${clearedCount} å€‹éæœŸç·©å­˜`);
            }
        } catch (error) {
            console.warn('âš ï¸ ç·©å­˜æ¸…ç†å¤±æ•—:', error);
        }
    }
    
    function clearAllCampaignCaches() {
        try {
            const keys = Object.keys(localStorage);
            let clearedCount = 0;
            
            keys.forEach(key => {
                if (key.startsWith(CACHE_PREFIX)) {
                    localStorage.removeItem(key);
                    clearedCount++;
                }
            });
            
            console.log(`ğŸ—‘ï¸ æ¸…é™¤äº†æ‰€æœ‰ ${clearedCount} å€‹å»£å‘Šæ´»å‹•ç·©å­˜`);
            return clearedCount;
        } catch (error) {
            console.warn('âš ï¸ ç·©å­˜æ¸…é™¤å¤±æ•—:', error);
            return 0;
        }
    }
    
    // é é¢è¼‰å…¥æ™‚æ¸…ç†éæœŸç·©å­˜
    clearExpiredCaches();
    
    // æ›´æ–°ç·©å­˜ç‹€æ…‹é¡¯ç¤º
    function updateCacheStatus() {
        const cacheStatusElement = document.getElementById('cacheStatus');
        if (!cacheStatusElement) return;
        
        try {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(key => key.startsWith(CACHE_PREFIX));
            const validCaches = cacheKeys.filter(key => {
                try {
                    const cached = JSON.parse(localStorage.getItem(key));
                    return (Date.now() - cached.timestamp) <= CACHE_DURATION;
                } catch {
                    return false;
                }
            });
            
            if (validCaches.length > 0) {
                cacheStatusElement.textContent = `(${validCaches.length} å€‹æ´»å‹•å·²ç·©å­˜)`;
                cacheStatusElement.style.color = '#28a745';
            } else {
                cacheStatusElement.textContent = '(ç„¡ç·©å­˜)';
                cacheStatusElement.style.color = '#6c757d';
            }
        } catch (error) {
            cacheStatusElement.textContent = '(ç‹€æ…‹æœªçŸ¥)';
            cacheStatusElement.style.color = '#dc3545';
        }
    }
    
    // åˆå§‹åŒ–ç·©å­˜ç‹€æ…‹é¡¯ç¤º
    updateCacheStatus();
    
    // å®šæœŸæ›´æ–°ç·©å­˜ç‹€æ…‹ (æ¯30ç§’)
    setInterval(updateCacheStatus, 30000);
    
    // é¡¯ç¤ºç·©å­˜æç¤ºè¨Šæ¯
    function showCacheMessage(cacheTimestamp) {
        const now = Date.now();
        const ageMinutes = Math.round((now - cacheTimestamp) / 60000);
        const ageHours = Math.round(ageMinutes / 60);
        
        let ageText = '';
        if (ageMinutes < 60) {
            ageText = `${ageMinutes} åˆ†é˜å‰`;
        } else {
            ageText = `${ageHours} å°æ™‚å‰`;
        }
        
        const cacheMsg = document.createElement('div');
        cacheMsg.className = 'cookie-status';
        cacheMsg.style.backgroundColor = '#e8f4fd';
        cacheMsg.style.borderColor = '#42a5f5';
        cacheMsg.style.color = '#1565c0';
        cacheMsg.innerHTML = `
            ğŸ¯ ä½¿ç”¨ç·©å­˜æ•¸æ“š (${ageText} ç·©å­˜)
            <button onclick="clearCurrentCampaignCache()" style="margin-left: 10px; font-size: 11px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ğŸ—‘ï¸ æ¸…é™¤ç·©å­˜
            </button>
        `;
        
        const container = document.getElementById('dailyReportContainer');
        if (container) {
            container.insertBefore(cacheMsg, container.firstChild);
        }
    }
    

    
    // å–å¾—å ±è¡¨è³‡æ–™
    async function fetchReportData(campaignId, sinceDate, toDate) {
        const loadingElement = document.getElementById('loadingMessage');
        const reportElement = document.getElementById('reportContent');
        const errorElement = document.getElementById('errorMessage');
        const selectionSection = document.getElementById('selectionSection');
        
        // æª¢æŸ¥æ˜¯å¦ç‚º slide å»£å‘Š
        isSlideAd = document.getElementById('isSlideAd').checked;
        
        // å–å¾—æŸ¥è©¢ç­–ç•¥è¨­å®š
        const queryStrategy = document.getElementById('queryStrategy').value;
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        loadingElement.style.display = 'block';
        reportElement.style.display = 'none';
        errorElement.style.display = 'none';
        selectionSection.style.display = 'none';
        
        try {
            // ç¬¬ä¸€æ­¥ï¼šå…ˆæŸ¥è©¢å»£å‘Šæ´»å‹•è³‡è¨Šï¼Œå–å¾—æ­£ç¢ºçš„æ™‚é–“æˆ³
            console.log('æ­£åœ¨æŸ¥è©¢å»£å‘Šæ´»å‹•è³‡è¨Š:', `/api/adset-info?campaignId=${encodeURIComponent(campaignId)}`);
            
            // å…ˆå˜—è©¦å¾ç·©å­˜ç²å–å»£å‘Šæ´»å‹•åŸºæœ¬è³‡è¨Š
            const basicCacheKey = `${CACHE_PREFIX}basic_${campaignId}`;
            let adsetInfo = getCampaignCache(basicCacheKey);
            
            if (!adsetInfo) {
                // æ²’æœ‰ç·©å­˜ï¼Œèª¿ç”¨ API
                const adsetResponse = await fetch(`/api/adset-info?campaignId=${encodeURIComponent(campaignId)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (adsetResponse.ok) {
                    adsetInfo = await adsetResponse.json();
                    console.log('æ”¶åˆ°å»£å‘Šæ´»å‹•è³‡è¨Š:', adsetInfo);
                    
                    // ç·©å­˜åŸºæœ¬è³‡è¨Šï¼ˆ24å°æ™‚ï¼‰
                    setCampaignCache(basicCacheKey, adsetInfo);
                } else {
                    console.warn('æŸ¥è©¢å»£å‘Šæ´»å‹•è³‡è¨Šå¤±æ•—ï¼Œå°‡ä½¿ç”¨é è¨­å€¼');
                    adsetInfo = {
                        success: false,
                        pricing: { bMode: 'CPC', price: 7.0, currency: 'TWD' },
                        info: { 
                            name: 'æœªçŸ¥æ´»å‹•', 
                            adType: 'åŸç”Ÿäº’å‹•å»£å‘Š', 
                            budget: 0, 
                            campaignEndDate: null,
                            fromTimestamp: null,
                            toTimestamp: null
                        }
                    };
                }
            } else {
                console.log('ğŸ¯ ä½¿ç”¨ç·©å­˜çš„å»£å‘Šæ´»å‹•åŸºæœ¬è³‡è¨Š');
            }
            
            currentAdsetInfo = adsetInfo;
            
            let actualSinceDate = sinceDate;
            let actualToDate = toDate;
            
            // è™•ç†å»£å‘Šæ´»å‹•è³‡è¨Š
            if (adsetInfo.success && adsetInfo.info) {
                // è‡ªå‹•è¨­ç½®èµ°æœŸçµæŸæ—¥æœŸ
                if (adsetInfo.info.campaignEndDate) {
                    document.getElementById('campaignEndDate').value = adsetInfo.info.campaignEndDate;
                    console.log('è‡ªå‹•è¨­ç½®èµ°æœŸçµæŸæ—¥æœŸ:', adsetInfo.info.campaignEndDate);
                }
                
                // è‡ªå‹•è¨­ç½®é–‹å§‹å’ŒçµæŸæ™‚é–“æˆ³
                if (adsetInfo.info.fromTimestamp) {
                    actualSinceDate = adsetInfo.info.fromTimestamp;
                    document.getElementById('sinceDate').value = actualSinceDate;
                    console.log('è‡ªå‹•è¨­ç½®é–‹å§‹æ™‚é–“æˆ³:', actualSinceDate);
                }
                if (adsetInfo.info.toTimestamp) {
                    actualToDate = adsetInfo.info.toTimestamp;
                    document.getElementById('toDate').value = actualToDate;
                    console.log('è‡ªå‹•è¨­ç½®çµæŸæ™‚é–“æˆ³:', actualToDate);
                }
                
                // è¨­ç½®ç•¶å‰æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('currentDate').value = today;
            }
            
            // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨è‡ªè¨‚æ™‚é–“
            const useCustomTime = document.getElementById('useCustomTime').checked;
            if (useCustomTime) {
                const customStartDate = document.getElementById('customStartDate').value;
                const customEndDate = document.getElementById('customEndDate').value;
                
                if (customStartDate && customEndDate) {
                    // å°‡æ—¥æœŸè½‰æ›ç‚ºæ™‚é–“æˆ³
                    const startDateTime = new Date(customStartDate + 'T00:00:00');
                    const endDateTime = new Date(customEndDate + 'T23:59:59');
                    
                    actualSinceDate = startDateTime.getTime();
                    actualToDate = endDateTime.getTime();
                    
                    console.log('ä½¿ç”¨è‡ªè¨‚æ™‚é–“å€æ®µ:', {
                        startDate: customStartDate,
                        endDate: customEndDate,
                        sinceTimestamp: actualSinceDate,
                        toTimestamp: actualToDate
                    });
                } else {
                    console.warn('è‡ªè¨‚æ™‚é–“æœªå®Œæ•´å¡«å¯«ï¼Œå°‡ä½¿ç”¨è‡ªå‹•å–å¾—çš„æ™‚é–“');
                }
            }
            
            // ç¾åœ¨ç”Ÿæˆç·©å­˜åƒæ•¸å’Œéµå€¼ï¼ˆä½¿ç”¨æ­£ç¢ºçš„æ™‚é–“æˆ³ï¼‰
            const queryParams = {
                isSlideAd: isSlideAd,
                queryStrategy: queryStrategy,
                sinceDate: actualSinceDate,
                toDate: actualToDate,
                useCustomTime: document.getElementById('useCustomTime').checked,
                customStartDate: document.getElementById('customStartDate').value,
                customEndDate: document.getElementById('customEndDate').value
            };
            
            const cacheKey = getCacheKey(campaignId, queryParams);
            console.log('ğŸ”‘ ç”Ÿæˆç·©å­˜éµå€¼:', cacheKey, 'åƒæ•¸:', queryParams);
            
            // æª¢æŸ¥å ±è¡¨æ•¸æ“šç·©å­˜
            const cachedData = getCampaignCache(cacheKey);
            if (cachedData) {
                console.log('ğŸ¯ ä½¿ç”¨ç·©å­˜çš„å ±è¡¨æ•¸æ“šï¼Œè·³éç¶²è·¯è«‹æ±‚');
                
                // å¾ç·©å­˜æ¢å¾©æ•¸æ“š
                allAdsetReports = cachedData.allAdsetReports;
                allAdunitReports = cachedData.allAdunitReports;
                adunitByAdset = cachedData.adunitByAdset;
                currentCutData = cachedData.currentCutData;
                
                // æ¢å¾©éš±è—æ¬„ä½çš„å€¼
                if (cachedData.hiddenFieldValues) {
                    Object.keys(cachedData.hiddenFieldValues).forEach(fieldId => {
                        const element = document.getElementById(fieldId);
                        if (element) {
                            element.value = cachedData.hiddenFieldValues[fieldId];
                        }
                    });
                }
                
                // ç›´æ¥é¡¯ç¤ºçµæœï¼Œè·³éç¶²è·¯è«‹æ±‚
                loadingElement.style.display = 'none';
                
                // åˆå§‹åŒ–é¸æ“‡ç‹€æ…‹ï¼ˆé è¨­å…¨é¸ï¼‰
                initializeSelections();
                
                // å»ºç«‹é¸æ“‡å™¨ç•Œé¢
                buildSelectionInterface();
                
                // é¡¯ç¤ºç·©å­˜æç¤º
                showCacheMessage(cachedData.cacheTimestamp);
                
                // è§£æä¸¦é¡¯ç¤ºåˆä½µçš„æ¯æ—¥å ±è¡¨
                if (allAdsetReports && Object.keys(allAdsetReports).length > 0) {
                    const firstReport = Object.values(allAdsetReports)[0];
                    if (firstReport && firstReport.content) {
                        displayMergedDailyReport(firstReport.content, cachedData.summary);
                    }
                }
                
                return; // ä½¿ç”¨ç·©å­˜ï¼Œç›´æ¥è¿”å›
            }
            
            // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨æ­£ç¢ºçš„æ™‚é–“æˆ³æŸ¥è©¢å ±è¡¨
            console.log('æ­£åœ¨æŸ¥è©¢å ±è¡¨ï¼Œä½¿ç”¨æ™‚é–“æˆ³:', `å¾ ${actualSinceDate} åˆ° ${actualToDate}`);
            console.log('ä½¿ç”¨æŸ¥è©¢ç­–ç•¥:', queryStrategy);
            
            const queries = [
                // æŸ¥è©¢ AdSet å±¤ç´šå ±è¡¨è³‡æ–™
                fetch(`/api/report-proxy?campaignId=${encodeURIComponent(campaignId)}&sinceDate=${encodeURIComponent(actualSinceDate)}&toDate=${encodeURIComponent(actualToDate)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                })
            ];
            
            // æ ¹æ“šæŸ¥è©¢ç­–ç•¥æ±ºå®šæ˜¯å¦æŸ¥è©¢ AdUnit å±¤ç´šå ±è¡¨
            if (queryStrategy === 'sequential') {
                queries.push(
                    fetch(`/api/adunit-reports-sequential?campaignId=${encodeURIComponent(campaignId)}&sinceDate=${encodeURIComponent(actualSinceDate)}&toDate=${encodeURIComponent(actualToDate)}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                );
            }
            
            // å¦‚æœæ˜¯ slide å»£å‘Šï¼ŒåŠ å…¥ AdUnit æŸ¥è©¢
            if (isSlideAd) {
                queries.push(
                    fetch(`/api/adunits?campaignId=${encodeURIComponent(campaignId)}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                );
                console.log('æ­£åœ¨æŸ¥è©¢ AdUnit:', `/api/adunits?campaignId=${encodeURIComponent(campaignId)}`);
            }
            
            // ä¸¦è¡ŒæŸ¥è©¢
            const responses = await Promise.all(queries);
            const [reportResponse, adunitReportResponse, adunitResponse] = responses;
            
            // è™•ç† AdSet å±¤ç´šå ±è¡¨å›æ‡‰
            if (!reportResponse.ok) {
                throw new Error(`AdSet å ±è¡¨è«‹æ±‚å¤±æ•—: HTTP ${reportResponse.status}: ${reportResponse.statusText}`);
            }
            
            const jsonResponse = await reportResponse.json();
            console.log('æ”¶åˆ° AdSet ä»£ç†å›æ‡‰:', jsonResponse);
            
            // å„²å­˜æ‰€æœ‰ AdSet çš„å ±è¡¨æ•¸æ“š
            allAdsetReports = jsonResponse.adset_reports || {};
            
            // è™•ç† AdUnit å±¤ç´šå ±è¡¨å›æ‡‰
            if (adunitReportResponse && adunitReportResponse.ok) {
                const adunitJsonResponse = await adunitReportResponse.json();
                console.log('æ”¶åˆ° AdUnit å ±è¡¨å›æ‡‰:', adunitJsonResponse);
                
                if (adunitJsonResponse.success) {
                    allAdunitReports = adunitJsonResponse.adunit_reports || {};
                    adunitByAdset = adunitJsonResponse.adunit_by_adset || {};
                    
                    // å„²å­˜æŸ¥è©¢æ•ˆèƒ½è³‡è¨Šåˆ°å…¨åŸŸè®Šæ•¸
                    if (adunitJsonResponse.summary) {
                        window.adunitQuerySummary = adunitJsonResponse.summary;
                        console.log('AdUnit æŸ¥è©¢æ•ˆèƒ½:', adunitJsonResponse.summary);
                    }
                }
            } else {
                console.warn('AdUnit å ±è¡¨æŸ¥è©¢å¤±æ•—æˆ–è·³é');
                allAdunitReports = {};
                adunitByAdset = {};
                window.adunitQuerySummary = null;
            }
            
            // è™•ç† AdUnit å’Œ cut æ•¸æ“š
            let cutData = {};
            if (isSlideAd && adunitResponse && adunitResponse.ok) {
                const adunitResult = await adunitResponse.json();
                console.log('æ”¶åˆ° AdUnit è³‡è¨Š:', adunitResult);
                
                if (adunitResult.success && adunitResult.adunits.length > 0) {
                    // ç‚ºæ¯å€‹ AdUnit æŸ¥è©¢ cut æ•¸æ“š
                    const cutQueries = adunitResult.adunits.map(adunit => 
                        fetch(`/api/cut-data?uuid=${encodeURIComponent(adunit.uuid)}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        })
                    );
                    
                    const cutResponses = await Promise.all(cutQueries);
                    
                    // è™•ç†æ¯å€‹ cut æ•¸æ“šå›æ‡‰
                    for (let i = 0; i < cutResponses.length; i++) {
                        const response = cutResponses[i];
                        const adunit = adunitResult.adunits[i];
                        
                        if (response.ok) {
                            const cutResult = await response.json();
                            if (cutResult.success) {
                                cutData[adunit.uuid] = {
                                    adunit: adunit,
                                    data: cutResult.data
                                };
                                console.log(`æ”¶åˆ° AdUnit ${adunit.uuid} çš„ cut æ•¸æ“š:`, cutResult.data);
                            }
                        }
                    }
                }
            }
            
            currentCutData = cutData;
            
            if (jsonResponse.success) {
                const htmlContent = jsonResponse.content;
                console.log('æ”¶åˆ° HTML å…§å®¹ï¼Œé•·åº¦:', htmlContent.length);
                
                // ä¿å­˜åˆ°ç·©å­˜
                const cacheData = {
                    currentAdsetInfo: currentAdsetInfo,
                    allAdsetReports: allAdsetReports,
                    allAdunitReports: allAdunitReports,
                    adunitByAdset: adunitByAdset,
                    currentCutData: currentCutData,
                    summary: jsonResponse.summary,
                    cacheTimestamp: Date.now(),
                    hiddenFieldValues: {
                        sinceDate: document.getElementById('sinceDate').value,
                        toDate: document.getElementById('toDate').value,
                        campaignEndDate: document.getElementById('campaignEndDate').value,
                        currentDate: document.getElementById('currentDate').value
                    }
                };
                
                setCampaignCache(cacheKey, cacheData);
                
                // åˆå§‹åŒ–é¸æ“‡ç‹€æ…‹ï¼ˆé è¨­å…¨é¸ï¼‰
                initializeSelections();
                
                // å»ºç«‹é¸æ“‡å™¨ç•Œé¢
                buildSelectionInterface();
                
                // è§£æä¸¦é¡¯ç¤ºåˆä½µçš„æ¯æ—¥å ±è¡¨
                displayMergedDailyReport(htmlContent, jsonResponse.summary);
                
                // é¡¯ç¤ºé¸æ“‡å€åŸŸ
                // selectionSection.style.display = 'block';
            } else {
                throw new Error(jsonResponse.error || 'ä»£ç†è«‹æ±‚å¤±æ•—');
            }
            
        } catch (error) {
            console.error('å–å¾—å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            errorElement.innerHTML = `
                <h4>âŒ å–å¾—å ±è¡¨å¤±æ•—</h4>
                <p><strong>éŒ¯èª¤è©³æƒ…:</strong> ${error.message}</p>
                <p><strong>å¯èƒ½åŸå› :</strong></p>
                <ul>
                    <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                    <li>å»£å‘Šæ´»å‹• ID ä¸æ­£ç¢º</li>
                    <li>Cookie å¯èƒ½å·²éæœŸ</li>
                    <li>ä¼ºæœå™¨ä»£ç†æœå‹™ç•°å¸¸</li>
                    ${isSlideAd ? '<li>AdUnit æˆ– cut æ•¸æ“šæŸ¥è©¢å¤±æ•—</li>' : ''}
                </ul>
                <p><strong>å»ºè­°è§£æ±ºæ–¹æ³•:</strong></p>
                <ul>
                    <li>ç¢ºèªå»£å‘Šæ´»å‹• ID æ˜¯å¦æ­£ç¢º</li>
                    <li>æª¢æŸ¥ç¶²è·¯é€£ç·š</li>
                    <li>å˜—è©¦é‡æ–°æ•´ç†é é¢</li>
                    <li>å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯çµ¡æŠ€è¡“æ”¯æ´</li>
                </ul>
            `;
        }
    }
    
    // æ–°å¢ï¼šæª¢æŸ¥ AdSet æ˜¯å¦æ‡‰è©²è¢«éæ¿¾ï¼ˆåŒ…å« demoï¼‰
    function shouldFilterAdset(report) {
        if (!report || !report.name) return false;
        return report.name.toLowerCase().includes('demo');
    }
    
    // æ–°å¢ï¼šåˆå§‹åŒ–é¸æ“‡ç‹€æ…‹
    function initializeSelections() {
        selectedAdsets.clear();
        selectedAdunits.clear();
        
        // é è¨­é¸æ“‡åœ¨æ™‚é–“å€æ®µå…§ä¸”æˆåŠŸçš„ AdSetï¼ˆéæ¿¾æ‰åŒ…å« demo çš„ï¼‰
        for (const adsetId in allAdsetReports) {
            const report = allAdsetReports[adsetId];
            if (report.success && isAdsetInTimeRange(report) && !shouldFilterAdset(report)) {
                selectedAdsets.add(adsetId);
                console.log(`é è¨­é¸æ“‡ AdSet: ${report.name}`);
            } else {
                const filterReason = shouldFilterAdset(report) ? 'åŒ…å« demo' : `æˆåŠŸ: ${report.success}, åœ¨æ™‚é–“å€æ®µ: ${isAdsetInTimeRange(report)}`;
                console.log(`è·³é AdSet: ${report.name} (${filterReason})`);
            }
        }
        
        // é è¨­é¸æ“‡åœ¨æ™‚é–“å€æ®µå…§ä¸”æˆåŠŸçš„ AdUnit
        for (const adunitUuid in allAdunitReports) {
            const report = allAdunitReports[adunitUuid];
            if (report.success && isAdunitInTimeRange(report)) {
                selectedAdunits.add(adunitUuid);
                console.log(`é è¨­é¸æ“‡ AdUnit: ${report.name}`);
            } else {
                console.log(`è·³é AdUnit: ${report.name} (æˆåŠŸ: ${report.success}, åœ¨æ™‚é–“å€æ®µ: ${isAdunitInTimeRange(report)})`);
            }
        }
        
        // åŒæ­¥åˆ°å…¨åŸŸè®Šæ•¸
        window.selectedAdsets = selectedAdsets;
        window.selectedAdunits = selectedAdunits;
        
        console.log(`åˆå§‹åŒ–å®Œæˆ - é¸æ“‡çš„ AdSet: ${selectedAdsets.size}/${Object.keys(allAdsetReports).length}, AdUnit: ${selectedAdunits.size}/${Object.keys(allAdunitReports).length}`);
    }
    
    // æ–°å¢ï¼šå»ºç«‹é¸æ“‡å™¨ç•Œé¢
    function buildSelectionInterface() {
        const adsetList = document.getElementById('adsetSelectionList');
        const adunitList = document.getElementById('adunitSelectionList');
        
        // æ¸…ç©ºç¾æœ‰å…§å®¹
        adsetList.innerHTML = '';
        adunitList.innerHTML = '';
        
        // å»ºç«‹ AdSet é¸æ“‡å™¨ï¼ˆéæ¿¾æ‰åŒ…å« demo çš„ï¼‰
        for (const [adsetId, report] of Object.entries(allAdsetReports)) {
            // éæ¿¾åŒ…å« demo çš„ AdSet
            if (shouldFilterAdset(report)) {
                console.log(`éæ¿¾æ‰åŒ…å« demo çš„ AdSet: ${report.name}`);
                continue;
            }
            
            const item = document.createElement('div');
            item.className = 'selection-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `adset_${adsetId}`;
            checkbox.value = adsetId;
            checkbox.checked = selectedAdsets.has(adsetId) && report.success;
            checkbox.disabled = !report.success;
            checkbox.addEventListener('change', updateSelectionSummary);
            
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.className = 'selection-item-label';
            label.textContent = `${report.name} ${report.success ? 'âœ…' : 'âŒ'}`;
            
            if (!report.success) {
                const errorInfo = document.createElement('div');
                errorInfo.className = 'selection-item-subtitle';
                errorInfo.textContent = `éŒ¯èª¤: ${report.error}`;
                label.appendChild(errorInfo);
            }
            
            item.appendChild(checkbox);
            item.appendChild(label);
            adsetList.appendChild(item);
        }
        
        // å»ºç«‹ AdUnit é¸æ“‡å™¨ï¼ˆéæ¿¾æ‰åŒ…å« demo çš„ AdSetï¼‰
        for (const [adsetId, adsetData] of Object.entries(adunitByAdset)) {
            // æª¢æŸ¥å°æ‡‰çš„ AdSet æ˜¯å¦æ‡‰è©²è¢«éæ¿¾
            const adsetReport = allAdsetReports[adsetId];
            if (adsetReport && shouldFilterAdset(adsetReport)) {
                console.log(`éæ¿¾æ‰åŒ…å« demo çš„ AdSet ä¸‹çš„ AdUnit: ${adsetData.adsetName}`);
                continue;
            }
            
            // æ·»åŠ  AdSet æ¨™é¡Œ
            const adsetHeader = document.createElement('div');
            adsetHeader.style.fontWeight = 'bold';
            adsetHeader.style.color = '#2e7d32';
            adsetHeader.style.marginTop = '10px';
            adsetHeader.style.marginBottom = '5px';
            adsetHeader.textContent = `ğŸ“Š ${adsetData.adsetName}`;
            adunitList.appendChild(adsetHeader);
            
            // æ·»åŠ è©² AdSet ä¸‹çš„æ‰€æœ‰ AdUnit
            for (const adunitReport of adsetData.adunits) {
                const item = document.createElement('div');
                item.className = 'selection-item';
                item.style.marginLeft = '15px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `adunit_${adunitReport.uuid}`;
                checkbox.value = adunitReport.uuid;
                checkbox.checked = selectedAdunits.has(adunitReport.uuid) && adunitReport.success;
                checkbox.disabled = !adunitReport.success;
                checkbox.addEventListener('change', updateSelectionSummary);
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.className = 'selection-item-label';
                label.textContent = `${adunitReport.name} ${adunitReport.success ? 'âœ…' : 'âŒ'}`;
                
                const subtitle = document.createElement('div');
                subtitle.className = 'selection-item-subtitle';
                subtitle.textContent = `UUID: ${adunitReport.uuid.slice(0, 8)}...`;
                
                if (!adunitReport.success) {
                    subtitle.textContent += ` | éŒ¯èª¤: ${adunitReport.error}`;
                }
                
                label.appendChild(subtitle);
                
                item.appendChild(checkbox);
                item.appendChild(label);
                adunitList.appendChild(item);
            }
        }
        
        updateSelectionSummary();
    }
    
    // æ–°å¢ï¼šåˆ‡æ›æ‰€æœ‰ checkbox
    function toggleAllCheckboxes(listId, checked) {
        const list = document.getElementById(listId);
        const checkboxes = list.querySelectorAll('input[type="checkbox"]:not(:disabled)');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
            
            if (listId === 'adsetSelectionList') {
                if (checked) {
                    selectedAdsets.add(checkbox.value);
                } else {
                    selectedAdsets.delete(checkbox.value);
                }
            } else if (listId === 'adunitSelectionList') {
                if (checked) {
                    selectedAdunits.add(checkbox.value);
                } else {
                    selectedAdunits.delete(checkbox.value);
                }
            }
        });
    }
    
    // æ–°å¢ï¼šæ›´æ–°é¸æ“‡æ‘˜è¦
    function updateSelectionSummary() {
        // å¾ DOM æ›´æ–°é¸æ“‡ç‹€æ…‹
        selectedAdsets.clear();
        selectedAdunits.clear();
        
        document.querySelectorAll('#adsetSelectionList input[type="checkbox"]:checked').forEach(cb => {
            selectedAdsets.add(cb.value);
        });
        
        document.querySelectorAll('#adunitSelectionList input[type="checkbox"]:checked').forEach(cb => {
            selectedAdunits.add(cb.value);
        });
        
        const summary = document.getElementById('selectionSummary');
        const totalAdsets = Object.keys(allAdsetReports).filter(id => allAdsetReports[id].success && !shouldFilterAdset(allAdsetReports[id])).length;
        const totalAdunits = Object.keys(allAdunitReports).filter(id => allAdunitReports[id].success).length;
        
        summary.innerHTML = `
            ğŸ“Š å·²é¸æ“‡ï¼š${selectedAdsets.size}/${totalAdsets} å€‹ AdSetï¼Œ${selectedAdunits.size}/${totalAdunits} å€‹ AdUnit
            ${selectedAdsets.size === 0 && selectedAdunits.size === 0 ? '<br>âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é …ç›®' : ''}
        `;
    }
    
    // æ–°å¢ï¼šæ›´æ–°å ±è¡¨é¡¯ç¤º
    function updateReportDisplay() {
        if (selectedAdsets.size === 0 && selectedAdunits.size === 0) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ AdSet æˆ– AdUnit');
            return;
        }
        
        // é‡æ–°é¡¯ç¤ºå ±è¡¨ï¼ŒåªåŒ…å«é¸ä¸­çš„é …ç›®
        const htmlContent = allAdsetReports[Object.keys(allAdsetReports)[0]]?.content || '';
        displayMergedDailyReport(htmlContent, {
            total_adsets: selectedAdsets.size,
            successful_reports: selectedAdsets.size,
            failed_reports: 0
        }, true); // å‚³å…¥ true è¡¨ç¤ºé€™æ˜¯æ›´æ–°é¡¯ç¤º
    }

    // é¡¯ç¤ºåˆä½µçš„æ¯æ—¥å ±è¡¨
    function displayMergedDailyReport(primaryHtmlContent, summary, isUpdate) {
        const loadingElement = document.getElementById('loadingMessage');
        const reportElement = document.getElementById('reportContent');
        const dailyReportContainer = document.getElementById('dailyReportContainer');
        
        // ç²å–èµ°æœŸå’Œç•¶å‰æ—¥æœŸè¨­å®š
        const campaignEndDate = document.getElementById('campaignEndDate').value;
        const currentDate = document.getElementById('currentDate').value;
        
        loadingElement.style.display = 'none';
        
        try {
            // é¦–å…ˆé¡¯ç¤ºæ´»å‹•æ¦‚è¦½
            let reportContent = `
                <div class="daily-report-section">
                    <h4>ğŸ“Š æ´»å‹•æ¦‚è¦½</h4>
                    <p><strong>æ´»å‹•åç¨±:</strong> ${currentAdsetInfo?.info?.name || 'æœªçŸ¥æ´»å‹•'}</p>
                    <p><strong>å»£å‘Šé›†æ•¸é‡:</strong> ${currentAdsetInfo?.info?.adsetCount || 0} å€‹</p>
                    <p><strong>å ±è¡¨ç‹€æ…‹:</strong> ${summary?.successful_reports || 0} å€‹æˆåŠŸ / ${summary?.total_adsets || 0} å€‹ç¸½è¨ˆ</p>
                    ${summary?.failed_reports > 0 ? `<p style="color: #dc3545;"><strong>âš ï¸ ${summary.failed_reports} å€‹å»£å‘Šé›†æŸ¥è©¢å¤±æ•—</strong></p>` : ''}
                </div>
            `;
            
            // åˆä½µæ‰€æœ‰æˆåŠŸçš„å ±è¡¨æ•¸æ“š
            const mergedTable = mergeAllAdsetReports();
            if (mergedTable) {
                // å¦‚æœæ˜¯ slide å»£å‘Šï¼Œéœ€è¦é‡æ–°æ§‹å»ºè¡¨æ ¼ä»¥åŒ…å« cut æ•¸æ“š
                let finalTable = mergedTable;
                if (isSlideAd && Object.keys(currentCutData).length > 0) {
                    finalTable = buildSlideReportTable(mergedTable, currentCutData);
                }
                
                // è™•ç†è¡¨æ ¼å…§å®¹ï¼Œæ ¹æ“šèµ°æœŸè¨­å®šèª¿æ•´é¡¯ç¤º
                if (campaignEndDate && currentDate) {
                    finalTable = processTableBySchedule(finalTable, campaignEndDate, currentDate);
                }
                
                // é¡¯ç¤ºåˆä½µçš„ç¸½è¡¨æ ¼
                reportContent += `
                    <div class="daily-report-section">
                        <h4>ğŸ“ˆ åˆä½µå ±è¡¨æ•¸æ“š${isSlideAd ? 'ï¼ˆå« Cut åˆ†ææ•¸æ“šï¼‰' : ''}</h4>
                        ${finalTable.outerHTML}
                    </div>
                `;
                
                // é¡¯ç¤ºå€‹åˆ¥ AdSet çš„å ±è¡¨
                reportContent += displayIndividualAdsetReports();
                
                dailyReportContainer.innerHTML = reportContent;
                
                // ç¾åŒ–è¡¨æ ¼
                const tables = dailyReportContainer.querySelectorAll('table');
                tables.forEach(table => {
                    table.className = 'report-table';
                });
                
                reportElement.style.display = 'block';
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯å’Œå„ç¨®è³‡è¨Š
                addReportMessages(dailyReportContainer, campaignEndDate, currentDate);
                
                // å•Ÿç”¨å°å‡ºæŒ‰éˆ•ä¸¦å„²å­˜å ±è¡¨è³‡æ–™
                enableExportButton();
                
                // ç¶å®šé‡æ–°ç”ŸæˆæŒ‰éˆ•äº‹ä»¶
                const refreshBtn = document.getElementById('refreshReportBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', regenerateMergedReport);
                }
                
                currentReportData = {
                    campaignId: document.getElementById('campaignId').value.trim(),
                    sinceDate: document.getElementById('sinceDate').value,
                    toDate: document.getElementById('toDate').value,
                    campaignEndDate: campaignEndDate,
                    currentDate: currentDate,
                    table: finalTable,
                    isSlideAd: isSlideAd,
                    cutData: currentCutData,
                    allAdsetReports: allAdsetReports,
                    allAdunitReports: allAdunitReports,
                    adunitByAdset: adunitByAdset
                };
            } else {
                throw new Error('ç„¡æ³•åˆä½µå ±è¡¨æ•¸æ“š');
            }
            
        } catch (error) {
            console.error('è§£æ HTML å…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            
            // å¦‚æœè§£æå¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            dailyReportContainer.innerHTML = `
                <div class="daily-report-section">
                    <h4>âš ï¸ ç„¡æ³•åˆä½µå ±è¡¨æ•¸æ“š</h4>
                    <p style="color: #6c757d;">
                        <strong>éŒ¯èª¤:</strong> ${error.message}
                    </p>
                    <p style="color: #6c757d; font-size: 14px;">
                        å¯èƒ½åŸå› ï¼šå ±è¡¨æ ¼å¼å·²è®Šæ›´æˆ–æ•¸æ“šä¸å®Œæ•´ã€‚è«‹æª¢æŸ¥å»£å‘Šæ´»å‹• ID æ˜¯å¦æ­£ç¢ºã€‚
                    </p>
                </div>
            `;
            reportElement.style.display = 'block';
        }
    }
    
    // åˆä½µæ‰€æœ‰ AdSet çš„å ±è¡¨æ•¸æ“š
    function mergeAllAdsetReports() {
        if (!allAdsetReports || Object.keys(allAdsetReports).length === 0) {
            return null;
        }
        
        // æ ¹æ“šé¸æ“‡éæ¿¾ AdSet å ±è¡¨ï¼Œä¸¦éæ¿¾æ™‚é–“å€æ®µå’ŒåŒ…å« demo çš„
        const filteredReports = Object.entries(allAdsetReports)
            .filter(([adsetId, report]) => {
                if (!selectedAdsets.has(adsetId) || !report.success) {
                    return false;
                }
                
                // éæ¿¾åŒ…å« demo çš„ AdSet
                if (shouldFilterAdset(report)) {
                    console.log(`åˆä½µå ±è¡¨æ™‚éæ¿¾æ‰åŒ…å« demo çš„ AdSet: ${report.name}`);
                    return false;
                }
                
                // æª¢æŸ¥æ™‚é–“å€æ®µéæ¿¾
                if (!isAdsetInTimeRange(report)) {
                    return false;
                }
                
                return true;
            })
            .map(([adsetId, report]) => report);
        
        if (filteredReports.length === 0) {
            return null;
        }
        
        console.log(`é–‹å§‹åˆä½µ ${filteredReports.length} å€‹é¸ä¸­ä¸”åœ¨æ™‚é–“å€æ®µå…§çš„å ±è¡¨`);
        
        // è§£ææ‰€æœ‰é¸ä¸­çš„å ±è¡¨è¡¨æ ¼
        const parsedTables = [];
        for (const report of filteredReports) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(report.content, 'text/html');
            const table = findDailyReportTable(doc);
            if (table) {
                parsedTables.push({
                    name: report.name,
                    table: table
                });
            }
        }
        
        if (parsedTables.length === 0) {
            return null;
        }
        
        // å¦‚æœåªæœ‰ä¸€å€‹è¡¨æ ¼ï¼Œç›´æ¥è¿”å›
        if (parsedTables.length === 1) {
            return parsedTables[0].table;
        }
        
        // åˆä½µå¤šå€‹è¡¨æ ¼çš„æ•¸æ“š
        return mergeTables(parsedTables);
    }
    
    // æ–°å¢ï¼šæª¢æŸ¥ AdSet æ˜¯å¦åœ¨æ™‚é–“å€æ®µå…§
    function isAdsetInTimeRange(report) {
        const useCustomTime = document.getElementById('useCustomTime').checked;
        if (!useCustomTime) {
            return true; // å¦‚æœæ²’æœ‰ä½¿ç”¨è‡ªè¨‚æ™‚é–“ï¼Œæ‰€æœ‰ AdSet éƒ½é¡¯ç¤º
        }
        
        const customStartDate = document.getElementById('customStartDate').value;
        const customEndDate = document.getElementById('customEndDate').value;
        
        if (!customStartDate || !customEndDate) {
            return true; // å¦‚æœæ™‚é–“è¨­å®šä¸å®Œæ•´ï¼Œé¡¯ç¤ºæ‰€æœ‰
        }
        
        console.log(`æª¢æŸ¥ AdSet æ™‚é–“å€æ®µ: ${report.name}, å€æ®µ: ${customStartDate} ~ ${customEndDate}`);
        
        // è§£æå ±è¡¨å…§å®¹ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰åœ¨æ™‚é–“å€æ®µå…§çš„æ•¸æ“š
        const parser = new DOMParser();
        const doc = parser.parseFromString(report.content, 'text/html');
        const table = findDailyReportTable(doc);
        
        if (!table) {
            console.log(`AdSet ${report.name}: æ‰¾ä¸åˆ°è¡¨æ ¼`);
            return true;
        }
        
        const rows = table.querySelectorAll('tr');
        const startTime = new Date(customStartDate).getTime();
        const endTime = new Date(customEndDate + 'T23:59:59').getTime();
        
        console.log(`æ™‚é–“å€æ®µç¯„åœ: ${startTime} ~ ${endTime}`);
        
        let hasDataInRange = false;
        
        // æª¢æŸ¥è¡¨æ ¼ä¸­æ˜¯å¦æœ‰åœ¨æ™‚é–“å€æ®µå…§çš„æ•¸æ“šè¡Œ
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].querySelectorAll('td, th');
            if (cells.length === 0) continue;
            
            const dateText = cells[0].textContent.trim();
            if (dateText === 'TOTAL') continue;
            
            // è§£ææ—¥æœŸ - å¢å¼·ç‰ˆæœ¬
            let rowDate = null;
            
            // æ ¼å¼ 1: YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
            } 
            // æ ¼å¼ 2: MM/DD (ä½¿ç”¨ç•¶å‰å¹´ä»½)
            else if (/^\d{1,2}\/\d{1,2}$/.test(dateText)) {
                const [month, day] = dateText.split('/').map(num => parseInt(num));
                const currentYear = new Date().getFullYear();
                rowDate = new Date(currentYear, month - 1, day);
            } 
            // æ ¼å¼ 3: MM-DD (ä½¿ç”¨ç•¶å‰å¹´ä»½)
            else if (/^\d{1,2}-\d{1,2}$/.test(dateText)) {
                const [month, day] = dateText.split('-').map(num => parseInt(num));
                const currentYear = new Date().getFullYear();
                rowDate = new Date(currentYear, month - 1, day);
            }
            // æ ¼å¼ 4: YYYY/MM/DD
            else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateText)) {
                const [year, month, day] = dateText.split('/').map(num => parseInt(num));
                rowDate = new Date(year, month - 1, day);
            }
            // æ ¼å¼ 5: DD/MM/YYYY (æŸäº›åœ°å€æ ¼å¼)
            else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateText)) {
                const parts = dateText.split('/').map(num => parseInt(num));
                // å‡è¨­æ˜¯ DD/MM/YYYY æ ¼å¼
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                rowDate = new Date(year, month - 1, day);
            }
            
            if (rowDate && !isNaN(rowDate.getTime())) {
                const rowTime = rowDate.getTime();
                console.log(`  æª¢æŸ¥æ—¥æœŸ: ${dateText} -> ${rowDate.toISOString().split('T')[0]} (${rowTime})`);
                
                if (rowTime >= startTime && rowTime <= endTime) {
                    console.log(`    âœ… åœ¨å€æ®µå…§!`);
                    hasDataInRange = true;
                    break; // æ‰¾åˆ°ä¸€ç­†åœ¨ç¯„åœå…§çš„æ•¸æ“šå°±è¶³å¤ äº†
                } else {
                    console.log(`    âŒ ä¸åœ¨å€æ®µå…§`);
                }
            } else {
                console.log(`  ç„¡æ³•è§£ææ—¥æœŸ: ${dateText}`);
            }
        }
        
        console.log(`AdSet ${report.name} æœ€çµ‚çµæœ: ${hasDataInRange ? 'é¡¯ç¤º' : 'éš±è—'}`);
        return hasDataInRange;
    }
    
    // æ–°å¢ï¼šæª¢æŸ¥ AdUnit æ˜¯å¦åœ¨æ™‚é–“å€æ®µå…§
    function isAdunitInTimeRange(adunitReport) {
        const useCustomTime = document.getElementById('useCustomTime').checked;
        if (!useCustomTime) {
            return true;
        }
        
        const customStartDate = document.getElementById('customStartDate').value;
        const customEndDate = document.getElementById('customEndDate').value;
        
        if (!customStartDate || !customEndDate) {
            return true;
        }
        
        console.log(`æª¢æŸ¥ AdUnit æ™‚é–“å€æ®µ: ${adunitReport.name}, å€æ®µ: ${customStartDate} ~ ${customEndDate}`);
        
        // è§£æ AdUnit å ±è¡¨å…§å®¹
        const parser = new DOMParser();
        const doc = parser.parseFromString(adunitReport.content, 'text/html');
        const table = findDailyReportTable(doc);
        
        if (!table) {
            console.log(`AdUnit ${adunitReport.name}: æ‰¾ä¸åˆ°è¡¨æ ¼`);
            return true;
        }
        
        const rows = table.querySelectorAll('tr');
        const startTime = new Date(customStartDate).getTime();
        const endTime = new Date(customEndDate + 'T23:59:59').getTime();
        
        let hasDataInRange = false;
        
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].querySelectorAll('td, th');
            if (cells.length === 0) continue;
            
            const dateText = cells[0].textContent.trim();
            if (dateText === 'TOTAL') continue;
            
            // è§£ææ—¥æœŸ - å¢å¼·ç‰ˆæœ¬ (èˆ‡ AdSet ç›¸åŒé‚è¼¯)
            let rowDate = null;
            
            // æ ¼å¼ 1: YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
            } 
            // æ ¼å¼ 2: MM/DD (ä½¿ç”¨ç•¶å‰å¹´ä»½)
            else if (/^\d{1,2}\/\d{1,2}$/.test(dateText)) {
                const [month, day] = dateText.split('/').map(num => parseInt(num));
                const currentYear = new Date().getFullYear();
                rowDate = new Date(currentYear, month - 1, day);
            } 
            // æ ¼å¼ 3: MM-DD (ä½¿ç”¨ç•¶å‰å¹´ä»½)
            else if (/^\d{1,2}-\d{1,2}$/.test(dateText)) {
                const [month, day] = dateText.split('-').map(num => parseInt(num));
                const currentYear = new Date().getFullYear();
                rowDate = new Date(currentYear, month - 1, day);
            }
            // æ ¼å¼ 4: YYYY/MM/DD
            else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateText)) {
                const [year, month, day] = dateText.split('/').map(num => parseInt(num));
                rowDate = new Date(year, month - 1, day);
            }
            // æ ¼å¼ 5: DD/MM/YYYY (æŸäº›åœ°å€æ ¼å¼)
            else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateText)) {
                const parts = dateText.split('/').map(num => parseInt(num));
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                rowDate = new Date(year, month - 1, day);
            }
            
            if (rowDate && !isNaN(rowDate.getTime())) {
                const rowTime = rowDate.getTime();
                console.log(`  æª¢æŸ¥ AdUnit æ—¥æœŸ: ${dateText} -> ${rowDate.toISOString().split('T')[0]} (${rowTime})`);
                
                if (rowTime >= startTime && rowTime <= endTime) {
                    console.log(`    âœ… AdUnit åœ¨å€æ®µå…§!`);
                    hasDataInRange = true;
                    break;
                } else {
                    console.log(`    âŒ AdUnit ä¸åœ¨å€æ®µå…§`);
                }
            } else {
                console.log(`  ç„¡æ³•è§£æ AdUnit æ—¥æœŸ: ${dateText}`);
            }
        }
        
        console.log(`AdUnit ${adunitReport.name} æœ€çµ‚çµæœ: ${hasDataInRange ? 'é¡¯ç¤º' : 'éš±è—'}`);
        return hasDataInRange;
    }
    
    // åˆä½µå¤šå€‹è¡¨æ ¼çš„å‡½æ•¸
    function mergeTables(parsedTables) {
        if (!parsedTables || parsedTables.length === 0) return null;
        
        // å–ç¬¬ä¸€å€‹è¡¨æ ¼ä½œç‚ºåŸºç¤
        const baseTable = parsedTables[0].table.cloneNode(true);
        const baseRows = baseTable.querySelectorAll('tr');
        
        if (baseRows.length < 2) return baseTable;
        
        // å»ºç«‹æ—¥æœŸåˆ°æ•¸æ“šçš„å°ç…§è¡¨
        const mergedData = {};
        let headers = [];
        
        // å–å¾—è¡¨é ­
        const headerCells = baseRows[0].querySelectorAll('th, td');
        for (let cell of headerCells) {
            headers.push(cell.textContent.trim());
        }
        
        // è™•ç†æ¯å€‹è¡¨æ ¼çš„æ•¸æ“š
        for (const {table} of parsedTables) {
            const rows = table.querySelectorAll('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td, th');
                
                if (cells.length > 0) {
                    const dateText = cells[0].textContent.trim();
                    
                    // è·³é TOTAL è¡Œ
                    if (dateText === 'TOTAL') continue;
                    
                    if (!mergedData[dateText]) {
                        mergedData[dateText] = {};
                    }
                    
                    // åˆä½µæ•¸å€¼æ•¸æ“š
                    for (let j = 1; j < cells.length; j++) {
                        const cellText = cells[j].textContent.trim();
                        
                        if (!mergedData[dateText][j]) {
                            mergedData[dateText][j] = {
                                value: 0,
                                isPercentage: false,
                                impressions: 0,
                                clicks: 0
                            };
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºç™¾åˆ†æ¯”æ¬„ä½
                        if (cellText.includes('%')) {
                            mergedData[dateText][j].isPercentage = true;
                        } else {
                            const cellValue = parseFloat(cellText.replace(/[,]/g, '')) || 0;
                            mergedData[dateText][j].value += cellValue;
                            
                            // ç‰¹åˆ¥è™•ç†æ›å…‰æ•¸å’Œé»æ“Šæ•¸ï¼Œç”¨æ–¼é‡æ–°è¨ˆç®—é»æ“Šç‡
                            if (headers[j] && (headers[j].includes('æ›å…‰æ•¸') || headers[j].includes('æ’­æ”¾æ•¸'))) {
                                mergedData[dateText][j].impressions += cellValue;
                            } else if (headers[j] && headers[j].includes('é»æ“Šæ•¸')) {
                                mergedData[dateText][j].clicks += cellValue;
                            }
                        }
                    }
                }
            }
        }
        
        // é‡å»ºè¡¨æ ¼
        const newTable = document.createElement('table');
        newTable.className = baseTable.className;
        
        // æ·»åŠ è¡¨é ­
        const headerRow = document.createElement('tr');
        for (let header of headers) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);
        
        // æ·»åŠ åˆä½µå¾Œçš„æ•¸æ“šè¡Œ
        const sortedDates = Object.keys(mergedData).sort();
        let totalImp = 0, totalClk = 0;
        
        for (const date of sortedDates) {
            const row = document.createElement('tr');
            const dateCell = document.createElement('td');
            dateCell.textContent = date;
            row.appendChild(dateCell);
            
            const rowData = mergedData[date];
            for (let j = 1; j < headers.length; j++) {
                const cell = document.createElement('td');
                const data = rowData[j] || { value: 0, isPercentage: false, impressions: 0, clicks: 0 };
                
                if (data.isPercentage) {
                    // é‡æ–°è¨ˆç®—é»æ“Šç‡/è§€çœ‹ç‡
                    let impressions = 0, clicks = 0;
                    
                    // æ‰¾åˆ°æ›å…‰æ•¸å’Œé»æ“Šæ•¸æ¬„ä½
                    for (let k = 1; k < headers.length; k++) {
                        if (headers[k].includes('æ›å…‰æ•¸') || headers[k].includes('æ’­æ”¾æ•¸')) {
                            impressions = rowData[k] ? rowData[k].value : 0;
                        } else if (headers[k].includes('é»æ“Šæ•¸')) {
                            clicks = rowData[k] ? rowData[k].value : 0;
                        }
                    }
                    
                    if (impressions > 0) {
                        cell.textContent = ((clicks / impressions) * 100).toFixed(2) + '%';
                    } else {
                        cell.textContent = '0.00%';
                    }
                } else {
                    const value = data.value;
                    if (headers[j] && (headers[j].includes('æ›å…‰æ•¸') || headers[j].includes('æ’­æ”¾æ•¸'))) {
                        totalImp += value;
                        cell.textContent = value > 0 ? value.toLocaleString() : '';
                    } else if (headers[j] && headers[j].includes('é»æ“Šæ•¸')) {
                        totalClk += value;
                        cell.textContent = value > 0 ? value.toString() : '';
                    } else {
                        cell.textContent = value > 0 ? value.toString() : '';
                    }
                }
                
                row.appendChild(cell);
            }
            
            newTable.appendChild(row);
        }
        
        // æ·»åŠ  TOTAL è¡Œ
        const totalRow = document.createElement('tr');
        const totalLabelCell = document.createElement('td');
        totalLabelCell.textContent = 'TOTAL';
        totalRow.appendChild(totalLabelCell);
        
        for (let j = 1; j < headers.length; j++) {
            const cell = document.createElement('td');
            
            if (headers[j] && (headers[j].includes('æ›å…‰æ•¸') || headers[j].includes('æ’­æ”¾æ•¸'))) {
                cell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
            } else if (headers[j] && headers[j].includes('é»æ“Šæ•¸')) {
                cell.textContent = totalClk > 0 ? totalClk.toString() : '';
            } else if (headers[j] && (headers[j].includes('é»æ“Šç‡') || headers[j].includes('è§€çœ‹ç‡'))) {
                if (totalImp > 0) {
                    cell.textContent = ((totalClk / totalImp) * 100).toFixed(2) + '%';
                } else {
                    cell.textContent = '0.00%';
                }
            }
            
            totalRow.appendChild(cell);
        }
        
        newTable.appendChild(totalRow);
        
        return newTable;
    }
    
    // é¡¯ç¤ºå€‹åˆ¥ AdSet çš„å ±è¡¨
    function displayIndividualAdsetReports() {
        let content = '';
        
        if (!allAdsetReports || Object.keys(allAdsetReports).length === 0) {
            return content;
        }
        
        content += `<div class="daily-report-section">
            <h4>ğŸ“‹ å€‹åˆ¥å»£å‘Šé›†å ±è¡¨ <button id="refreshReportBtn" class="button" style="margin-left: 10px; font-size: 12px;">ğŸ”„ é‡æ–°ç”Ÿæˆç¸½åˆå ±è¡¨</button></h4>
        `;
        
        // éæ¿¾ä¸¦é¡¯ç¤ºåœ¨æ™‚é–“å€æ®µå…§ä¸”ä¸åŒ…å« demo çš„ AdSet
        const filteredAdsets = Object.entries(allAdsetReports).filter(([adsetId, report]) => {
            return report.success && isAdsetInTimeRange(report) && !shouldFilterAdset(report);
        });
        
        if (filteredAdsets.length === 0) {
            content += `
                <div style="margin: 20px 0; padding: 15px; border: 1px solid #ffc107; border-radius: 8px; background: #fff3cd;">
                    <p style="color: #856404; margin: 0;">ğŸ“… åœ¨ç•¶å‰æ™‚é–“å€æ®µå…§æ²’æœ‰æ‰¾åˆ°ä»»ä½•å»£å‘Šé›†æ•¸æ“š</p>
                </div>
            `;
        }
        
        for (const [adsetId, report] of filteredAdsets) {
            const isCollapsed = !selectedAdsets.has(adsetId);
            const buttonText = isCollapsed ? 'â•' : 'â–';
            const buttonStyle = isCollapsed ? 'background: #6c757d; color: white;' : 'background: #28a745; color: white;';
            const displayStyle = isCollapsed ? 'display: none;' : '';
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(report.content, 'text/html');
            const table = findDailyReportTable(doc);
            
            if (table) {
                content += `
                    <div style="margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="color: #495057; margin: 0;">ğŸ“Š ${report.name}</h5>
                            <button onclick="toggleAdsetCollapse('${adsetId}')" class="button" style="${buttonStyle} font-size: 12px; padding: 6px 12px;">
                                ${buttonText}
                            </button>
                        </div>
                        <div id="adset-content-${adsetId}" style="${displayStyle}">
                            ${table.outerHTML}
                        </div>
                    </div>
                `;
                
                // æ·»åŠ è©² AdSet ä¸‹åœ¨æ™‚é–“å€æ®µå…§çš„ AdUnit å ±è¡¨
                if (adunitByAdset[adsetId] && adunitByAdset[adsetId].adunits.length > 0) {
                    // éæ¿¾åœ¨æ™‚é–“å€æ®µå…§çš„ AdUnit
                    const filteredAdunits = adunitByAdset[adsetId].adunits.filter(adunitReport => {
                        return adunitReport.success && isAdunitInTimeRange(adunitReport);
                    });
                    
                    if (filteredAdunits.length > 0) {
                        content += `
                            <div id="adunit-section-${adsetId}" style="margin: 10px 0 20px 20px; padding: 15px; border: 1px solid #28a745; border-radius: 8px; background: #f8fff9; ${displayStyle}">
                                <h6 style="color: #28a745; margin-bottom: 15px;">ğŸ¯ AdUnit å ±è¡¨ (${filteredAdunits.length} å€‹åœ¨æ™‚é–“å€æ®µå…§)</h6>
                        `;
                        
                        for (const adunitReport of filteredAdunits) {
                            const isAdunitCollapsed = !selectedAdunits.has(adunitReport.uuid);
                            const adunitButtonText = isAdunitCollapsed ? 'â•' : 'â–';
                            const adunitButtonStyle = isAdunitCollapsed ? 'background: #6c757d; color: white;' : 'background: #28a745; color: white;';
                            const adunitDisplayStyle = isAdunitCollapsed ? 'display: none;' : '';
                            
                            const adunitParser = new DOMParser();
                            const adunitDoc = adunitParser.parseFromString(adunitReport.content, 'text/html');
                            const adunitTable = findDailyReportTable(adunitDoc);
                            
                            if (adunitTable) {
                                content += `
                                    <div style="margin: 15px 0; padding: 12px; border: 1px solid #6c757d; border-radius: 6px; background: #ffffff;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <h6 style="color: #6c757d; margin: 0; font-size: 14px;">
                                                ğŸ¯ ${adunitReport.name}
                                                <span style="color: #6c757d; font-size: 12px;">(${adunitReport.uuid.slice(0, 8)}...)</span>
                                            </h6>
                                            <button onclick="toggleAdunitCollapse('${adunitReport.uuid}')" class="button" style="${adunitButtonStyle} font-size: 11px; padding: 4px 8px;">
                                                ${adunitButtonText}
                                            </button>
                                        </div>
                                        <div id="adunit-content-${adunitReport.uuid}" style="${adunitDisplayStyle}">
                                            ${adunitTable.outerHTML}
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        
                        content += `</div>`;
                    }
                }
            }
        }
        
        content += '</div>';
        return content;
    }
    
    // æ–°å¢ï¼šåˆ‡æ› AdSet æ”¶åˆç‹€æ…‹
    function toggleAdsetCollapse(adsetId) {
        const contentDiv = document.getElementById(`adset-content-${adsetId}`);
        const adunitSection = document.getElementById(`adunit-section-${adsetId}`);
        const button = event.target;
        
        if (selectedAdsets.has(adsetId)) {
            // ç•¶å‰æ˜¯å±•é–‹ç‹€æ…‹ï¼Œè¦æ”¶åˆ
            selectedAdsets.delete(adsetId);
            contentDiv.style.display = 'none';
            if (adunitSection) adunitSection.style.display = 'none';
            button.textContent = 'â•';
            button.style.background = '#6c757d';
        } else {
            // ç•¶å‰æ˜¯æ”¶åˆç‹€æ…‹ï¼Œè¦å±•é–‹
            selectedAdsets.add(adsetId);
            contentDiv.style.display = 'block';
            if (adunitSection) adunitSection.style.display = 'block';
            button.textContent = 'â–';
            button.style.background = '#28a745';
        }
    }
    
    // æ–°å¢ï¼šåˆ‡æ› AdUnit æ”¶åˆç‹€æ…‹
    function toggleAdunitCollapse(adunitUuid) {
        const contentDiv = document.getElementById(`adunit-content-${adunitUuid}`);
        const button = event.target;
        
        if (selectedAdunits.has(adunitUuid)) {
            // ç•¶å‰æ˜¯å±•é–‹ç‹€æ…‹ï¼Œè¦æ”¶åˆ
            selectedAdunits.delete(adunitUuid);
            contentDiv.style.display = 'none';
            button.textContent = 'â•';
            button.style.background = '#6c757d';
        } else {
            // ç•¶å‰æ˜¯æ”¶åˆç‹€æ…‹ï¼Œè¦å±•é–‹
            selectedAdunits.add(adunitUuid);
            contentDiv.style.display = 'block';
            button.textContent = 'â–';
            button.style.background = '#28a745';
        }
    }
    
    // å°‹æ‰¾æ¯æ—¥å ±è¡¨è¡¨æ ¼
    function findDailyReportTable(doc) {
        // å°ˆé–€æŸ¥æ‰¾æ¯æ—¥å ±è¡¨çš„è¡¨æ ¼
        let dailyReportTable = null;
        
        // æŸ¥æ‰¾åŒ…å«"æ¯æ—¥å ±è¡¨"æ–‡å­—çš„å…ƒç´ 
        const allElements = doc.querySelectorAll('*');
        let dailyReportSection = null;
        
        for (let element of allElements) {
            if (element.textContent && element.textContent.includes('æ¯æ—¥å ±è¡¨')) {
                dailyReportSection = element;
                break;
            }
        }
        
        if (dailyReportSection) {
            // æ‰¾åˆ°æ¯æ—¥å ±è¡¨æ¨™é¡Œï¼Œå°‹æ‰¾å…¶å¾Œçš„è¡¨æ ¼
            let nextElement = dailyReportSection.nextElementSibling;
            
            // å¾ªç’°æŸ¥æ‰¾è¡¨æ ¼ï¼Œå¯èƒ½éœ€è¦è·¨è¶Šä¸€äº› div å®¹å™¨
            while (nextElement) {
                if (nextElement.tagName === 'TABLE') {
                    dailyReportTable = nextElement;
                    break;
                } else if (nextElement.tagName === 'DIV') {
                    // åœ¨ div å®¹å™¨å…§æŸ¥æ‰¾è¡¨æ ¼
                    const tableInDiv = nextElement.querySelector('table');
                    if (tableInDiv) {
                        dailyReportTable = tableInDiv;
                        break;
                    }
                }
                nextElement = nextElement.nextElementSibling;
            }
        }
        
        if (!dailyReportTable) {
            // å¦‚æœæ²’æ‰¾åˆ°æ¯æ—¥å ±è¡¨è¡¨æ ¼ï¼Œå˜—è©¦é€šéè¡¨æ ¼å…§å®¹ä¾†è­˜åˆ¥
            const tables = doc.querySelectorAll('table');
            
            for (let table of tables) {
                const tableText = table.textContent || '';
                // æª¢æŸ¥è¡¨æ ¼æ˜¯å¦åŒ…å«æ—¥æœŸæ ¼å¼çš„å…§å®¹ï¼ˆYYYY-MM-DDï¼‰
                if (tableText.includes('æ’­æ”¾æ•¸') || tableText.includes('è§€çœ‹æ•¸') || 
                    tableText.includes('é»æ“Šæ•¸') || tableText.includes('è§€çœ‹ç‡') ||
                    tableText.includes('æ›å…‰æ•¸') || tableText.includes('é»æ“Šç‡') ||
                    /\d{4}-\d{2}-\d{2}/.test(tableText)) {
                    dailyReportTable = table;
                    break;
                }
            }
        }
        
        return dailyReportTable;
    }
    
    // æ ¹æ“šèµ°æœŸè¨­å®šè™•ç†è¡¨æ ¼å…§å®¹
    function processTableBySchedule(table, campaignEndDate, currentDate) {
        const clonedTable = table.cloneNode(true);
        const rows = clonedTable.querySelectorAll('tr');
        
        if (rows.length < 2) return clonedTable; // å¦‚æœæ²’æœ‰æ•¸æ“šè¡Œï¼Œç›´æ¥è¿”å›
        
        // è½‰æ›æ—¥æœŸæ ¼å¼ç”¨æ–¼æ¯”è¼ƒ
        const campaignEnd = new Date(campaignEndDate);
        const current = new Date(currentDate);
        
        // è§£æç¾æœ‰æ•¸æ“š
        const tableData = [];
        const headers = [];
        let totalRow = null;
        
        // ç²å–è¡¨é ­
        const headerCells = rows[0].querySelectorAll('th, td');
        for (let cell of headerCells) {
            headers.push(cell.textContent.trim());
        }
        
        // === æ–°å¢ï¼šè‹¥è¡¨é ­ç¼ºã€Œæ˜ŸæœŸã€ï¼Œæ’å…¥å¾ŒçºŒè‡ªå‹•è£œå€¼ ===
        let needInsertWeekCol = true;
        headers.forEach(h => {
            if (h.includes('æ˜ŸæœŸ') || h.includes('é€±')) needInsertWeekCol = false;
        });
        if (needInsertWeekCol) {
            headers.splice(1, 0, 'æ˜ŸæœŸ'); // æ—¥æœŸå¾Œæ’ä¸€æ¬„
        }
        
        // è§£ææ•¸æ“šè¡Œï¼Œè·³éTOTALè¡Œ
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length > 0) {
                const firstCellText = cells[0].textContent.trim();
                
                if (firstCellText === 'TOTAL') {
                    // ä¿å­˜TOTALè¡Œä¾›å¾ŒçºŒä½¿ç”¨
                    totalRow = row.cloneNode(true);
                    continue;
                }
                
                // å˜—è©¦è§£ææ—¥æœŸæ ¼å¼
                let rowDate = null;
                const dateText = firstCellText;
                
                // æ ¼å¼è§£æé‚è¼¯
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                    rowDate = new Date(dateText);
                } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                    const [month, day] = dateText.split('/');
                    rowDate = new Date(current.getFullYear(), parseInt(month) - 1, parseInt(day));
                } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                    const [month, day] = dateText.split('-');
                    rowDate = new Date(current.getFullYear(), parseInt(month) - 1, parseInt(day));
                }
                
                if (rowDate) {
                    const rowData = [];
                    for (let j = 0; j < cells.length; j++) {
                        rowData.push(cells[j].textContent.trim());
                    }
                    // after rowData push å®Œ
                    if (needInsertWeekCol) {
                        const weekStr = getWeekdayInChinese(rowDate);
                        rowData.splice(1, 0, weekStr); // æŠŠæ˜ŸæœŸå¡«åˆ°ç¬¬ 2 æ ¼
                    }
                    tableData.push({
                        date: rowDate,
                        dateText: dateText,
                        data: rowData,
                        hasData: true
                    });
                }
            }
        }
        
        // ç”Ÿæˆå®Œæ•´çš„æ—¥æœŸç¯„åœï¼ˆå¾æœ€æ—©çš„æ•¸æ“šæ—¥æœŸåˆ°èµ°æœŸçµæŸæ—¥æœŸï¼‰
        let startDate = null;
        let endDate = campaignEnd;
        
        if (tableData.length > 0) {
            // æ‰¾åˆ°æœ€æ—©çš„æ•¸æ“šæ—¥æœŸ
            startDate = new Date(Math.min(...tableData.map(item => item.date.getTime())));
            
            // å¦‚æœæœ‰æ•¸æ“šçš„æœ€å¾Œæ—¥æœŸæ™šæ–¼èµ°æœŸçµæŸæ—¥æœŸï¼Œå‰‡æ“´å±•åˆ°è©²æ—¥æœŸ
            const lastDataDate = new Date(Math.max(...tableData.map(item => item.date.getTime())));
            if (lastDataDate > endDate) {
                endDate = lastDataDate;
            }
        } else {
            // å¦‚æœæ²’æœ‰ç¾æœ‰æ•¸æ“šï¼Œå¾ç•¶å‰æ—¥æœŸé–‹å§‹åˆ°èµ°æœŸçµæŸ
            startDate = current;
        }
        
        // ç”Ÿæˆå®Œæ•´çš„æ—¥æœŸåºåˆ—
        const completeData = [];
        const currentDateIter = new Date(startDate);
        
        while (currentDateIter <= endDate) {
            const dateStr = formatDateToMatch(currentDateIter, tableData.length > 0 ? tableData[0].dateText : null);
            const weekday = getWeekdayInChinese(currentDateIter);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰æ•¸æ“š
            const existingData = tableData.find(item => 
                item.date.getTime() === currentDateIter.getTime()
            );
            
            if (existingData) {
                // ä½¿ç”¨ç¾æœ‰æ•¸æ“š
                completeData.push(existingData);
            } else {
                // å‰µå»ºç©ºç™½è¡Œ
                const emptyRowData = [dateStr, weekday];
                
                // æ ¹æ“šè¡¨é ­æ•¸é‡å¡«å……ç©ºç™½æ¬„ä½
                for (let i = 2; i < headers.length; i++) {
                    emptyRowData.push('');
                }
                
                completeData.push({
                    date: new Date(currentDateIter),
                    dateText: dateStr,
                    data: emptyRowData,
                    hasData: false
                });
            }
            
            // ç§»åˆ°ä¸‹ä¸€å¤©
            currentDateIter.setDate(currentDateIter.getDate() + 1);
        }
        
        // é‡æ–°æ§‹å»ºè¡¨æ ¼
        const newTable = document.createElement('table');
        newTable.className = clonedTable.className;
        
        // æ·»åŠ è¡¨é ­
        const headerRow = document.createElement('tr');
        for (let header of headers) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);
        
        // æ·»åŠ æ•¸æ“šè¡Œ
        for (let item of completeData) {
            const row = document.createElement('tr');
            
            for (let i = 0; i < item.data.length; i++) {
                const cell = document.createElement('td');
                
                if (!item.hasData && i >= 2) {
                    // å°æ–¼ç©ºç™½æ•¸æ“šï¼Œé¡¯ç¤ºç‰¹æ®Šæ¨™è¨˜
                    if (item.date > current) {
                        cell.innerHTML = '<span style="color: #ccc;">â€”</span>';
                        cell.style.backgroundColor = '#f8f9fa';
                    } else if (item.date > campaignEnd) {
                        cell.innerHTML = '<span style="color: #ccc;">â€”</span>';
                        cell.style.backgroundColor = '#fff3cd';
                    } else {
                        cell.innerHTML = '<span style="color: #ccc;">â€”</span>';
                        cell.style.backgroundColor = '#f8f9fa';
                    }
                } else {
                    cell.textContent = item.data[i] || '';
                }
                
                row.appendChild(cell);
            }
            
            // æ·»åŠ æœªåˆ°æœŸçš„è¦–è¦ºæ¨™ç¤º
            if (!item.hasData) {
                if (item.date > current) {
                    row.style.backgroundColor = '#f8f9fa';
                    row.style.opacity = '0.6';
                    row.firstChild.innerHTML += ' <span style="color: #ffc107;"></span>';
                } else if (item.date > campaignEnd) {
                    row.style.backgroundColor = '#fff3cd';
                    row.style.opacity = '0.8';
                    row.firstChild.innerHTML += ' <span style="color: #dc3545;">ğŸ“…</span>';
                }
            }
            
            newTable.appendChild(row);
        }
        
        // æ·»åŠ TOTALè¡Œ
        if (totalRow) {
            newTable.appendChild(totalRow);
        }
        
        return newTable;
    }
    
    // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸä»¥åŒ¹é…ç¾æœ‰æ ¼å¼
    function formatDateToMatch(date, sampleDateText) {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        
        if (!sampleDateText) {
            return `${month}/${day}`;
        }
        
        // æ ¹æ“šæ¨£æœ¬æ ¼å¼æ±ºå®šè¼¸å‡ºæ ¼å¼
        if (sampleDateText.includes('-')) {
            if (sampleDateText.length > 5) {
                // YYYY-MM-DD æ ¼å¼
                return `${date.getFullYear()}-${month}-${day}`;
            } else {
                // MM-DD æ ¼å¼
                return `${month}-${day}`;
            }
        } else {
            // MM/DD æ ¼å¼
            return `${month}/${day}`;
        }
    }
    
    // è¼”åŠ©å‡½æ•¸ï¼šç²å–ä¸­æ–‡æ˜ŸæœŸ
    function getWeekdayInChinese(date) {
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        return weekdays[date.getDay()];
    }
    
    // åˆå§‹åŒ–é è¨­æ—¥æœŸ
    setDefaultDates();
    
    // å•Ÿç”¨å°å‡ºæŒ‰éˆ•
    function enableExportButton() {
        const exportBtn = document.getElementById('exportExcel');
        exportBtn.disabled = false;
    }
    
    // ç”¢å‡º Excel å ±è¡¨
    async function exportToExcel() {
        if (!currentReportData) {
            alert('è«‹å…ˆå–å¾—å ±è¡¨è³‡æ–™');
            return;
        }

        try {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('å»£å‘Šå ±è¡¨');
            
            // è¨­å®šæ¬„å¯¬
            worksheet.columns = [
                { width: 4, },   // A å¤–æ¡†
                { width: 12 },  // B æ—¥æœŸ
                { width: 15 },   // C æ˜ŸæœŸ
                { width: 15 },  // D æ›å…‰
                { width: 20 },  // E é»æ“Š
                { width: 28 },  // F CTR
                { width: 15 },  // G cut1
                { width: 15 },  // H cut2
                { width: 15 },  // I æ–‡æ¡ˆ
                { width: 15 }   // J ç©ºç™½
            ];
            
            worksheet.properties.defaultRowHeight = 26;

            // å®šç¾©æ¨£å¼ç‰©ä»¶
            const styles = {
                header: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                orangeHeader: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE67E22' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                normal: {
                    font: { 
                        name: 'Helvetica',
                        size: 13 
                    },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                total: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFDA66' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                redFont: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        color: { argb: 'FFFF0000' }, 
                        size: 13 
                    },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                grayBg: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                whiteBg: {
                    font: { 
                        name: 'Helvetica',
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                emptyRow: {
                    font: { 
                        name: 'Helvetica',
                        color: { argb: 'FF999999' }, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8F9FA' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                yellowBg: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        size: 13 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF2CB' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                },
                sectionHeader: {
                    font: { 
                        name: 'Helvetica',
                        bold: true, 
                        color: { argb: 'FFFFFFFF' }, 
                        size: 14 
                    },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2E7D32' } },
                    alignment: { vertical: 'middle', horizontal: 'center' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                }
            };

            // æ¨£å¼å¥—ç”¨è¼”åŠ©å‡½æ•¸
            function applyStyle(cell, style) {
                if (style.font) cell.font = style.font;
                if (style.fill) cell.fill = style.fill;
                if (style.alignment) cell.alignment = style.alignment;
                if (style.border) cell.border = style.border;
            }

            // å–å¾—å»£å‘Šé›†è³‡è¨Š
            const adsetInfo = currentAdsetInfo || {};
            const pricing = adsetInfo.pricing || { bMode: 'CPC', price: 7.0, currency: 'TWD' };
            const info = adsetInfo.info || { name: 'æœªçŸ¥æ´»å‹•', adType: 'åŸç”Ÿäº’å‹•å»£å‘Š', budget: 0 };
            
            const activityName = info.name || 'è«‹å¡«å…¥æ´»å‹•åç¨±';
            let adTypeDisplay = info.adType || 'NATIVE';
            if (adTypeDisplay === 'NATIVE') {
                adTypeDisplay = 'åŸç”Ÿå»£å‘Š';
            }
            // å„ªå…ˆä½¿ç”¨å¾ Campaign å–å¾—çš„ç¸½é ç®—
            const totalBudget = info.campaignBudget !== undefined ? info.campaignBudget : (info.parsedBudget > 0 ? info.parsedBudget : (info.budget || 10000));
            const pricingMode = pricing.bMode || 'CPC';
            const pricingPrice = pricing.price || 7.0;
            const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
            
            // è¨ˆç®—èµ°æœŸç›¸é—œæ•¸æ“š
            const campaignEndDate = currentReportData.campaignEndDate;
            const currentDate = currentReportData.currentDate;
            let remainingDays = 0;
            let isOngoing = true;
            
            if (campaignEndDate && currentDate) {
                const endDate = new Date(campaignEndDate);
                const today = new Date(currentDate);
                const timeDiff = endDate.getTime() - today.getTime();
                remainingDays = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                isOngoing = remainingDays > 0;
            }

            let currentRow = 1;

            // 1. æ’å…¥ Logo åœ–ç‰‡ï¼ˆåŒåŸæœ¬é‚è¼¯ï¼‰
            let logoInserted = false;
            
            // å˜—è©¦è¼‰å…¥æœ¬åœ° logo åœ–ç‰‡
            try {
                const response = await fetch('/static/images/logo.png');
                if (response.ok) {
                    const imageBuffer = await response.arrayBuffer();
                    const imageId = workbook.addImage({
                        buffer: imageBuffer,
                        extension: 'jpeg',
                    });
                    
                    worksheet.addImage(imageId, {
                        tl: { col: 1, row: 1 },
                        ext: { width: 200, height: 60 }
                    });
                    logoInserted = true;
                    console.log('âœ… Logo åœ–ç‰‡è¼‰å…¥æˆåŠŸ');
                }
            } catch (error) {
                console.warn('âš ï¸ æœ¬åœ° logo åœ–ç‰‡è¼‰å…¥å¤±æ•—:', error);
            }
            
            if (!logoInserted) {
                try {
                    const cdnUrl = 'https://static.ottercdn.com/trek/media/e19b2b54-641e-4519-a34f-a84deeea878e.png';
                    
                    if (cdnUrl) {
                        console.log('ğŸ”„ å˜—è©¦ CDN å‚™æ¡ˆ...', cdnUrl);
                        const response = await fetch(cdnUrl);
                        if (response.ok) {
                            const imageBuffer = await response.arrayBuffer();
                            const imageId = workbook.addImage({
                                buffer: imageBuffer,
                                extension: 'jpeg',
                            });
                            
                            worksheet.addImage(imageId, {
                                tl: { col: 1, row: 1 },
                                ext: { width: 80, height: 40 }
                            });
                            logoInserted = true;
                            console.log('âœ… CDN Logo åœ–ç‰‡è¼‰å…¥æˆåŠŸ');
                        }
                    }
                } catch (cdnError) {
                    console.warn('âš ï¸ CDN logo åœ–ç‰‡è¼‰å…¥å¤±æ•—:', cdnError);
                }
            }
            
            if (!logoInserted) {
                worksheet.getCell('B2').value = 'ASEAL';
                applyStyle(worksheet.getCell('B2'), styles.grayBg);
                worksheet.getCell('B2').font = { bold: true, size: 14 };
                console.log('ğŸ“ ä½¿ç”¨æ–‡å­— Logo å‚™æ¡ˆ');
            }

            // 2. é ‚éƒ¨è³‡è¨Šå€åŸŸï¼ˆç¬¬2-3è¡Œï¼‰
            worksheet.getCell('D2').value = 'æ´»å‹•åç¨±';
            applyStyle(worksheet.getCell('D2'), styles.grayBg);
            worksheet.getCell('E2').value = activityName;
            applyStyle(worksheet.getCell('E2'), styles.whiteBg);
            worksheet.getCell('G2').value = 'ç¸½é ç®—';
            applyStyle(worksheet.getCell('G2'), styles.grayBg);
            worksheet.getCell('H2').value = `${currency}${totalBudget.toLocaleString()}`;
            applyStyle(worksheet.getCell('H2'), styles.whiteBg);

            worksheet.getCell('D3').value = 'å»£å‘Šé¡å‹';
            applyStyle(worksheet.getCell('D3'), styles.grayBg);
            worksheet.getCell('E3').value = adTypeDisplay;
            applyStyle(worksheet.getCell('E3'), styles.whiteBg);
            worksheet.getCell('G3').value = 'èµ°æœŸé ç®—';
            applyStyle(worksheet.getCell('G3'), styles.grayBg);
            worksheet.getCell('H3').value = `${currency}${totalBudget.toLocaleString()}`;
            applyStyle(worksheet.getCell('H3'), styles.whiteBg);
            worksheet.getCell('H3').font = { bold: true, size: 13, name: 'Helvetica' };

            // åˆä½µå„²å­˜æ ¼
            worksheet.mergeCells('B2:C3'); // Logo å€åŸŸ
            worksheet.mergeCells('E2:F2'); // æ´»å‹•åç¨±å€¼
            worksheet.mergeCells('E3:F3'); // å»£å‘Šé¡å‹å€¼
            
            // 3. å‰©é¤˜æ•¸æ“šè¡Œï¼ˆç¬¬4-5è¡Œï¼‰
            const remainingDailyValue = calculateRemainingDailyValue(totalBudget, pricingMode, pricingPrice, remainingDays);

            worksheet.getCell('B4').value = 'å‰©é¤˜å¤©æ•¸';
            applyStyle(worksheet.getCell('B4'), styles.grayBg);
            worksheet.getCell('C4').value = `(${remainingDays})`;
            applyStyle(worksheet.getCell('C4'), styles.redFont);
            worksheet.getCell('D4').value = 'è¨ˆåƒ¹æ–¹å¼';
            applyStyle(worksheet.getCell('D4'), styles.grayBg);
            worksheet.getCell('E4').value = pricingMode;
            applyStyle(worksheet.getCell('E4'), styles.whiteBg);
            worksheet.getCell('F4').value = `${currency}${pricingPrice}`;
            applyStyle(worksheet.getCell('F4'), styles.whiteBg);
            worksheet.getCell('G4').value = 'å‰©é¤˜èŠ±è²»';
            applyStyle(worksheet.getCell('G4'), styles.grayBg);
            worksheet.getCell('H4').value = isOngoing ? `${currency}${Math.max(0, remainingDailyValue.remainingBudget).toLocaleString()}` : '(å·²çµæŸ)';
            applyStyle(worksheet.getCell('H4'), styles.redFont);

            worksheet.getCell('B5').value = 'å‰©é¤˜æ¯æ—¥';
            applyStyle(worksheet.getCell('B5'), styles.grayBg);
            worksheet.getCell('C5').value = remainingDailyValue.remainingDaily;
            applyStyle(worksheet.getCell('C5'), styles.redFont);
            worksheet.getCell('D5').value = 'å»£å‘Šç›®æ¨™';
            applyStyle(worksheet.getCell('D5'), styles.grayBg);
            worksheet.getCell('E5').value = remainingDailyValue.targetCount.toLocaleString();
            applyStyle(worksheet.getCell('E5'), styles.whiteBg);
            worksheet.getCell('F5').value = remainingDailyValue.targetUnit;
            applyStyle(worksheet.getCell('F5'), styles.whiteBg);
            worksheet.getCell('G5').value = remainingDailyValue.remainingLabel;
            applyStyle(worksheet.getCell('G5'), styles.grayBg);
            worksheet.getCell('H5').value = isOngoing ? Math.max(0, remainingDailyValue.remainingAmount) : '0';
            applyStyle(worksheet.getCell('H5'), styles.redFont);

            currentRow = 7;

            // 4. ç¸½åˆå ±è¡¨å€æ®µ
            currentRow = await addMergedReportSection(worksheet, styles, currentRow, applyStyle);

            // 5. å€‹åˆ¥ AdSet å ±è¡¨å€æ®µ
            if (currentReportData.allAdsetReports) {
                currentRow = await addIndividualAdsetSections(worksheet, styles, currentRow, applyStyle);
            }

            // ç”¢å‡ºæª”æ¡ˆ
            const buffer = await workbook.xlsx.writeBuffer({ useStyles: true });
            const blob = new Blob([buffer], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å»£å‘Šå ±è¡¨_${currentReportData.campaignId.slice(0,8)}_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const totalDataRows = countTotalDataRows();
            const hasDataRows = countHasDataRows();
            const emptyRows = totalDataRows - hasDataRows;
            
            let successMessage = `âœ… Excel å ±è¡¨å·²æˆåŠŸç”¢å‡ºï¼æª”æ¡ˆå·²ä¸‹è¼‰ã€‚`;
            
            if (currentAdsetInfo && currentAdsetInfo.success) {
                const budgetSource = info.campaignBudget !== undefined ? 'å¾ Campaign å–å¾—' : (info.parsedBudget > 0 ? 'å¾æ´»å‹•åç¨±è§£æ' : 'ä½¿ç”¨åŸå§‹é ç®—');
                const scheduleInfo = remainingDays > 0 ? `å‰©é¤˜ ${remainingDays} å¤©` : 'æ´»å‹•å·²çµæŸ';
                const adsetCount = info.adsetCount || 1;
                
                // è¨ˆç®—é¸æ“‡çš„çµ±è¨ˆ
                const totalAvailableAdsets = Object.keys(currentReportData.allAdsetReports || {}).filter(id => currentReportData.allAdsetReports[id].success).length;
                const selectedAdsetCount = selectedAdsets.size;
                
                const totalAvailableAdunits = Object.keys(currentReportData.allAdunitReports || {}).filter(id => currentReportData.allAdunitReports[id].success).length;
                const selectedAdunitCount = selectedAdunits.size;
                
                // æ•ˆèƒ½è³‡è¨Š
                let performanceInfo = '';
                if (window.adunitQuerySummary) {
                    const summary = window.adunitQuerySummary;
                    const method = summary.processing_method === 'batch_processing' ? 'åˆ†æ‰¹è™•ç†' : 'ä¸¦è¡Œè™•ç†';
                    const batchInfo = summary.total_batches ? ` (${summary.total_batches} æ‰¹æ¬¡, æ¯æ‰¹ ${summary.batch_size} å€‹)` : ` (${summary.max_workers || 0} åŸ·è¡Œç·’)`;
                    performanceInfo = `\n- æŸ¥è©¢æ•ˆèƒ½ï¼š${summary.query_duration}ç§’ ${method}${batchInfo}`;
                }
                
                successMessage += `\nğŸ“Š å·²åŒ¯å‡ºé¸æ“‡çš„å ±è¡¨å…§å®¹ï¼š\n- æ´»å‹•åç¨±ï¼š${activityName}\n- é¸æ“‡çš„å»£å‘Šé›†ï¼š${selectedAdsetCount}/${totalAvailableAdsets} å€‹\n- é¸æ“‡çš„ AdUnitï¼š${selectedAdunitCount}/${totalAvailableAdunits} å€‹${performanceInfo}\n- è¨ˆåƒ¹æ–¹å¼ï¼š${pricingMode} (${currency}${pricingPrice})\n- ç¸½é ç®—ï¼š${currency}${totalBudget.toLocaleString()} (${budgetSource})\n- èµ°æœŸç‹€æ…‹ï¼š${scheduleInfo}\nğŸ“… åŒ…å«ç¸½åˆæ•¸æ“šã€${selectedAdsetCount} å€‹å»£å‘Šé›†è©³ç´°æ•¸æ“šï¼Œä»¥åŠ ${selectedAdunitCount} å€‹ AdUnit è©³ç´°æ•¸æ“š`;
            }
            alert(successMessage);

        } catch (err) {
            console.error('ç”¢å‡º Excel å ±è¡¨å¤±æ•—:', err);
            alert('âŒ ç”¢å‡º Excel å ±è¡¨å¤±æ•—ï¼š' + err.message);
        }
    }

    // è¨ˆç®—å‰©é¤˜æ¯æ—¥æ•¸å€¼çš„è¼”åŠ©å‡½æ•¸
    function calculateRemainingDailyValue(totalBudget, pricingMode, pricingPrice, remainingDays) {
        // è§£æè¡¨æ ¼æ•¸æ“šä»¥è¨ˆç®—å·²ä½¿ç”¨çš„é ç®—
        const trs = currentReportData.table.querySelectorAll('tr');
        let sumImp = 0, sumClk = 0;
        
        for (let i = 1; i < trs.length; i++) {
            const td = trs[i].querySelectorAll('td,th');
            if (td.length < 2) continue;
            
            const date = td[0].textContent.trim();
            if (date === 'TOTAL') continue;
            
            // æå–æ›å…‰æ•¸å’Œé»æ“Šæ•¸
            if (td.length > 2) {
                const imp = +(td[2].textContent.replace(/[,â€”]/g,'')) || 0;
                sumImp += imp;
            }
            if (td.length > 3) {
                const clk = +(td[3].textContent.replace(/[,â€”]/g,'')) || 0;
                sumClk += clk;
            }
        }
        
        let targetUnit = 'clicks', targetCount = 0, remainingLabel = 'å‰©é¤˜é»æ“Šæ•¸';
        let remainingAmount = 0, remainingBudget = 0;
        
        if (pricingMode === 'CPM') {
            targetUnit = 'impressions';
            remainingLabel = 'å‰©é¤˜æ›å…‰æ•¸';
            targetCount = Math.floor((totalBudget / pricingPrice) * 1000);
            remainingBudget = totalBudget - ((sumImp * pricingPrice) / 1000);
            remainingAmount = Math.floor((remainingBudget / pricingPrice) * 1000);
        } else if (pricingMode === 'CPV') {
            targetUnit = 'views';
            remainingLabel = 'å‰©é¤˜è§€çœ‹æ•¸';
            targetCount = Math.floor(totalBudget / pricingPrice);
            remainingBudget = totalBudget - (sumClk * pricingPrice);
            remainingAmount = Math.floor(remainingBudget / pricingPrice);
        } else {
            targetUnit = 'clicks';
            remainingLabel = 'å‰©é¤˜é»æ“Šæ•¸';
            targetCount = Math.floor(totalBudget / pricingPrice);
            remainingBudget = totalBudget - (sumClk * pricingPrice);
            remainingAmount = Math.floor(remainingBudget / pricingPrice);
        }
        
        const remainingDaily = (remainingDays > 0 && remainingAmount > 0) ? 
            Math.ceil(Math.max(0, remainingAmount) / remainingDays) : 0;

        return {
            targetUnit,
            targetCount,
            remainingLabel,
            remainingAmount,
            remainingBudget,
            remainingDaily
        };
    }

    // æ·»åŠ ç¸½åˆå ±è¡¨å€æ®µ
    async function addMergedReportSection(worksheet, styles, startRow, applyStyle) {
        // æ·»åŠ å€æ®µæ¨™é¡Œ
        worksheet.mergeCells(startRow, 2, startRow, 9);
        const sectionCell = worksheet.getCell(startRow, 2);
        sectionCell.value = 'ğŸ“ˆ ç¸½åˆå ±è¡¨æ•¸æ“š';
        applyStyle(sectionCell, styles.sectionHeader);
        
        let currentRow = startRow + 2;
        
        // è§£æç¸½åˆè¡¨æ ¼æ•¸æ“š
        const trs = currentReportData.table.querySelectorAll('tr');
        const headerRow = trs[0];
        const headers = Array.from(headerRow.querySelectorAll('th,td')).map(h => h.textContent.trim());
        
        // æ·»åŠ è¡¨é ­
            for (let i = 0; i < headers.length; i++) {
            const cell = worksheet.getCell(currentRow, i + 2);
                cell.value = headers[i];
                applyStyle(cell, (i < 5) ? styles.header : styles.orangeHeader);
            }
        currentRow++;
        
        // æ·»åŠ æ•¸æ“šè¡Œ
        for (let i = 1; i < trs.length; i++) {
            const td = trs[i].querySelectorAll('td,th');
            if (td.length < 2) continue;
            
            const date = td[0].textContent.trim();
            
            for (let j = 0; j < td.length; j++) {
                const cell = worksheet.getCell(currentRow, j + 2);
                const cellValue = td[j].textContent.trim();
                
                if (!isNaN(cellValue.replace(/[,]/g, '')) && cellValue !== '') {
                    cell.value = +cellValue.replace(/[,]/g, '');
                } else {
                    cell.value = cellValue;
                }
                
                if (date === 'TOTAL') {
                    applyStyle(cell, styles.total);
                    if (cellValue.includes('%')) {
                        cell.font = { bold: true, color: { argb: 'FFFF0000' }, size: 13, name: 'Helvetica' };
                    }
                } else {
                    applyStyle(cell, styles.normal);
                }
                }
                currentRow++;
            }

        return currentRow + 2; // ç•™ä¸€äº›ç©ºé–“
    }

    // æ·»åŠ å€‹åˆ¥ AdSet å ±è¡¨å€æ®µ
    async function addIndividualAdsetSections(worksheet, styles, startRow, applyStyle) {
        let currentRow = startRow;
        
        // æ·»åŠ å€‹åˆ¥å ±è¡¨å€æ®µæ¨™é¡Œ
        worksheet.mergeCells(currentRow, 2, currentRow, 9);
        const sectionCell = worksheet.getCell(currentRow, 2);
        sectionCell.value = 'ğŸ“‹ å€‹åˆ¥å»£å‘Šé›†å ±è¡¨';
        applyStyle(sectionCell, styles.sectionHeader);
        
        currentRow += 2;
        
        // è™•ç†æ¯å€‹é¸ä¸­çš„ AdSet çš„å ±è¡¨ï¼ˆéæ¿¾æ‰åŒ…å« demo çš„ï¼‰
        for (const [adsetId, report] of Object.entries(currentReportData.allAdsetReports)) {
            if (!selectedAdsets.has(adsetId)) {
                continue; // è·³éæœªé¸ä¸­çš„ AdSet
            }
            
            // éæ¿¾åŒ…å« demo çš„ AdSet
            if (shouldFilterAdset(report)) {
                console.log(`Excel å°å‡ºæ™‚éæ¿¾æ‰åŒ…å« demo çš„ AdSet: ${report.name}`);
                continue;
            }
            
            if (report.success) {
                // æ·»åŠ  AdSet åç¨±
                worksheet.mergeCells(currentRow, 2, currentRow, 9);
                const adsetTitleCell = worksheet.getCell(currentRow, 2);
                adsetTitleCell.value = `ğŸ“Š ${report.name}`;
                adsetTitleCell.font = { name: 'Helvetica', bold: true, size: 12, color: { argb: 'FF2E7D32' } };
                adsetTitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
                
                currentRow += 1;
                
                // è§£æä¸¦æ·»åŠ  AdSet è¡¨æ ¼
                const parser = new DOMParser();
                const doc = parser.parseFromString(report.content, 'text/html');
                const table = findDailyReportTable(doc);
                
                if (table) {
                    const rows = table.querySelectorAll('tr');
                    
                    // æ·»åŠ è¡¨é ­
                    const headerCells = rows[0].querySelectorAll('th,td');
                    for (let j = 0; j < headerCells.length; j++) {
                        const cell = worksheet.getCell(currentRow, j + 2);
                        cell.value = headerCells[j].textContent.trim();
                        applyStyle(cell, (j < 5) ? styles.header : styles.orangeHeader);
                    }
                    currentRow++;
                    
                    // æ·»åŠ æ•¸æ“šè¡Œ
                    for (let i = 1; i < rows.length; i++) {
                        const rowCells = rows[i].querySelectorAll('td,th');
                        if (rowCells.length < 2) continue;
                        
                        const date = rowCells[0].textContent.trim();
                        
                        for (let j = 0; j < rowCells.length; j++) {
                            const cell = worksheet.getCell(currentRow, j + 2);
                            const cellValue = rowCells[j].textContent.trim();
                            
                            if (!isNaN(cellValue.replace(/[,]/g, '')) && cellValue !== '') {
                                cell.value = +cellValue.replace(/[,]/g, '');
                            } else {
                                cell.value = cellValue;
                            }
                            
                            if (date === 'TOTAL') {
                    applyStyle(cell, styles.total);
                                if (cellValue.includes('%')) {
                                    cell.font = { bold: true, color: { argb: 'FFFF0000' }, size: 13, name: 'Helvetica' };
                                }
                } else {
                                applyStyle(cell, styles.normal);
                            }
                        }
                        currentRow++;
                    }
                }
                
                // æ·»åŠ è©² AdSet ä¸‹çš„é¸ä¸­ AdUnit å ±è¡¨
                if (adunitByAdset[adsetId] && adunitByAdset[adsetId].adunits.length > 0) {
                    // éæ¿¾é¸ä¸­çš„ AdUnit
                    const selectedAdunitReports = adunitByAdset[adsetId].adunits.filter(
                        adunitReport => selectedAdunits.has(adunitReport.uuid)
                    );
                    
                    if (selectedAdunitReports.length > 0) {
                        currentRow += 1;
                        
                        // æ·»åŠ  AdUnit å€æ®µæ¨™é¡Œ
                        worksheet.mergeCells(currentRow, 2, currentRow, 9);
                        const adunitSectionCell = worksheet.getCell(currentRow, 2);
                        adunitSectionCell.value = `ğŸ¯ AdUnit å ±è¡¨ (${selectedAdunitReports.length} å€‹å·²é¸æ“‡)`;
                        adunitSectionCell.font = { name: 'Helvetica', bold: true, size: 11, color: { argb: 'FF28A745' } };
                        adunitSectionCell.alignment = { vertical: 'middle', horizontal: 'left' };
                        
                        currentRow += 1;
                        
                        for (const adunitReport of selectedAdunitReports) {
                            if (adunitReport.success) {
                                // æ·»åŠ  AdUnit åç¨±
                                worksheet.mergeCells(currentRow, 2, currentRow, 9);
                                const adunitTitleCell = worksheet.getCell(currentRow, 2);
                                adunitTitleCell.value = `ğŸ¯ ${adunitReport.name} (${adunitReport.uuid.slice(0, 8)}...)`;
                                adunitTitleCell.font = { name: 'Helvetica', bold: true, size: 10, color: { argb: 'FF6C757D' } };
                                adunitTitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
                                
                                currentRow += 1;
                                
                                // è§£æä¸¦æ·»åŠ  AdUnit è¡¨æ ¼
                                const adunitParser = new DOMParser();
                                const adunitDoc = adunitParser.parseFromString(adunitReport.content, 'text/html');
                                const adunitTable = findDailyReportTable(adunitDoc);
                                
                                if (adunitTable) {
                                    const adunitRows = adunitTable.querySelectorAll('tr');
                                    
                                    // æ·»åŠ  AdUnit è¡¨é ­
                                    const adunitHeaderCells = adunitRows[0].querySelectorAll('th,td');
                                    for (let j = 0; j < adunitHeaderCells.length; j++) {
                                        const cell = worksheet.getCell(currentRow, j + 2);
                                        cell.value = adunitHeaderCells[j].textContent.trim();
                                        applyStyle(cell, (j < 5) ? styles.header : styles.orangeHeader);
                                    }
                                    currentRow++;
                                    
                                    // æ·»åŠ  AdUnit æ•¸æ“šè¡Œ
                                    for (let i = 1; i < adunitRows.length; i++) {
                                        const adunitRowCells = adunitRows[i].querySelectorAll('td,th');
                                        if (adunitRowCells.length < 2) continue;
                                        
                                        const date = adunitRowCells[0].textContent.trim();
                                        
                                        for (let j = 0; j < adunitRowCells.length; j++) {
                                            const cell = worksheet.getCell(currentRow, j + 2);
                                            const cellValue = adunitRowCells[j].textContent.trim();
                                            
                                            if (!isNaN(cellValue.replace(/[,]/g, '')) && cellValue !== '') {
                                                cell.value = +cellValue.replace(/[,]/g, '');
                                            } else {
                                                cell.value = cellValue;
                                            }
                                            
                                            if (date === 'TOTAL') {
                    applyStyle(cell, styles.total);
                                                if (cellValue.includes('%')) {
                                                    cell.font = { bold: true, color: { argb: 'FFFF0000' }, size: 13, name: 'Helvetica' };
                                                }
                                            } else {
                                                applyStyle(cell, styles.normal);
                                            }
                                        }
                                        currentRow++;
                                    }
                                }
                            } else {
                                // é¡¯ç¤ºå¤±æ•—çš„ AdUnit
                                worksheet.mergeCells(currentRow, 2, currentRow, 9);
                                const errorCell = worksheet.getCell(currentRow, 2);
                                errorCell.value = `âŒ ${adunitReport.name} (${adunitReport.uuid.slice(0, 8)}...) - æŸ¥è©¢å¤±æ•—: ${adunitReport.error}`;
                                errorCell.font = { name: 'Helvetica', bold: true, size: 10, color: { argb: 'FFDC3545' } };
                                errorCell.alignment = { vertical: 'middle', horizontal: 'left' };
                                currentRow += 1;
                            }
                            
                            currentRow += 1; // åœ¨æ¯å€‹ AdUnit ä¹‹é–“ç•™ç©ºé–“
                        }
                    }
                }
            } else {
                // é¡¯ç¤ºå¤±æ•—çš„ AdSet
                worksheet.mergeCells(currentRow, 2, currentRow, 9);
                const errorCell = worksheet.getCell(currentRow, 2);
                errorCell.value = `âŒ ${report.name} - æŸ¥è©¢å¤±æ•—: ${report.error}`;
                errorCell.font = { name: 'Helvetica', bold: true, size: 12, color: { argb: 'FFDC3545' } };
                errorCell.alignment = { vertical: 'middle', horizontal: 'left' };
                currentRow += 1;
            }
            
            currentRow += 2; // åœ¨æ¯å€‹ AdSet ä¹‹é–“ç•™ç©ºé–“
        }
        
        return currentRow;
    }

    // è¨ˆç®—ç¸½æ•¸æ“šè¡Œæ•¸çš„è¼”åŠ©å‡½æ•¸
    function countTotalDataRows() {
        if (!currentReportData.table) return 0;
        const rows = currentReportData.table.querySelectorAll('tr');
        return Math.max(0, rows.length - 1); // æ‰£é™¤è¡¨é ­
    }

    // è¨ˆç®—æœ‰æ•¸æ“šçš„è¡Œæ•¸çš„è¼”åŠ©å‡½æ•¸
    function countHasDataRows() {
        if (!currentReportData.table) return 0;
        const rows = currentReportData.table.querySelectorAll('tr');
        let count = 0;
        
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].querySelectorAll('td,th');
            if (cells.length > 2) {
                const cellContent = cells[2].textContent.trim();
                if (cellContent && cellContent !== 'â€”' && cellContent !== 'TOTAL') {
                    count++;
                }
            }
        }
        
        return count;
    }

    // å»ºæ§‹ slide å»£å‘Šå ±è¡¨è¡¨æ ¼ï¼ˆåŒ…å« cut æ•¸æ“šï¼‰
    function buildSlideReportTable(originalTable, cutData) {
        // è§£æåŸå§‹è¡¨æ ¼
        const rows = originalTable.querySelectorAll('tr');
        if (rows.length < 2) return originalTable;

        // è§£æè¡¨é ­
        const originalHeaders = Array.from(rows[0].querySelectorAll('th, td')).map(h => h.textContent.trim());
        
        // æ‰¾å‡ºå„æ¬„ä½çš„ç´¢å¼•ä½ç½®
        let dateIndex = -1, impIndex = -1, clkIndex = -1, ctrIndex = -1;
        originalHeaders.forEach((header, index) => {
            if (header.includes('æ—¥æœŸ')) dateIndex = index;
            else if (header.includes('æ›å…‰æ•¸') || header.includes('æ’­æ”¾æ•¸')) impIndex = index;
            else if (header.includes('é»æ“Šæ•¸')) clkIndex = index;
            else if (header.includes('é»æ“Šç‡') || header.includes('è§€çœ‹ç‡')) ctrIndex = index;
        });

        // åˆ†ææ‰€æœ‰ AdUnit çš„ cut æ•¸é‡ï¼Œæ‰¾å‡ºæœ€å¤§å€¼
        let maxCuts = 0;
        for (const uuid in cutData) {
            const data = cutData[uuid].data;
            if (data.success) {
                const cutKeys = Object.keys(data.success).filter(key => !isNaN(key));
                maxCuts = Math.max(maxCuts, cutKeys.length);
            }
        }

        // å»ºæ§‹æ–°çš„è¡¨é ­
        const newHeaders = ['æ—¥æœŸ', 'æ˜ŸæœŸ', 'æ›å…‰æ•¸', 'é»æ“Šæ•¸', 'é»æ“Šç‡'];
        for (let i = 1; i <= maxCuts; i++) {
            newHeaders.push(`cut${i}`);
        }
        newHeaders.push('æ–‡æ¡ˆ');

        // å»ºæ§‹æ–°è¡¨æ ¼
        const newTable = document.createElement('table');
        newTable.className = originalTable.className;

        // æ·»åŠ è¡¨é ­
        const headerRow = document.createElement('tr');
        for (let header of newHeaders) {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        }
        newTable.appendChild(headerRow);

        // è™•ç†æ•¸æ“šè¡Œ
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td, th');
            
            if (cells.length === 0) continue;

            const dateText = dateIndex >= 0 ? cells[dateIndex].textContent.trim() : cells[0].textContent.trim();
            
            // è·³é TOTAL è¡Œï¼ˆç¨å¾Œè™•ç†ï¼‰
            if (dateText === 'TOTAL') continue;

            // è§£ææ—¥æœŸ
            let rowDate = null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) {
                rowDate = new Date(dateText);
            } else if (/^\d{2}\/\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('/');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
            } else if (/^\d{2}-\d{2}$/.test(dateText)) {
                const [month, day] = dateText.split('-');
                rowDate = new Date(new Date().getFullYear(), parseInt(month) - 1, parseInt(day));
            }

            // å–å¾—åŸå§‹æ•¸æ“š
            const imp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,â€”]/g,'')) || 0 : 0;
            const clk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,â€”]/g,'')) || 0 : 0;
            const ctr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';

            // è¨ˆç®—ç•¶å¤©çš„ cut æ•¸æ“šç¸½å’Œ
            const cutTotals = new Array(maxCuts).fill(0);
            const formattedDate = rowDate ? formatDateForCutData(rowDate) : null;

            if (formattedDate) {
                for (const uuid in cutData) {
                    const data = cutData[uuid].data;
                    if (data.success) {
                        for (let cutNum = 1; cutNum <= maxCuts; cutNum++) {
                            const cutKey = cutNum.toString();
                            if (data.success[cutKey]) {
                                const dayData = data.success[cutKey].find(d => d._id === formattedDate);
                                if (dayData) {
                                    cutTotals[cutNum - 1] += dayData.totalCount;
                                }
                            }
                        }
                    }
                }
            }

            // è¨ˆç®—æ–‡æ¡ˆæ•¸é‡ï¼šç¸½é»æ“Šæ•¸ - æ‰€æœ‰ cut çš„ç¸½å’Œ
            const totalCutClicks = cutTotals.reduce((sum, cut) => sum + cut, 0);
            const textClicks = Math.max(0, clk - totalCutClicks);

            // å»ºæ§‹æ–°çš„æ•¸æ“šè¡Œ
            const newRow = document.createElement('tr');
            
            // æ—¥æœŸ
            const dateCell = document.createElement('td');
            dateCell.textContent = dateText;
            newRow.appendChild(dateCell);

            // æ˜ŸæœŸ
            const weekCell = document.createElement('td');
            weekCell.textContent = rowDate ? getWeekdayInChinese(rowDate) : '';
            newRow.appendChild(weekCell);

            // æ›å…‰æ•¸
            const impCell = document.createElement('td');
            impCell.textContent = imp > 0 ? imp.toLocaleString() : '';
            newRow.appendChild(impCell);

            // é»æ“Šæ•¸
            const clkCell = document.createElement('td');
            clkCell.textContent = clk > 0 ? clk : '';
            newRow.appendChild(clkCell);

            // é»æ“Šç‡
            const ctrCell = document.createElement('td');
            ctrCell.textContent = ctr;
            newRow.appendChild(ctrCell);

            // Cut æ•¸æ“š
            for (let i = 0; i < maxCuts; i++) {
                const cutCell = document.createElement('td');
                cutCell.textContent = cutTotals[i] > 0 ? cutTotals[i] : '';
                newRow.appendChild(cutCell);
            }

            // æ–‡æ¡ˆ
            const textCell = document.createElement('td');
            textCell.textContent = textClicks > 0 ? textClicks : '';
            newRow.appendChild(textCell);

            newTable.appendChild(newRow);
        }

        // è™•ç† TOTAL è¡Œ
        const totalRow = Array.from(rows).find(row => {
            const cells = row.querySelectorAll('td, th');
            return cells.length > 0 && cells[0].textContent.trim() === 'TOTAL';
        });

        if (totalRow) {
            const cells = totalRow.querySelectorAll('td, th');
            const totalImp = impIndex >= 0 ? +(cells[impIndex].textContent.replace(/[,â€”]/g,'')) || 0 : 0;
            const totalClk = clkIndex >= 0 ? +(cells[clkIndex].textContent.replace(/[,â€”]/g,'')) || 0 : 0;
            const totalCtr = ctrIndex >= 0 ? cells[ctrIndex].textContent.trim() : '';

            // è¨ˆç®—ç¸½è¨ˆ cut æ•¸æ“š
            const totalCutTotals = new Array(maxCuts).fill(0);
            for (const uuid in cutData) {
                const data = cutData[uuid].data;
                if (data.success) {
                    for (let cutNum = 1; cutNum <= maxCuts; cutNum++) {
                        const cutKey = cutNum.toString();
                        if (data.success[cutKey]) {
                            const cutTotal = data.success[cutKey].reduce((sum, d) => sum + d.totalCount, 0);
                            totalCutTotals[cutNum - 1] += cutTotal;
                        }
                    }
                }
            }

            const totalCutClicks = totalCutTotals.reduce((sum, cut) => sum + cut, 0);
            const totalTextClicks = Math.max(0, totalClk - totalCutClicks);

            const newTotalRow = document.createElement('tr');
            
            // TOTAL æ¨™ç±¤
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = 'TOTAL';
            newTotalRow.appendChild(totalLabelCell);

            // ç©ºç™½æ˜ŸæœŸæ¬„
            const emptyWeekCell = document.createElement('td');
            emptyWeekCell.textContent = '';
            newTotalRow.appendChild(emptyWeekCell);

            // ç¸½æ›å…‰æ•¸
            const totalImpCell = document.createElement('td');
            totalImpCell.textContent = totalImp > 0 ? totalImp.toLocaleString() : '';
            newTotalRow.appendChild(totalImpCell);

            // ç¸½é»æ“Šæ•¸
            const totalClkCell = document.createElement('td');
            totalClkCell.textContent = totalClk > 0 ? totalClk : '';
            newTotalRow.appendChild(totalClkCell);

            // ç¸½é»æ“Šç‡
            const totalCtrCell = document.createElement('td');
            totalCtrCell.textContent = totalCtr;
            newTotalRow.appendChild(totalCtrCell);

            // ç¸½ Cut æ•¸æ“š
            for (let i = 0; i < maxCuts; i++) {
                const totalCutCell = document.createElement('td');
                totalCutCell.textContent = totalCutTotals[i] > 0 ? totalCutTotals[i] : '';
                newTotalRow.appendChild(totalCutCell);
            }

            // ç¸½æ–‡æ¡ˆ
            const totalTextCell = document.createElement('td');
            totalTextCell.textContent = totalTextClicks > 0 ? totalTextClicks : '';
            newTotalRow.appendChild(totalTextCell);

            newTable.appendChild(newTotalRow);
        }

        return newTable;
    }

    // æ ¼å¼åŒ–æ—¥æœŸç”¨æ–¼ cut æ•¸æ“šæŸ¥è©¢
    function formatDateForCutData(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // æ·»åŠ å ±è¡¨è¨Šæ¯
    function addReportMessages(container, campaignEndDate, currentDate) {
        // æ·»åŠ æˆåŠŸè¨Šæ¯
        const successMsg = document.createElement('div');
        successMsg.className = 'cookie-status cookie-success';
        successMsg.innerHTML = `âœ“ æ¯æ—¥å ±è¡¨è¼‰å…¥æˆåŠŸï¼${isSlideAd ? ' (å« Cut åˆ†ææ•¸æ“š)' : ''}`;
        container.insertBefore(successMsg, container.firstChild);
        
        // é¡¯ç¤º AdUnit çµ±è¨ˆè³‡è¨Š
        if (Object.keys(allAdunitReports).length > 0) {
            const adunitMsg = document.createElement('div');
            adunitMsg.className = 'cookie-status';
            adunitMsg.style.backgroundColor = '#e8f5e8';
            adunitMsg.style.borderColor = '#4caf50';
            adunitMsg.style.color = '#2e7d32';
            
            const totalAdunits = Object.keys(allAdunitReports).length;
            const successfulAdunits = Object.values(allAdunitReports).filter(report => report.success).length;
            const failedAdunits = totalAdunits - successfulAdunits;
            
            // æŒ‰ AdSet åˆ†çµ„é¡¯ç¤º
            let adunitBreakdown = '';
            for (const [adsetId, adsetData] of Object.entries(adunitByAdset)) {
                const adsetAdunits = adsetData.adunits.length;
                const adsetSuccess = adsetData.adunits.filter(unit => unit.success).length;
                adunitBreakdown += `\n  â€¢ ${adsetData.adsetName}: ${adsetSuccess}/${adsetAdunits} å€‹ AdUnit`;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ•ˆèƒ½è³‡è¨Š
            let performanceInfo = '';
            if (window.adunitQuerySummary) {
                const summary = window.adunitQuerySummary;
                performanceInfo = ` | âš¡ ä¸¦è¡ŒæŸ¥è©¢è€—æ™‚: ${summary.query_duration}ç§’ (${summary.max_workers} åŸ·è¡Œç·’)`;
            }
            
            adunitMsg.innerHTML = `ğŸ¯ AdUnit å ±è¡¨çµ±è¨ˆï¼šæˆåŠŸæŸ¥è©¢ ${successfulAdunits}/${totalAdunits} å€‹ AdUnit${performanceInfo}${adunitBreakdown}`;
            container.insertBefore(adunitMsg, container.firstChild);
        }
        
        // é¡¯ç¤º slide å»£å‘Šè³‡è¨Š
        if (isSlideAd && Object.keys(currentCutData).length > 0) {
            const slideMsg = document.createElement('div');
            slideMsg.className = 'cookie-status';
            slideMsg.style.backgroundColor = '#e1f5fe';
            slideMsg.style.borderColor = '#29b6f6';
            slideMsg.style.color = '#01579b';
            
            const adunitCount = Object.keys(currentCutData).length;
            const adunitNames = Object.values(currentCutData).map(item => 
                item.adunit.title || item.adunit.name || 'Untitled'
            ).join(', ');
            
            slideMsg.innerHTML = `ğŸ¬ Slide å»£å‘Šè³‡è¨Šï¼šæ‰¾åˆ° ${adunitCount} å€‹ AdUnit<br>AdUnit åç¨±ï¼š${adunitNames}`;
            container.insertBefore(slideMsg, container.firstChild);
        }
        
        // é¡¯ç¤ºæŸ¥è©¢æ™‚é–“ç¯„åœè³‡è¨Š
        const useCustomTime = document.getElementById('useCustomTime').checked;
        if (useCustomTime) {
            const customStartDate = document.getElementById('customStartDate').value;
            const customEndDate = document.getElementById('customEndDate').value;
            
            if (customStartDate && customEndDate) {
                const timeRangeMsg = document.createElement('div');
                timeRangeMsg.className = 'cookie-status';
                timeRangeMsg.style.backgroundColor = '#e8f4fd';
                timeRangeMsg.style.borderColor = '#42a5f5';
                timeRangeMsg.style.color = '#1565c0';
                timeRangeMsg.innerHTML = `ğŸ•’ ä½¿ç”¨è‡ªè¨‚æ™‚é–“å€æ®µï¼š${customStartDate} ~ ${customEndDate}ï¼ˆç”¨æˆ¶æ‰‹å‹•è¨­å®šï¼‰`;
                container.insertBefore(timeRangeMsg, container.firstChild);
            }
        }
        
        // é¡¯ç¤ºèµ°æœŸè³‡è¨Šï¼ˆå¼·èª¿æ˜¯è‡ªå‹•å¾ Campaign å–å¾—ï¼‰
        if (campaignEndDate && currentDate) {
            const scheduleMsg = document.createElement('div');
            scheduleMsg.className = 'cookie-status';
            scheduleMsg.style.backgroundColor = '#fff3cd';
            scheduleMsg.style.borderColor = '#ffeaa7';
            scheduleMsg.style.color = '#856404';
            scheduleMsg.innerHTML = `ğŸ“… èµ°æœŸè¨­å®šï¼šçµæŸæ—¥æœŸ ${campaignEndDate}ï¼ˆè‡ªå‹•å¾ Campaign.toTime å–å¾—ï¼‰ï¼Œç•¶å‰æ—¥æœŸ ${currentDate}`;
            container.insertBefore(scheduleMsg, container.firstChild);
        } else if (campaignEndDate) {
            // åªæœ‰èµ°æœŸçµæŸæ—¥æœŸï¼Œæ²’æœ‰ç•¶å‰æ—¥æœŸ
            const scheduleMsg = document.createElement('div');
            scheduleMsg.className = 'cookie-status';
            scheduleMsg.style.backgroundColor = '#fff3cd';
            scheduleMsg.style.borderColor = '#ffeaa7';
            scheduleMsg.style.color = '#856404';
            scheduleMsg.innerHTML = `ğŸ“… èµ°æœŸè¨­å®šï¼šçµæŸæ—¥æœŸ ${campaignEndDate}ï¼ˆè‡ªå‹•å¾ Campaign.toTime å–å¾—ï¼‰`;
            container.insertBefore(scheduleMsg, container.firstChild);
        }
        
        // é¡¯ç¤ºå»£å‘Šé›†è³‡è¨Š
        if (currentAdsetInfo && currentAdsetInfo.success) {
            const adsetInfoMsg = document.createElement('div');
            adsetInfoMsg.className = 'cookie-status';
            adsetInfoMsg.style.backgroundColor = '#e8f5e8';
            adsetInfoMsg.style.borderColor = '#4caf50';
            adsetInfoMsg.style.color = '#2e7d32';
            const pricing = currentAdsetInfo.pricing;
            const info = currentAdsetInfo.info;
            const currency = pricing.currency === 'TWD' ? '$' : pricing.currency;
            
            // é¡¯ç¤ºé ç®—è§£æè³‡è¨Š
            let budgetInfo = '';
            if (info.campaignBudget !== undefined) {
                budgetInfo = `${currency}${info.campaignBudget.toLocaleString()} (å¾ Campaign å–å¾—)`;
            } else if (info.parsedBudget > 0) {
                budgetInfo = `${currency}${info.parsedBudget.toLocaleString()} (å¾æ´»å‹•åç¨±è§£æ)`;
            } else {
                budgetInfo = `${currency}${info.budget.toLocaleString()} (åŸå§‹é ç®—)`;
            }
            
            // é¡¯ç¤ºæ™‚é–“æˆ³è³‡è¨Š
            let timestampInfo = '';
            if (info.fromTimestamp && info.toTimestamp) {
                const fromDate = new Date(info.fromTimestamp).toLocaleDateString('zh-TW');
                const toDate = new Date(info.toTimestamp).toLocaleDateString('zh-TW');
                timestampInfo = ` | ğŸ“… èµ°æœŸï¼š${fromDate} ~ ${toDate}`;
            }
            
            adsetInfoMsg.innerHTML = `
                ğŸ“Š å»£å‘Šé›†è³‡è¨Šï¼š${info.name || 'æœªçŸ¥æ´»å‹•'} | 
                ğŸ’° è¨ˆåƒ¹æ–¹å¼ï¼š${pricing.bMode} (${currency}${pricing.price}) | 
                ğŸ¯ å»£å‘Šé¡å‹ï¼š${info.adType || 'NATIVE'} | 
                ğŸ’µ ç¸½é ç®—ï¼š${budgetInfo}${timestampInfo}
            `;
            container.insertBefore(adsetInfoMsg, container.firstChild);
        }
        
        // åˆ†æè¡¨æ ¼çµæ§‹ä¸¦é¡¯ç¤º
        const table = container.querySelector('table');
        if (table) {
            const tableHeaders = Array.from(table.querySelectorAll('tr')[0].querySelectorAll('th,td')).map(h => h.textContent.trim());
            const structureMsg = document.createElement('div');
            structureMsg.className = 'cookie-status';
            structureMsg.style.backgroundColor = '#e3f2fd';
            structureMsg.style.borderColor = '#2196f3';
            structureMsg.style.color = '#1976d2';
            structureMsg.innerHTML = `ğŸ“‹ æª¢æ¸¬åˆ°çš„è¡¨æ ¼æ¬„ä½ï¼š${tableHeaders.join(' | ')}`;
            container.insertBefore(structureMsg, container.firstChild);
        }
    }

    // æ–°å¢ï¼šåˆ‡æ› AdSet é¸æ“‡ç‹€æ…‹
    function toggleAdsetSelection(adsetId) {
        toggleAdsetCollapse(adsetId);
    }
    
    // æ–°å¢ï¼šåˆ‡æ› AdUnit é¸æ“‡ç‹€æ…‹
    function toggleAdunitSelection(adunitUuid) {
        toggleAdunitCollapse(adunitUuid);
    }
    
    // æ–°å¢ï¼šé‡æ–°é¡¯ç¤ºå€‹åˆ¥å ±è¡¨
    function refreshIndividualReports() {
        const container = document.getElementById('dailyReportContainer');
        
        // ä¿ç•™ç¾æœ‰çš„è¨Šæ¯å’Œç¸½åˆå ±è¡¨ï¼Œåªæ›´æ–°å€‹åˆ¥å ±è¡¨éƒ¨åˆ†
        const reports = container.querySelectorAll('.daily-report-section');
        
        // æ‰¾åˆ°å€‹åˆ¥å ±è¡¨å€åŸŸä¸¦æ›¿æ›
        for (let report of reports) {
            const title = report.querySelector('h4');
            if (title && title.textContent.includes('å€‹åˆ¥å»£å‘Šé›†å ±è¡¨')) {
                const newReportContent = displayIndividualAdsetReports();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newReportContent;
                report.replaceWith(tempDiv.firstElementChild);
                
                // é‡æ–°ç¶å®šé‡æ–°ç”ŸæˆæŒ‰éˆ•äº‹ä»¶
                const refreshBtn = document.getElementById('refreshReportBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', regenerateMergedReport);
                }
                break;
            }
        }
    }
    
    // æ–°å¢ï¼šé‡æ–°ç”Ÿæˆç¸½åˆå ±è¡¨
    function regenerateMergedReport() {
        const container = document.getElementById('dailyReportContainer');
        
        // é‡æ–°ç”Ÿæˆåˆä½µå ±è¡¨
        const mergedTable = mergeAllAdsetReports();
        if (mergedTable) {
            // è™•ç† slide å»£å‘Šå’Œèµ°æœŸ
            let finalTable = mergedTable;
            if (isSlideAd && Object.keys(currentCutData).length > 0) {
                finalTable = buildSlideReportTable(mergedTable, currentCutData);
            }
            
            const campaignEndDate = currentReportData.campaignEndDate;
            const currentDate = currentReportData.currentDate;
            if (campaignEndDate && currentDate) {
                finalTable = processTableBySchedule(finalTable, campaignEndDate, currentDate);
            }
            
            // æ›´æ–°ç¸½åˆå ±è¡¨å€åŸŸ
            const reports = container.querySelectorAll('.daily-report-section');
            for (let report of reports) {
                const title = report.querySelector('h4');
                if (title && title.textContent.includes('ç¸½åˆå ±è¡¨æ•¸æ“š')) {
                    const newContent = `
                        <h4>ğŸ“ˆ ç¸½åˆå ±è¡¨æ•¸æ“š${isSlideAd ? 'ï¼ˆå« Cut åˆ†ææ•¸æ“šï¼‰' : ''}</h4>
                        ${finalTable.outerHTML}
                    `;
                    report.innerHTML = newContent;
                    
                    // ç¾åŒ–è¡¨æ ¼
                    const table = report.querySelector('table');
                    if (table) {
                        table.className = 'report-table';
                    }
                    break;
                }
            }
            
            // æ›´æ–°å ±è¡¨è³‡æ–™
            currentReportData.table = finalTable;
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const selectedAdsetCount = selectedAdsets.size;
            const selectedAdunitCount = selectedAdunits.size;
            alert(`âœ… ç¸½åˆå ±è¡¨å·²é‡æ–°ç”Ÿæˆï¼\nå·²åŒ…å« ${selectedAdsetCount} å€‹ AdSet å’Œ ${selectedAdunitCount} å€‹ AdUnit çš„æ•¸æ“šã€‚`);
        } else {
            alert('âŒ ç„¡æ³•ç”Ÿæˆç¸½åˆå ±è¡¨ï¼Œè«‹ç¢ºä¿è‡³å°‘é¸æ“‡ä¸€å€‹ AdSetã€‚');
        }
    }
});

// å…¨åŸŸç·©å­˜ç®¡ç†å‡½æ•¸
function clearCurrentCampaignCache() {
    const campaignId = document.getElementById('campaignId').value.trim();
    if (!campaignId) {
        alert('è«‹å…ˆè¼¸å…¥å»£å‘Šæ´»å‹• ID');
        return;
    }
    
    const CACHE_PREFIX = 'adCampaignCache_';
    
    try {
        // æ¸…é™¤åŸºæœ¬è³‡è¨Šç·©å­˜
        const basicCacheKey = `${CACHE_PREFIX}basic_${campaignId}`;
        localStorage.removeItem(basicCacheKey);
        
        // æ¸…é™¤æ‰€æœ‰ç›¸é—œçš„å ±è¡¨ç·©å­˜
        const keys = Object.keys(localStorage);
        let clearedCount = 0;
        
        keys.forEach(key => {
            if (key.startsWith(CACHE_PREFIX) && key.includes(campaignId)) {
                localStorage.removeItem(key);
                clearedCount++;
                console.log(`ğŸ—‘ï¸ å·²æ¸…é™¤ç·©å­˜: ${key}`);
            }
        });
        
        alert(`âœ… å·²æ¸…é™¤è©²å»£å‘Šæ´»å‹•çš„æ‰€æœ‰ç·©å­˜ (å…± ${clearedCount} å€‹)ï¼Œä¸‹æ¬¡æŸ¥è©¢å°‡é‡æ–°å¾ä¼ºæœå™¨ç²å–æ•¸æ“š`);
        
        // æ›´æ–°ç·©å­˜ç‹€æ…‹é¡¯ç¤º
        if (typeof updateCacheStatus === 'function') {
            updateCacheStatus();
        }
    } catch (error) {
        alert('âŒ æ¸…é™¤ç·©å­˜å¤±æ•—: ' + error.message);
    }
}

// åœ¨ DOMContentLoaded å¤–éƒ¨å®šç¾©å…¨åŸŸå‡½æ•¸ï¼Œä¾›æŒ‰éˆ•é»æ“Šäº‹ä»¶ä½¿ç”¨
function toggleAdsetCollapse(adsetId) {
    const contentDiv = document.getElementById(`adset-content-${adsetId}`);
    const adunitSection = document.getElementById(`adunit-section-${adsetId}`);
    const button = event.target;
    
    // æ›´æ–°å…¨åŸŸçš„ selectedAdsets
    if (window.selectedAdsets && window.selectedAdsets.has(adsetId)) {
        // ç•¶å‰æ˜¯å±•é–‹ç‹€æ…‹ï¼Œè¦æ”¶åˆ
        window.selectedAdsets.delete(adsetId);
        contentDiv.style.display = 'none';
        if (adunitSection) adunitSection.style.display = 'none';
        button.textContent = 'â•';
        button.style.background = '#6c757d';
    } else {
        // ç•¶å‰æ˜¯æ”¶åˆç‹€æ…‹ï¼Œè¦å±•é–‹
        if (!window.selectedAdsets) window.selectedAdsets = new Set();
        window.selectedAdsets.add(adsetId);
        contentDiv.style.display = 'block';
        if (adunitSection) adunitSection.style.display = 'block';
        button.textContent = 'â–';
        button.style.background = '#28a745';
    }
}

function toggleAdunitCollapse(adunitUuid) {
    const contentDiv = document.getElementById(`adunit-content-${adunitUuid}`);
    const button = event.target;
    
    // æ›´æ–°å…¨åŸŸçš„ selectedAdunits
    if (window.selectedAdunits && window.selectedAdunits.has(adunitUuid)) {
        // ç•¶å‰æ˜¯å±•é–‹ç‹€æ…‹ï¼Œè¦æ”¶åˆ
        window.selectedAdunits.delete(adunitUuid);
        contentDiv.style.display = 'none';
        button.textContent = 'â•';
        button.style.background = '#6c757d';
    } else {
        // ç•¶å‰æ˜¯æ”¶åˆç‹€æ…‹ï¼Œè¦å±•é–‹
        if (!window.selectedAdunits) window.selectedAdunits = new Set();
        window.selectedAdunits.add(adunitUuid);
        contentDiv.style.display = 'block';
        button.textContent = 'â–';
        button.style.background = '#28a745';
    }
}
</script>
{% endblock %} 