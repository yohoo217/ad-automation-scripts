{% extends "base.html" %}

{% block title %}å‚ç›´ Slide å»£å‘Šå»ºç«‹{% endblock %}

{% block page_title %}å»ºç«‹å‚ç›´ Slide å»£å‘Š{% endblock %}

{% block additional_styles %}
<style>
    .slide-controls {
        margin-top: 20px;
        margin-bottom: 20px;
    }
    .slide-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .clear-form-btn {
        background-color: #f44336;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 15px;
    }
    .clear-form-btn:hover {
        background-color: #d32f2f;
    }
    .main-content-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 20px;
    }
    .form-column {
        flex: 1;
        min-width: 0;
    }
    .preview-column {
        width: 300px;
        flex-shrink: 0;
        position: sticky;
        top: 20px;
    }
    .ad-preview-container {
        width: 300px;
        height: 600px;
        border: 2px solid #333;
        margin: 0;
        display: flex;
        flex-direction: column;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        background-color: #000;
        overflow: hidden;
    }
    .ad-preview-header {
        padding: 2px 8px;
        font-size: 12px;
        color: #cd9601;
        text-align: left;
    }
    .ad-preview-main {
        flex-grow: 1;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        height: 157px;
        background-color: #000;
    }
    .ad-preview-title {
        padding: 4px 8px;
        font-weight: bold;
        font-size: 14px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: white;
    }
    .ad-preview-subtitle {
        padding: 4px 8px;
        font-size: 12px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: gray;
    }
    .ad-preview-footer {
        display: flex;
        font-size: 12px;
    }
    .ad-preview-advertiser {
        flex-grow: 1;
        padding: 4px 8px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: gray;
    }
    .ad-preview-cta {
        padding: 4px 12px;
        font-weight: bold;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background-color: #0d6efd;
        color: white;
        border-radius: 5px;
        margin: 4px;
    }
    #preview-slide-wrapper {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    .preview-slide {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }
    .preview-slide.active {
        opacity: 1;
    }
    .preview-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    #preview-dots-container {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 10;
    }
    .preview-dot {
        width: 8px;
        height: 8px;
        background-color: #888;
        border-radius: 50%;
        transition: background-color 0.3s;
    }
    .preview-dot.active {
        background-color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content-wrapper">
    <div class="form-column">
        <form action="{{ url_for('main.clear_vertical_slide_form') }}" method="post" style="display: inline;">
            <button type="submit" class="clear-form-btn" onclick="return confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡«å¯«çš„å…§å®¹å—ï¼Ÿ')">æ¸…é™¤æ‰€æœ‰å…§å®¹</button>
        </form>

        <form action="{{ url_for('main.create_vertical_slide_ad') }}" method="post" id="ad-form">
            <div class="field-group">
                <h3>ğŸ“‹ åŸºæœ¬å»£å‘Šè³‡è¨Š</h3>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="adset_id">Adset ID <span class="required">*</span></label>
                        <input type="text" id="adset_id" name="adset_id" value="{{ adset_id or '' }}" required
                               placeholder="ä¾‹å¦‚ï¼š00947c1b-f7cd-47c6-a23a-0639e9702cc7">
                        <div class="help-text">å»£å‘Šçµ„IDï¼Œå¿…å¡«</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="display_name">å»£å‘Šå–®å…ƒé¡¯ç¤ºåç¨±</label>
                        <input type="text" id="display_name" name="display_name" value="{{ display_name or '' }}"
                               placeholder="åƒ…ä¾›å¾Œå°é¡¯ç¤ºä½¿ç”¨">
                        <div class="help-text">åƒ…é¡¯ç¤ºæ–¼å¾Œå°ï¼Œå¯é¸</div>
                    </div>
                </div>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="advertiser">å»£å‘Šå•† <span class="required">*</span></label>
                        <input type="text" id="advertiser" name="advertiser" value="{{ advertiser or '' }}" required
                               placeholder="å»£å‘Šä¸»åç¨±">
                        <div class="help-text">å»£å‘Šä¸»åç¨±ï¼Œå¿…å¡«</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="main_title">ä¸»æ¨™é¡Œ <span class="required">*</span></label>
                        <input type="text" id="main_title" name="main_title" value="{{ main_title or '' }}" required
                               placeholder="å»£å‘Šä¸»æ¨™é¡Œ">
                        <div class="help-text">å»£å‘Šä¸»æ¨™é¡Œï¼Œå¿…å¡«</div>
                    </div>
                </div>
                
                <div class="form-grid-2">
                    <div class="form-row">
                        <label for="subtitle">æ–‡å­—æ•˜è¿°</label>
                        <input type="text" id="subtitle" name="subtitle" value="{{ subtitle or '' }}"
                               placeholder="å»£å‘Šå‰¯æ¨™é¡Œï¼ˆå¯é¸ï¼‰">
                        <div class="help-text">å»£å‘Šå‰¯æ¨™é¡Œï¼Œå¯é¸</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="call_to_action">è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—</label>
                        <input type="text" id="call_to_action" name="call_to_action" value="{{ call_to_action or 'ç«‹å³äº†è§£' }}"
                               placeholder="ç«‹å³äº†è§£">
                        <div class="help-text">CTAæŒ‰éˆ•æ–‡å­—ï¼Œé è¨­ç‚ºã€Œç«‹å³äº†è§£ã€</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <label for="landing_page">åˆ°é”é é¢ç¶²å€ <span class="required">*</span></label>
                    <input type="url" id="landing_page" name="landing_page" placeholder="https://example.com" 
                           value="{{ landing_page or '' }}" required>
                    <div class="help-text">ç”¨æˆ¶é»æ“Šå»£å‘Šå¾Œè·³è½‰çš„ç¶²å€ï¼Œå¿…å¡«</div>
                </div>
            </div>

            <div class="field-group">
                <h3>å»£å‘Šç´ æ <span class="required">*</span></h3>
                <p>æ‰€æœ‰åœ–ç‰‡å‡ç‚ºå¿…å¡«ã€‚è«‹æä¾›æœ¬åœ°å®Œæ•´æª”æ¡ˆè·¯å¾‘ï¼Œæˆ–ä½¿ç”¨ä¸Šå‚³åŠŸèƒ½ã€‚</p>
                
                <div class="form-row">
                    <label for="image_path_m">åœ–ç‰‡ 1200x628 <span class="required">*</span></label>
                    <div class="file-upload-container">
                        <input type="text" id="image_path_m" name="image_path_m" placeholder="/path/to/your/image_1200x628.jpg" value="{{ image_path_m or '' }}" required>
                        <div class="help-text">å¤§å‹æ©«å¹…åœ–ç‰‡ï¼Œå°ºå¯¸1200x628åƒç´ </div>
                        <div class="preview-container">
                            <label class="custom-file-upload">
                                ä¸Šå‚³åœ–ç‰‡
                                <input type="file" class="file-input" data-target="image_path_m" accept="image/*">
                            </label>
                            <img id="preview_m" class="upload-preview" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <label for="image_path_s">åœ–ç‰‡ 300x300 <span class="required">*</span></label>
                    <div class="file-upload-container">
                        <input type="text" id="image_path_s" name="image_path_s" placeholder="/path/to/your/image_300x300.jpg" value="{{ image_path_s or '' }}" required>
                        <div class="help-text">æ–¹å½¢åœ–ç‰‡ï¼Œå°ºå¯¸300x300åƒç´ </div>
                        <div class="preview-container">
                            <label class="custom-file-upload">
                                ä¸Šå‚³åœ–ç‰‡
                                <input type="file" class="file-input" data-target="image_path_s" accept="image/*">
                            </label>
                            <img id="preview_s" class="upload-preview" style="display: none;">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <label for="background_image">éŠæˆ²å¥—ä»¶é è¨­èƒŒæ™¯ <span class="required">*</span></label>
                    <input type="text" id="background_image" name="background_image" placeholder="è«‹è¼¸å…¥èƒŒæ™¯åœ–ç‰‡ç¶²å€" value="{{ background_image or '' }}" required>
                    <div class="help-text">éŠæˆ²å¥—ä»¶é è¨­èƒŒæ™¯åœ–ç‰‡ç¶²å€</div>
                </div>
            </div>

            <div class="field-group">
                <h3>æ»‘å‹•å»£å‘Šè¨­å®š <span class="required">*</span></h3>
                <div id="vertical-slide-items-container">
                    <!-- é»˜èªé¡¯ç¤ºä¸€å€‹æ»‘å‹•é …ç›®ï¼Œå°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                </div>
                <div class="slide-controls">
                    <button type="button" id="add-vertical-slide-item" class="button nav-button">æ–°å¢æ»‘å‹•é …ç›®</button>
                    <button type="button" id="remove-vertical-slide-item" class="button" style="background-color: #d9534f;">ç§»é™¤æœ€å¾Œä¸€å€‹é …ç›®</button>
                </div>
                <input type="hidden" id="payload_game_widget" name="payload_game_widget">
                
                <!-- éš±è—çš„æ•¸æ“šå‚³é -->
                <input type="hidden" id="slide_items_data" value="{{ slide_items | tojson | e }}">
            </div>
            
            <input type="submit" value="å»ºç«‹å‚ç›´ Slide å»£å‘Š">
        </form>
    </div>
    <div class="preview-column">
        <div class="field-group">
            <h3>ğŸ–¼ï¸ å»£å‘Šå³æ™‚é è¦½</h3>
            <div class="ad-preview-container">
                <div class="ad-preview-header">å»£å‘Š</div>
                <div class="ad-preview-main">
                    <div id="preview-slide-wrapper">
                        <!-- Slides will be injected here -->
                    </div>
                    <div id="preview-dots-container">
                        <!-- Dots will be injected here -->
                    </div>
                </div>
                <div id="preview-main-title" class="ad-preview-title">ä¸»æ¨™é¡Œ</div>
                <div id="preview-subtitle" class="ad-preview-subtitle">æ–‡å­—æ•˜è¿°</div>
                <div class="ad-preview-footer">
                    <div id="preview-advertiser" class="ad-preview-advertiser">å»£å‘Šå•†</div>
                    <div id="preview-call-to-action" class="ad-preview-cta">è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    // Debounce å‡½æ•¸ï¼Œé˜²æ­¢äº‹ä»¶éæ–¼é »ç¹è§¸ç™¼
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // è‡ªå‹•å„²å­˜è¡¨å–®ç‹€æ…‹åˆ°å¾Œç«¯ session
    const autoSaveForm = debounce(() => {
        const form = document.getElementById('ad-form');
        const formData = new FormData(form);
        
        // ä½¿ç”¨ fetch API å°‡è¡¨å–®æ•¸æ“šç™¼é€åˆ°å¾Œç«¯
        fetch("{{ url_for('main.save_form_data') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Form state auto-saved to session.');
            } else {
                console.error('Failed to auto-save form state:', data.message);
            }
        })
        .catch(error => {
            console.error('Error in auto-save request:', error);
        });
    }, 500); // åœ¨ç”¨æˆ¶åœæ­¢è¼¸å…¥ 500 æ¯«ç§’å¾Œè§¸ç™¼

    document.addEventListener('DOMContentLoaded', function() {
        // ç‚ºè¡¨å–®æ·»åŠ è¼¸å…¥äº‹ä»¶ç›£è½å™¨ä»¥è§¸ç™¼è‡ªå‹•å„²å­˜
        const adForm = document.getElementById('ad-form');
        if (adForm) {
            adForm.addEventListener('input', autoSaveForm);
        }

        // åˆå§‹åŒ–æ»‘å‹•é …ç›®
        initializeSlideItems();

        // æ·»åŠ äº‹ä»¶ç›£è½å™¨çµ¦æŒ‰éˆ•
        document.getElementById('add-vertical-slide-item').addEventListener('click', addSlideItem);
        document.getElementById('remove-vertical-slide-item').addEventListener('click', removeSlideItem);

        // æ·»åŠ äº‹ä»¶ç›£è½å™¨ä»¥æ›´æ–°é è¦½
        const inputsToTrack = ['advertiser', 'main_title', 'subtitle', 'call_to_action'];
        inputsToTrack.forEach(id => {
            document.getElementById(id).addEventListener('input', updateVerticalSlideAdPreview);
        });
    });
    
    function initializeSlideItems() {
        // å¾éš±è—å…ƒç´ ä¸­è®€å–æ»‘å‹•é …ç›®æ•¸æ“š
        const slideItemsDataElement = document.getElementById('slide_items_data');
        let slideItemsData = [];
        
        if (slideItemsDataElement && slideItemsDataElement.value) {
            try {
                slideItemsData = JSON.parse(slideItemsDataElement.value);
            } catch (e) {
                console.error('è§£ææ»‘å‹•é …ç›®æ•¸æ“šå¤±æ•—:', e);
            }
        }
        
        if (slideItemsData && slideItemsData.length > 0) {
            // æ¢å¾©ç¾æœ‰çš„æ»‘å‹•é …ç›®
            slideItemsData.forEach(function(item) {
                addSlideItemWithData(item.index, item.image_url, item.target_url);
            });
        } else {
            // å¦‚æœæ²’æœ‰é …ç›®ï¼Œæ·»åŠ ä¸€å€‹ç©ºçš„
            addSlideItem();
        }
        
        // æ›´æ–° payload å’Œé è¦½
        updatePayload();
        updateVerticalSlideAdPreview();
    }
    
    function addSlideItem() {
        addSlideItemWithData(slideItemCount, '', '');
    }
    
    function addSlideItemWithData(index, imageUrl, targetUrl) {
        if (index >= slideItemCount) {
            slideItemCount = index + 1;
        }
        
        const container = document.getElementById('vertical-slide-items-container');
        const newItem = document.createElement('div');
        newItem.className = 'vertical-slide-item';
        newItem.setAttribute('data-index', index);
        
        newItem.innerHTML = `
            <button type="button" class="remove-item-btn" onclick="removeSpecificSlideItem(${index})" title="ç§»é™¤æ­¤é …ç›®">Ã—</button>
            <h4>æ»‘å‹•é …ç›® #${index + 1}</h4>
            <div class="form-grid-2">
                <div class="form-row">
                    <label for="image_url_${index}">åœ–ç‰‡ç¶²å€ <span class="required">*</span></label>
                    <input type="url" id="image_url_${index}" name="image_url_${index}" class="vertical-slide-image-url" 
                           placeholder="https://example.com/slide${index + 1}.jpg" 
                           value="${imageUrl}" required>
                    <div class="help-text">æ»‘å‹•é …ç›®çš„åœ–ç‰‡ç¶²å€</div>
                </div>
                
                <div class="form-row">
                    <label for="target_url_${index}">ç›®æ¨™ç¶²å€ <span class="required">*</span></label>
                    <input type="url" id="target_url_${index}" name="target_url_${index}" class="vertical-slide-target-url"
                           placeholder="https://example.com/target${index + 1}" 
                           value="${targetUrl}" required>
                    <div class="help-text">é»æ“Šæ­¤æ»‘å‹•é …ç›®å¾Œè·³è½‰çš„ç¶²å€</div>
                </div>
            </div>
        `;
        
        container.appendChild(newItem);

        // ç‚ºæ–°æ·»åŠ çš„è¼¸å…¥æ¬„ä½ç¶å®š change äº‹ä»¶ä»¥æ›´æ–° payload
        newItem.querySelectorAll('.vertical-slide-image-url, .vertical-slide-target-url').forEach(input => {
            input.addEventListener('input', () => {
                updatePayload();
                updateVerticalSlideAdPreview();
            });
        });
        updatePayload();
        updateVerticalSlideAdPreview();
    }
    
    function removeSlideItem() {
        const container = document.getElementById('vertical-slide-items-container');
        if (slideItemCount > 1) {
            // ä¿ç•™è‡³å°‘ä¸€å€‹é …ç›®
            container.removeChild(container.lastChild);
            slideItemCount--;
            updatePayload();
            updateVerticalSlideAdPreview();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ»‘å‹•é …ç›®ï¼');
        }
    }
    
    function removeSpecificSlideItem(index) {
        const container = document.getElementById('vertical-slide-items-container');
        if (container.children.length > 1) {
            const item = container.querySelector(`[data-index="${index}"]`);
            if (item) {
                container.removeChild(item);
                // é‡æ–°ç·¨è™Ÿå…¶é¤˜é …ç›®
                renumberSlideItems();
                updatePayload();
                updateVerticalSlideAdPreview();
            }
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ»‘å‹•é …ç›®ï¼');
        }
    }
    
    function renumberSlideItems() {
        const container = document.getElementById('vertical-slide-items-container');
        const items = container.querySelectorAll('.vertical-slide-item');
        
        items.forEach((item, newIndex) => {
            item.setAttribute('data-index', newIndex);
            item.querySelector('h4').textContent = `æ»‘å‹•é …ç›® #${newIndex + 1}`;
            
            // æ›´æ–°æ‰€æœ‰ç›¸é—œçš„ ID å’Œ name
            const inputs = item.querySelectorAll('input');
            inputs.forEach(input => {
                const oldName = input.getAttribute('name');
                const oldId = input.getAttribute('id');
                
                if (oldName) {
                    const baseName = oldName.replace(/_\d+$/, '');
                    input.setAttribute('name', `${baseName}_${newIndex}`);
                }
                
                if (oldId) {
                    const baseId = oldId.replace(/_\d+$/, '');
                    input.setAttribute('id', `${baseId}_${newIndex}`);
                }
                
                // æ›´æ–°å°æ‡‰çš„ label
                const label = item.querySelector(`label[for="${oldId}"]`);
                if (label) {
                    label.setAttribute('for', input.id);
                }
            });
            
            // æ›´æ–°ç§»é™¤æŒ‰éˆ•çš„ onclick
            const removeBtn = item.querySelector('.remove-item-btn');
            if (removeBtn) {
                removeBtn.setAttribute('onclick', `removeSpecificSlideItem(${newIndex})`);
            }
        });
        
        slideItemCount = items.length;
    }
    
    function updatePayload() {
        const imageUrlsInputs = document.querySelectorAll('.vertical-slide-image-url');
        const targetUrlsInputs = document.querySelectorAll('.vertical-slide-target-url');
        
        const slides = [];
        const invokes = [];
        
        for (let i = 0; i < imageUrlsInputs.length; i++) {
            const imageUrl = imageUrlsInputs[i].value;
            const targetUrl = targetUrlsInputs[i].value;
            
            if (imageUrl && imageUrl.trim() !== '') {
                slides.push(imageUrl);
                if (targetUrl && targetUrl.trim() !== '') {
                    invokes.push({
                        action: "OPEN_EXTERNAL_BROWSER",
                        payload: {
                            url: targetUrl
                        }
                    });
                }
            }
        }
        
        const payload = {
            type: "SLIDE",
            data: {
                options: {
                    direction: "vertical",
                    loop: "true",
                    loopedSlides: slides.length > 0 ? slides.length : 1,
                    autoplay: {
                        delay: 2000
                    }
                },
                slides: slides // Array of image URLs
            },
            invokes: invokes // Array of invoke objects
        };
        
        document.getElementById('payload_game_widget').value = JSON.stringify(payload, null, 2);
    }
    
    function updateVerticalSlideAdPreview() {
        // æ›´æ–°æ–‡å­—éƒ¨åˆ†
        document.getElementById('preview-main-title').textContent = document.getElementById('main_title').value || 'ä¸»æ¨™é¡Œ';
        document.getElementById('preview-subtitle').textContent = document.getElementById('subtitle').value || 'æ–‡å­—æ•˜è¿°';
        document.getElementById('preview-advertiser').textContent = document.getElementById('advertiser').value || 'å»£å‘Šå•†';
        document.getElementById('preview-call-to-action').textContent = document.getElementById('call_to_action').value || 'è¡Œå‹•å‘¼ç±²æŒ‰éˆ•æ–‡å­—';

        // æ›´æ–°å¹»ç‡ˆç‰‡éƒ¨åˆ†
        const slideWrapper = document.getElementById('preview-slide-wrapper');
        const dotsContainer = document.getElementById('preview-dots-container');
        slideWrapper.innerHTML = '';
        dotsContainer.innerHTML = '';

        const slideItemForms = document.querySelectorAll('#vertical-slide-items-container .vertical-slide-item');
        
        if (slideItemForms.length === 0) {
            slideWrapper.innerHTML = '<span style="color: #888; font-size: 14px; padding: 10px;">æ»‘å‹•å»£å‘Šè¨­å®š</span>';
            return;
        }
        
        let validSlides = [];
        slideItemForms.forEach((item, index) => {
            const imageUrlInput = item.querySelector('input[name^="image_url_"]');
            if (imageUrlInput && imageUrlInput.value) {
                validSlides.push(imageUrlInput.value);
                
                const slideDiv = document.createElement('div');
                slideDiv.className = 'preview-slide';
                slideDiv.innerHTML = `<img src="${imageUrlInput.value}" alt="Slide ${index + 1}">`;
                slideWrapper.appendChild(slideDiv);

                const dotSpan = document.createElement('span');
                dotSpan.className = 'preview-dot';
                dotsContainer.appendChild(dotSpan);
            }
        });

        clearInterval(slidePreviewInterval);

        if (validSlides.length > 0) {
            const slides = slideWrapper.querySelectorAll('.preview-slide');
            const dots = dotsContainer.querySelectorAll('.preview-dot');
            currentPreviewSlideIndex = 0;
            
            function showSlide() {
                slides.forEach((s, i) => s.classList.toggle('active', i === currentPreviewSlideIndex));
                dots.forEach((d, i) => d.classList.toggle('active', i === currentPreviewSlideIndex));
            }

            showSlide();

            if (slides.length > 1) {
                slidePreviewInterval = setInterval(() => {
                    currentPreviewSlideIndex = (currentPreviewSlideIndex + 1) % slides.length;
                    showSlide();
                }, 3000);
            }
        } else {
             slideWrapper.innerHTML = '<span style="color: #888; font-size: 14px; padding: 10px;">è«‹æ–¼æ»‘å‹•å»£å‘Šè¨­å®šä¸­<br>è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡ç¶²å€</span>';
        }
    }

    function parseInfoText(inputText) {
        // è§£æå»£å‘Šä¸»
        let advertiserMatch = inputText.match(/-å»£å‘Šä¸»ï¼š(.*?)($|\n)/);
        if (advertiserMatch && advertiserMatch[1]) {
            document.getElementById('advertiser').value = advertiserMatch[1].trim();
        }
        
        // è§£ææ¨™é¡Œ
        let titleMatch = inputText.match(/-\s*æ¨™é¡Œï¼š(.*?)($|\n)/);
        if (titleMatch && titleMatch[1]) {
            document.getElementById('main_title').value = titleMatch[1].trim();
        }
        
        // è§£æå°é€£
        let landingMatch = inputText.match(/å°é€£ï¼š(https?:\/\/[^\s]+)/);
        if (landingMatch && landingMatch[1]) {
            document.getElementById('landing_page').value = landingMatch[1].trim();
            
            // åŒæ™‚å¡«å…¥ç¬¬ä¸€å€‹æ»‘å‹•é …ç›®çš„ç›®æ¨™URL
            const firstTargetUrlInput = document.querySelector('.vertical-slide-target-url');
            if (firstTargetUrlInput) {
                firstTargetUrlInput.value = landingMatch[1].trim();
            }
        }
        
        // è§£æ CTA
        let ctaMatch = inputText.match(/-\s*CTAï¼š(.*?)($|\n)/);
        if (ctaMatch && ctaMatch[1]) {
            document.getElementById('call_to_action').value = ctaMatch[1].trim();
        }
        
        // è§£æç´ æï¼Œä½œç‚ºèƒŒæ™¯åœ–ç‰‡å’Œç¬¬ä¸€å€‹æ»‘å‹•é …ç›®çš„åœ–ç‰‡
        let materialMatch = inputText.match(/ç´ æï¼š(https?:\/\/[^\s]+)/);
        if (materialMatch && materialMatch[1]) {
            document.getElementById('background_image').value = materialMatch[1].trim();
            
            // å¡«å…¥ç¬¬ä¸€å€‹æ»‘å‹•é …ç›®çš„åœ–ç‰‡URL
            const firstImageUrlInput = document.querySelector('.vertical-slide-image-url');
            if (firstImageUrlInput) {
                firstImageUrlInput.value = materialMatch[1].trim();
            }
            
            updatePayload();
        }
        updateVerticalSlideAdPreview();
    }
</script>
{% endblock %} 